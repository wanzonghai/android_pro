window.Laya=function(e){"use strict";class ClassUtils{static regClass(e,t){ClassUtils._classMap[e]=t}static getClass(e){return ClassUtils._classMap[e]}static getInstance(e){var t=ClassUtils.getClass(e);return t?new t:(console.warn("[error] Undefined class:",e),null)}}function dummy(){}ClassUtils._classMap={};class Config{}Config.isAntialias=!0,Config.useWebGL2=!0,Config.FPS=60,Config.useRetinalCanvas=!1,Config.animationInterval=50,Config.webGL2D_MeshAllocMaxMem=!0,Config.defaultFontSize=12,Config.defaultFont="Arial",Config.isAlpha=!1,Config.isDepth=!1,Config.isfailIfMajorPerformanceCaveat=!1,Config.powerPreference="default",Config.premultipliedAlpha=!0,Config.isStencil=!1,Config.preserveDrawingBuffer=!1,Config.printWebglOrder=!1,Config.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},Config.fixedFrames=!0,Config.destroyResourceImmediatelyDefault=!0;class Const{}Const.ENUM_TEXTALIGN_DEFAULT=0,Const.ENUM_TEXTALIGN_CENTER=1,Const.ENUM_TEXTALIGN_RIGHT=2,Const.BYTES_PE=4,Const.BYTES_PIDX=2,Const.MAX_CLIP_SIZE=99999999;class NodeFlags{}NodeFlags.NOT_ACTIVE=1,NodeFlags.ACTIVE_INHIERARCHY=2,NodeFlags.AWAKED=4,NodeFlags.NOT_READY=8,NodeFlags.DISPLAY=16,NodeFlags.HAS_ZORDER=32,NodeFlags.HAS_MOUSE=64,NodeFlags.DISPLAYED_INSTAGE=128,NodeFlags.DRAWCALL_OPTIMIZE=256,NodeFlags.PROCESS_COLLISIONS=512,NodeFlags.PROCESS_TRIGGERS=1024,NodeFlags.HAS_SCRIPT=2048,NodeFlags.ESCAPE_DRAWING_TO_TEXTURE=4096,NodeFlags.DISABLE_INNER_CLIPPING=8192,NodeFlags.DISABLE_OUTER_CLIPPING=16384,NodeFlags.DISABLE_VISIBILITY=32768,NodeFlags.EDITING_NODE=65536,NodeFlags.HIDE_BY_EDITOR=131072,NodeFlags.LOCK_BY_EDITOR=262144;class HideFlags{}HideFlags.HideInHierarchy=1,HideFlags.HideInInspector=2,HideFlags.DontSave=4,HideFlags.HideAndDontSave=7;class ILaya{}ILaya.Loader=null,ILaya.Context=null,ILaya.Browser=null,ILaya.Laya=null,ILaya.loader=null,ILaya.timer=null,ILaya.systemTimer=null,ILaya.physicsTimer=null,ILaya.stage=null;class LayaEnv{}LayaEnv.version="3.0.0rc",LayaEnv.isPlaying=!0,LayaEnv.isPreview=!1,LayaEnv.isConch=null!=window.conch;class Pool{static getPoolBySign(e){return Pool._poolDic[e]||(Pool._poolDic[e]=[])}static clearBySign(e){Pool._poolDic[e]&&(Pool._poolDic[e].length=0)}static recover(e,t){!1===t[Pool.POOLSIGN]&&(t[Pool.POOLSIGN]=!0,Pool.getPoolBySign(e).push(t))}static recoverByClass(e){if(e){var t=e.__className||e.constructor._$gid;t&&Pool.recover(t,e)}}static _getClassSign(e){var t=e.__className||e._$gid;return t||(e._$gid=t=Pool._CLSID+"",Pool._CLSID++),t}static createByClass(e){return Pool.getItemByClass(Pool._getClassSign(e),e)}static getItemByClass(e,t){if(!Pool._poolDic[e])return new t;var r=Pool.getPoolBySign(e);if(r.length)var i=r.pop();else i=new t;return i[Pool.POOLSIGN]=!1,i}static getItemByCreateFun(e,t,r=null){var i=Pool.getPoolBySign(e),a=i.length?i.pop():t.call(r);return a[Pool.POOLSIGN]=!1,a}static getItem(e){var t=Pool.getPoolBySign(e),r=t.length?t.pop():null;return r&&(r[Pool.POOLSIGN]=!1),r}}Pool._CLSID=0,Pool.POOLSIGN="__InPool",Pool._poolDic={};var t=1;const r=180/Math.PI,i=Math.PI/180;class Utils{static toRadian(e){return e*i}static toAngle(e){return e*r}static toHexColor(e){if(e<0||isNaN(e))return null;for(var t=e.toString(16);t.length<6;)t="0"+t;return"#"+t}static fromStringColor(e){if(!e)return 0;if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){let t=e.indexOf("("),r=e.indexOf(")");if(-1==t||-1==r)return 0;let i=(e=e.substring(t+1,r)).split(","),a=i.length;for(let e=0;e<a;e++)i[e]=parseFloat(i[e]),isNaN(i[e])&&(i[e]=0);return 4==i.length?(i[0]<<24)+(i[1]<<16)+(i[2]<<8)+Math.round(255*i[3]):(i[0]<<16)+(i[1]<<8)+i[2]}{"#"===e.charAt(0)&&(e=e.substring(1));let t=e.length;if(3===t||4===t){let r="";for(let i=0;i<t;i++)r+=e[i]+e[i];e=r}return parseInt(e,16)}}static getGID(){return t++}static copyArray(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var r=t.length;for(let i=0;i<r;i++)e[i]=t[i];return e}static transPointList(e,t,r){var i,a=e.length;for(i=0;i<a;i+=2)e[i]+=t,e[i+1]+=r}static parseInt(e,t=0){var r=parseInt(e,t);return isNaN(r)?0:r}static getBaseName(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.substring(t+1)),t=e.indexOf("?"),-1!=t&&(e=e.substring(0,t)),e}static getFileExtension(e){let t=e.lastIndexOf(".");if(-1!=t){let r=e.substring(t+1).toLowerCase(),i=r.indexOf("?");if(-1!=i&&(r=r.substring(0,i)),"ls"===r){let i=e.lastIndexOf(".",t-1);if(-1!=i){let a=e.substring(i+1,t+1)+r;if("lanit.ls"===a||"ltcb.ls"===a)return a}}return r}return""}static replaceFileExtension(e,t,r){if(!e)return e;let i=e.lastIndexOf(".");if(t.length>0&&!r&&(t="."+t),-1!=i){let r=e.indexOf("?",i);return-1!=r?e.substring(0,i)+t+e.substring(r):e.substring(0,i)+t}return e+t}}class Component{get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}constructor(){this._hideFlags=0,this._status=0,this._enabled=!0,this._singleton=!0,this._id=Utils.getGID(),this._initialize()}_initialize(){this._extra={}}hasHideFlag(e){return 0!=(this._hideFlags&e)}get id(){return this._id}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this.owner&&this._setActive(e&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(e){if(0!=this._status)throw"reuse a destroyed component";this.owner=e,this._isScript()&&e._setBit(NodeFlags.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(e,t=null){}_parseInteractive(e=null,t=null){}_cloneTo(e){}_setActive(e){var t,r;if(e){if(0==this._status&&(this._status=1,(LayaEnv.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,LayaEnv.isPlaying||this.runInEditor)){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||ILaya.stage._componentDriver).add(this),LayaEnv.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()}}else if(this._enableState&&(this._enableState=!1,LayaEnv.isPlaying||this.runInEditor)){((null===(r=this.owner._is3D&&this.owner._scene)||void 0===r?void 0:r._componentDriver)||ILaya.stage._componentDriver).remove(this),this.owner.offAllCaller(this),ILaya.stage.offAllCaller(this),this._onDisable()}}setupScript(){}destroy(){4!=this._status&&this.owner&&this.owner._destroyComponent(this)}_destroy(e){var t;if(e)return this._onDestroy(),this.onDestroy(),void(this.onReset&&(this.onReset(),this._resetComp(),Pool.recoverByClass(this)));this._setActive(!1),this._status=4,((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||ILaya.stage._componentDriver)._toDestroys.add(this)}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}class Matrix{constructor(e=1,t=0,r=0,i=1,a=0,s=0,n=0){if(this._bTransform=!1,null!=Matrix._createFun)return Matrix._createFun(e,t,r,i,a,s,n);this.a=e,this.b=t,this.c=r,this.d=i,this.tx=a,this.ty=s,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(e,t){return this.tx=e,this.ty=t,this}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}rotate(e){var t=Math.cos(e),r=Math.sin(e),i=this.a,a=this.c,s=this.tx;return this.a=i*t-this.b*r,this.b=i*r+this.b*t,this.c=a*t-this.d*r,this.d=a*r+this.d*t,this.tx=s*t-this.ty*r,this.ty=s*r+this.ty*t,this._bTransform=!0,this}skew(e,t){var r=Math.tan(e),i=Math.tan(t),a=this.a,s=this.b;return this.a+=i*this.c,this.b+=i*this.d,this.c+=r*a,this.d+=r*s,this}invertTransformPoint(e){var t=this.a,r=this.b,i=this.c,a=this.d,s=this.tx,n=t*a-r*i,o=a/n,l=-r/n,h=-i/n,u=t/n,d=(i*this.ty-a*s)/n,_=-(t*this.ty-r*s)/n;return e.setTo(o*e.x+h*e.y+d,l*e.x+u*e.y+_)}transformPoint(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}transformPointN(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var e=this.a,t=this.b,r=this.c,i=this.d,a=this.tx,s=e*i-t*r;return this.a=i/s,this.b=-t/s,this.c=-r/s,this.d=e/s,this.tx=(r*this.ty-i*a)/s,this.ty=-(e*this.ty-t*a)/s,this}setTo(e,t,r,i,a,s){return this.a=e,this.b=t,this.c=r,this.d=i,this.tx=a,this.ty=s,this}concat(e){var t=this.a,r=this.c,i=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=r*e.a+this.d*e.c,this.d=r*e.b+this.d*e.d,this.tx=i*e.a+this.ty*e.c+e.tx,this.ty=i*e.b+this.ty*e.d+e.ty,this}static mul(e,t,r){var i=e.a,a=e.b,s=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,u=t.b,d=t.c,_=t.d,c=t.tx,m=t.ty;return 0!==u||0!==d?(r.a=i*h+a*d,r.b=i*u+a*_,r.c=s*h+n*d,r.d=s*u+n*_,r.tx=h*o+d*l+c,r.ty=u*o+_*l+m):(r.a=i*h,r.b=a*_,r.c=s*h,r.d=n*_,r.tx=h*o+c,r.ty=_*l+m),r}static mul16(e,t,r){var i=e.a,a=e.b,s=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,u=t.b,d=t.c,_=t.d,c=t.tx,m=t.ty;return 0!==u||0!==d?(r[0]=i*h+a*d,r[1]=i*u+a*_,r[4]=s*h+n*d,r[5]=s*u+n*_,r[12]=h*o+d*l+c,r[13]=u*o+_*l+m):(r[0]=i*h,r[1]=a*_,r[4]=s*h,r[5]=n*_,r[12]=h*o+c,r[13]=_*l+m),r}scaleEx(e,t){var r=this.a,i=this.b,a=this.c,s=this.d;0!==i||0!==a?(this.a=e*r,this.b=e*i,this.c=t*a,this.d=t*s):(this.a=e*r,this.b=0*s,this.c=0*r,this.d=t*s),this._bTransform=!0}rotateEx(e){var t=Math.cos(e),r=Math.sin(e),i=this.a,a=this.b,s=this.c,n=this.d;0!==a||0!==s?(this.a=t*i+r*s,this.b=t*a+r*n,this.c=-r*i+t*s,this.d=-r*a+t*n):(this.a=t*i,this.b=r*n,this.c=-r*i,this.d=t*n),this._bTransform=!0}clone(){var e=Matrix.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){Pool.recover("Matrix",this.identity())}static create(){return Pool.getItemByClass("Matrix",Matrix)}}Matrix.EMPTY=new Matrix,Matrix.TEMP=new Matrix,Matrix._createFun=null;class Point{constructor(e=0,t=0){this.x=e,this.y=t}static create(){return Pool.getItemByClass("Point",Point)}setTo(e,t){return this.x=e,this.y=t,this}reset(){return this.x=this.y=0,this}recover(){Pool.recover("Point",this.reset())}distance(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}toString(){return this.x+","+this.y}normalize(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}copy(e){return this.setTo(e.x,e.y)}}Point.TEMP=new Point,Point.EMPTY=new Point;class Rectangle{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.width=r,this.height=i}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(e,t,r,i){return this.x=e,this.y=t,this.width=r,this.height=i,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=Rectangle.TEMP&&this!=Rectangle.EMPTY&&Pool.recover("Rectangle",this.reset())}static create(){return Pool.getItemByClass("Rectangle",Rectangle)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}contains(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}intersects(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}intersection(e,t=null){return this.intersects(e)?(t||(t=new Rectangle),t.x=Math.max(this.x,e.x),t.y=Math.max(this.y,e.y),t.width=Math.min(this.right,e.right)-t.x,t.height=Math.min(this.bottom,e.bottom)-t.y,t):null}union(e,t=null){return t||(t=new Rectangle),this.clone(t),e.width<=0||e.height<=0?t:(t.addPoint(e.x,e.y),t.addPoint(e.right,e.bottom),this)}clone(e=null){return e||(e=new Rectangle),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}addPoint(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}_getBoundPoints(){var e=Rectangle._temB;return e.length=0,0==this.width||0==this.height||e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e}static _getBoundPointS(e,t,r,i,a){var s=Rectangle._temA;return s.length=0,0==r||0==i||(a&&(e*=a.width,t*=a.height,r*=a.width,i*=a.height),s.push(e,t,e+r,t,e,t+i,e+r,t+i)),s}static _getWrapRec(e,t=null){if(!e||e.length<1)return t?t.setTo(0,0,0,0):Rectangle.TEMP.setTo(0,0,0,0);t=t||Rectangle.create();var r,i,a,s,n,o=e.length,l=Point.TEMP;for(a=n=-(i=s=99999),r=0;r<o;r+=2)l.x=e[r],l.y=e[r+1],i=i<l.x?i:l.x,s=s<l.y?s:l.y,a=a>l.x?a:l.x,n=n>l.y?n:l.y;return t.setTo(i,s,a-i,n-s)}isEmpty(){return this.width<=0||this.height<=0}}Rectangle.EMPTY=new Rectangle,Rectangle.TEMP=new Rectangle,Rectangle._temB=[],Rectangle._temA=[];class LayaGL{}var a,s;e.HDREncodeFormat=void 0,(a=e.HDREncodeFormat||(e.HDREncodeFormat={}))[a.NONE=0]="NONE",a[a.RGBM=1]="RGBM",a[a.RGBD=2]="RGBD",e.TextureFormat=void 0,(s=e.TextureFormat||(e.TextureFormat={}))[s.R8G8B8=0]="R8G8B8",s[s.R8G8B8A8=1]="R8G8B8A8",s[s.R5G6B5=16]="R5G6B5",s[s.Alpha8=2]="Alpha8",s[s.DXT1=3]="DXT1",s[s.DXT3=29]="DXT3",s[s.DXT5=4]="DXT5",s[s.ETC1RGB=5]="ETC1RGB",s[s.ETC2RGB=6]="ETC2RGB",s[s.ETC2RGBA=7]="ETC2RGBA",s[s.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",s[s.ETC2SRGB=28]="ETC2SRGB",s[s.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",s[s.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",s[s.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",s[s.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",s[s.R32G32B32A32=15]="R32G32B32A32",s[s.R32G32B32=30]="R32G32B32",s[s.R16G16B16A16=17]="R16G16B16A16",s[s.R16G16B16=31]="R16G16B16",s[s.ASTC4x4=18]="ASTC4x4",s[s.ASTC4x4SRGB=23]="ASTC4x4SRGB",s[s.ASTC6x6=19]="ASTC6x6",s[s.ASTC6x6SRGB=24]="ASTC6x6SRGB",s[s.ASTC8x8=20]="ASTC8x8",s[s.ASTC8x8SRGB=25]="ASTC8x8SRGB",s[s.ASTC10x10=21]="ASTC10x10",s[s.ASTC10x10SRGB=26]="ASTC10x10SRGB",s[s.ASTC12x12=22]="ASTC12x12",s[s.ASTC12x12SRGB=27]="ASTC12x12SRGB",s[s.KTXTEXTURE=-1]="KTXTEXTURE",s[s.PVRTEXTURE=-2]="PVRTEXTURE";class Delegate{constructor(){this._flag=0,this._items=[]}add(e,t,r){let i=this._items,a=i.findIndex(((r,i,a)=>r==e&&a[i+1]==t));-1!=a?(i[a+2]=r,i[a+3]=1):i.push(e,t,r,1)}once(e,t,r){let i=this._items,a=i.findIndex(((r,i,a)=>r==e&&a[i+1]==t));-1!=a?(i[a+2]=r,i[a+3]=2):i.push(e,t,r,2)}remove(e,t){let r=this._items,i=r.findIndex(((r,i,a)=>r==e&&a[i+1]==t));-1!=i&&(0!=this._flag?(r[i+3]=0,this._flag=2):r.splice(i,4))}clear(){let e=this._items;0!=this._flag?(e.forEach(((e,t,r)=>{t%4==3&&(r[t]=0)})),this._flag=2):e.length=0}clearForTarget(e){if(!e)return;let t=this._items;if(0!=this._flag)t.forEach(((t,r,i)=>{r%4==1&&i[r]==e&&(i[r+2]=0)})),this._flag=2;else{let r=t.length-4;for(;r>=0;)t[r+1]==e&&t.splice(r,4),r-=4}}get count(){return this._items.length/4}invoke(...e){if(0!=this._flag)return;this._flag=1;let t=this._items,r=t.length;for(let i=0;i<r;i+=4){if(0==t[i+3])continue;let r=t[i+2];null!=r?t[i].call(t[i+1],...r,...e):t[i].call(t[i+1],...e),2==t[i+3]&&(t[i+3]=0,this._flag=2)}if(2==this._flag){let e=t.length,r=0;for(;r<e;)0!=t[r+3]?r+=4:(t.splice(r,4),e-=4)}this._flag=0}}class Event{static isMouseEvent(e){return n.has(e)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new Point}setTo(e,t,r){return this.type=e,this.currentTarget=t,this.target=r,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get altKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.altKey}get ctrlKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.ctrlKey}get shiftKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.shiftKey}get metaKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}Event.EMPTY=new Event,Event.MOUSE_DOWN="mousedown",Event.MOUSE_UP="mouseup",Event.RIGHT_MOUSE_DOWN="rightmousedown",Event.RIGHT_MOUSE_UP="rightmouseup",Event.CLICK="click",Event.RIGHT_CLICK="rightclick",Event.MOUSE_MOVE="mousemove",Event.MOUSE_OVER="mouseover",Event.MOUSE_OUT="mouseout",Event.MOUSE_WHEEL="mousewheel",Event.ROLL_OVER="mouseover",Event.ROLL_OUT="mouseout",Event.DOUBLE_CLICK="doubleclick",Event.MOUSE_DRAG="mousedrag",Event.MOUSE_DRAG_END="mousedragend",Event.DRAG_START="dragstart",Event.DRAG_MOVE="dragmove",Event.DRAG_END="dragend",Event.KEY_DOWN="keydown",Event.KEY_PRESS="keypress",Event.KEY_UP="keyup",Event.CHANGE="change",Event.CHANGED="changed",Event.WILL_RESIZE="willResize",Event.RESIZE="resize",Event.ADDED="added",Event.REMOVED="removed",Event.DISPLAY="display",Event.UNDISPLAY="undisplay",Event.ERROR="error",Event.COMPLETE="complete",Event.LOADED="loaded",Event.READY="ready",Event.PROGRESS="progress",Event.INPUT="input",Event.RENDER="render",Event.OPEN="open",Event.MESSAGE="message",Event.CLOSE="close",Event.FRAME="enterframe",Event.ENTER="enter",Event.SELECT="select",Event.BLUR="blur",Event.FOCUS="focus",Event.VISIBILITY_CHANGE="visibilitychange",Event.FOCUS_CHANGE="focuschange",Event.PLAYED="played",Event.PAUSED="paused",Event.STOPPED="stopped",Event.START="start",Event.END="end",Event.LINK="link",Event.LABEL="label",Event.FULL_SCREEN_CHANGE="fullscreenchange",Event.DEVICE_LOST="devicelost",Event.TRANSFORM_CHANGED="transformchanged",Event.LAYERCHANGE="layerChange",Event.staticMask="staticMask",Event.TRIGGER_ENTER="triggerenter",Event.TRIGGER_STAY="triggerstay",Event.TRIGGER_EXIT="triggerexit",Event.COLLISION_ENTER="collisionenter",Event.COLLISION_STAY="collisionstay",Event.COLLISION_EXIT="collisionexit",Event.JOINT_BREAK="jointbreak";const n=new Set([Event.MOUSE_DOWN,Event.MOUSE_UP,Event.MOUSE_MOVE,Event.CLICK,Event.DOUBLE_CLICK,Event.RIGHT_CLICK,Event.RIGHT_MOUSE_DOWN,Event.RIGHT_MOUSE_UP,Event.MOUSE_OVER,Event.MOUSE_OUT,Event.MOUSE_WHEEL]),o=[];class EventDispatcher{onStartListeningToType(e){}hasListener(e){let t=this._events&&this._events[e];return!!t&&t.count>0}event(e,t){let r=this._events&&this._events[e];if(!r)return!1;let i=r.count>0;if(Array.isArray(t))r.invoke(...t);else if(void 0!==t)r.invoke(t);else if(t===Event.EMPTY){let t=o.length>0?o.pop():new Event;r.invoke(t.setTo(e,this,this)),t.target=t.currentTarget=null,o.push(t)}else r.invoke();return i}on(e,t,r,i){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let a=this._events[e];return a||(this.onStartListeningToType(e),this._events[e]=a=new Delegate),a.add(r,t,i),this}once(e,t,r,i){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let a=this._events[e];return a||(this.onStartListeningToType(e),this._events[e]=a=new Delegate),a.once(r,t,i),this}off(e,t,r){2==arguments.length&&(r=t,t=null);let i=this._events&&this._events[e];return i&&i.remove(r,t),this}offAll(e){if(null==e)this._events=null;else{let t=this._events&&this._events[e];t&&t.clear()}return this}offAllCaller(e){if(e&&this._events)for(let t in this._events)this._events[t].clearForTarget(e);return this}}var l,h,u=0,d=0,_=0;class Resource extends EventDispatcher{static get cpuMemory(){return Resource._cpuMemory}static get gpuMemory(){return Resource._gpuMemory}static _addCPUMemory(e){Resource._cpuMemory+=e}static _addGPUMemory(e){Resource._gpuMemory+=e}static _addMemory(e,t){Resource._cpuMemory+=e,Resource._gpuMemory+=t}static destroyUnusedResources(){d=0,_=0,ILaya.loader.loading?ILaya.timer.frameLoop(1,Resource,Resource._destroyUnusedResources):Resource._destroyUnusedResources(!0)}static _destroyUnusedResources(e){if(!e&&ILaya.loader.loading)return;ILaya.timer.clear(Resource,Resource._destroyUnusedResources);let t=0;for(let e in Resource._idResourcesMap){let r=Resource._idResourcesMap[e];r.lock||0!==r._referenceCount||(r.destroy(),t++)}Resource.DEBUG&&t>0&&console.debug(`destroyUnusedResources(${t})`),t>0&&_<5&&(_++,ILaya.timer.frameLoop(1,Resource,Resource._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute=e}get referenceCount(){return this._referenceCount}constructor(e){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++u,this._destroyed=!1,this._referenceCount=0,(null==e||e)&&(Resource._idResourcesMap[this.id]=this),this.lock=!1,this.destroyedImmediately=!0}_setCPUMemory(e){var t=e-this._cpuMemory;this._cpuMemory=e,Resource._addCPUMemory(t)}_setGPUMemory(e){var t=e-this._gpuMemory;this._gpuMemory=e,Resource._addGPUMemory(t)}_setCreateURL(e,t){this.url=e,this.uuid=t}isCreateFromURL(e){return this.uuid&&e.length===this.uuid.length+6&&e.endsWith(this.uuid)||this.url===e}_addReference(e=1){this._referenceCount+=e}_removeReference(e=1){this._referenceCount-=e,d>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}_recoverResource(){}_disposeResource(){}_activeResource(){}destroy(){this._destroyed||(this._destroyed=!0,this.lock=!1,d++,this._disposeResource(),d--,this.offAll(),delete Resource._idResourcesMap[this.id],this.url&&(Resource.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),ILaya.loader.clearRes(this.url,this)))}}Resource._idResourcesMap={},Resource._cpuMemory=0,Resource._gpuMemory=0,Resource.DEBUG=!1;class BaseTexture extends Resource{get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(e){this._texture.anisoLevel=e}get filterMode(){return this._texture.filterMode}set filterMode(e){this._texture.filterMode=e}get wrapModeU(){return this._texture.wrapU}set wrapModeU(e){this._texture.wrapU=e}get wrapModeV(){return this._texture.wrapV}set wrapModeV(e){this._texture.wrapV=e}get wrapModeW(){return this._texture.wrapW}set wrapModeW(e){this._texture.wrapW=e}get compareMode(){return this._texture.compareMode}set compareMode(e){this._texture.compareMode=LayaGL.textureContext.setTextureCompareMode(this._texture,e)}get gammaCorrection(){return this._texture.gammaCorrection}set baseMipmapLevel(e){this._texture.baseMipmapLevel=e}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set maxMipmapLevel(e){this._texture.maxMipmapLevel=e}get maxMipmapLevel(){return this._texture.maxMipmapLevel}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(t,r,i){super(),this._gammaSpace=!1,this._width=t,this._height=r,this._format=i,this.destroyedImmediately=Config.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=e.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:case e.TextureFormat.R16G16B16:case e.TextureFormat.R16G16B16A16:case e.TextureFormat.R32G32B32:case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return!1;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R16G16B16A16:return 2;case e.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}class Byte{static getSystemEndian(){if(!Byte._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),Byte._sysEndian=256===new Int16Array(e)[0]?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}return Byte._sysEndian}constructor(e=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}get endian(){return this._xd_?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}set endian(e){this._xd_=e===Byte.LITTLE_ENDIAN}set length(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e}get length(){return this._length}_resizeBuffer(e){try{var t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw"Invalid typed array length:"+e}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(e,t){return this.readFloat32Array(e,t)}readFloat32Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Float32Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getUint8Array(e,t){return this.readUint8Array(e,t)}readUint8Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Uint8Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getInt16Array(e,t){return this.readInt16Array(e,t)}readInt16Array(e,t){var r=e+t;r=r>this._length?this._length:r;var i=new Int16Array(this._d_.buffer.slice(e,r));return this._pos_=r,i}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}writeFloat32(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}writeFloat64(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}writeInt32(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}writeUint32(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}writeUint16(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}writeInt16(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++]}writeUint8(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}_getUInt8(e){return this._readUInt8(e)}_readUInt8(e){return this._d_.getUint8(e)}_getUint16(e){return this._readUint16(e)}_readUint16(e){return this._d_.getUint16(e,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new Matrix(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(e){var t,r,i=this._pos_+e,a=String.fromCharCode,s=this._u8d_,n=[],o=0;for(n.length=1e3;this._pos_<i;)if((t=s[this._pos_++])<128)0!=t&&(n[o++]=a(t));else if(t<224)n[o++]=a((63&t)<<6|127&s[this._pos_++]);else if(t<240)r=s[this._pos_++],n[o++]=a((31&t)<<12|(127&r)<<6|127&s[this._pos_++]);else{const e=(15&t)<<18|(127&(r=s[this._pos_++]))<<12|(127&s[this._pos_++])<<6|127&s[this._pos_++];if(e>=65536){const t=e-65536,r=55296|t>>10,i=56320|1023&t;n[o++]=a(r),n[o++]=a(i)}else n[o++]=a(e)}return n.length=o,n.join("")}getCustomString(e){return this.readCustomString(e)}readCustomString(e){for(var t,r="",i=0,a=String.fromCharCode,s=this._u8d_;e>0;)if((t=s[this._pos_])<128)r+=a(t),this._pos_++,e--;else for(i=t-128,this._pos_++,e-=i;i>0;)t=s[this._pos_++],r+=a(s[this._pos_++]<<8|t),i--;return r}get pos(){return this._pos_}set pos(e){this._pos_=e}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(e){for(var t=0,r=(e+="").length;t<r;t++){var i=e.charCodeAt(t);if(i<=127)this.writeByte(i);else if(i<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|i>>6,128|63&i],this._pos_),this._pos_+=2;else if(i>=55296&&i<=56319){t++;const r=e.charCodeAt(t);if(!Number.isNaN(r)&&r>=56320&&r<=57343){const e=64+(1023&i),t=1023&r,a=240|e>>8&63,s=128|e>>2&63,n=128|(3&e)<<4|t>>6&15,o=128|63&t;this._ensureWrite(this._pos_+4),this._u8d_.set([a,s,n,o],this._pos_),this._pos_+=4}}else i<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|i>>12,128|i>>6&63,128|63&i],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|i>>18,128|i>>12&63,128|i>>6&63,128|63&i],this._pos_),this._pos_+=4)}}writeUTFString(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var r=this.pos-t-2;this._d_.setUint16(t,r,this._xd_)}writeUTFString32(e){var t=this.pos;this.writeUint32(1),this.writeUTFBytes(e);var r=this.pos-t-4;this._d_.setUint32(t,r,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(e=-1){if(0===e)return"";var t=this.bytesAvailable;if(e>t)throw"readUTFBytes error - Out of bounds";return e=e>0?e:t,this._rUTF(e)}getUTFBytes(e=-1){return this.readUTFBytes(e)}writeByte(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}writeArrayBuffer(e,t=0,r=0){if(t<0||r<0)throw"writeArrayBuffer error - Out of bounds";0==r&&(r=e.byteLength-t),this._ensureWrite(this._pos_+r);var i=new Uint8Array(e);this._u8d_.set(i.subarray(t,t+r),this._pos_),this._pos_+=r}readArrayBuffer(e){var t;return t=this._u8d_.buffer.slice(this._pos_,this._pos_+e),this._pos_=this._pos_+e,t}}Byte.BIG_ENDIAN="bigEndian",Byte.LITTLE_ENDIAN="littleEndian",Byte._sysEndian=null;class HalfFloatUtils{static __init__(){for(var e=0;e<256;++e){var t=e-127;t<-27?(HalfFloatUtils._baseTable[0|e]=0,HalfFloatUtils._baseTable[256|e]=32768,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):t<-14?(HalfFloatUtils._baseTable[0|e]=1024>>-t-14,HalfFloatUtils._baseTable[256|e]=1024>>-t-14|32768,HalfFloatUtils._shiftTable[0|e]=-t-1,HalfFloatUtils._shiftTable[256|e]=-t-1):t<=15?(HalfFloatUtils._baseTable[0|e]=t+15<<10,HalfFloatUtils._baseTable[256|e]=t+15<<10|32768,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13):t<128?(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13)}for(HalfFloatUtils._mantissaTable[0]=0,e=1;e<1024;++e){var r=e<<13;for(t=0;0==(8388608&r);)t-=8388608,r<<=1;r&=-8388609,t+=947912704,HalfFloatUtils._mantissaTable[e]=r|t}for(e=1024;e<2048;++e)HalfFloatUtils._mantissaTable[e]=939524096+(e-1024<<13);for(HalfFloatUtils._exponentTable[0]=0,e=1;e<31;++e)HalfFloatUtils._exponentTable[e]=e<<23;for(HalfFloatUtils._exponentTable[31]=1199570944,HalfFloatUtils._exponentTable[32]=2147483648,e=33;e<63;++e)HalfFloatUtils._exponentTable[e]=2147483648+(e-32<<23);for(HalfFloatUtils._exponentTable[63]=3347054592,HalfFloatUtils._offsetTable[0]=0,e=1;e<64;++e)HalfFloatUtils._offsetTable[e]=32===e?0:1024}static roundToFloat16Bits(e){HalfFloatUtils._floatView[0]=e;var t=HalfFloatUtils._uint32View[0],r=t>>23&511;return HalfFloatUtils._baseTable[r]+((8388607&t)>>HalfFloatUtils._shiftTable[r])}static convertToNumber(e){var t=e>>10;return HalfFloatUtils._uint32View[0]=HalfFloatUtils._mantissaTable[HalfFloatUtils._offsetTable[t]+(1023&e)]+HalfFloatUtils._exponentTable[t],HalfFloatUtils._floatView[0]}}HalfFloatUtils._buffer=new ArrayBuffer(4),HalfFloatUtils._floatView=new Float32Array(HalfFloatUtils._buffer),HalfFloatUtils._uint32View=new Uint32Array(HalfFloatUtils._buffer),HalfFloatUtils._baseTable=new Uint32Array(512),HalfFloatUtils._shiftTable=new Uint32Array(512),HalfFloatUtils._mantissaTable=new Uint32Array(2048),HalfFloatUtils._exponentTable=new Uint32Array(64),HalfFloatUtils._offsetTable=new Uint32Array(64),e.FilterMode=void 0,(l=e.FilterMode||(e.FilterMode={}))[l.Point=0]="Point",l[l.Bilinear=1]="Bilinear",l[l.Trilinear=2]="Trilinear",e.RenderCapable=void 0,(h=e.RenderCapable||(e.RenderCapable={}))[h.Element_Index_Uint32=0]="Element_Index_Uint32",h[h.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",h[h.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",h[h.Texture_anisotropic=3]="Texture_anisotropic",h[h.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",h[h.RenderTextureFormat_Depth=5]="RenderTextureFormat_Depth",h[h.RenderTextureFormat_ShadowMap=6]="RenderTextureFormat_ShadowMap",h[h.Vertex_VAO=7]="Vertex_VAO",h[h.DrawElement_Instance=8]="DrawElement_Instance",h[h.Shader_TextureLod=9]="Shader_TextureLod",h[h.COMPRESS_TEXTURE_S3TC=10]="COMPRESS_TEXTURE_S3TC",h[h.COMPRESS_TEXTURE_S3TC_SRGB=11]="COMPRESS_TEXTURE_S3TC_SRGB",h[h.COMPRESS_TEXTURE_PVRTC=12]="COMPRESS_TEXTURE_PVRTC",h[h.COMPRESS_TEXTURE_ETC1=13]="COMPRESS_TEXTURE_ETC1",h[h.COMPRESS_TEXTURE_ETC=14]="COMPRESS_TEXTURE_ETC",h[h.COMPRESS_TEXTURE_ASTC=15]="COMPRESS_TEXTURE_ASTC",h[h.Texture_SRGB=16]="Texture_SRGB",h[h.MSAA=17]="MSAA",h[h.UnifromBufferObject=18]="UnifromBufferObject",h[h.GRAPHICS_API_GLES3=19]="GRAPHICS_API_GLES3",h[h.Texture3D=20]="Texture3D",h[h.Texture_FloatLinearFiltering=21]="Texture_FloatLinearFiltering",h[h.Texture_HalfFloatLinearFiltering=22]="Texture_HalfFloatLinearFiltering";const c=827611204,m=861165636,p=894720068,f=131072;class DDSTextureInfo{constructor(e,t,r,i,a,s,n,o,l,h){this.width=e,this.height=t,this.mipmapCount=r,this.isCube=i,this.blockBytes=s,this.dataOffset=n,this.format=o,this.source=h,this.bpp=a,this.compressed=l}static getDDSTextureInfo(t){let r=new Int32Array(t,0,31),i=r[4],a=r[3],s=1;131072&r[2]&&(s=Math.max(1,r[7]));let n=r[21],o=4==(4&r[20]),l=64==(64&r[20]),h=(r[20]&f)===f,u=512==(512&r[28]),d=n===c||n===m||n===p,_=e.TextureFormat.DXT1,g=r[1]+4,T=1;switch(n){case c:_=e.TextureFormat.DXT1,T=8;break;case m:_=e.TextureFormat.DXT3,T=16;break;case p:_=e.TextureFormat.DXT5,T=16;break;case 113:_=e.TextureFormat.R16G16B16A16,T=4;break;case 116:_=e.TextureFormat.R32G32B32A32,T=4;break;default:throw"Unsupported format "+(x=n,String.fromCharCode(255&x,x>>8&255,x>>16&255,x>>24&255))}var x;if(542327876!==r[0])throw"Invalid magic number in DDS header";if(!o&&!l&&!h)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let S=LayaGL.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC)||LayaGL.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(d&&!S)throw"Compressed textures are not supported on this platform.";return new DDSTextureInfo(i,a,s,u,0,T,g,_,d,t)}}var g;e.TextureDimension=void 0,(g=e.TextureDimension||(e.TextureDimension={}))[g.Tex2D=0]="Tex2D",g[g.Cube=1]="Cube",g[g.Tex3D=2]="Tex3D",g[g.Texture2DArray=3]="Texture2DArray",g[g.CubeArray=4]="CubeArray",g[g.Unkonw=5]="Unkonw",g[g.None=6]="None";const T=6408,x=6407,S=5121;class KTXTextureInfo{static getLayaFormat(t,r,i,a){if(0!=t){if(t==T&&32856==r&&i==S)return{format:e.TextureFormat.R8G8B8A8,sRGB:!1};if(t==T&&35907==r&&i==S)return{format:e.TextureFormat.R8G8B8A8,sRGB:!0};if(t==T&&34836==r&&5126==i)return{format:e.TextureFormat.R32G32B32A32,sRGB:!1};if(t==T&&34842==r&&5131==i)return{format:e.TextureFormat.R16G16B16A16,sRGB:!1};if(t==x&&34837==r&&5126==i)return{format:e.TextureFormat.R32G32B32,sRGB:!1};if(t==x&&34843==r&&5131==i)return{format:e.TextureFormat.R16G16B16,sRGB:!1};if(t==x&&35905==r&&i==S)return{format:e.TextureFormat.R8G8B8,sRGB:!0};if(t==x&&32849==r&&i==S)return{format:e.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(r){case 36196:return{format:e.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:e.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:e.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:e.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:e.TextureFormat.ETC2SRGB,sRGB:!0};case 37808:return{format:e.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:e.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:e.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:e.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:e.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:e.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:e.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:e.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:e.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:e.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(e){let t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])throw"ktx2 !";if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return KTXTextureInfo.createKTX1Info(e);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(t){let r=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(t,12,13*r),a=67305985==i.getUint32(0,!0),s=i.getUint32(1*r,a),n=i.getUint32(2*r,a),o=i.getUint32(3*r,a),l=i.getUint32(4*r,a);i.getUint32(5*r,a);let h=i.getUint32(6*r,a),u=i.getUint32(7*r,a);i.getUint32(8*r,a);let d=i.getUint32(9*r,a),_=i.getUint32(10*r,a),c=i.getUint32(11*r,a),m=i.getUint32(12*r,a),p=KTXTextureInfo.getLayaFormat(o,l,s,n),f=p.format,g=p.sRGB,T=e.TextureDimension.Tex2D;_>1&&d>1?T=e.TextureDimension.CubeArray:_>1&&d<=1?T=e.TextureDimension.Cube:_<=1&&d>1&&(T=e.TextureDimension.Texture2DArray);return new KTXTextureInfo(t,0==o,g,T,h,u,f,c||1,m,64)}constructor(e,t,r,i,a,s,n,o,l,h){this.source=e,this.compress=t,this.sRGB=r,this.dimension=i,this.width=a,this.height=s,this.format=n,this.mipmapCount=o,this.bytesOfKeyValueData=l,this.headerOffset=h}}class Texture2D extends BaseTexture{static __init__(){var t=new Uint8Array(3);if(t[0]=128,t[1]=128,t[2]=128,Texture2D.grayTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1),Texture2D.grayTexture.setPixelsData(t,!1,!1),Texture2D.grayTexture.lock=!0,Texture2D.grayTexture.name="Default_Gray",t[0]=255,t[1]=255,t[2]=255,Texture2D.whiteTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1),Texture2D.whiteTexture.setPixelsData(t,!1,!1),Texture2D.whiteTexture.lock=!0,Texture2D.whiteTexture.name="Default_White",t[0]=0,t[1]=0,t[2]=0,Texture2D.blackTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1),Texture2D.blackTexture.setPixelsData(t,!1,!1),Texture2D.blackTexture.lock=!0,Texture2D.blackTexture.name="Default_Black",LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16)){let t=new Uint16Array(3);t[0]=14336,t[1]=14336,t[2]=15360,Texture2D.normalTexture=new Texture2D(1,1,e.TextureFormat.R16G16B16,!1,!1,!1),Texture2D.normalTexture.setPixelsData(t,!1,!1)}else t[0]=128,t[1]=128,t[2]=255,Texture2D.normalTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8,!1,!1,!1),Texture2D.normalTexture.setPixelsData(t,!1,!1);Texture2D.normalTexture.lock=!0,Texture2D.normalTexture.name="Default_Normal",(t=new Uint8Array(9))[0]=255,t[1]=255,t[2]=255,t[3]=255,t[4]=255,t[5]=128,t[6]=128,t[7]=128,t[8]=0,Texture2D.defalutUITexture=new Texture2D(1,3,e.TextureFormat.R8G8B8,!1,!1),Texture2D.defalutUITexture.setPixelsData(t,!1,!1),Texture2D.defalutUITexture.lock=!0,Texture2D.errorTexture=Texture2D.whiteTexture}static _SimpleAnimatorTextureParse(t,r=null,i=null){var a,s,n=new Byte(t);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,l=n.readInt32(),h=n.readInt32();a=new Float32Array(l*l*4),s=new Float32Array(n.readArrayBuffer(4*h)),a.set(s,0),(o=new Texture2D(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(a,!1,!1),o.filterMode=e.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":l=n.readInt32(),h=n.readInt32();if(a=new Uint16Array(n.readArrayBuffer(2*h)),LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16))(s=new Uint16Array(l*l*4)).set(a,0),(o=new Texture2D(l,l,e.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),s=new Float32Array(l*l*4);for(var u=0,d=a.length;u<d;u++)s[u]=HalfFloatUtils.convertToNumber(a[u]);(o=new Texture2D(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(t,r=null,i=null){let a=i?i[2]:e.TextureFormat.R8G8B8A8,s=!i||i[3],n=!!i&&i[4],o=!!i&&i[5],l=new Texture2D(t.width,t.height,a,s,n,o);if(r){let e=r.premultiplyAlpha;l.setImageData(t,e,!1),l.setProperties(r)}else l.setImageData(t,!1,!1);return n&&(LayaEnv.isConch&&t._nativeObj?l._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,t.width,t.height)):(ILaya.Browser.canvas.size(t.width,t.height),ILaya.Browser.canvas.clear(),ILaya.Browser.context.drawImage(t,0,0,t.width,t.height),l._pixels=new Uint8Array(ILaya.Browser.context.getImageData(0,0,t.width,t.height).data.buffer))),l}static _parseDDS(e,t=null,r=null){let i=DDSTextureInfo.getDDSTextureInfo(e),a=new Texture2D(i.width,i.height,i.format,i.mipmapCount>1,!1,!1);return a.setDDSData(i),t&&a.setProperties(t),a}static _parseKTX(e,t=null,r=null){let i=KTXTextureInfo.getKTXTextureInfo(e),a=new Texture2D(i.width,i.height,i.format,i.mipmapCount>1,!1,i.sRGB);return a.setKTXData(i),t&&a.setProperties(t),a}static _parsePVR(e,t=null,r=null){throw"pvr !"}static load(e,t){ILaya.loader.load(e,t,null,ILaya.Loader.TEXTURE2D)}constructor(t,r,i,a=!0,s,n=!1){super(t,r,i),this._canRead=!1,this._dimension=e.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=s,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,r,i,a,n)}setImageData(e,t,r){let i=this._texture;LayaGL.textureContext.setTextureImageData(i,e,t,r)}setPixelsData(e,t,r){let i=this._texture;LayaGL.textureContext.setTexturePixelsData(i,e,t,r)}setSubPixelsData(e,t,r,i,a,s,n,o,l){let h=this._texture;LayaGL.textureContext.setTextureSubPixelsData(h,a,s,n,e,t,r,i,o,l)}setDDSData(e){let t=this._texture;LayaGL.textureContext.setTextureDDSData(t,e)}setKTXData(e){let t=this._texture;LayaGL.textureContext.setTextureKTXData(t,e)}setHDRData(e){let t=this._texture;LayaGL.textureContext.setTextureHDRData(t,e)}get defaultTexture(){return Texture2D.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(e){e&&(null!=e.wrapModeU&&(this.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(this.wrapModeV=e.wrapModeV),null!=e.filterMode&&(this.filterMode=e.filterMode),null!=e.anisoLevel&&(this.anisoLevel=e.anisoLevel))}}Texture2D.TEXTURE2D="TEXTURE2D",Texture2D.grayTexture=null,Texture2D.whiteTexture=null,Texture2D.blackTexture=null,Texture2D.normalTexture=null,Texture2D.errorTexture=null,Texture2D.defalutUITexture=null;class BaseShader extends Resource{constructor(){super()}}class RenderState2D{static mat2MatArray(e,t){var r=e,i=t;return i[0]=r.a,i[1]=r.b,i[2]=RenderState2D.EMPTYMAT4_ARRAY[2],i[3]=RenderState2D.EMPTYMAT4_ARRAY[3],i[4]=r.c,i[5]=r.d,i[6]=RenderState2D.EMPTYMAT4_ARRAY[6],i[7]=RenderState2D.EMPTYMAT4_ARRAY[7],i[8]=RenderState2D.EMPTYMAT4_ARRAY[8],i[9]=RenderState2D.EMPTYMAT4_ARRAY[9],i[10]=RenderState2D.EMPTYMAT4_ARRAY[10],i[11]=RenderState2D.EMPTYMAT4_ARRAY[11],i[12]=r.tx,i[13]=r.ty,i[14]=RenderState2D.EMPTYMAT4_ARRAY[14],i[15]=RenderState2D.EMPTYMAT4_ARRAY[15],t}static restoreTempArray(){RenderState2D.TEMPMAT4_ARRAY[0]=1,RenderState2D.TEMPMAT4_ARRAY[1]=0,RenderState2D.TEMPMAT4_ARRAY[4]=0,RenderState2D.TEMPMAT4_ARRAY[5]=1,RenderState2D.TEMPMAT4_ARRAY[12]=0,RenderState2D.TEMPMAT4_ARRAY[13]=0}static clear(){RenderState2D.worldScissorTest=!1,RenderState2D.worldAlpha=1}}var y,E,C,v,R;RenderState2D._MAXSIZE=99999999,RenderState2D.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],RenderState2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY,RenderState2D.worldMatrix=new Matrix,RenderState2D.matWVP=null,RenderState2D.worldAlpha=1,RenderState2D.worldScissorTest=!1,RenderState2D.width=0,RenderState2D.height=0,RenderState2D.InvertY=!1,e.RenderTargetFormat=void 0,(y=e.RenderTargetFormat||(e.RenderTargetFormat={}))[y.None=-1]="None",y[y.R8G8B8=0]="R8G8B8",y[y.R8G8B8A8=1]="R8G8B8A8",y[y.R16G16B16A16=17]="R16G16B16A16",y[y.R32G32B32=30]="R32G32B32",y[y.R32G32B32A32=15]="R32G32B32A32",y[y.R16G16B16=31]="R16G16B16",y[y.DEPTH_16=35]="DEPTH_16",y[y.STENCIL_8=36]="STENCIL_8",y[y.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",y[y.DEPTH_32=38]="DEPTH_32",e.RenderClearFlag=void 0,(E=e.RenderClearFlag||(e.RenderClearFlag={}))[E.Nothing=0]="Nothing",E[E.Color=1]="Color",E[E.Depth=2]="Depth",E[E.Stencil=4]="Stencil";class Color{static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}constructor(e=1,t=1,r=1,i=1){this.r=e,this.g=t,this.b=r,this.a=i}equal(e){if(!e)return!1;const toFIxed=(e,t)=>{var r=1e-5;return-r<e-t&&e-t<r};return toFIxed(e.r,this.r)&&toFIxed(e.g,this.g)&&toFIxed(e.b,this.b)&&toFIxed(e.a,this.a)}toLinear(e){e.r=Color.gammaToLinearSpace(this.r),e.g=Color.gammaToLinearSpace(this.g),e.b=Color.gammaToLinearSpace(this.b),e.a=this.a}toGamma(e){e.r=Color.linearToGammaSpace(this.r),e.g=Color.linearToGammaSpace(this.g),e.b=Color.linearToGammaSpace(this.b),e.a=this.a}cloneTo(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}scale(e){return this.r=this.r*e,this.g=this.g*e,this.b=this.b*e,this}setValue(e,t,r,i){this.r=e,this.g=t,this.b=r,this.a=i}fromArray(e,t=0){this.r=e[t+0],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var e=new Color;return this.cloneTo(e),e}}Color.RED=new Color(1,0,0,1),Color.GREEN=new Color(0,1,0,1),Color.BLUE=new Color(0,0,1,1),Color.CYAN=new Color(0,1,1,1),Color.YELLOW=new Color(1,.92,.016,1),Color.MAGENTA=new Color(1,0,1,1),Color.GRAY=new Color(.5,.5,.5,1),Color.WHITE=new Color(1,1,1,1),Color.BLACK=new Color(0,0,0,1),Color.CLEAR=new Color(0,0,0,0);class NativeRenderTexture2D extends BaseTexture{static get currentActive(){return NativeRenderTexture2D._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Texture2D.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,r,i=e.RenderTargetFormat.R8G8B8,a=e.RenderTargetFormat.DEPTH_16,s=!0){super(t,r,i),this._mgrKey=0,this._colorFormat=i,this._depthStencilFormat=a,0!=t&&0!=r&&s&&this._create(),this.lock=!0}get isCube(){return this._nativeObj.isCube}get samples(){return this._nativeObj.samples}get generateMipmap(){return this._nativeObj.generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._nativeObj=new window.conchRenderTexture2D(LayaGL.renderEngine._nativeObj,this.width,this.height,this._colorFormat,this.depthStencilFormat),this._texture=this._nativeObj._renderTarget._textures[0]}static pushRT(){throw new Error("Method not implemented.")}static popRT(){throw new Error("Method not implemented.")}start(){this._nativeObj.start()}end(){this._nativeObj.end()}restore(){this._nativeObj.restore()}clear(e=0,t=0,r=0,i=1){this._nativeObj.clear(e,t,r,i)}getData(e,t,r,i){return this._nativeObj.getData(e,t,r,i)}recycle(){}_disposeResource(){this._nativeObj._disposeResource()}}NativeRenderTexture2D._clearColor=new Color(0,0,0,0),NativeRenderTexture2D.rtStack=[],NativeRenderTexture2D.defuv=[0,0,1,0,1,1,0,1],NativeRenderTexture2D.flipyuv=[0,1,1,1,1,0,0,0];class RenderTexture2D extends BaseTexture{static get currentActive(){return RenderTexture2D._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Texture2D.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,r,i=e.RenderTargetFormat.R8G8B8,a=e.RenderTargetFormat.None){super(t,r,i),this._mgrKey=0,this._invertY=!1,this._colorFormat=i,this._depthStencilFormat=a,0!=t&&0!=r&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._renderTarget=LayaGL.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!0,1),this._texture=this._renderTarget._textures[0]}static pushRT(){RenderTexture2D.rtStack.push({rt:RenderTexture2D._currentActive,w:RenderState2D.width,h:RenderState2D.height})}static popRT(){var e=RenderTexture2D.rtStack.pop();e&&(RenderTexture2D._currentActive!=e.rt&&(e.rt?(LayaGL.textureContext.bindRenderTarget(e.rt._renderTarget),RenderState2D.InvertY=e.rt._invertY):(LayaGL.textureContext.bindoutScreenTarget(),RenderState2D.InvertY=!1),RenderTexture2D._currentActive=e.rt),LayaGL.renderEngine.viewport(0,0,e.w,e.h),LayaGL.renderEngine.scissor(0,0,e.w,e.h),RenderState2D.width=e.w,RenderState2D.height=e.h)}start(){LayaGL.textureContext.bindRenderTarget(this._renderTarget),this._lastRT=RenderTexture2D._currentActive,RenderTexture2D._currentActive=this,RenderState2D.InvertY=this._invertY,LayaGL.renderEngine.viewport(0,0,this._width,this._height),LayaGL.renderEngine.scissor(0,0,this._width,this._height),this._lastWidth=RenderState2D.width,this._lastHeight=RenderState2D.height,RenderState2D.width=this._width,RenderState2D.height=this._height,BaseShader.activeShader=null}end(){LayaGL.textureContext.unbindRenderTarget(this._renderTarget),RenderTexture2D._currentActive=null,RenderState2D.InvertY=!1}restore(){this._lastRT!=RenderTexture2D._currentActive&&(this._lastRT?(LayaGL.textureContext.bindRenderTarget(this._lastRT._renderTarget),RenderState2D.InvertY=this._lastRT._invertY):(LayaGL.textureContext.unbindRenderTarget(this._renderTarget),RenderState2D.InvertY=!1),RenderTexture2D._currentActive=this._lastRT),LayaGL.renderEngine.viewport(0,0,this._lastWidth,this._lastHeight),LayaGL.renderEngine.scissor(0,0,this._lastWidth,this._lastHeight),RenderState2D.width=this._lastWidth,RenderState2D.height=this._lastHeight,BaseShader.activeShader=null}clear(t=0,r=0,i=0,a=1){RenderTexture2D._clearColor.r=t,RenderTexture2D._clearColor.g=r,RenderTexture2D._clearColor.b=i,RenderTexture2D._clearColor.a=a,RenderTexture2D._clearColor.toLinear(RenderTexture2D._clearLinearColor),LayaGL.renderEngine.clearRenderTexture(e.RenderClearFlag.Color|e.RenderClearFlag.Depth,RenderTexture2D._clearLinearColor,1)}getData(e,t,r,i){return LayaGL.textureContext.getRenderTextureData(this._renderTarget,e,t,r,i)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}RenderTexture2D._clearColor=new Color(0,0,0,0),RenderTexture2D._clearLinearColor=new Color,RenderTexture2D.rtStack=[],RenderTexture2D.defuv=[0,0,1,0,1,1,0,1],RenderTexture2D.flipyuv=[0,1,1,1,1,0,0,0],window.conch&&!window.conchConfig.conchWebGL&&(RenderTexture2D=NativeRenderTexture2D);class WebGLRTMgr{static getRT(t,r){return r|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new RenderTexture2D(t,r,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)}static releaseRT(e){e.destroy()}}WebGLRTMgr.dict={},e.BlendFactor=void 0,(C=e.BlendFactor||(e.BlendFactor={}))[C.Zero=0]="Zero",C[C.One=1]="One",C[C.SourceColor=2]="SourceColor",C[C.OneMinusSourceColor=3]="OneMinusSourceColor",C[C.DestinationColor=4]="DestinationColor",C[C.OneMinusDestinationColor=5]="OneMinusDestinationColor",C[C.SourceAlpha=6]="SourceAlpha",C[C.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",C[C.DestinationAlpha=8]="DestinationAlpha",C[C.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",C[C.SourceAlphaSaturate=10]="SourceAlphaSaturate",C[C.BlendColor=11]="BlendColor",C[C.OneMinusBlendColor=12]="OneMinusBlendColor",e.BlendType=void 0,(v=e.BlendType||(e.BlendType={}))[v.BLEND_DISABLE=0]="BLEND_DISABLE",v[v.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",v[v.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",e.RenderStateType=void 0,(R=e.RenderStateType||(e.RenderStateType={}))[R.DepthTest=0]="DepthTest",R[R.DepthMask=1]="DepthMask",R[R.DepthFunc=2]="DepthFunc",R[R.StencilTest=3]="StencilTest",R[R.StencilMask=4]="StencilMask",R[R.StencilFunc=5]="StencilFunc",R[R.StencilOp=6]="StencilOp",R[R.BlendType=7]="BlendType",R[R.BlendEquation=8]="BlendEquation",R[R.BlendEquationSeparate=9]="BlendEquationSeparate",R[R.BlendFunc=10]="BlendFunc",R[R.BlendFuncSeperate=11]="BlendFuncSeperate",R[R.CullFace=12]="CullFace",R[R.FrontFace=13]="FrontFace";class RenderStateContext{static __init__(){RenderStateContext.DepthTestCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.DepthMaskCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.DepthFuncCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.StencilTestCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.StencilMaskCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.StencilFuncCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.stencilOpCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendEquationCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendEquationSeparateCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendFuncCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendFuncSeperateCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.CullFaceCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.FrontFaceCMD=LayaGL.renderEngine.createRenderStateComand()}static setDepthTest(t){RenderStateContext.DepthTestCMD.clear(),RenderStateContext.DepthTestCMD.addCMD(e.RenderStateType.DepthTest,t),RenderStateContext.DepthTestCMD.applyCMD()}static setDepthMask(t){RenderStateContext.DepthMaskCMD.clear(),RenderStateContext.DepthMaskCMD.addCMD(e.RenderStateType.DepthMask,t),RenderStateContext.DepthMaskCMD.applyCMD()}static setDepthFunc(t){RenderStateContext.DepthFuncCMD.clear(),RenderStateContext.DepthFuncCMD.addCMD(e.RenderStateType.DepthFunc,t),RenderStateContext.DepthFuncCMD.applyCMD()}static setStencilTest(t){RenderStateContext.StencilTestCMD.clear(),RenderStateContext.StencilTestCMD.addCMD(e.RenderStateType.StencilTest,t),RenderStateContext.StencilTestCMD.applyCMD()}static setStencilMask(t){RenderStateContext.StencilMaskCMD.clear(),RenderStateContext.StencilMaskCMD.addCMD(e.RenderStateType.StencilMask,t),RenderStateContext.StencilMaskCMD.applyCMD()}static setStencilFunc(t,r){RenderStateContext.StencilFuncCMD.clear(),RenderStateContext.stencilFuncArray[0]=t,RenderStateContext.stencilFuncArray[1]=r,RenderStateContext.StencilFuncCMD.addCMD(e.RenderStateType.StencilFunc,RenderStateContext.stencilFuncArray),RenderStateContext.StencilFuncCMD.applyCMD()}static setstencilOp(t,r,i){RenderStateContext.stencilOpCMD.clear(),RenderStateContext.stencilOpArray[0]=t,RenderStateContext.stencilOpArray[1]=r,RenderStateContext.stencilOpArray[2]=i,RenderStateContext.stencilOpCMD.addCMD(e.RenderStateType.StencilOp,RenderStateContext.stencilOpArray),RenderStateContext.stencilOpCMD.applyCMD()}static setBlend(t){RenderStateContext.BlendCMD.clear(),t?RenderStateContext.BlendCMD.addCMD(e.RenderStateType.BlendType,e.BlendType.BLEND_ENABLE_SEPERATE):RenderStateContext.BlendCMD.addCMD(e.RenderStateType.BlendType,e.BlendType.BLEND_DISABLE),RenderStateContext.BlendCMD.applyCMD()}static setBlendEquation(t){RenderStateContext.BlendEquationCMD.clear(),RenderStateContext.BlendEquationCMD.addCMD(e.RenderStateType.BlendEquation,t),RenderStateContext.BlendEquationCMD.applyCMD()}static setBlendEquationSeparate(t,r){RenderStateContext.BlendEquationSeparateCMD.clear(),RenderStateContext.blendEquationSeparateArray[0]=t,RenderStateContext.blendEquationSeparateArray[1]=r,RenderStateContext.BlendEquationSeparateCMD.addCMD(e.RenderStateType.BlendEquationSeparate,RenderStateContext.blendEquationSeparateArray),RenderStateContext.BlendEquationSeparateCMD.applyCMD()}static setBlendFunc(t,r,i=!1){RenderStateContext.BlendFuncCMD.clear(),RenderStateContext.blenfunArray[0]=t,RenderStateContext.blenfunArray[1]=r,RenderStateContext.BlendFuncCMD.addCMD(e.RenderStateType.BlendFunc,RenderStateContext.blenfunArray),RenderStateContext.BlendFuncCMD.applyCMD()}static setBlendFuncSeperate(t,r,i,a){RenderStateContext.BlendFuncSeperateCMD.clear(),RenderStateContext.blendFuncSeperateArray[0]=t,RenderStateContext.blendFuncSeperateArray[1]=r,RenderStateContext.blendFuncSeperateArray[2]=i,RenderStateContext.blendFuncSeperateArray[3]=a,RenderStateContext.BlendFuncSeperateCMD.addCMD(e.RenderStateType.BlendFuncSeperate,RenderStateContext.blendFuncSeperateArray),RenderStateContext.BlendFuncSeperateCMD.applyCMD()}}RenderStateContext.stencilFuncArray=new Array(2),RenderStateContext.blendEquationSeparateArray=new Array(2),RenderStateContext.blenfunArray=new Array(2),RenderStateContext.blendFuncSeperateArray=new Array(4),RenderStateContext.stencilOpArray=new Array(3);class BlendMode{static _init_(){BlendMode.fns=[BlendMode.BlendNormal,BlendMode.BlendAdd,BlendMode.BlendMultiply,BlendMode.BlendScreen,BlendMode.BlendOverlay,BlendMode.BlendLight,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddOld],BlendMode.targetFns=[BlendMode.BlendNormalTarget,BlendMode.BlendAddTarget,BlendMode.BlendMultiplyTarget,BlendMode.BlendScreenTarget,BlendMode.BlendOverlayTarget,BlendMode.BlendLightTarget,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddTargetOld]}static BlendNormal(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha,!0)}static BlendAddOld(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha,!0)}static BlendAdd(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One,!0)}static BlendMultiply(){RenderStateContext.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha,!0)}static BlendScreen(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One,!0)}static BlendOverlay(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha,!0)}static BlendLight(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One,!0)}static BlendNormalTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha,!0)}static BlendAddTargetOld(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha,!0)}static BlendAddTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One,!0)}static BlendMultiplyTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha,!0)}static BlendScreenTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One,!0)}static BlendOverlayTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceColor,!0)}static BlendLightTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One,!0)}static BlendMask(){RenderStateContext.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.SourceAlpha,!0)}static BlendDestinationOut(){RenderStateContext.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.Zero,!0)}}BlendMode.activeBlendFunction=null,BlendMode.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],BlendMode.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},BlendMode.NORMAL="normal",BlendMode.MASK="mask",BlendMode.LIGHTER="lighter";class ShaderDefinesBase{constructor(e,t,r){this._value=0,this._name2int=e,this._int2name=t,this._int2nameMap=r}add(e){return this._value|="string"==typeof e?this._name2int[e]:e,this._value}addInt(e){return this._value|=e,this._value}remove(e){return this._value&="string"==typeof e?~this._name2int[e]:~e,this._value}isDefine(e){return(this._value&e)===e}getValue(){return this._value}setValue(e){this._value=e}toNameDic(){var e=this._int2nameMap[this._value];return e||ShaderDefinesBase._toText(this._value,this._int2name,this._int2nameMap)}static _reg(e,t,r,i){r[e]=t,i[t]=e}static _toText(e,t,r){var i=r[e];if(i)return i;for(var a={},s=1,n=0;n<32&&!((s=1<<n)>e);n++)if(e&s){var o=t[s];o&&(a[o]="")}return r[e]=a,a}static _toInt(e,t){for(var r=e.split("."),i=0,a=0,s=r.length;a<s;a++){var n=t[r[a]];if(!n)throw new Error("Defines to int err:"+e+"/"+r[a]);i|=n}return i}}class ShaderDefines2D extends ShaderDefinesBase{static __init__(){ShaderDefines2D.reg("TEXTURE2D",ShaderDefines2D.TEXTURE2D),ShaderDefines2D.reg("PRIMITIVE",ShaderDefines2D.PRIMITIVE),ShaderDefines2D.reg("GLOW_FILTER",ShaderDefines2D.FILTERGLOW),ShaderDefines2D.reg("BLUR_FILTER",ShaderDefines2D.FILTERBLUR),ShaderDefines2D.reg("COLOR_FILTER",ShaderDefines2D.FILTERCOLOR),ShaderDefines2D.reg("COLOR_ADD",ShaderDefines2D.COLORADD),ShaderDefines2D.reg("WORLDMAT",ShaderDefines2D.WORLDMAT),ShaderDefines2D.reg("FILLTEXTURE",ShaderDefines2D.FILLTEXTURE),ShaderDefines2D.reg("MVP3D",ShaderDefines2D.MVP3D),ShaderDefines2D.reg("GAMMASPACE",ShaderDefines2D.GAMMASPACE),ShaderDefines2D.reg("INVERTY",ShaderDefines2D.INVERTY)}constructor(){super(ShaderDefines2D.__name2int,ShaderDefines2D.__int2name,ShaderDefines2D.__int2nameMap)}static reg(e,t){this._reg(e,t,ShaderDefines2D.__name2int,ShaderDefines2D.__int2name)}static toText(e,t,r){return this._toText(e,t,r)}static toInt(e){return this._toInt(e,ShaderDefines2D.__name2int)}}ShaderDefines2D.TEXTURE2D=1,ShaderDefines2D.PRIMITIVE=4,ShaderDefines2D.FILTERGLOW=8,ShaderDefines2D.FILTERBLUR=16,ShaderDefines2D.FILTERCOLOR=32,ShaderDefines2D.COLORADD=64,ShaderDefines2D.WORLDMAT=128,ShaderDefines2D.FILLTEXTURE=256,ShaderDefines2D.SKINMESH=512,ShaderDefines2D.MVP3D=2048,ShaderDefines2D.GAMMASPACE=4096,ShaderDefines2D.INVERTY=8192,ShaderDefines2D.NOOPTMASK=ShaderDefines2D.FILTERGLOW|ShaderDefines2D.FILTERBLUR|ShaderDefines2D.FILTERCOLOR|ShaderDefines2D.FILLTEXTURE,ShaderDefines2D.__name2int={},ShaderDefines2D.__int2name=[],ShaderDefines2D.__int2nameMap=[];const b=new Rectangle,D=new Rectangle;class Texture extends Resource{static create(e,t,r,i,a,s=0,n=0,o=0,l=0){return Texture._create(e,t,r,i,a,s,n,o,l)}static _create(e,t,r,i,a,s=0,n=0,o=0,l=0,h=null){var u,d=e instanceof Texture,_=d?e.uv:Texture.DEF_UV,c=d?e.bitmap:e;c.width&&t+i>c.width&&(i=c.width-t),c.height&&r+a>c.height&&(a=c.height-r),h?(u=h).setTo(c,null,o||i,l||a):u=new Texture(c,null,o||i,l||a),u.width=i,u.height=a,u.offsetX=s,u.offsetY=n;var m=1/c.width,p=1/c.height;t*=m,r*=p,i*=m,a*=p;var f=u.uv[0],g=u.uv[1],T=u.uv[4],x=u.uv[5],S=T-f,y=x-g,E=function(e,t,r){for(var i=0;i<8;i+=2)r[i]+=e,r[i+1]+=t;return r}(_[0],_[1],[t,r,t+i,r,t+i,r+a,t,r+a]);u.uv=new Float32Array([f+E[0]*S,g+E[1]*y,T-(1-E[2])*S,g+E[3]*y,T-(1-E[4])*S,x-(1-E[5])*y,f+E[6]*S,x-(1-E[7])*y]);var C=c.scaleRate;return C&&1!=C?(u.sourceWidth/=C,u.sourceHeight/=C,u.width/=C,u.height/=C,u.scaleRate=C,u.offsetX/=C,u.offsetY/=C):u.scaleRate=1,u}static createFromTexture(e,t,r,i,a){var s=e.scaleRate;1!=s&&(t*=s,r*=s,i*=s,a*=s);var n=Rectangle.TEMP.setTo(t-e.offsetX,r-e.offsetY,i,a),o=n.intersection(b.setTo(0,0,e.width,e.height),D);return o?Texture.create(e,o.x,o.y,o.width,o.height,o.x-n.x,o.y-n.y,i,a):null}get uv(){return this._uv}set uv(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}get bitmap(){return this._bitmap}set bitmap(e){this._bitmap!=e&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount))}constructor(e=null,t=null,r=0,i=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let a=e instanceof Texture?e.bitmap:e;this.setTo(a,t,r,i)}_addReference(e=1){super._addReference(e),this._bitmap&&this._bitmap._addReference(e)}_removeReference(e=1){super._removeReference(e),this._bitmap&&this._bitmap._removeReference(e)}_getSource(e=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(e=null,t=null,r=0,i=0){this.bitmap=e,this.sourceWidth=r,this.sourceHeight=i,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||Texture.DEF_UV}load(e,t){return this._destroyed?Promise.resolve():ILaya.loader.load(e).then((e=>{let r=e.bitmap;this.bitmap=r,this.sourceWidth=this._w=r.width,this.sourceHeight=this._h=r.height,t&&t.run(),this.event(Event.READY,this)}))}getTexturePixels(e,t,r,i){var a,s,n,o=this.bitmap,l=this._w,h=this._h,u=this.sourceWidth,d=this.sourceHeight,_=o.width,c=o.height,m=this.offsetX,p=this.offsetY;let f=r,g=i;if(e+r>l+m&&(f-=e+r-l-m),e+r>u&&(r-=e+r-u),t+i>h+p&&(g-=t+i-h-p),t+i>d&&(i-=t+i-d),r<=0||i<=0)return null;let T=m>e?m-e:0,x=p>t?p-t:0,S=e>m?e-m:0,y=t>p?t-p:0;f-=T,g-=x;var E=4*r,C=null;try{C=o.getPixels()}catch(e){}if(C){if(0==e&&0==t&&r==_&&i==c)return C;let o=this._uv.slice(),l=Math.round(o[0]*_),h=Math.round(o[1]*c);var v=new Uint8Array(r*i*4);for(a=4*l+4*S+(s=(h+y)*(E=4*_)),n=0;n<g;n++)v.set(C.slice(a,a+4*f),4*r*(n+x)+4*T),a+=E;return v}var R=new ILaya.Context;R.size(r,i),R.asBitmap=!0;var b=null;if(0!=e||0!=t||r!=_||i!=c){var D=(b=this._uv.slice())[0],A=b[1],M=(b[2]-D)/l,L=(b[7]-A)/h;b=[D+S*M,A+y*L,D+(S+f)*M,A+y*L,D+(S+f)*M,A+(y+g)*L,D+S*M,A+(y+g)*L]}R._drawTextureM(this,T,x,f,g,null,1,b,4294967295),R._targets.start(),R.flush(),R._targets.end(),R._targets.restore();var w=R._targets.getData(0,0,r,i);for(R.destroy(),v=new Uint8Array(r*i*4),a=0,s=(i-1)*E,n=i-1;n>=0;n--)v.set(w.slice(s,s+E),a),a+=E,s-=E;return v}getPixels(e,t,r,i){return this.getTexturePixels(e,t,r,i)}recoverBitmap(e=null){var t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||ILaya.loader.load(t).then((t=>{this.bitmap=t.bitmap,e&&e()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(e){this._obsolute=e}_disposeResource(){let e=this._bitmap;this._bitmap=null,e&&e._removeReference(this._referenceCount)}getCachedClip(e,t,r,i){let a=`${e}_${t}_${r}_${i}`;this._clipCache||(this._clipCache=new Map);let s=this._clipCache.get(a);return s||(s=Texture.createFromTexture(this,e,t,r,i),s&&(s._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(a,s),s)}}Texture.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),Texture.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),Texture.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]);class StringKey{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(e){var t=this._strsToID[e];return null!=t?t:(this._idToStrs[this._length]=e,this._strsToID[e]=this._length++)}getID(e){var t=this._strsToID[e];return null==t?-1:t}getName(e){var t=this._idToStrs[e];return null==t?void 0:t}}class AssetDb{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={}}UUID_to_URL(e){return this.uuidMap[e]}UUID_to_URL_async(e){return Promise.resolve(null)}URL_to_UUID_async(e){return Promise.resolve(null)}resolveURL(e,t){if(e.startsWith("res://")){let r=e.substring(6);return AssetDb.inst.UUID_to_URL_async(r).then((e=>(t&&t(e),e)))}return t&&t(e),Promise.resolve(e)}shaderName_to_URL(e){return this.shaderNameMap[e]}shaderName_to_URL_async(e){return Promise.resolve(null)}getMeta(e,t){return Promise.resolve(null)}getSubAssetURL(e,t,r,i){return r?`${Utils.replaceFileExtension(e,"")}@${r}.${i}`:e}}AssetDb.inst=new AssetDb;class URL{static __init__(){URL.rootPath=URL.basePath=location&&null!=location.protocol&&""!=location.protocol?URL.getPath(location.protocol+"//"+location.host+location.pathname):""}static initMiniGameExtensionOverrides(){LayaEnv.isPreview||(URL.overrideExtension(["rendertexture","videotexture"],"rt.json"),URL.overrideExtension(["controller"],"controller.json"),URL.overrideExtension(["mc"],"mc.bin"),URL.overrideExtension(["mcc"],"mcc.json"),URL.overrideExtension(["shader"],"shader.json"),URL.overrideExtension(["scene3d","scene","taa","prefab"],"json"),URL.overrideExtension(["fui"],"fui.json"),URL.overrideExtension(["glsl"],"glsl.txt"),URL.overrideExtension(["skel"],"skel.bin"))}constructor(e){this._url=URL.formatURL(e),this._path=URL.getPath(e)}get url(){return this._url}get path(){return this._path}static formatURL(e,t){if(!e)return t||URL.basePath||"";if(e.startsWith("res://")){let t=e.substring(6),r=AssetDb.inst.UUID_to_URL(t);if(!r)return e;e=r}let r=e.charCodeAt(0);if(-1==e.indexOf(":")&&47!==r){null!=URL.customFormat&&(e=URL.customFormat(e));let i=URL.version[e];if(null!=i){let t=e.lastIndexOf(".");e=e.substring(0,t)+"-"+i+e.substring(t)}if(126===r)e=URL.join(URL.rootPath,e.substring(2));else{if(null==t){t=URL.basePath;for(let r in URL.basePaths)if(e.startsWith(r)){t=URL.basePaths[r];break}}e=URL.join(t,e)}}return e}static postFormatURL(e){if(URL.hasExtOverrides){let t=Utils.getFileExtension(e),r=URL.overrideFileExts[t];null!=r&&(e=Utils.replaceFileExtension(e,r))}return e}static normalize(e){if(-1==e.indexOf("./"))return e;let t=e.split("/"),r=t.length,i=0;for(;i<r;)if("."!=t[i]){if(".."==t[i]){let e=i-1;if(e>=0&&".."!==t[e]){t.splice(e,2),r-=2,i--;continue}}i++}else t.splice(i,1),r--;return t.length=r,t.join("/")}static getResURLByUUID(e){return e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:e}static join(e,t){if(!t)return"";if(t.indexOf(":")>0)return t;if(e){let r=t.charCodeAt(0);126!==r&&47!==r&&(t=47!==e.charCodeAt(e.length-1)?e+"/"+t:e+t)}return URL.normalize(t)}static getPath(e){var t=e.lastIndexOf("/");return t>0?e.substring(0,t+1):""}static getFileName(e){var t=e.lastIndexOf("/");return t>0?e.substring(t+1):e}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substring(t):null}static overrideExtension(e,t){for(let r of e)URL.overrideFileExts[r]=t;URL.hasExtOverrides=!0}}URL.version={},URL.basePath="",URL.basePaths={},URL.rootPath="",URL.overrideFileExts={},URL.customFormat=function(e){return e};class IncludeFile{static splitToWords(e,t){for(var r,i,a=[],s=-1,n=0,o=e.length;n<o;n++)if(r=e.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(r)>=0){if(s>=0&&n-s>1&&(i=e.substr(s,n-s),a.push(i)),'"'==r||"'"==r){var l=e.indexOf(r,n+1);if(l<0)throw"Sharder err:"+e;a.push(e.substr(n+1,l-n-1)),n=l,s=-1;continue}"("==r&&t&&a.length>0&&(i=a[a.length-1]+";","vec4;main;".indexOf(i)<0&&(t.useFuns+=i)),s=-1}else s<0&&(s=n);return s<o&&o-s>1&&(i=e.substr(s,o-s),a.push(i)),a}constructor(e){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var t,r,i=0;!((i=e.indexOf("#begin",i))<0);){for(r=i+5;!((r=e.indexOf("#end",r))<0)&&"i"===e.charAt(r+4);)r+=5;if(r<0)throw"add include err,no #end:"+e;t=e.indexOf("\n",i);var a=IncludeFile.splitToWords(e.substr(i,t-i),null);"code"==a[1]?this.codes[a[2]]=e.substr(t+1,r-t-1):"function"==a[1]&&(t=e.indexOf("function",i),t+="function".length,this.funs[a[3]]=e.substr(t+1,r-t-1),this.funnames+=a[3]+";"),i=r+1}}getWith(e=null){var t=e?this.codes[e]:this.script;if(!t)throw"get with error:"+e;return t}getFunsScript(e){var t="";for(var r in this.funs)e.indexOf(r+";")>=0&&(t+=this.funs[r]);return t}}class ShaderNode{constructor(e){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}setParent(e){e.childs.push(this),this.z=e.z+1,this.parent=e}setCondition(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}toscript(e,t){return this._toscript(e,t,++ShaderNode.__id)}_toscript(e,t,r){if(this.childs.length<1&&!this.text)return t;if(t.length,this.condition){var i=!!this.condition.call(e);if(2===this.conditionType&&(i=!i),!i&&ShaderNode.__noCompileEnable)return t}if(!this.noCompile&&ShaderNode.__noCompileEnable||this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach((function(i,a,s){i._toscript(e,t,r)})),this.includefiles.length>0&&this.useFuns.length>0)for(var a,s=0,n=this.includefiles.length;s<n;s++)this.includefiles[s].curUseID!=r&&(a=this.includefiles[s].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[s].curUseID=r,t[0]=a+t[0]);return t}}ShaderNode.__id=1,ShaderNode.__noCompileEnable=!0;const A=new RegExp("\r","g"),M=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g");class ShaderCompile{static addInclude(e,t,r){if(!t||0===t.length)return console.error("shader include file err:"+e),null;if(!r&&ShaderCompile.includes[e])return console.warn("shader include file already exists:"+e),ShaderCompile.includes[e];t=t.replace(A,"");let i=new IncludeFile(t);return ShaderCompile.includes[e]=i,i}static compile(e,t,r){let i={vsNode:new ShaderNode([]),psNode:new ShaderNode([]),includeNames:new Set,defs:new Set},a=[];e=e.replace(A,""),t=t.replace(A,""),ShaderCompile._compileToTree(i.vsNode,e,i.defs,a,r),ShaderCompile._compileToTree(i.psNode,t,i.defs,a,r);for(let e of a)e.file?i.includeNames.add(e.name):console.warn(`ShaderCompile missing file ${e.name}`);return i}static compileAsync(e,t,r){let i={vsNode:new ShaderNode([]),psNode:new ShaderNode([]),includeNames:new Set,defs:new Set},a=[];return e=e.replace(A,""),t=t.replace(A,""),ShaderCompile._compileToTree(i.vsNode,e,i.defs,a,r),ShaderCompile._compileToTree(i.psNode,t,i.defs,a,r),this._loadIncludesDeep(i,a,0)}static _loadIncludesDeep(e,t,r){let i,a=t.length;for(let s=r;s<a;s++){let r=t[s];r.file?e.includeNames.add(r.name):(i||(i=[]),i.push(r))}return i?ILaya.loader.load(i.map((e=>e.name))).then((r=>{let s=i.length;for(let a=0;a<s;a++){let s=i[a],n=r[a];if(n){e.includeNames.add(s.name);let r=n.getWith(s.codeName);s.node.condition?s.node.text=r:(ShaderCompile._compileToTree(s.node,r,e.defs,t,URL.getPath(s.name)),s.node.text="")}else{let e=s.node.parent.childs;e.splice(e.indexOf(s.node),1)}}return t.length>a?ShaderCompile._loadIncludesDeep(e,t,a):e})):Promise.resolve(e)}static _compileToTree(e,t,r,i,a){let s,n,o,l,h,u,d,_,c,m,p=t.split("\n");for(_=0;_<p.length;_++)if(o=p[_],!(o.length<1)&&(u=o.indexOf("//"),0!==u))if(u>=0&&(o=o.substr(0,u)),(u=o.indexOf("#"))<0){n=e.childs[e.childs.length-1];let t=e.includefiles;if(n&&!n.name){t.length>0&&IncludeFile.splitToWords(o,n),n.text+="\n"+o;continue}s=new ShaderNode(t),s.text=o,s.noCompile=!0,t.length>0&&IncludeFile.splitToWords(o,s),s.setParent(e)}else{for(s=new ShaderNode(e.includefiles),s.text=o,s.noCompile=!0,l="#",m=u+1,c=o.length;m<c;m++){let e=o.charAt(m);if(" "===e||"\t"===e||"?"===e)break;l+=e}switch(s.name=l,l){case"#ifdef":case"#ifndef":for(s.src=o,s.noCompile=null!=o.match(/[!&|()=<>]/),s.noCompile?console.log("function():Boolean{return "+o.substr(u+s.name.length)+"}"):(d=o.replace(/^\s*/,"").split(/\s+/),s.setCondition(d[1],"#ifdef"===l?ShaderCompile.IFDEF_YES:ShaderCompile.IFDEF_ELSE),s.text=s.text),s.setParent(e),e=s,d=o.substr(m).split(M),m=0;m<d.length;m++)o=d[m],o.length&&r.add(o);break;case"#if":case"#elif":for(s.src=o,s.noCompile=!0,"#elif"==l&&(n=(e=e.parent).childs[e.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),s.setParent(e),e=s,d=o.substr(m).split(M),m=0;m<d.length;m++)o=d[m],o.length&&"defined"!=o&&r.add(o);break;case"#else":s.src=o,n=(e=e.parent).childs[e.childs.length-1],s.noCompile=n.noCompile,s.noCompile||(s.condition=n.condition,s.conditionType=n.conditionType==ShaderCompile.IFDEF_YES?ShaderCompile.IFDEF_ELSE:ShaderCompile.IFDEF_YES),s.setParent(e),e=s;break;case"#endif":n=(e=e.parent).childs[e.childs.length-1],s.noCompile=n.noCompile,s.noCompile||(s.text=s.text),s.setParent(e);break;case"#include":d=IncludeFile.splitToWords(o,null);let t,_=d[1];_.startsWith(".")?_=URL.join(a,_):_.startsWith("/")?_=URL.formatURL(_.substring(1)):(t=ShaderCompile.includes[_],t||(_="internal/"+_)),t=ShaderCompile.includes[_],!t&&ShaderCompile.loadIncludeFileSync&&(ShaderCompile.loadIncludeFileSync(_),t=ShaderCompile.includes[_]);let c="with"==d[2]?d[3]:null;i.push({name:_,codeName:c,node:s,file:t}),s.setParent(e),(u=d[0].indexOf("?"))<0?(t&&(o=t.getWith(c),this._compileToTree(s,o,r,i,URL.getPath(_))),s.text=""):(s.setCondition(d[0].substr(u+1),ShaderCompile.IFDEF_YES),t&&(s.text=t.getWith(c)));break;case"#import":d=IncludeFile.splitToWords(o,null),h=d[1],s.includefiles.push({node:s,file:ShaderCompile.includes[h],ofs:s.text.length});break;default:s.setParent(e)}}}}ShaderCompile.IFDEF_NO=0,ShaderCompile.IFDEF_YES=1,ShaderCompile.IFDEF_ELSE=2,ShaderCompile.IFDEF_PARENT=3,ShaderCompile.includes={};class Shader extends BaseShader{static create(e,t,r=null,i=null,a=null){return new Shader(e,t,r,i,a)}static withCompile2D(e,t,r,i,a,s=null){if(i&&Shader.sharders[i])return Shader.sharders[i];var n=Shader._preCompileShader[Shader.SHADERNAME2ID*e+t];if(!n)throw new Error("withCompile shader err!"+e+" "+t);var o={},l="";if(r)for(var h in r)l+="#define "+h+"\n",o[h]=!0;var u=n.vsNode.toscript(o,[]),d=n.psNode.toscript(o,[]);return(a||Shader.create)(l+u.join("\n"),l+d.join("\n"),i,n.nameMap,s)}static addInclude(e,t){ShaderCompile.addInclude(e,t)}static preCompile(e,t,r,i){let a=Shader.SHADERNAME2ID*e,s=ShaderCompile.compile(t,r);s.nameMap=i,Shader._preCompileShader[a]=s}static preCompile2D(e,t,r,i,a){let s=Shader.SHADERNAME2ID*e+t,n=ShaderCompile.compile(r,i);n.nameMap=a,Shader._preCompileShader[s]=n}constructor(e,t,r=null,i=null,a=null){if(super(),this._attribInfo=null,this._curActTexIndex=0,this.tag={},this._program=null,this._params=null,this._paramsMap={},!e||!t)throw"Shader Error";this._attribInfo=a,this._id=++Shader._count,this._vs=e,this._ps=t,this._nameMap=i||{},null!=r&&(Shader.sharders[r]=this),this.recreateResource(),this.lock=!0,this._render2DContext=LayaGL.render2DContext}recreateResource(){this._compile(),this._setGPUMemory(0)}_disposeResource(){RenderStateContext.mainContext.deleteShader(this._vshader),RenderStateContext.mainContext.deleteShader(this._pshader),RenderStateContext.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._params=null,this._paramsMap={},this._setGPUMemory(0),this._curActTexIndex=0}_compile(){if(this._vs&&this._ps&&!this._params){this._reCompile=!0,this._params=[];var e,t,r,i=RenderStateContext.mainContext;this._program=i.createProgram(),this._vshader=Shader._createShader(i,this._vs,i.VERTEX_SHADER),this._pshader=Shader._createShader(i,this._ps,i.FRAGMENT_SHADER),i.attachShader(this._program,this._vshader),i.attachShader(this._program,this._pshader);var a=this._attribInfo?this._attribInfo.length:0;for(t=0;t<a;t+=2)i.bindAttribLocation(this._program,this._attribInfo[t+1],this._attribInfo[t]);if(i.linkProgram(this._program),!i.getProgramParameter(this._program,i.LINK_STATUS))throw i.getProgramInfoLog(this._program);var s=i.getProgramParameter(this._program,i.ACTIVE_UNIFORMS);for(t=0;t<s;t++){var n=i.getActiveUniform(this._program,t);(e={vartype:"uniform",glfun:null,ivartype:1,location:i.getUniformLocation(this._program,n.name),name:n.name,type:n.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0}).name.indexOf("[0]")>0&&(e.name=e.name.substr(0,e.name.length-3),e.isArray=!0,e.location=i.getUniformLocation(this._program,e.name)),this._params.push(e)}for(t=0,r=this._params.length;t<r;t++)switch((e=this._params[t]).indexOfParams=t,e.index=1,e.value=[e.location,null],e.codename=e.name,e.name=this._nameMap[e.codename]?this._nameMap[e.codename]:e.codename,this._paramsMap[e.name]=e,e._this=this,e.uploadedValue=[],e.type){case i.INT:e.fun=e.isArray?this._uniform1iv:this._uniform1i;break;case i.FLOAT:e.fun=e.isArray?this._uniform1fv:this._uniform1f;break;case i.FLOAT_VEC2:e.fun=e.isArray?this._uniform_vec2v:this._uniform_vec2;break;case i.FLOAT_VEC3:e.fun=e.isArray?this._uniform_vec3v:this._uniform_vec3;break;case i.FLOAT_VEC4:e.fun=e.isArray?this._uniform_vec4v:this._uniform_vec4;break;case i.SAMPLER_2D:e.fun=this._uniform_sampler2D;break;case i.SAMPLER_CUBE:e.fun=this._uniform_samplerCube;break;case i.FLOAT_MAT4:e.glfun=i.uniformMatrix4fv,e.fun=this._uniformMatrix4fv;break;case i.BOOL:e.fun=this._uniform1i;break;case i.FLOAT_MAT2:case i.FLOAT_MAT3:default:throw new Error("compile shader err!")}}}static _createShader(e,t,r){var i=e.createShader(r);return e.shaderSource(i,t),e.compileShader(i),e.getShaderParameter(i,e.COMPILE_STATUS)?i:(console.log(e.getShaderInfoLog(i)),null)}getUniform(e){return this._paramsMap[e]}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(RenderStateContext.mainContext.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(RenderStateContext.mainContext.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return RenderStateContext.mainContext.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(RenderStateContext.mainContext.uniform2f(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(RenderStateContext.mainContext.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return RenderStateContext.mainContext.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(RenderStateContext.mainContext.uniform3f(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3v(e,t){return RenderStateContext.mainContext.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(RenderStateContext.mainContext.uniform4f(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4v(e,t){return RenderStateContext.mainContext.uniform4fv(e.location,t),1}_uniformMatrix4fv(e,t){return RenderStateContext.mainContext.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(RenderStateContext.mainContext.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return RenderStateContext.mainContext.uniform1iv(e.location,t),1}_uniform_sampler2D(e,t){var r=RenderStateContext.mainContext,i=e.uploadedValue;return null==i[0]?(i[0]=this._curActTexIndex,r.uniform1i(e.location,this._curActTexIndex),this._render2DContext.activeTexture(r.TEXTURE0+this._curActTexIndex),this._render2DContext.bindTexture(r.TEXTURE_2D,t),this._curActTexIndex++,1):(this._render2DContext.activeTexture(r.TEXTURE0+i[0]),this._render2DContext.bindTexture(r.TEXTURE_2D,t),0)}_uniform_samplerCube(e,t){var r=RenderStateContext.mainContext,i=e.uploadedValue;return null==i[0]?(i[0]=this._curActTexIndex,r.uniform1i(e.location,this._curActTexIndex),this._render2DContext.activeTexture(r.TEXTURE0+this._curActTexIndex),this._render2DContext.bindTexture(r.TEXTURE_CUBE_MAP,t),this._curActTexIndex++,1):(this._render2DContext.activeTexture(r.TEXTURE0+i[0]),this._render2DContext.bindTexture(r.TEXTURE_CUBE_MAP,t),0)}uploadTexture2D(e){this._render2DContext.bindTexture(RenderStateContext.mainContext.TEXTURE_2D,e)}upload(e,t=null){BaseShader.activeShader=BaseShader.bindShader=this,this._render2DContext.bindUseProgram(this._program),this._reCompile?(t=this._params,this._reCompile=!1):t=t||this._params;for(var r,i,a=t.length,s=0;s<a;s++)null!==(i=e[(r=t[s]).name])&&r.fun.call(this,r,i)}}Shader._count=0,Shader._preCompileShader={},Shader.SHADERNAME2ID=2e-4,Shader.nameKey=new StringKey,Shader.sharders=new Array(32);class Shader2X extends Shader{constructor(e,t,r=null,i=null,a=null){super(e,t,r,i,a),this._params2dQuick2=null,this._shaderValueWidth=0,this._shaderValueHeight=0}_disposeResource(){super._disposeResource(),this._params2dQuick2=null}upload2dQuick2(e){this.upload(e,this._params2dQuick2||this._make2dQuick2())}_make2dQuick2(){if(!this._params2dQuick2){this._params2dQuick2=[];for(var e,t=this._params,r=0,i=t.length;r<i;r++)"size"!==(e=t[r]).name&&this._params2dQuick2.push(e)}return this._params2dQuick2}static create(e,t,r=null,i=null,a=null){return new Shader2X(e,t,r,i,a)}}class Value2D{static _initone(e,t){Value2D._typeClass[e]=t,Value2D._cache[e]=[],Value2D._cache[e]._length=0}static create(e,t){var r=Value2D._cache[e|t];return r._length?r[--r._length]:new Value2D._typeClass[e|t](t)}static __init__(){}constructor(e,t){this.defines=new ShaderDefines2D,this.size=[0,0],this.alpha=1,this.ALPHA=1,this.subID=0,this.ref=1,this._cacheID=0,this.clipMatDir=[Const.MAX_CLIP_SIZE,0,0,Const.MAX_CLIP_SIZE],this.clipMatPos=[0,0],this.clipOff=[0,0],this.mainID=e,this.subID=t,this.textureHost=null,this.texture=null,this.color=null,this.colorAdd=null,this.u_mmat2=null,this._cacheID=e|t,this._inClassCache=Value2D._cache[this._cacheID],e>0&&!this._inClassCache&&(this._inClassCache=Value2D._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}setValue(e){}_ShaderWithCompile(){return Shader.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,Shader2X.create,this._attribLocation)}upload(){var e=RenderState2D;RenderState2D.worldMatrix4===RenderState2D.TEMPMAT4_ARRAY||this.defines.addInt(ShaderDefines2D.WORLDMAT),this.mmat=e.worldMatrix4,RenderState2D.matWVP&&(this.defines.addInt(ShaderDefines2D.MVP3D),this.u_MvpMatrix=RenderState2D.matWVP.elements);let t=!RenderTexture2D.currentActive;t&&this.textureHost&&(this.textureHost instanceof RenderTexture2D?t=1==this.textureHost.gammaCorrection:this.textureHost instanceof Texture&&(t=1==this.textureHost.bitmap.gammaCorrection)),t?this.defines.addInt(ShaderDefines2D.GAMMASPACE):this.defines.remove(ShaderDefines2D.GAMMASPACE),RenderState2D.InvertY?this.defines.addInt(ShaderDefines2D.INVERTY):this.defines.remove(ShaderDefines2D.INVERTY);var r=Shader.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();r._shaderValueWidth!==e.width||r._shaderValueHeight!==e.height?(this.size[0]=e.width,this.size[1]=e.height,r._shaderValueWidth=e.width,r._shaderValueHeight=e.height,r.upload(this,null)):r.upload(this,r._params2dQuick2||r._make2dQuick2())}setFilters(e){if(this.filters=e,e)for(var t,r=e.length,i=0;i<r;i++)(t=e[i])&&(this.defines.add(t.type),t.action.setValue(this))}clear(){this.defines._value=this.subID,this.clipOff[0]=0}release(){--this.ref<1&&(this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this),this.clear(),this.filters=null,this.ref=1,this.clipOff[0]=0)}}Value2D._cache=[],Value2D._typeClass=[],Value2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];class SubmitKey{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}copyFrom(e){this.other=e.other,this.blendShader=e.blendShader,this.submitType=e.submitType}copyFrom2(e,t,r){this.other=r,this.submitType=t}equal3_2(e,t,r){return this.submitType===t&&this.other===r&&this.blendShader===e.blendShader}equal4_2(e,t,r){return this.submitType===t&&this.other===r&&this.blendShader===e.blendShader}equal_3(e){return this.submitType===e.submitType&&this.blendShader===e.blendShader}equal(e){return this.other===e.other&&this.submitType===e.submitType&&this.blendShader===e.blendShader}}class SubmitCMD{constructor(){this._ref=1,this._key=new SubmitKey}renderSubmit(){return this.fun.apply(this._this,this.args),1}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var e=SubmitCMD.POOL;e[e._length++]=this,this.args=null,this.fun=null,this._this=null}}static create(e,t,r){var i=SubmitCMD.POOL._length?SubmitCMD.POOL[--SubmitCMD.POOL._length]:new SubmitCMD;return i.fun=t,i.args=e,i._this=r,i._ref=1,i._key.clear(),i}}SubmitCMD.POOL=[],SubmitCMD.POOL._length=0;class Filter{constructor(){}get type(){return-1}}Filter.BLUR=16,Filter.COLOR=32,Filter.GLOW=8,Filter._filter=function(e,t,r,i){var a=t,s=this._next;if(s){var n=e.filters,o=n.length;if(1==o&&n[0].type==Filter.COLOR)return t.save(),t.setColorFilter(n[0]),s._fun.call(s,e,t,r,i),void t.restore();var l,h=Value2D.create(ShaderDefines2D.TEXTURE2D,0),u=Point.TEMP,d=a._curMat,_=Matrix.create();d.copyTo(_);var c=0,m=0,p=null,f=e._cacheStyle.filterCache||null;if(f&&0==e.getRepaint()){if((e._isHaveGlowFilter()||!1)&&(c=50,m=25),(l=e.getBounds()).width<=0||l.height<=0)return;l.width+=c+8,l.height+=c+8,l.x-=e.pivotX+4,l.y-=e.pivotY+4,u.x=l.x*_.a+l.y*_.c,u.y=l.y*_.d+l.x*_.b,l.x=u.x,l.y=u.y,u.x=l.width*_.a+l.height*_.c,u.y=l.height*_.d+l.width*_.b,l.width=u.x,l.height=u.y}else{e._isHaveGlowFilter()&&(c=50,m=25),(l=new Rectangle).copyFrom(e.getSelfBounds()),l.x+=e.x,l.y+=e.y,l.x-=e.pivotX+4,l.y-=e.pivotY+4;var g=l.x,T=l.y;if(l.width+=c+8,l.height+=c+8,u.x=l.x*_.a+l.y*_.c,u.y=l.y*_.d+l.x*_.b,l.x=u.x,l.y=u.y,u.x=l.width*_.a+l.height*_.c,u.y=l.height*_.d+l.width*_.b,l.width=u.x,l.height=u.y,l.width<=0||l.height<=0)return;f&&WebGLRTMgr.releaseRT(f),p=WebGLRTMgr.getRT(l.width,l.height);var x=f=WebGLRTMgr.getRT(l.width,l.height);e._getCacheStyle().filterCache=f,a.pushRT(),a.useRT(p);var S=e.x-g+m,y=e.y-T+m;s._fun.call(s,e,t,S,y),a.useRT(x);for(var E=0;E<o;E++){0!=E&&(a.useRT(p),a.drawTarget(x,0,0,l.width,l.height,Matrix.TEMP.identity(),h,null,BlendMode.TOINT.overlay),a.useRT(x));var C=n[E];switch(C.type){case Filter.BLUR:case Filter.GLOW:C._glRender&&C._glRender.render(p,t,l.width,l.height,C);break;case Filter.COLOR:a.setColorFilter(C),a.drawTarget(p,0,0,l.width,l.height,Matrix.EMPTY.identity(),Value2D.create(ShaderDefines2D.TEXTURE2D,0)),a.setColorFilter(null)}}a.popRT()}if(r=r-m-e.x,i=i-m-e.y,u.setTo(r,i),_.transformPoint(u),r=u.x+l.x,i=u.y+l.y,a._drawRenderTexture(f,r,i,l.width,l.height,Matrix.TEMP.identity(),1,RenderTexture2D.defuv),p){var v=SubmitCMD.create([p],(function(e){e.destroy()}),this);p=null,t.addRenderObject(v)}_.destroy()}};const L={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class ColorUtils{constructor(e){if(this.arrColor=[],null==e||"none"==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let t;"string"==typeof e?(t=Utils.fromStringColor(e),this.strColor=e):(t=e,this.strColor=Utils.toHexColor(t)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&t)>>>24)/255,((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255],this.numColor=(4278190080&t)>>>24|(16711680&t)>>8|(65280&t)<<8|(255&t)<<24):(this.arrColor=[((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255,1],this.numColor=4278190080|(16711680&t)>>16|65280&t|(255&t)<<16)}static _initDefault(){for(var e in ColorUtils._DEFAULT={},L)ColorUtils._SAVE[e]=ColorUtils._DEFAULT[e]=new ColorUtils(L[e]);return ColorUtils._DEFAULT}static _initSaveMap(){ColorUtils._SAVE_SIZE=0,ColorUtils._SAVE=Object.assign({},ColorUtils._DEFAULT)}static create(e){let t=e+"",r=ColorUtils._SAVE[t];return null!=r?r:(ColorUtils._SAVE_SIZE>500&&ColorUtils._initSaveMap(),ColorUtils._SAVE_SIZE++,ColorUtils._SAVE[t]=new ColorUtils(e))}}ColorUtils._SAVE={},ColorUtils._SAVE_SIZE=0,ColorUtils._DEFAULT=ColorUtils._initDefault();const w=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],I=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],B=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class ColorFilter extends Filter{constructor(e=null){super(),e||(e=this._copyMatrix(B)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(e)}gray(){return this.setByMatrix(I)}color(e=0,t=0,r=0,i=1){return this.setByMatrix([e,0,0,0,1,0,t,0,0,1,0,0,r,0,1,0,0,0,i,0])}setColor(e){var t=ColorUtils.create(e).arrColor,r=[0,0,0,0,256*t[0],0,0,0,0,256*t[1],0,0,0,0,256*t[2],0,0,0,1,0];return this.setByMatrix(r)}setByMatrix(e){this._matrix!=e&&this._copyMatrix(e);for(var t=0,r=0,i=0;i<20;i++)i%5!=4?this._mat[t++]=e[i]:this._alpha[r++]=e[i];return this}get type(){return Filter.COLOR}adjustColor(e,t,r,i){return this.adjustHue(i),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(r),this}adjustBrightness(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}adjustContrast(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,r=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?w[e]:w[e<<0]*(1-t)+w[1+(e<<0)]*t)+127)/127,i=.5*(127-t);return this._multiplyMatrix([r,0,0,0,i,0,r,0,0,i,0,0,r,0,i,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),r=1-t,i=.3086*r,a=.6094*r,s=.082*r;return this._multiplyMatrix([i+t,a,s,0,0,i,a+t,s,0,0,i,a,s+t,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),r=Math.sin(e),i=.213,a=.715,s=.072;return this._multiplyMatrix([i+t*(1-i)+r*-i,a+t*-a+r*-a,s+t*-s+r*(1-s),0,0,i+t*-i+.143*r,a+t*(1-a)+.14*r,s+t*-s+-.283*r,0,0,i+t*-i+-.787*r,a+t*-a+r*a,s+t*(1-s)+r*s,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(B))}_multiplyMatrix(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var r=0;r<5;r++){for(var i=0;i<5;i++)t[i]=this._matrix[i+5*r];for(i=0;i<5;i++){for(var a=0,s=0;s<5;s++)a+=e[i+5*s]*t[s];this._matrix[i+5*r]=a}}return this.setByMatrix(this._matrix)}_clampValue(e,t){return Math.min(t,Math.max(-t,e))}_fixMatrix(e=null){return null==e?B:(e.length<25?e=e.slice(0,e.length).concat(B.slice(e.length,25)):e.length>25&&(e=e.slice(0,25)),e)}_copyMatrix(e){this._matrix||(this._matrix=[]);for(var t=0;t<25;t++)this._matrix[t]=e[t];return this._matrix}onAfterDeserialize(){let e=ColorUtils.create(this._color||"#FFFFFF").arrColor;this.color(e[0],e[1],e[2],e[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class GrahamScan{static multiply(e,t,r){return(e.x-r.x)*(t.y-r.y)-(t.x-r.x)*(e.y-r.y)}static dis(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}static _getPoints(e,t=!1,r=null){for(GrahamScan._mPointList||(GrahamScan._mPointList=[]);GrahamScan._mPointList.length<e;)GrahamScan._mPointList.push(new Point);return r||(r=[]),r.length=0,t?GrahamScan.getFrom(r,GrahamScan._mPointList,e):GrahamScan.getFromR(r,GrahamScan._mPointList,e),r}static getFrom(e,t,r){var i;for(i=0;i<r;i++)e.push(t[i]);return e}static getFromR(e,t,r){var i;for(i=0;i<r;i++)e.push(t.pop());return e}static pListToPointList(e,t=!1){var r,i=e.length/2,a=GrahamScan._getPoints(i,t,GrahamScan._tempPointList);for(r=0;r<i;r++)a[r].setTo(e[r+r],e[r+r+1]);return a}static pointListToPlist(e){var t,r,i=e.length,a=GrahamScan._temPList;for(a.length=0,t=0;t<i;t++)r=e[t],a.push(r.x,r.y);return a}static scanPList(e){return Utils.copyArray(e,GrahamScan.pointListToPlist(GrahamScan.scan(GrahamScan.pListToPointList(e,!0))))}static scan(e){var t,r,i,a,s,n=0,o=e.length,l={};for((a=GrahamScan._temArr).length=0,t=(o=e.length)-1;t>=0;t--)(s=(i=e[t]).x+"_"+i.y)in l||(l[s]=!0,a.push(i));for(o=a.length,Utils.copyArray(e,a),t=1;t<o;t++)(e[t].y<e[n].y||e[t].y==e[n].y&&e[t].x<e[n].x)&&(n=t);for(i=e[0],e[0]=e[n],e[n]=i,t=1;t<o-1;t++){for(n=t,r=t+1;r<o;r++)(GrahamScan.multiply(e[r],e[n],e[0])>0||0==GrahamScan.multiply(e[r],e[n],e[0])&&GrahamScan.dis(e[0],e[r])<GrahamScan.dis(e[0],e[n]))&&(n=r);i=e[t],e[t]=e[n],e[n]=i}if((a=GrahamScan._temArr).length=0,e.length<3)return Utils.copyArray(a,e);for(a.push(e[0],e[1],e[2]),t=3;t<o;t++){for(;a.length>=2&&GrahamScan.multiply(e[t],a[a.length-1],a[a.length-2])>=0;)a.pop();e[t]&&a.push(e[t])}return a}}GrahamScan._tempPointList=[],GrahamScan._temPList=[],GrahamScan._temArr=[];class SpriteConst{}var P,F,U,N,O;SpriteConst.ALPHA=1,SpriteConst.TRANSFORM=2,SpriteConst.BLEND=4,SpriteConst.CANVAS=8,SpriteConst.FILTERS=16,SpriteConst.MASK=32,SpriteConst.CLIP=64,SpriteConst.STYLE=128,SpriteConst.TEXTURE=256,SpriteConst.GRAPHICS=512,SpriteConst.LAYAGL3D=1024,SpriteConst.CUSTOM=2048,SpriteConst.ONECHILD=4096,SpriteConst.HITAREA=8192,SpriteConst.CHILDS=16384,SpriteConst.REPAINT_NONE=0,SpriteConst.REPAINT_NODE=1,SpriteConst.REPAINT_CACHE=2,SpriteConst.REPAINT_ALL=3,e.RenderStatisticsInfo=void 0,(P=e.RenderStatisticsInfo||(e.RenderStatisticsInfo={}))[P.DrawCall=0]="DrawCall",P[P.InstanceDrawCall=1]="InstanceDrawCall",P[P.Triangle=2]="Triangle",P[P.UniformUpload=3]="UniformUpload",P[P.GPUMemory=4]="GPUMemory",P[P.TextureMemeory=5]="TextureMemeory",P[P.RenderTextureMemory=6]="RenderTextureMemory",P[P.BufferMemory=7]="BufferMemory";class Stat{static show(e=0,t=0,r=Stat.AllShow){Stat._currentShowArray=r,Stat._StatRender.show(e,t,r)}static showToggle(e=0,t=0,r=Stat.AllToggle){Stat._currentToggleArray=r,Stat._StatRender.showToggle(e,t,r)}static setStat(e,t){Stat[e]||(Stat[e]=0),Stat[e]+=t}static enable(){Stat._StatRender.enable()}static hide(){Stat._StatRender.hide()}static updateEngineData(){Stat.trianglesFaces=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.Triangle),Stat.drawCall=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.DrawCall),Stat.instanceDrawCall=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall),Stat.gpuMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.GPUMemory),Stat.textureMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory),Stat.renderTextureMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory),Stat.bufferMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.BufferMemory)}static clear(){Stat._currentShowArray&&(Stat._currentShowArray.forEach((e=>{"average"==e.mode&&(Stat[e.value]=0)})),LayaGL.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.Triangle),LayaGL.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.DrawCall),LayaGL.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall))}static set onclick(e){Stat._StatRender.set_onclick(e)}}Stat.FPSStatUIParams={title:"FPS(WebGL)",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},Stat.NodeStatUIParams={title:"NodeNums",value:"spriteCount",color:"white",units:"int",mode:"summit"},Stat.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},Stat.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},Stat.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},Stat.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},Stat.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},Stat.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},Stat.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},Stat.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},Stat.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},Stat.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},Stat.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},Stat.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},Stat.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},Stat.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},Stat.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},Stat.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},Stat.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},Stat.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},Stat.AllShow=[Stat.FPSStatUIParams,Stat.NodeStatUIParams,Stat.Sprite3DStatUIParams,Stat.DrawCall,Stat.TriangleFace,Stat.RenderNode,Stat.SkinRenderNode,Stat.ParticleRenderNode,Stat.FrustumCulling,Stat.OpaqueDrawCall,Stat.TransDrawCall,Stat.DepthCastDrawCall,Stat.InstanceDrawCall,Stat.CMDDrawCall,Stat.BlitDrawCall,Stat.GPUMemory,Stat.TextureMemeory,Stat.RenderTextureMemory,Stat.BufferMemory],Stat.memoryShow=[Stat.GPUMemory,Stat.TextureMemeory,Stat.RenderTextureMemory,Stat.BufferMemory],Stat.renderShow=[Stat.DrawCall,Stat.TriangleFace,Stat.OpaqueDrawCall,Stat.TransDrawCall,Stat.DepthCastDrawCall,Stat.InstanceDrawCall,Stat.CMDDrawCall,Stat.BlitDrawCall],Stat.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},Stat.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},Stat.toogle_Light={title:"Light",value:"enableLight",color:"white"},Stat.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},Stat.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},Stat.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},Stat.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},Stat.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},Stat.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},Stat.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},Stat.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},Stat.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},Stat.AllToggle=[Stat.toogle_Shadow,Stat.toogle_Light,Stat.toogle_MulLight,Stat.toogle_Postprocess,Stat.toogle_AnimatorUpdate,Stat.toogle_PhysicsUpdate,Stat.toogle_Opaque,Stat.toogle_Transparent,Stat.toogle_CameraCMD,Stat.toogle_Skin,Stat.toogle_Particle,Stat.toogle_msaa],Stat.RenderModeToggle=[Stat.toogle_Shadow,Stat.toogle_Light,Stat.toogle_MulLight,Stat.toogle_Postprocess,Stat.toogle_AnimatorUpdate,Stat.toogle_PhysicsUpdate],Stat.RenderFuncToggle=[Stat.toogle_Opaque,Stat.toogle_Transparent,Stat.toogle_CameraCMD,Stat.toogle_Skin,Stat.toogle_Particle,Stat.toogle_msaa],Stat.FPS=0,Stat.loopCount=0,Stat.spriteRenderUseCacheCount=0,Stat.canvasNormal=0,Stat.canvasBitmap=0,Stat.canvasReCache=0,Stat.renderSlow=!1,Stat._fpsData=[],Stat._timer=0,Stat._count=0,Stat._fpsStr="",Stat.spriteCount=0,Stat.sprite3DCount=0,Stat.drawCall=0,Stat.trianglesFaces=0,Stat.renderNode=0,Stat.skinRenderNode=0,Stat.particleRenderNode=0,Stat.frustumCulling=0,Stat.uniformUpload=0,Stat.opaqueDrawCall=0,Stat.transDrawCall=0,Stat.depthCastDrawCall=0,Stat.instanceDrawCall=0,Stat.cmdDrawCall=0,Stat.blitDrawCall=0,Stat.textureMemory=0,Stat.renderTextureMemory=0,Stat.bufferMemory=0,Stat.enableShadow=!0,Stat.enableMulLight=!0,Stat.enableLight=!0,Stat.enableCameraCMD=!0,Stat.enablePostprocess=!0,Stat.enableSkin=!0,Stat.enableTransparent=!0,Stat.enableParticle=!0,Stat.enableAnimatorUpdate=!0,Stat.enablePhysicsUpdate=!0,Stat.enablemsaa=!0,Stat.enableOpaque=!0,window.Stat=Stat;class SubmitBase{static __init__(){var e=SubmitBase.RENDERBASE=new SubmitBase(-1);e.shaderValue=new Value2D(0,0),e.shaderValue.ALPHA=1,e._ref=4294967295}constructor(e=SubmitBase.TYPE_2D){this.clipInfoID=-1,this._mesh=null,this._blendFn=null,this._id=0,this._renderType=0,this._parent=null,this._key=new SubmitKey,this._startIdx=0,this._numEle=0,this._ref=1,this.shaderValue=null,this._renderType=e,this._id=++SubmitBase.ID}getID(){return this._id}getRenderType(){return this._renderType}toString(){return"ibindex:"+this._startIdx+" num:"+this._numEle+" key="+this._key}renderSubmit(){return 1}releaseRender(){}}SubmitBase.TYPE_2D=1e4,SubmitBase.TYPE_CANVAS=10003,SubmitBase.TYPE_CMDSETRT=10004,SubmitBase.TYPE_CUSTOM=10005,SubmitBase.TYPE_BLURRT=10006,SubmitBase.TYPE_CMDDESTORYPRERT=10007,SubmitBase.TYPE_DISABLESTENCIL=10008,SubmitBase.TYPE_OTHERIBVB=10009,SubmitBase.TYPE_PRIMITIVE=10010,SubmitBase.TYPE_RT=10011,SubmitBase.TYPE_BLUR_RT=10012,SubmitBase.TYPE_TARGET=10013,SubmitBase.TYPE_CHANGE_VALUE=10014,SubmitBase.TYPE_SHAPE=10015,SubmitBase.TYPE_TEXTURE=10016,SubmitBase.TYPE_FILLTEXTURE=10017,SubmitBase.KEY_ONCE=-1,SubmitBase.KEY_FILLRECT=1,SubmitBase.KEY_DRAWTEXTURE=2,SubmitBase.KEY_VG=3,SubmitBase.KEY_TRIANGLES=4,SubmitBase.ID=1,SubmitBase.preRender=null,e.RenderParams=void 0,(F=e.RenderParams||(e.RenderParams={}))[F.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",F[F.Max_Uniform_Count=1]="Max_Uniform_Count",F[F.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",F[F.MAX_Texture_Size=3]="MAX_Texture_Size",F[F.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",F[F.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",F[F.FLOAT=6]="FLOAT",F[F.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",F[F.BYTE=8]="BYTE",F[F.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class VertexElementFormat{static __init__(){VertexElementFormat._elementInfos={single:[1,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector2:[2,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector3:[3,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector4:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],color:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],byte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte3:[3,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte:[1,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],short2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],short4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],halfvector4:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],nbyte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.BYTE),1]}}static getElementInfos(e){var t=VertexElementFormat._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}VertexElementFormat.Single="single",VertexElementFormat.Vector2="vector2",VertexElementFormat.Vector3="vector3",VertexElementFormat.Vector4="vector4",VertexElementFormat.Color="color",VertexElementFormat.Byte4="byte4",VertexElementFormat.Byte3="byte3",VertexElementFormat.Byte2="byte2",VertexElementFormat.ByteOne="byte",VertexElementFormat.Short2="short2",VertexElementFormat.Short4="short4",VertexElementFormat.NormalizedShort2="normalizedshort2",VertexElementFormat.NormalizedShort4="normalizedshort4",VertexElementFormat.HalfVector2="halfvector2",VertexElementFormat.HalfVector4="halfvector4",VertexElementFormat.NorByte4="nbyte4";class VertexDeclaration{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(e,t){this._id=++VertexDeclaration._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t;var r=t.length;this._shaderValues={};for(var i=0;i<r;i++){var a=t[i],s=a._elementUsage;this._vertexElementsDic[s]=a;var n=new Int32Array(5),o=VertexElementFormat.getElementInfos(a._elementFormat);n[0]=o[0],n[1]=o[1],n[2]=o[2],n[3]=this._vertexStride,n[4]=a._offset,this._shaderValues[s]=n}}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}VertexDeclaration._uniqueIDCounter=1;class VertexElement{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(e,t,r){this._offset=e,this._elementFormat=t,this._elementUsage=r}}e.BufferTargetType=void 0,(U=e.BufferTargetType||(e.BufferTargetType={}))[U.ARRAY_BUFFER=0]="ARRAY_BUFFER",U[U.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",U[U.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",U[U.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",U[U.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",U[U.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",U[U.PIXEL_PACK_BUFFER=6]="PIXEL_PACK_BUFFER",U[U.PIXEL_UNPACK_BUFFER=7]="PIXEL_UNPACK_BUFFER",e.BufferUsage=void 0,(N=e.BufferUsage||(e.BufferUsage={}))[N.Static=0]="Static",N[N.Dynamic=1]="Dynamic",N[N.Stream=2]="Stream";class BufferState{constructor(){this._nativeVertexArrayObject=LayaGL.renderEngine.createVertexState()}applyVertexBuffers(){this._nativeVertexArrayObject.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._nativeVertexArrayObject.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this._vertexBuffers=e,this._bindedIndexBuffer=t,t&&t.unbind(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t.unbind()}bind(){this._nativeVertexArrayObject.bindVertexArray(),BufferState._curBindedBufferState=this}unBind(){if(BufferState._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._nativeVertexArrayObject.unbindVertexArray(),BufferState._curBindedBufferState=null}isbind(){return BufferState._curBindedBufferState==this}static clearbindBufferState(){LayaGL.renderEngine.unbindVertexState(),BufferState._curBindedBufferState=null}destroy(){this._nativeVertexArrayObject.destroy(),this._nativeVertexArrayObject=null}}e.IndexFormat=void 0,(O=e.IndexFormat||(e.IndexFormat={}))[O.UInt8=0]="UInt8",O[O.UInt16=1]="UInt16",O[O.UInt32=2]="UInt32";class Buffer{get bufferUsage(){return this._bufferUsage}constructor(e,t){this._byteLength=0,this._glBuffer=LayaGL.renderEngine.createBuffer(e,t),this._bufferType=e,this._bufferUsage=t}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}class IndexBuffer extends Buffer{constructor(t,r){super(t,r),this._indexType=e.IndexFormat.UInt16}_setIndexData(e,t){var r=BufferState._curBindedBufferState;r?r._bindedIndexBuffer===this?this._glBuffer.setDataLength(0):(r.unBind(),this.bind(),"number"==typeof e?this._glBuffer.setDataLength(e):this._glBuffer.setData(e,t),r.bind()):(this.bind(),"number"==typeof e?this._glBuffer.setDataLength(e):this._glBuffer.setData(e,t))}}class RenderInfo{}RenderInfo.loopStTm=0,RenderInfo.loopCount=0;class Buffer2D{get bufferLength(){return this.constBuffer._buffer.byteLength}set byteLength(e){this.setByteLength(e)}setByteLength(e){this.constBuffer._byteLength!==e&&(e<=this._bufferSize||this._resizeBuffer(2*e+256,!0),this.constBuffer._byteLength=e)}needSize(e){var t=this.constBuffer._byteLength;if(e){var r=this.constBuffer._byteLength+e;r<=this._bufferSize||this._resizeBuffer(r<<1,!0),this.constBuffer._byteLength=r}return t}constructor(e){this._maxsize=0,this._upload=!0,this._uploadSize=0,this._bufferSize=0,this._u8Array=null,this.constBuffer=e}getFloat32Array(){return this._floatArray32||(this._floatArray32=new Float32Array(this.constBuffer._buffer.buffer)),this._floatArray32}_bufferData(){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),RenderInfo.loopCount%30==0){if(this.constBuffer._buffer.byteLength>this._maxsize+64){this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse();let e=this.constBuffer._buffer.buffer;this._bufferSize%4==0&&(this._floatArray32=new Float32Array(e)),this._bufferSize%4==0&&(this._uint32Array=new Uint32Array(e)),this._uint16Array=new Uint16Array(e)}this._maxsize=this.constBuffer._byteLength}this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),this.constBuffer._glBuffer.setData(new Uint8Array(this.constBuffer._buffer.buffer,0,this.constBuffer._byteLength),0),this.constBuffer.unbind()}_bufferSubData(e=0,t=0,r=0){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),RenderInfo.loopCount%30==0&&(this.constBuffer._buffer.byteLength>this._maxsize+64&&(this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse()),this._maxsize=this.constBuffer._byteLength),this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),t||r){var i=this.constBuffer._buffer.buffer.slice(t,r);this.constBuffer._glBuffer.setData(i,e)}else this.constBuffer._glBuffer.setData(this.constBuffer._buffer.buffer,e)}_checkArrayUse(){}_bind_upload(){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferData(),!0)}_bind_subUpload(e=0,t=0,r=0){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferSubData(e,t,r),!0)}_resizeBuffer(e,t){var r=this.constBuffer._buffer;if(r&&e<=r.byteLength)return this;if(this._u8Array,t&&r&&r.byteLength>0){var i=new Uint8Array(r.buffer),a=new Uint8Array(e);a.set(i,0),r=this.constBuffer._buffer=a,this._u8Array=new Uint8Array(this.constBuffer._buffer.buffer)}else{var s=new ArrayBuffer(e);r=this.constBuffer._buffer=new Uint8Array(s),this._u8Array=new Uint8Array(r.buffer)}return r=this.constBuffer._buffer.buffer,e%4==0&&(this._floatArray32=new Float32Array(r)),e%4==0&&(this._uint32Array=new Uint32Array(r)),this._uint16Array=new Uint16Array(r),this._checkArrayUse(),this._upload=!0,this._bufferSize=r.byteLength,this}append(e){var t,r;this._upload=!0,t=e.byteLength,e instanceof Uint8Array?(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Uint8Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):e instanceof Uint16Array?(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):e instanceof Float32Array&&(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Float32Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)),r.set(e,0),this.constBuffer._byteLength+=t,this._checkArrayUse()}appendU16Array(e,t){this._resizeBuffer(this.constBuffer._byteLength+2*t,!0);var r=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength,t);if(6==t)r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5];else if(t>=100)r.set(new Uint16Array(e.buffer,0,t));else for(var i=0;i<t;i++)r[i]=e[i];this.constBuffer._byteLength+=2*t,this._checkArrayUse()}getBuffer(){return this.constBuffer._buffer.buffer}setNeedUpload(){this._upload=!0}subUpload(e=0,t=0,r=0){var i=this._bind_subUpload();return this.constBuffer.unbind(),BaseShader.activeShader=null,i}_disposeResource(){this._upload=!0,this._uploadSize=0,this._floatArray32=null,this._uint32Array=null,this._u8Array=null}clear(){this.constBuffer._byteLength=0,this._upload=!0}}Buffer2D.FLOAT32=4,Buffer2D.SHORT=2;class IndexBuffer2D extends IndexBuffer{constructor(t=e.BufferUsage.Static){super(e.BufferTargetType.ELEMENT_ARRAY_BUFFER,t),this.buffer2D=new Buffer2D(this),this._bufferUsage=t,this._buffer=new Uint8Array(8)}_bindForVAO(){this._glBuffer.bindBuffer()}destory(){this._uint16Array=null,this._buffer=null}disposeResource(){this.buffer2D._disposeResource()}}IndexBuffer2D.create=function(t=e.BufferUsage.Static){return new IndexBuffer2D(t)};class VertexBuffer extends Buffer{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(e){this._instanceBuffer=e}constructor(e,t){super(e,t),this._instanceBuffer=!1,this._vertexDeclaration=null}}class VertexBuffer2D extends VertexBuffer{get vertexStride(){return this._vertexStride}constructor(t,r){super(e.BufferTargetType.ARRAY_BUFFER,r),this.buffer2D=new Buffer2D(this),this._vertexStride=t,this._bufferUsage=r}getFloat32Array(){return this.buffer2D._floatArray32}get _floatArray32(){return this.buffer2D._floatArray32}get _uint32Array(){return this.buffer2D._uint32Array}appendArray(e){var t=this._byteLength>>2;this.buffer2D.setByteLength(this._byteLength+4*e.length),this.getFloat32Array().set(e,t),this.buffer2D._upload=!0}deleteBuffer(){this.buffer2D._disposeResource()}_bindForVAO(){this._glBuffer.bindBuffer()}destroy(){super.destroy(),this._byteLength=0,this.buffer2D._upload=!0,this._buffer=null}}VertexBuffer2D.create=function(t,r=e.BufferUsage.Dynamic){return new VertexBuffer2D(t,r)};class Mesh2D{constructor(t,r,i){this._stride=0,this.vertNum=0,this.indexNum=0,this._applied=!1,this._quadNum=0,this.canReuse=!1,this._stride=t,this._vb=new VertexBuffer2D(t,e.BufferUsage.Dynamic),r?this._vb.buffer2D._resizeBuffer(r,!1):Config.webGL2D_MeshAllocMaxMem&&this._vb.buffer2D._resizeBuffer(65536*t,!1),this._ib=new IndexBuffer2D,i&&this._ib.buffer2D._resizeBuffer(i,!1)}createQuadIB(e){this._quadNum=e,this._ib.buffer2D._resizeBuffer(6*e*2,!1),this._ib.buffer2D.byteLength=this._ib.buffer2D.bufferLength;for(var t=this._ib.buffer2D._uint16Array,r=0,i=0,a=0;a<e;a++)t[r++]=i,t[r++]=i+2,t[r++]=i+1,t[r++]=i,t[r++]=i+3,t[r++]=i+2,i+=4;this._ib.buffer2D.setNeedUpload()}setAttributes(e){if(this._attribInfo=e,this._attribInfo.length%3!=0)throw"Mesh2D setAttributes error!"}configVAO(){this._applied||(this._applied=!0,this._vao||(this._vao=new BufferState),this._vao.applyState([this._vb],this._ib))}useMesh(){(this._vao&&!this._vao.isbind()||this._ib.buffer2D._upload||this._vb.buffer2D._upload)&&BufferState._curBindedBufferState&&BufferState._curBindedBufferState.unBind(),this._applied||this.configVAO(),this._ib.buffer2D._bind_upload(),this._vb.buffer2D._bind_upload(),this._vao.bind()}releaseMesh(){}destroy(){}clearVB(){this._vb.buffer2D.clear()}}Mesh2D._gvaoid=0;class MeshQuadTexture extends Mesh2D{static __int__(){MeshQuadTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(MeshQuadTexture.const_stride,4,4),this.canReuse=!0,this.setAttributes(MeshQuadTexture._fixattriInfo),MeshQuadTexture._fixib?(this._ib=MeshQuadTexture._fixib,this._quadNum=MeshQuadTexture._maxIB):(this.createQuadIB(MeshQuadTexture._maxIB),MeshQuadTexture._fixib=this._ib),MeshQuadTexture.VertexDeclarition||(MeshQuadTexture.VertexDeclarition=new VertexDeclaration(24,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Byte4,1),new VertexElement(20,VertexElementFormat.Byte4,2)])),this._vb.vertexDeclaration=MeshQuadTexture.VertexDeclarition}static getAMesh(e){var t=null;return t=MeshQuadTexture._POOL.length?MeshQuadTexture._POOL.pop():new MeshQuadTexture,e&&t._vb.buffer2D._resizeBuffer(65536*MeshQuadTexture.const_stride,!1),t}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshQuadTexture._POOL.push(this)}destroy(){this._vb.destroy(),this._vb.deleteBuffer()}addQuad(e,t,r,i){var a=this._vb,s=a._byteLength>>2;a.buffer2D.setByteLength(s+MeshQuadTexture.const_stride<<2);var n=a._floatArray32||a.getFloat32Array(),o=a._uint32Array,l=s,h=i?255:0;n[l++]=e[0],n[l++]=e[1],n[l++]=t[0],n[l++]=t[1],o[l++]=r,o[l++]=h,n[l++]=e[2],n[l++]=e[3],n[l++]=t[2],n[l++]=t[3],o[l++]=r,o[l++]=h,n[l++]=e[4],n[l++]=e[5],n[l++]=t[4],n[l++]=t[5],o[l++]=r,o[l++]=h,n[l++]=e[6],n[l++]=e[7],n[l++]=t[6],n[l++]=t[7],o[l++]=r,o[l++]=h,a.buffer2D._upload=!0}}MeshQuadTexture.const_stride=24,MeshQuadTexture._maxIB=16384,MeshQuadTexture._POOL=[];class MeshTexture extends Mesh2D{static __init__(){MeshTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(MeshTexture.const_stride,4,4),this.canReuse=!0,this.setAttributes(MeshTexture._fixattriInfo),MeshTexture.VertexDeclarition||(MeshTexture.VertexDeclarition=new VertexDeclaration(24,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Byte4,1),new VertexElement(20,VertexElementFormat.Byte4,2)])),this._vb.vertexDeclaration=MeshTexture.VertexDeclarition}static getAMesh(e){var t;return t=MeshTexture._POOL.length?MeshTexture._POOL.pop():new MeshTexture,e&&t._vb.buffer2D._resizeBuffer(65536*MeshTexture.const_stride,!1),t}addData(e,t,r,i,a){var s=this._vb,n=this._ib,o=e.length>>1,l=s.buffer2D.needSize(o*MeshTexture.const_stride)>>2,h=s._floatArray32||s.getFloat32Array(),u=s._uint32Array,d=0,_=i.a,c=i.b,m=i.c,p=i.d,f=i.tx,g=i.ty,T=0;for(T=0;T<o;T++){var x=e[d],S=e[d+1];h[l]=x*_+S*m+f,h[l+1]=x*c+S*p+g,h[l+2]=t[d],h[l+3]=t[d+1],u[l+4]=a,u[l+5]=255,l+=6,d+=2}s.buffer2D.setNeedUpload();var y=this.vertNum,E=r.length,C=n.buffer2D.needSize(r.byteLength),v=n.buffer2D._uint16Array,R=C>>1;if(y>0){var b=R+E,D=0;for(T=R;T<b;T++,D++)v[T]=r[D]+y}else v.set(r,R);n.buffer2D.setNeedUpload(),this.vertNum+=o,this.indexNum+=r.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshTexture._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}MeshTexture.const_stride=24,MeshTexture._POOL=[];class MeshVG extends Mesh2D{static __init__(){MeshVG._fixattriInfo=[5126,2,0,5121,4,8]}constructor(){super(MeshVG.const_stride,4,4),this.canReuse=!0,this.setAttributes(MeshVG._fixattriInfo),MeshVG.vertexDeclaration||(MeshVG.vertexDeclaration=new VertexDeclaration(12,[new VertexElement(0,VertexElementFormat.Vector2,0),new VertexElement(8,VertexElementFormat.Byte4,1)])),this._vb.vertexDeclaration=MeshVG.vertexDeclaration}static getAMesh(e){var t;return t=MeshVG._POOL.length?MeshVG._POOL.pop():new MeshVG,e&&t._vb.buffer2D._resizeBuffer(65536*MeshVG.const_stride,!1),t}addVertAndIBToMesh(e,t,r,i){for(var a=this._vb.buffer2D.needSize(t.length/2*MeshVG.const_stride)>>2,s=this._vb._floatArray32||this._vb.getFloat32Array(),n=this._vb._uint32Array,o=0,l=t.length/2,h=0;h<l;h++)s[a++]=t[o],s[a++]=t[o+1],o+=2,n[a++]=r;this._vb.buffer2D.setNeedUpload(),this._ib.buffer2D.append(new Uint16Array(i)),this._ib.buffer2D.setNeedUpload(),this.vertNum+=l,this.indexNum+=i.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshVG._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}MeshVG.const_stride=12,MeshVG._POOL=[],MeshVG.vertexDeclaration=null;class NativeWebGLCacheAsNormalCanvas{constructor(e,t){this._context=e,this._nativeObj=new window._conchWebGLCacheAsNormalCanvas(e._nativeObj,0)}startRec(){this._nativeObj.startRec()}endRec(){this._nativeObj.endRec()}isCacheValid(){return this._nativeObj.isCacheValid()}isTextNeedRestore(){return this._nativeObj.isTextNeedRestore()}get context(){return this._context}}class WebGLCacheAsNormalCanvas{constructor(e,t){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new Matrix,this.oldTx=0,this.oldTy=0,this.invMat=new Matrix,this.context=e,this.sprite=t,e._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){let e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e)),e._incache=!0,this.touches.length=0,e.touches=this.touches,e._globalClipMatrix.copyTo(this.cachedClipInfo),this.submits.length=0,this.submitStartPos=e._submits._length;for(var t=0,r=this.meshlist.length;t<r;t++){var i=this.meshlist[t];i.canReuse?i.releaseMesh():i.destroy()}this.meshlist.length=0,this._mesh=MeshQuadTexture.getAMesh(!1),this._pathMesh=MeshVG.getAMesh(!1),this._triangleMesh=MeshTexture.getAMesh(!1),this.meshlist.push(this._mesh),this.meshlist.push(this._pathMesh),this.meshlist.push(this._triangleMesh),e._curSubmit=SubmitBase.RENDERBASE,this._oldMesh=e._mesh,this._oldPathMesh=e._pathMesh,this._oldTriMesh=e._triangleMesh,this._oldMeshList=e.meshlist,e._mesh=this._mesh,e._pathMesh=this._pathMesh,e._triangleMesh=this._triangleMesh,e.meshlist=this.meshlist,this.oldTx=e._curMat.tx,this.oldTy=e._curMat.ty,e._curMat.tx=0,e._curMat.ty=0,e._curMat.copyTo(this.invMat),this.invMat.invert()}endRec(){let e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e));var t=e._submits;this.submitEndPos=t._length;for(var r=this.submitEndPos-this.submitStartPos,i=0;i<r;i++)this.submits.push(t[this.submitStartPos+i]);t._length-=r,e._mesh=this._oldMesh,e._pathMesh=this._oldPathMesh,e._triangleMesh=this._oldTriMesh,e.meshlist=this._oldMeshList,e._curSubmit=SubmitBase.RENDERBASE,e._curMat.tx=this.oldTx,e._curMat.ty=this.oldTy,e.touches=null,e._incache=!1}isCacheValid(){var e=this.context._globalClipMatrix;return e.a==this.cachedClipInfo.a&&e.b==this.cachedClipInfo.b&&e.c==this.cachedClipInfo.c&&e.d==this.cachedClipInfo.d&&e.tx==this.cachedClipInfo.tx&&e.ty==this.cachedClipInfo.ty}isTextNeedRestore(){var e=!1,t=this.touches;if(t)for(var r=0;r<t.length;r++)if(t[r].deleted){e=!0;break}return e}flushsubmit(){var e=SubmitBase.RENDERBASE;this.submits.forEach((function(t){t!=SubmitBase.RENDERBASE&&(SubmitBase.preRender=e,e=t,t.renderSubmit())}))}releaseMem(){}}WebGLCacheAsNormalCanvas.matI=new Matrix,window.conch&&!window.conchConfig.conchWebGL&&(WebGLCacheAsNormalCanvas=NativeWebGLCacheAsNormalCanvas);class LayaGLQuickRunner{static __init__(){LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_transform_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.transform_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.CHILDS]=LayaGLQuickRunner.transform_drawNodes,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_transform_drawTexture,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_drawTexture,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.transform_drawTexture,LayaGLQuickRunner.map[SpriteConst.GRAPHICS|SpriteConst.CHILDS]=LayaGLQuickRunner.drawLayaGL_drawNodes}static transform_drawTexture(e,t,r,i){e._style;var a=e.texture;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,i);var s=e._isWidthSet?e._width:a.sourceWidth,n=e._isHeightSet?e._height:a.sourceHeight,o=s/a.sourceWidth,l=n/a.sourceHeight;if(s=a.width*o,n=a.height*l,s<=0||n<=0)return null;var h=-e.pivotX+a.offsetX*o,u=-e.pivotY+a.offsetY*l;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(a,h,u,s,n),t.restoreTransform(LayaGLQuickRunner.curMat)}static alpha_drawTexture(e,t,r,i){var a,s=e._style,n=e.texture;if((a=s.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=a;var l=e._isWidthSet?e._width:n.sourceWidth,h=e._isHeightSet?e._height:n.sourceHeight,u=l/n.sourceWidth,d=h/n.sourceHeight;if(l=n.width*u,h=n.height*d,l<=0||h<=0)return null;var _=r-s.pivotX+n.offsetX*u,c=i-s.pivotY+n.offsetY*d;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(n,_,c,l,h),t.globalAlpha=o}}static alpha_transform_drawTexture(e,t,r,i){var a,s=e._style,n=e.texture;if((a=s.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=a,t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,i);var l=e._isWidthSet?e._width:n.sourceWidth,h=e._isHeightSet?e._height:n.sourceHeight,u=l/n.sourceWidth,d=h/n.sourceHeight;if(l=n.width*u,h=n.height*d,l<=0||h<=0)return null;var _=-s.pivotX+n.offsetX*u,c=-s.pivotY+n.offsetY*d;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(n,_,c,l,h),t.restoreTransform(LayaGLQuickRunner.curMat),t.globalAlpha=o}}static alpha_transform_drawLayaGL(e,t,r,i){var a,s=e._style;if((a=s.alpha)>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=a,t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,i),e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-s.pivotX,-s.pivotY),t.restoreTransform(LayaGLQuickRunner.curMat),t.globalAlpha=n}}static alpha_drawLayaGL(e,t,r,i){var a,s=e._style;if((a=s.alpha)>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=a,e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r-s.pivotX,i-s.pivotY),t.globalAlpha=n}}static transform_drawLayaGL(e,t,r,i){var a=e._style;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,i),e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-a.pivotX,-a.pivotY),t.restoreTransform(LayaGLQuickRunner.curMat)}static transform_drawNodes(e,t,r,i){var a=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);let s=t._drawingToTexture;var n=e._style;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,i),r=-n.pivotX,i=-n.pivotY;var o=e._children,l=o.length;let h,u,d,_,c,m,p;n.viewport&&(h=n.viewport,u=h.x,d=h.y,_=h.right,c=h.bottom);for(let e=0;e<l;++e){let a,n=o[e];a=s?n._visible&&!n._getBit(NodeFlags.ESCAPE_DRAWING_TO_TEXTURE):n._visible||n._getBit(NodeFlags.DISABLE_VISIBILITY),h&&((m=n._x)>=_||m+n.width<=u||(p=n._y)>=c||p+n.height<=d)&&(a=!1),a&&n.render(t,r,i)}t.restoreTransform(LayaGLQuickRunner.curMat),a&&t.drawCallOptimize(!1)}static drawLayaGL_drawNodes(e,t,r,i){var a=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);let s=t._drawingToTexture;var n=e._style;r-=n.pivotX,i-=n.pivotY,e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r,i);var o=e._children,l=o.length;let h,u,d,_,c,m,p;n.viewport&&(h=n.viewport,u=h.x,d=h.y,_=h.right,c=h.bottom);for(let e=0;e<l;++e){let a,n=o[e];a=s?n._visible&&!n._getBit(NodeFlags.ESCAPE_DRAWING_TO_TEXTURE):n._visible||n._getBit(NodeFlags.DISABLE_VISIBILITY),h&&((m=n._x)>=_||m+n.width<=u||(p=n._y)>=c||p+n.height<=d)&&(a=!1),a&&n.render(t,r,i)}a&&t.drawCallOptimize(!1)}}LayaGLQuickRunner.map=[],LayaGLQuickRunner.curMat=new Matrix;class NativeFilter{constructor(){}get type(){return-1}}NativeFilter.BLUR=16,NativeFilter.COLOR=32,NativeFilter.GLOW=8,NativeFilter._filter=function(t,r,i,a){var s=r,n=this._next;if(n){var o=t.filters,l=o.length;if(1==l&&o[0].type==NativeFilter.COLOR)return r.save(),r.setColorFilter(o[0]),n._fun.call(n,t,r,i,a),void r.restore();var h,u=Value2D.create(ShaderDefines2D.TEXTURE2D,0),d=Point.TEMP,_=s._curMat,c=Matrix.create();_.copyTo(c);var m=0,p=0,f=null,g=t._cacheStyle.filterCache||null;if(g&&0==t.getRepaint()){if((t._isHaveGlowFilter()||!1)&&(m=50,p=25),(h=t.getBounds()).width<=0||h.height<=0)return;h.width+=m+8,h.height+=m+8,h.x-=t.pivotX+4,h.y-=t.pivotY+4,d.x=h.x*c.a+h.y*c.c,d.y=h.y*c.d+h.x*c.b,h.x=d.x,h.y=d.y,d.x=h.width*c.a+h.height*c.c,d.y=h.height*c.d+h.width*c.b,h.width=d.x,h.height=d.y}else{t._isHaveGlowFilter()&&(m=50,p=25),(h=new Rectangle).copyFrom(t.getSelfBounds()),h.x+=t.x,h.y+=t.y,h.x-=t.pivotX+4,h.y-=t.pivotY+4;var T=h.x,x=h.y;if(h.width+=m+8,h.height+=m+8,d.x=h.x*c.a+h.y*c.c,d.y=h.y*c.d+h.x*c.b,h.x=d.x,h.y=d.y,d.x=h.width*c.a+h.height*c.c,d.y=h.height*c.d+h.width*c.b,h.width=d.x,h.height=d.y,h.width<=0||h.height<=0)return;g&&g.destroy(),f=new window.conchRenderTexture2D(LayaGL.renderEngine._nativeObj,h.width,h.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);var S=g=new window.conchRenderTexture2D(LayaGL.renderEngine._nativeObj,h.width,h.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);t._getCacheStyle().filterCache=g,s.pushRT(),s.useRT(f);var y=t.x-T+p,E=t.y-x+p;n._fun.call(n,t,r,y,E),s.useRT(S);for(var C=0;C<l;C++){0!=C&&(s.useRT(f),s.drawTarget(S,0,0,h.width,h.height,Matrix.TEMP.identity(),u,null,BlendMode.TOINT.overlay),s.useRT(S));var v=o[C];switch(v.type){case NativeFilter.BLUR:s.drawTargetBlurFilter(f,0,0,h.width,h.height,v.strength);break;case NativeFilter.GLOW:v._glRender&&v._glRender.render(f,r,h.width,h.height,v);break;case NativeFilter.COLOR:s.setColorFilter(v),s.drawTarget(f,0,0,h.width,h.height,Matrix.EMPTY.identity(),Value2D.create(ShaderDefines2D.TEXTURE2D,0)),s.setColorFilter(null)}}s.popRT()}i=i-p-t.x,a=a-p-t.y,d.setTo(i,a),c.transformPoint(d),i=d.x+h.x,a=d.y+h.y,s.drawFilter(g,f,i,a,h.width,h.height),c.destroy()}};class RenderSprite{static __init__(){var e,t,r;for(LayaGLQuickRunner.__init__(),r=new RenderSprite(69905,null),t=RenderSprite.renders.length=2*SpriteConst.CHILDS,e=0;e<t;e++)RenderSprite.renders[e]=r;RenderSprite.renders[0]=new RenderSprite(0,null)}static _initRenderFun(e,t,r,i){var a=e._renderType;(RenderSprite.renders[a]=RenderSprite._getTypeRender(a))._fun(e,t,r,i)}static _getTypeRender(e){if(LayaGLQuickRunner.map[e]&&LayaEnv.isPlaying)return new RenderSprite(e,null);for(var t=null,r=SpriteConst.CHILDS;r>0;)r&e&&(t=new RenderSprite(r,t)),r>>=1;return t}constructor(e,t){if(LayaGLQuickRunner.map[e]&&LayaEnv.isPlaying)return this._fun=LayaGLQuickRunner.map[e],void(this._next=RenderSprite.NORENDER);switch(this._next=t||RenderSprite.NORENDER,e){case 0:return void(this._fun=this._no);case SpriteConst.ALPHA:return void(this._fun=this._alpha);case SpriteConst.TRANSFORM:return void(this._fun=this._transform);case SpriteConst.BLEND:return void(this._fun=this._blend);case SpriteConst.CANVAS:return void(this._fun=this._canvas);case SpriteConst.MASK:return void(LayaEnv.isConch&&!window.conchConfig.conchWebGL?this._fun=this._maskNative:this._fun=this._mask);case SpriteConst.CLIP:return void(this._fun=this._clip);case SpriteConst.STYLE:return void(this._fun=this._style);case SpriteConst.GRAPHICS:return void(this._fun=this._graphics);case SpriteConst.CHILDS:return void(this._fun=this._children);case SpriteConst.CUSTOM:return void(this._fun=this._custom);case SpriteConst.TEXTURE:return void(this._fun=this._texture);case SpriteConst.FILTERS:return void(LayaEnv.isConch&&!window.conchConfig.conchWebGL?this._fun=NativeFilter._filter:this._fun=Filter._filter);case SpriteConst.HITAREA:return void(this._fun=this._hitarea);case 69905:return void(this._fun=RenderSprite._initRenderFun)}this.onCreate(e)}onCreate(e){}_style(e,t,r,i){}_no(e,t,r,i){}_custom(e,t,r,i){e.customRender(t,r,i),this._next._fun.call(this._next,e,t,0,0)}_clip(e,t,r,i){let a=this._next;if(a==RenderSprite.NORENDER)return;if(e._getBit(NodeFlags.DISABLE_INNER_CLIPPING)&&!t._drawingToTexture)return void a._fun.call(a,e,t,r,i);let s=e._style.scrollRect,n=s.width,o=s.height;0===n&&(n=.001),0===o&&(o=.001),t.save(),t.clipRect(r,i,n,o),a._fun.call(a,e,t,r-s.x,i-s.y),t.restore()}_texture(e,t,r,i){if(!e._getBit(NodeFlags.HIDE_BY_EDITOR)){var a=e.texture;if(a._getSource()){var s=e._isWidthSet?e._width:a.sourceWidth,n=e._isHeightSet?e._height:a.sourceHeight,o=s/a.sourceWidth,l=n/a.sourceHeight;if(s=a.width*o,n=a.height*l,s>0&&n>0){let h=r-e.pivotX+a.offsetX*o,u=i-e.pivotY+a.offsetY*l;t.drawTexture(a,h,u,s,n,4294967295)}}}var h=this._next;h!=RenderSprite.NORENDER&&h._fun.call(h,e,t,r,i)}_graphics(e,t,r,i){if(!e._getBit(NodeFlags.HIDE_BY_EDITOR)){var a=e._style,s=e._graphics;s&&s._render(e,t,r-a.pivotX,i-a.pivotY)}var n=this._next;n!=RenderSprite.NORENDER&&n._fun.call(n,e,t,r,i)}_hitarea(e,t,r,i){if(!t._drawingToTexture&&e.hitArea){var a=e._style,s=e.hitArea._hit,n=t.globalAlpha;t.globalAlpha*=.5,s&&s._render(e,t,r-a.pivotX,i-a.pivotY),(s=e.hitArea._unHit)&&s._render(e,t,r-a.pivotX,i-a.pivotY),t.globalAlpha=n}var o=this._next;o!=RenderSprite.NORENDER&&o._fun.call(o,e,t,r,i)}_alpha(e,t,r,i){var a;if((a=e._style.alpha)>.01||e._needRepaint()){var s=t.globalAlpha;t.globalAlpha*=a;var n=this._next;n._fun.call(n,e,t,r,i),t.globalAlpha=s}}_transform(e,t,r,i){var a=e.transform,s=this._next;a&&s!=RenderSprite.NORENDER?(t.save(),t.transform(a.a,a.b,a.c,a.d,a.tx+r,a.ty+i),s._fun.call(s,e,t,0,0),t.restore()):s!=RenderSprite.NORENDER&&s._fun.call(s,e,t,r,i)}_children(e,t,r,i){let a=e._style,s=e._children,n=s.length;r-=e.pivotX,i-=e.pivotY;let o,l,h,u,d,_,c,m=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),p=t._drawingToTexture;a.viewport&&(o=a.viewport,l=o.x,h=o.y,u=o.right,d=o.bottom);for(let a=0;a<n;++a){let n,m=s[a];n=p?m._visible&&!m._getBit(NodeFlags.ESCAPE_DRAWING_TO_TEXTURE):m._visible||m._getBit(NodeFlags.DISABLE_VISIBILITY),n&&(o&&((_=m._x)>=u||_+m.width<=l||(c=m._y)>=d||c+m.height<=h)?n=!1:e._cacheStyle.mask!=m||m._getBit(NodeFlags.DISABLE_VISIBILITY)||(n=!1)),n&&(m._getBit(NodeFlags.DISABLE_OUTER_CLIPPING)&&t.clipRect(0,0,1,1,!0),m.render(t,r,i))}m&&t.drawCallOptimize(!1)}_canvas(e,t,r,i){var a=e._cacheStyle,s=this._next;if(!a.enableCanvasRender||!t._drawingToTexture&&a.mask&&a.mask._getBit(NodeFlags.DISABLE_VISIBILITY))s._fun.call(s,e,t,r,i);else{"bitmap"===a.cacheAs?Stat.canvasBitmap++:Stat.canvasNormal++;var n=!1,o=!1;if(a.canvas){var l=a.canvas;o=l.isTextNeedRestore&&l.isTextNeedRestore(),n=l.isCacheValid&&!l.isCacheValid()}if(e._needRepaint()||!a.canvas||o||n||ILaya.stage.isGlobalRepaint())if("normal"===a.cacheAs){if(t._targets)return void s._fun.call(s,e,t,r,i);this._canvas_webgl_normal_repaint(e,t)}else this._canvas_repaint(e,t,r,i);var h=a.cacheRect;t.drawCanvas(a.canvas,r+h.x,i+h.y,h.width,h.height)}}_canvas_repaint(e,t,r,i){var a,s,n,o,l,h,u,d,_,c=e._cacheStyle,m=this._next,p=c.canvas,f=c.cacheAs;if(u=(_=c._calculateCacheRect(e,f,r,i)).x,d=_.y,l=(o=c.cacheRect).width*u,h=o.height*d,s=o.x,n=o.y,"bitmap"===f&&(l>2048||h>2048))return console.warn("cache bitmap size larger than 2048, cache ignored"),c.releaseContext(),void m._fun.call(m,e,t,r,i);if(p||(c.createContext(),p=c.canvas),(a=p.context).sprite=e,(p.width!=l||p.height!=h)&&p.size(l,h),"bitmap"===f?a.asBitmap=!0:"normal"===f&&(a.asBitmap=!1),a.clear(),1!=u||1!=d){var g=a;g.save(),g.scale(u,d),m._fun.call(m,e,a,-s,-n),g.restore(),e._applyFilters()}else g=a,m._fun.call(m,e,a,-s,-n),e._applyFilters();c.staticCache&&(c.reCache=!1),Stat.canvasReCache++}_canvas_webgl_normal_repaint(e,t){var r=e._cacheStyle,i=this._next,a=r.canvas,s=r.cacheAs;r._calculateCacheRect(e,s,0,0),a||(a=new WebGLCacheAsNormalCanvas(t,e),r.canvas=a);var n=a.context;a.startRec(),i._fun.call(i,e,n,e.pivotX,e.pivotY),e._applyFilters(),Stat.canvasReCache++,a.endRec()}_blend(e,t,r,i){var a=e._style,s=this._next;a.blendMode?(t.save(),t.globalCompositeOperation=a.blendMode,s._fun.call(s,e,t,r,i),t.restore()):s._fun.call(s,e,t,r,i)}_mask(e,t,r,i){let a=this._next,s=e.mask;if(!s||s._getBit(NodeFlags.DISABLE_VISIBILITY)&&!t._drawingToTexture)a._fun.call(a,e,t,r,i);else{t.save();let n=t.globalCompositeOperation,o=new Rectangle;o.copyFrom(s.getBounds());let l=o.width=Math.round(o.width),h=o.height=Math.round(o.height);if(o.x=Math.round(o.x),o.y=Math.round(o.y),l>0&&h>0){let u=WebGLRTMgr.getRT(l,h);t.breakNextMerge(),t.pushRT(),t.addRenderObject(SubmitCMD.create([t,u,l,h],RenderSprite.tmpTarget,this)),s.render(t,-o.x,-o.y),t.breakNextMerge(),t.popRT(),t.save();let d=.1;t.clipRect(r+o.x-e.getStyle().pivotX+d,i+o.y-e.getStyle().pivotY+d,l-2*d,h-2*d),a._fun.call(a,e,t,r,i),t.restore(),n=t.globalCompositeOperation,t.addRenderObject(SubmitCMD.create(["mask"],RenderSprite.setBlendMode,this));let _=Value2D.create(ShaderDefines2D.TEXTURE2D,0),c=Texture.INV_UV;t.drawTarget(u,r+o.x-e.getStyle().pivotX,i+o.y-e.getStyle().pivotY,l,h,Matrix.TEMP.identity(),_,c,6),t.addRenderObject(SubmitCMD.create([u],RenderSprite.recycleTarget,this))}t.addRenderObject(SubmitCMD.create([n],RenderSprite.setBlendMode,this)),t.restore()}}_maskNative(e,t,r,i){var a=this._next,s=e.mask;if(s){t.save(),t.globalCompositeOperation;var n=new Rectangle;n.copyFrom(s.getBounds());let o=n.width=Math.round(n.width),l=n.height=Math.round(n.height);if(n.x=Math.round(n.x),n.y=Math.round(n.y),o>0&&l>0){let h=t.drawMask(o,l);s.render(t,-n.x,-n.y);let u=.1;t.drawMasked(r+n.x-e.getStyle().pivotX+u,i+n.y-e.getStyle().pivotY+u,o-2*u,l-2*u),a._fun.call(a,e,t,r,i),t.drawMaskComposite(h,r+n.x-e.getStyle().pivotX,i+n.y-e.getStyle().pivotY,o,l)}t.restore()}else a._fun.call(a,e,t,r,i)}static tmpTarget(e,t,r,i){t.start(),t.clear(0,0,0,0)}static recycleTarget(e){WebGLRTMgr.releaseRT(e)}static setBlendMode(e){BlendMode.targetFns[BlendMode.TOINT[e]]()}}RenderSprite.renders=[],RenderSprite.NORENDER=new RenderSprite(0,null);class Bezier{constructor(){this._controlPoints=[new Point,new Point,new Point],this._calFun=this.getPoint2}_switchPoint(e,t){var r=this._controlPoints.shift();r.setTo(e,t),this._controlPoints.push(r)}getPoint2(e,t){var r=this._controlPoints[0],i=this._controlPoints[1],a=this._controlPoints[2],s=Math.pow(1-e,2)*r.x+2*e*(1-e)*i.x+Math.pow(e,2)*a.x,n=Math.pow(1-e,2)*r.y+2*e*(1-e)*i.y+Math.pow(e,2)*a.y;t.push(s,n)}getPoint3(e,t){var r=this._controlPoints[0],i=this._controlPoints[1],a=this._controlPoints[2],s=this._controlPoints[3],n=Math.pow(1-e,3)*r.x+3*i.x*e*(1-e)*(1-e)+3*a.x*e*e*(1-e)+s.x*Math.pow(e,3),o=Math.pow(1-e,3)*r.y+3*i.y*e*(1-e)*(1-e)+3*a.y*e*e*(1-e)+s.y*Math.pow(e,3);t.push(n,o)}insertPoints(e,t){var r,i;for(i=1/(e=e>0?e:5),r=0;r<=1;r+=i)this._calFun(r,t)}getBezierPoints(e,t=5,r=2){var i,a;if((a=e.length)<2*(r+1))return[];var s=[];switch(r){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=r;)this._controlPoints.push(Point.create());for(i=0;i<2*r;i+=2)this._switchPoint(e[i],e[i+1]);for(i=2*r;i<a;i+=2)this._switchPoint(e[i],e[i+1]),i/2%r==0&&this.insertPoints(t,s);return s}}var G,k;Bezier.I=new Bezier,e.BlendEquationSeparate=void 0,(G=e.BlendEquationSeparate||(e.BlendEquationSeparate={}))[G.ADD=0]="ADD",G[G.SUBTRACT=1]="SUBTRACT",G[G.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",G[G.MIN=3]="MIN",G[G.MAX=4]="MAX",e.CullMode=void 0,(k=e.CullMode||(e.CullMode={}))[k.Off=0]="Off",k[k.Front=1]="Front",k[k.Back=2]="Back";class DrawStyle{static create(e){if(e){var t=e instanceof ColorUtils?e:ColorUtils.create(e);return t._drawStyle||(t._drawStyle=new DrawStyle(e))}return DrawStyle.DEFAULT}constructor(e){this.setValue(e)}setValue(e){this._color=e?e instanceof ColorUtils?e:ColorUtils.create(e):ColorUtils.create("#000000")}reset(){this._color=ColorUtils.create("#000000")}toInt(){return this._color.numColor}equal(e){return"string"==typeof e?this._color.strColor===e:e instanceof ColorUtils&&this._color.numColor===e.numColor}toColorStr(){return this._color.strColor}}DrawStyle.DEFAULT=new DrawStyle("#000000");class Path{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(e){this.paths.length=1,this._curPath=this.paths[0]=new renderPath,this._curPath.convex=e}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new renderPath,this.paths.push(this._curPath)}addPoint(e,t){this._curPath.path.push(e,t)}push(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new renderPath,this.paths.push(this._curPath)):(this._curPath=new renderPath,this.paths.push(this._curPath));var r=this._curPath;r.path=e.slice(),r.convex=t}reset(){this.paths.length=0}}class renderPath{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class SaveBase{static _createArray(){var e=[];return e._length=0,e}static _init(){var e=SaveBase._namemap={};return e[SaveBase.TYPE_ALPHA]="ALPHA",e[SaveBase.TYPE_FILESTYLE]="fillStyle",e[SaveBase.TYPE_FONT]="font",e[SaveBase.TYPE_LINEWIDTH]="lineWidth",e[SaveBase.TYPE_STROKESTYLE]="strokeStyle",e[SaveBase.TYPE_ENABLEMERGE]="_mergeID",e[SaveBase.TYPE_MARK]=e[SaveBase.TYPE_TRANSFORM]=e[SaveBase.TYPE_TRANSLATE]=[],e[SaveBase.TYPE_TEXTBASELINE]="textBaseline",e[SaveBase.TYPE_TEXTALIGN]="textAlign",e[SaveBase.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[SaveBase.TYPE_SHADER]="shader",e[SaveBase.TYPE_FILTERS]="filters",e[SaveBase.TYPE_COLORFILTER]="_colorFiler",e}constructor(){}isSaveMark(){return!1}restore(e){this._dataObj[this._valueName]=this._value,SaveBase.POOL[SaveBase.POOL._length++]=this,this._newSubmit&&(e._curSubmit=SubmitBase.RENDERBASE)}static save(e,t,r,i){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var a=SaveBase.POOL,s=a._length>0?a[--a._length]:new SaveBase;s._value=r[s._valueName=SaveBase._namemap[t]],s._dataObj=r,s._newSubmit=i;var n=e._save;n[n._length++]=s}}}SaveBase.TYPE_ALPHA=1,SaveBase.TYPE_FILESTYLE=2,SaveBase.TYPE_FONT=8,SaveBase.TYPE_LINEWIDTH=256,SaveBase.TYPE_STROKESTYLE=512,SaveBase.TYPE_MARK=1024,SaveBase.TYPE_TRANSFORM=2048,SaveBase.TYPE_TRANSLATE=4096,SaveBase.TYPE_ENABLEMERGE=8192,SaveBase.TYPE_TEXTBASELINE=16384,SaveBase.TYPE_TEXTALIGN=32768,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION=65536,SaveBase.TYPE_CLIPRECT=131072,SaveBase.TYPE_CLIPRECT_STENCIL=262144,SaveBase.TYPE_IBVB=524288,SaveBase.TYPE_SHADER=1048576,SaveBase.TYPE_FILTERS=2097152,SaveBase.TYPE_FILTERS_TYPE=4194304,SaveBase.TYPE_COLORFILTER=8388608,SaveBase.POOL=SaveBase._createArray(),SaveBase._namemap=SaveBase._init();class SaveClipRect{constructor(){this._globalClipMatrix=new Matrix,this._clipInfoID=-1,this._clipRect=new Rectangle,this.incache=!1}isSaveMark(){return!1}restore(e){this._globalClipMatrix.copyTo(e._globalClipMatrix),this._clipRect.clone(e._clipRect),e._clipInfoID=this._clipInfoID,SaveClipRect.POOL[SaveClipRect.POOL._length++]=this,e._clipInCache=this.incache}static save(e){if((e._saveMark._saveuse&SaveBase.TYPE_CLIPRECT)!=SaveBase.TYPE_CLIPRECT){e._saveMark._saveuse|=SaveBase.TYPE_CLIPRECT;var t=SaveClipRect.POOL,r=t._length>0?t[--t._length]:new SaveClipRect;e._globalClipMatrix.copyTo(r._globalClipMatrix),e._clipRect.clone(r._clipRect),r._clipInfoID=e._clipInfoID,r.incache=e._clipInCache;var i=e._save;i[i._length++]=r}}}SaveClipRect.POOL=SaveBase._createArray();class SaveMark{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(e){e._saveMark=this._preSaveMark,SaveMark.POOL[SaveMark.POOL._length++]=this}static Create(e){var t=SaveMark.POOL,r=t._length>0?t[--t._length]:new SaveMark;return r._saveuse=0,r._preSaveMark=e._saveMark,e._saveMark=r,r}}SaveMark.POOL=SaveBase._createArray();class SaveTransform{constructor(){this._matrix=new Matrix}isSaveMark(){return!1}restore(e){e._curMat=this._savematrix,SaveTransform.POOL[SaveTransform.POOL._length++]=this}static save(e){var t=e._saveMark;if((t._saveuse&SaveBase.TYPE_TRANSFORM)!==SaveBase.TYPE_TRANSFORM){t._saveuse|=SaveBase.TYPE_TRANSFORM;var r=SaveTransform.POOL,i=r._length>0?r[--r._length]:new SaveTransform;i._savematrix=e._curMat,e._curMat=e._curMat.copyTo(i._matrix);var a=e._save;a[a._length++]=i}}}SaveTransform.POOL=SaveBase._createArray();class SaveTranslate{constructor(){this._mat=new Matrix}isSaveMark(){return!1}restore(e){this._mat.copyTo(e._curMat),SaveTranslate.POOL[SaveTranslate.POOL._length++]=this}static save(e){var t=SaveTranslate.POOL,r=t._length>0?t[--t._length]:new SaveTranslate;e._curMat.copyTo(r._mat);var i=e._save;i[i._length++]=r}}SaveTranslate.POOL=SaveBase._createArray();var V,W,H="/*\n\ttexture和fillrect使用的。\n*/\nattribute vec4 posuv;\nattribute vec4 attribColor;\nattribute vec4 attribFlags;\n//attribute vec4 clipDir;\n//attribute vec2 clipRect;\nuniform vec4 clipMatDir;\nuniform vec2 clipMatPos;\t\t// 这个是全局的，不用再应用矩阵了。\nvarying vec2 cliped;\nuniform vec2 size;\nuniform vec2 clipOff;\t\t\t// 使用要把clip偏移。cacheas normal用. 只用了[0]\n#ifdef WORLDMAT\n\tuniform mat4 mmat;\n#endif\n#ifdef MVP3D\n\tuniform mat4 u_MvpMatrix;\n#endif\nvarying vec4 v_texcoordAlpha;\nvarying vec4 v_color;\nvarying float v_useTex;\n\nvoid main() {\n\n\tvec4 pos = vec4(posuv.xy,0.,1.);\n#ifdef WORLDMAT\n\tpos=mmat*pos;\n#endif\n\tvec4 pos1  =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,0.,1.0);\n#ifdef MVP3D\n\tgl_Position=u_MvpMatrix*pos1;\n#else\n\tgl_Position=pos1;\n#endif\n\tv_texcoordAlpha.xy = posuv.zw;\n\t//v_texcoordAlpha.z = attribColor.a/255.0;\n\tv_color = attribColor/255.0;\n\tv_color.xyz*=v_color.w;//反正后面也要预乘\n\tv_useTex = attribFlags.r/255.0;\n\n\tfloat clipw = length(clipMatDir.xy);\n\tfloat cliph = length(clipMatDir.zw);\n\t\n\tvec2 clpos = clipMatPos.xy;\n\t#ifdef WORLDMAT\n\t\t// 如果有mmat，需要修改clipMatPos,因为 这是cacheas normal （如果不是就错了）， clipMatPos被去掉了偏移\n\t\tif(clipOff[0]>0.0){\n\t\t\tclpos.x+=mmat[3].x;\t//tx\t最简单处理\n\t\t\tclpos.y+=mmat[3].y;\t//ty\n\t\t}\n\t#endif\n\tvec2 clippos = pos.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n\tif(clipw>20000. && cliph>20000.)\n\t\tcliped = vec2(0.5,0.5);\n\telse {\n\t\t//转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\n\t}\n\n\t#ifdef INVERTY\n\t\tgl_Position.y = -gl_Position.y;\n\t#endif\n\n}\n",X="/*\n\ttexture和fillrect使用的。\n*/\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvec3 linearToGamma(in vec3 value)\n{\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\n\n    // return pow(value, vec3(1.0 / 2.2));\n    // return pow(value, vec3(0.455));\n}\n\nvec4 linearToGamma(in vec4 value)\n{\n    return vec4(linearToGamma(value.rgb), value.a);\n}\n\nvec3 gammaToLinear(in vec3 value)\n{\n    // return pow((value + 0.055) / 1.055, vec3(2.4));\n    return pow(value, vec3(2.2));\n}\n\nvec4 gammaToLinear(in vec4 value)\n{\n    return vec4(gammaToLinear(value.rgb), value.a);\n}\n\n\nvarying vec4 v_texcoordAlpha;\nvarying vec4 v_color;\nvarying float v_useTex;\nuniform sampler2D texture;\nvarying vec2 cliped;\n\nvec4 sampleTexture(sampler2D texture, vec2 uv)\n{\n    vec4 color = texture2D(texture, uv);\n#ifdef GAMMASPACE\n    color.xyz = linearToGamma(color.xyz);\n#endif\n    return color;\n}\n\n#ifdef BLUR_FILTER\nuniform vec4 strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\nuniform vec2 blurInfo;\n\n    #define PI 3.141593\n\nfloat getGaussian(float x, float y)\n{\n    return strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / strength_sig2_2sig2_gauss1.z);\n}\n\nvec4 blur()\n{\n    const float blurw = 9.0;\n    vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n    vec2 halfsz = vec2(blurw, blurw) / 2.0 / blurInfo;\n    vec2 startpos = v_texcoordAlpha.xy - halfsz;\n    vec2 ctexcoord = startpos;\n    vec2 step = 1.0 / blurInfo; //每个像素\n\n    for (float y = 0.0; y <= blurw; ++y)\n\t{\n\t    ctexcoord.x = startpos.x;\n\t    for (float x = 0.0; x <= blurw; ++x)\n\t\t{\n\t\t    // TODO 纹理坐标的固定偏移应该在vs中处理\n\t\t    vec4Color += sampleTexture(texture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0);\n\t\t    ctexcoord.x += step.x;\n\t\t}\n\t    ctexcoord.y += step.y;\n\t}\n    // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\n    return vec4Color;\n}\n#endif\n\n#ifdef COLOR_FILTER\nuniform vec4 colorAlpha;\nuniform mat4 colorMat;\n#endif\n\n#ifdef GLOW_FILTER\nuniform vec4 u_color;\nuniform vec4 u_blurInfo1;\nuniform vec4 u_blurInfo2;\n#endif\n\n#ifdef COLOR_ADD\nuniform vec4 colorAdd;\n#endif\n\n#ifdef FILLTEXTURE\nuniform vec4 u_TexRange; // startu,startv,urange, vrange\n#endif\n\nvoid main()\n{\n    if (cliped.x < 0.)\n\tdiscard;\n    if (cliped.x > 1.)\n\tdiscard;\n    if (cliped.y < 0.)\n\tdiscard;\n    if (cliped.y > 1.)\n\tdiscard;\n\n#ifdef FILLTEXTURE\n    vec4 color = sampleTexture(texture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\n#else\n    vec4 color = sampleTexture(texture, v_texcoordAlpha.xy);\n#endif\n\n    if (v_useTex <= 0.)\n        color = vec4(1., 1., 1., 1.);\n\n    color.a *= v_color.w;\n    // color.rgb*=v_color.w;\n    vec4 transColor = v_color;\n    #ifndef GAMMASPACE\n        transColor = gammaToLinear(v_color);\n    #endif\n    color.rgb *= transColor.rgb;\n    gl_FragColor = color;\n\n#ifdef COLOR_ADD\n    gl_FragColor = vec4(colorAdd.rgb, colorAdd.a * gl_FragColor.a);\n    gl_FragColor.xyz *= colorAdd.a;\n#endif\n\n#ifdef BLUR_FILTER\n    gl_FragColor = blur();\n    gl_FragColor.w *= v_color.w;\n#endif\n\n#ifdef COLOR_FILTER\n    mat4 alphaMat = colorMat;\n\n    alphaMat[0][3] *= gl_FragColor.a;\n    alphaMat[1][3] *= gl_FragColor.a;\n    alphaMat[2][3] *= gl_FragColor.a;\n\n    gl_FragColor = gl_FragColor * alphaMat;\n    gl_FragColor += colorAlpha / 255.0 * gl_FragColor.a;\n#endif\n\n#ifdef GLOW_FILTER\n    const float c_IterationTime = 10.0;\n    float floatIterationTotalTime = c_IterationTime * c_IterationTime;\n    vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\n    vec2 vec2FilterDir = vec2(-(u_blurInfo1.z) / u_blurInfo2.x, -(u_blurInfo1.w) / u_blurInfo2.y);\n    vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\n    float maxNum = u_blurInfo1.x * u_blurInfo1.y;\n    vec2 vec2Off = vec2(0.0, 0.0);\n    float floatOff = c_IterationTime / 2.0;\n    for (float i = 0.0; i <= c_IterationTime; ++i)\n\t{\n\t    for (float j = 0.0; j <= c_IterationTime; ++j)\n\t\t{\n\t\t    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\n\t\t    vec4Color += sampleTexture(texture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off) / floatIterationTotalTime;\n\t\t}\n\t}\n    gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\n    gl_FragColor.rgb *= gl_FragColor.a;\n#endif\n}\n",z="attribute vec4 position;\nattribute vec4 attribColor;\n//attribute vec4 clipDir;\n//attribute vec2 clipRect;\nuniform vec4 clipMatDir;\nuniform vec2 clipMatPos;\n#ifdef WORLDMAT\n\tuniform mat4 mmat;\n#endif\nuniform mat4 u_mmat2;\n//uniform vec2 u_pos;\nuniform vec2 size;\nvarying vec4 color;\n//vec4 dirxy=vec4(0.9,0.1, -0.1,0.9);\n//vec4 clip=vec4(100.,30.,300.,600.);\nvarying vec2 cliped;\nvoid main(){\n\t\n#ifdef WORLDMAT\n\tvec4 pos=mmat*vec4(position.xy,0.,1.);\n\tgl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n#else\n\tgl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n#endif\t\n\tfloat clipw = length(clipMatDir.xy);\n\tfloat cliph = length(clipMatDir.zw);\n\tvec2 clippos = position.xy - clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\n\tif(clipw>20000. && cliph>20000.)\n\t\tcliped = vec2(0.5,0.5);\n\telse {\n\t\t//clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\n\t\tcliped=vec2( dot(clippos,clipMatDir.xy)/clipw/clipw, dot(clippos,clipMatDir.zw)/cliph/cliph);\n\t}\n  //pos2d.x = dot(clippos,dirx);\n  color=attribColor/255.;\n}",Y="precision mediump float;\n//precision mediump float;\nvarying vec4 color;\n//uniform float alpha;\nvarying vec2 cliped;\n\nvec3 gammaToLinear(in vec3 value)\n{\n    return pow((value + 0.055) / 1.055, vec3(2.4));\n}\n\nvec4 gammaToLinear(in vec4 value)\n{\n    return vec4(gammaToLinear(value.rgb), value.a);\n}\n\nvoid main(){\n\t//vec4 a=vec4(color.r, color.g, color.b, 1);\n\t//a.a*=alpha;\n\t#ifdef GAMMASPACE\n    \tgl_FragColor= color;// vec4(color.r, color.g, color.b, alpha);\n\t#else\n\t\tgl_FragColor= gammaToLinear(color);\n\t#endif\n\tgl_FragColor.rgb*=color.a;\n\tif(cliped.x<0.) discard;\n\tif(cliped.x>1.) discard;\n\tif(cliped.y<0.) discard;\n\tif(cliped.y>1.) discard;\n}",j="attribute vec2 position;\nattribute vec2 texcoord;\nattribute vec4 color;\nuniform vec2 size;\nuniform float offsetX;\nuniform float offsetY;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nvoid main() {\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  v_color = color;\n  v_color.rgb *= v_color.a;\n  v_texcoord = texcoord;  \n}",K="precision mediump float;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nuniform sampler2D texture;\nuniform float alpha;\n\nvec4 sampleTexture(sampler2D texture,vec2 uv){\n    vec4 color = texture2D(texture,uv);\n    #ifdef GAMMASPACE\n        color.xyz = color.xyz*color.xyz;\n    #endif\n    return color;\n}\n\nvec3 gammaToLinear(in vec3 value)\n{\n    // return pow((value + 0.055) / 1.055, vec3(2.4));\n    return pow(value, vec3(2.2));\n}\n\nvec4 gammaToLinear(in vec4 value)\n{\n    return vec4(gammaToLinear(value.rgb), value.a);\n}\n\nvoid main() {\n    vec4 t_color = sampleTexture(texture, v_texcoord);\n    vec4 transColor = v_color;\n    #ifndef GAMMASPACE\n        transColor = gammaToLinear(v_color);\n    #endif\n    gl_FragColor = t_color.rgba * transColor;\n    gl_FragColor *= alpha;\n}";class Shader2D{constructor(){this.ALPHA=1,this.defines=new ShaderDefines2D,this.shaderType=0,this.fillStyle=DrawStyle.DEFAULT,this.strokeStyle=DrawStyle.DEFAULT}destroy(){this.defines=null,this.filters=null}static __init__(){window.conch&&!window.conchConfig.conchWebGL?(window.preCompile2D(ShaderDefines2D.TEXTURE2D,H,X),window.preCompile2D(ShaderDefines2D.PRIMITIVE,z,Y),window.preCompile2D(ShaderDefines2D.SKINMESH,j,K)):(Shader.preCompile2D(0,ShaderDefines2D.TEXTURE2D,H,X,null),Shader.preCompile2D(0,ShaderDefines2D.PRIMITIVE,z,Y,null),Shader.preCompile2D(0,ShaderDefines2D.SKINMESH,j,K,null))}}class SkinMeshBuffer{constructor(){this.ib=IndexBuffer2D.create(e.BufferUsage.Dynamic),this.vb=VertexBuffer2D.create(8)}static getInstance(){return SkinMeshBuffer.instance=SkinMeshBuffer.instance||new SkinMeshBuffer}addSkinMesh(e){e.getData2(this.vb,this.ib,this.vb._byteLength/32)}reset(){this.vb.buffer2D.clear(),this.ib.buffer2D.clear()}}class BasePoly{static createLine2(e,t,r,i,a,s){if(e.length<4)return null;var n=BasePoly.tempData.length>e.length+2?BasePoly.tempData:new Array(e.length+2);n[0]=e[0],n[1]=e[1];var o=2,l=0,h=e.length;for(l=2;l<h;l+=2)Math.abs(e[l]-e[l-2])+Math.abs(e[l+1]-e[l-1])>.01&&(n[o++]=e[l],n[o++]=e[l+1]);s&&Math.abs(e[0]-n[o-2])+Math.abs(e[1]-n[o-1])>.01&&(n[o++]=e[0],n[o++]=e[1]);var u=a;h=o/2;var d,_,c,m,p,f,g,T,x,S,y,E,C,v,R,b,D,A,M,L,w=r/2;for(c=n[0],m=n[1],S=c-(p=n[2]),x=(x=-(m-(f=n[3])))/(L=Math.sqrt(x*x+S*S))*w,S=S/L*w,u.push(c-x,m-S,c+x,m+S),l=1;l<h-1;l++)c=n[2*(l-1)],m=n[2*(l-1)+1],p=n[2*l],f=n[2*l+1],g=n[2*(l+1)],T=n[2*(l+1)+1],S=c-p,E=p-g,R=(-(x=(x=-(m-f))/(L=Math.sqrt(x*x+S*S))*w)+c)*(-(S=S/L*w)+f)-(-x+p)*(-S+m),A=(-(y=(y=-(f-T))/(L=Math.sqrt(y*y+E*E))*w)+g)*(-(E=E/L*w)+f)-(-y+p)*(-E+T),M=(C=-S+m-(-S+f))*(D=-y+p-(-y+g))-(b=-E+T-(-E+f))*(v=-x+p-(-x+c)),Math.abs(M)<.1?(M+=10.1,u.push(p-x,f-S,p+x,f+S)):(d=(v*A-D*R)/M,_=(b*R-C*A)/M,u.push(d,_,p-(d-p),f-(_-f)));for(c=n[o-4],m=n[o-3],S=c-(p=n[o-2]),x=(x=-(m-(f=n[o-1])))/(L=Math.sqrt(x*x+S*S))*w,S=S/L*w,u.push(p-x,f-S,p+x,f+S),l=1;l<h;l++)t.push(i+2*(l-1),i+2*(l-1)+1,i+2*l+1,i+2*l+1,i+2*l,i+2*(l-1));return u}static createLineTriangle(e,t,r,i,a,s,n){var o=e.slice(),l=o.length,h=o[0],u=o[1],d=o[2],_=(o[2],0),c=0,m=0,p=0,f=l/2;if(!(f<=1)&&2!=f){for(var g=new Array(4*f),T=0,x=0,S=0;S<f-1;S++)h=o[x++],u=o[x++],d=o[x++],p=o[x++]-u,0!=(m=d-h)&&0!=p&&(_=Math.sqrt(m*m+p*p))>.001&&(g[c=4*T]=h,g[c+1]=u,g[c+2]=m/_,g[c+3]=p/_,T++);for(i?(h=o[l-2],u=o[l-1],d=o[0],p=o[1]-u,0!=(m=d-h)&&0!=p&&(_=Math.sqrt(m*m+p*p))>.001&&(g[c=4*T]=h,g[c+1]=u,g[c+2]=m/_,g[c+3]=p/_,T++)):(g[c=4*T]=h,g[c+1]=u,g[c+2]=m/_,g[c+3]=p/_,T++),x=0,S=0;S<f;S++)h=o[x],u=o[x+1],d=o[x+2],o[x+3]}}}BasePoly.tempData=new Array(256);class EarcutNode{constructor(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Earcut{static earcut(e,t,r){r=r||2;var i,a,s,n,o,l,h,u=t&&t.length,d=u?t[0]*r:e.length,_=Earcut.linkedList(e,0,d,r,!0),c=[];if(!_)return c;if(u&&(_=Earcut.eliminateHoles(e,t,_,r)),e.length>80*r){i=s=e[0],a=n=e[1];for(var m=r;m<d;m+=r)(o=e[m])<i&&(i=o),(l=e[m+1])<a&&(a=l),o>s&&(s=o),l>n&&(n=l);h=0!==(h=Math.max(s-i,n-a))?1/h:0}return Earcut.earcutLinked(_,c,r,i,a,h),c}static linkedList(e,t,r,i,a){var s,n;if(a===Earcut.signedArea(e,t,r,i)>0)for(s=t;s<r;s+=i)n=Earcut.insertNode(s,e[s],e[s+1],n);else for(s=r-i;s>=t;s-=i)n=Earcut.insertNode(s,e[s],e[s+1],n);return n&&Earcut.equals(n,n.next)&&(Earcut.removeNode(n),n=n.next),n}static filterPoints(e,t){if(!e)return e;t||(t=e);var r,i=e;do{if(r=!1,i.steiner||!Earcut.equals(i,i.next)&&0!==Earcut.area(i.prev,i,i.next))i=i.next;else{if(Earcut.removeNode(i),(i=t=i.prev)===i.next)break;r=!0}}while(r||i!==t);return t}static earcutLinked(e,t,r,i,a,s,n=null){if(e){!n&&s&&Earcut.indexCurve(e,i,a,s);for(var o,l,h=e;e.prev!==e.next;)if(o=e.prev,l=e.next,s?Earcut.isEarHashed(e,i,a,s):Earcut.isEar(e))t.push(o.i/r),t.push(e.i/r),t.push(l.i/r),Earcut.removeNode(e),e=l.next,h=l.next;else if((e=l)===h){n?1===n?(e=Earcut.cureLocalIntersections(e,t,r),Earcut.earcutLinked(e,t,r,i,a,s,2)):2===n&&Earcut.splitEarcut(e,t,r,i,a,s):Earcut.earcutLinked(Earcut.filterPoints(e,null),t,r,i,a,s,1);break}}}static isEar(e){var t=e.prev,r=e,i=e.next;if(Earcut.area(t,r,i)>=0)return!1;for(var a=e.next.next;a!==e.prev;){if(Earcut.pointInTriangle(t.x,t.y,r.x,r.y,i.x,i.y,a.x,a.y)&&Earcut.area(a.prev,a,a.next)>=0)return!1;a=a.next}return!0}static isEarHashed(e,t,r,i){var a=e.prev,s=e,n=e.next;if(Earcut.area(a,s,n)>=0)return!1;for(var o=a.x<s.x?a.x<n.x?a.x:n.x:s.x<n.x?s.x:n.x,l=a.y<s.y?a.y<n.y?a.y:n.y:s.y<n.y?s.y:n.y,h=a.x>s.x?a.x>n.x?a.x:n.x:s.x>n.x?s.x:n.x,u=a.y>s.y?a.y>n.y?a.y:n.y:s.y>n.y?s.y:n.y,d=Earcut.zOrder(o,l,t,r,i),_=Earcut.zOrder(h,u,t,r,i),c=e.nextZ;c&&c.z<=_;){if(c!==e.prev&&c!==e.next&&Earcut.pointInTriangle(a.x,a.y,s.x,s.y,n.x,n.y,c.x,c.y)&&Earcut.area(c.prev,c,c.next)>=0)return!1;c=c.nextZ}for(c=e.prevZ;c&&c.z>=d;){if(c!==e.prev&&c!==e.next&&Earcut.pointInTriangle(a.x,a.y,s.x,s.y,n.x,n.y,c.x,c.y)&&Earcut.area(c.prev,c,c.next)>=0)return!1;c=c.prevZ}return!0}static cureLocalIntersections(e,t,r){var i=e;do{var a=i.prev,s=i.next.next;!Earcut.equals(a,s)&&Earcut.intersects(a,i,i.next,s)&&Earcut.locallyInside(a,s)&&Earcut.locallyInside(s,a)&&(t.push(a.i/r),t.push(i.i/r),t.push(s.i/r),Earcut.removeNode(i),Earcut.removeNode(i.next),i=e=s),i=i.next}while(i!==e);return i}static splitEarcut(e,t,r,i,a,s){var n=e;do{for(var o=n.next.next;o!==n.prev;){if(n.i!==o.i&&Earcut.isValidDiagonal(n,o)){var l=Earcut.splitPolygon(n,o);return n=Earcut.filterPoints(n,n.next),l=Earcut.filterPoints(l,l.next),Earcut.earcutLinked(n,t,r,i,a,s),void Earcut.earcutLinked(l,t,r,i,a,s)}o=o.next}n=n.next}while(n!==e)}static eliminateHoles(e,t,r,i){var a,s,n,o,l,h=[];for(a=0,s=t.length;a<s;a++)n=t[a]*i,o=a<s-1?t[a+1]*i:e.length,(l=Earcut.linkedList(e,n,o,i,!1))===l.next&&(l.steiner=!0),h.push(Earcut.getLeftmost(l));for(h.sort(Earcut.compareX),a=0;a<h.length;a++)Earcut.eliminateHole(h[a],r),r=Earcut.filterPoints(r,r.next);return r}static compareX(e,t){return e.x-t.x}static eliminateHole(e,t){if(t=Earcut.findHoleBridge(e,t)){var r=Earcut.splitPolygon(t,e);Earcut.filterPoints(r,r.next)}}static findHoleBridge(e,t){var r,i=t,a=e.x,s=e.y,n=-1/0;do{if(s<=i.y&&s>=i.next.y&&i.next.y!==i.y){var o=i.x+(s-i.y)*(i.next.x-i.x)/(i.next.y-i.y);if(o<=a&&o>n){if(n=o,o===a){if(s===i.y)return i;if(s===i.next.y)return i.next}r=i.x<i.next.x?i:i.next}}i=i.next}while(i!==t);if(!r)return null;if(a===n)return r.prev;var l,h=r,u=r.x,d=r.y,_=1/0;for(i=r.next;i!==h;)a>=i.x&&i.x>=u&&a!==i.x&&Earcut.pointInTriangle(s<d?a:n,s,u,d,s<d?n:a,s,i.x,i.y)&&((l=Math.abs(s-i.y)/(a-i.x))<_||l===_&&i.x>r.x)&&Earcut.locallyInside(i,e)&&(r=i,_=l),i=i.next;return r}static indexCurve(e,t,r,i){var a=e;do{null===a.z&&(a.z=Earcut.zOrder(a.x,a.y,t,r,i)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,Earcut.sortLinked(a)}static sortLinked(e){var t,r,i,a,s,n,o,l,h=1;do{for(r=e,e=null,s=null,n=0;r;){for(n++,i=r,o=0,t=0;t<h&&(o++,i=i.nextZ);t++);for(l=h;o>0||l>0&&i;)0!==o&&(0===l||!i||r.z<=i.z)?(a=r,r=r.nextZ,o--):(a=i,i=i.nextZ,l--),s?s.nextZ=a:e=a,a.prevZ=s,s=a;r=i}s.nextZ=null,h*=2}while(n>1);return e}static zOrder(e,t,r,i,a){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*a)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*a)|t<<8))|t<<4))|t<<2))|t<<1))<<1}static getLeftmost(e){var t=e,r=e;do{t.x<r.x&&(r=t),t=t.next}while(t!==e);return r}static pointInTriangle(e,t,r,i,a,s,n,o){return(a-n)*(t-o)-(e-n)*(s-o)>=0&&(e-n)*(i-o)-(r-n)*(t-o)>=0&&(r-n)*(s-o)-(a-n)*(i-o)>=0}static isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!Earcut.intersectsPolygon(e,t)&&Earcut.locallyInside(e,t)&&Earcut.locallyInside(t,e)&&Earcut.middleInside(e,t)}static area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}static equals(e,t){return e.x===t.x&&e.y===t.y}static intersects(e,t,r,i){return!!(Earcut.equals(e,t)&&Earcut.equals(r,i)||Earcut.equals(e,i)&&Earcut.equals(r,t))||Earcut.area(e,t,r)>0!=Earcut.area(e,t,i)>0&&Earcut.area(r,i,e)>0!=Earcut.area(r,i,t)>0}static intersectsPolygon(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&Earcut.intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}static locallyInside(e,t){return Earcut.area(e.prev,e,e.next)<0?Earcut.area(e,t,e.next)>=0&&Earcut.area(e,e.prev,t)>=0:Earcut.area(e,t,e.prev)<0||Earcut.area(e,e.next,t)<0}static middleInside(e,t){var r=e,i=!1,a=(e.x+t.x)/2,s=(e.y+t.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&a<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(i=!i),r=r.next}while(r!==e);return i}static splitPolygon(e,t){var r=new EarcutNode(e.i,e.x,e.y),i=new EarcutNode(t.i,t.x,t.y),a=e.next,s=t.prev;return e.next=t,t.prev=e,r.next=a,a.prev=r,i.next=r,r.prev=i,s.next=i,i.prev=s,i}static insertNode(e,t,r,i){var a=new EarcutNode(e,t,r);return i?(a.next=i.next,a.prev=i,i.next.prev=a,i.next=a):(a.prev=a,a.next=a),a}static removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}static signedArea(e,t,r,i){for(var a=0,s=t,n=r-i;s<r;s+=i)a+=(e[n]-e[s])*(e[s+1]+e[n+1]),n=s;return a}}e.MeshTopology=void 0,(V=e.MeshTopology||(e.MeshTopology={}))[V.Points=0]="Points",V[V.Lines=1]="Lines",V[V.LineLoop=2]="LineLoop",V[V.LineStrip=3]="LineStrip",V[V.Triangles=4]="Triangles",V[V.TriangleStrip=5]="TriangleStrip",V[V.TriangleFan=6]="TriangleFan";class Submit extends SubmitBase{constructor(e=SubmitBase.TYPE_2D){super(e)}renderSubmit(){if(0===this._numEle||!this._mesh||0==this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var r=t._getSource();if(!r)return 1;this.shaderValue.texture=r}return this._mesh.useMesh(),this.shaderValue.upload(),BlendMode.activeBlendFunction!==this._blendFn&&(RenderStateContext.setBlend(!0),this._blendFn(),BlendMode.activeBlendFunction=this._blendFn),LayaGL.renderDrawContext.drawElements(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx),1}releaseRender(){SubmitBase.RENDERBASE!=this&&--this._ref<1&&(Submit.POOL[Submit._poolSize++]=this,this.shaderValue.release(),this.shaderValue=null,this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}static create(e,t,r){var i=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit;i._ref=1,i._mesh=t,i._key.clear(),i._startIdx=t.indexNum*Const.BYTES_PIDX,i._numEle=0;var a=e._nBlendType;i._blendFn=e._targets?BlendMode.targetFns[a]:BlendMode.fns[a],i.shaderValue=r,i.shaderValue.setValue(e._shader2D);var s=e._shader2D.filters;return s&&i.shaderValue.setFilters(s),i}static createShape(e,t,r,i){var a=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit;a._mesh=t,a._numEle=r,a._startIdx=2*t.indexNum,a._ref=1,a.shaderValue=i,a.shaderValue.setValue(e._shader2D);var s=e._nBlendType;return a._key.blendShader=s,a._blendFn=e._targets?BlendMode.targetFns[s]:BlendMode.fns[s],a}}Submit._poolSize=0,Submit.POOL=[];class SubmitCanvas extends SubmitBase{static create(e,t,r){var i=SubmitCanvas.POOL._length?SubmitCanvas.POOL[--SubmitCanvas.POOL._length]:new SubmitCanvas;i.canv=e,i._ref=1,i._numEle=0;var a=i.shaderValue;return a.alpha=t,a.defines.setValue(0),r&&r.length&&a.setFilters(r),i}constructor(){super(SubmitBase.TYPE_2D),this._matrix=new Matrix,this._matrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.shaderValue=new Value2D(0,0)}renderSubmit(){var e=RenderState2D.worldAlpha,t=RenderState2D.worldMatrix4,r=RenderState2D.worldMatrix,i=RenderState2D.worldFilters,a=RenderState2D.worldShaderDefines,s=this.shaderValue,n=this._matrix,o=this._matrix4,l=Matrix.TEMP;return Matrix.mul(n,r,l),o[0]=l.a,o[1]=l.b,o[4]=l.c,o[5]=l.d,o[12]=l.tx,o[13]=l.ty,RenderState2D.worldMatrix=l.clone(),RenderState2D.worldMatrix4=o,RenderState2D.worldAlpha=RenderState2D.worldAlpha*s.alpha,s.filters&&s.filters.length&&(RenderState2D.worldFilters=s.filters,RenderState2D.worldShaderDefines=s.defines),this.canv.flushsubmit(),RenderState2D.worldAlpha=e,RenderState2D.worldMatrix4=t,RenderState2D.worldMatrix.destroy(),RenderState2D.worldMatrix=r,RenderState2D.worldFilters=i,RenderState2D.worldShaderDefines=a,1}releaseRender(){if(--this._ref<1){var e=SubmitCanvas.POOL;this._mesh=null,e[e._length++]=this}}getRenderType(){return SubmitBase.TYPE_CANVAS}}SubmitCanvas.POOL=[],SubmitCanvas.POOL._length=0;class SubmitTarget{constructor(){this.blendType=0,this._ref=1,this._key=new SubmitKey}renderSubmit(){this._mesh.useMesh();var t=this.srcRT;return t&&(this.shaderValue.texture=t._getSource(),this.shaderValue.upload(),this.blend(),LayaGL.renderDrawContext.drawElements(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx)),1}blend(){BlendMode.activeBlendFunction!==BlendMode.fns[this.blendType]&&(RenderStateContext.setBlend(!0),BlendMode.fns[this.blendType](),BlendMode.activeBlendFunction=BlendMode.fns[this.blendType])}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var e=SubmitTarget.POOL;e[e._length++]=this}}static create(e,t,r,i){var a=SubmitTarget.POOL._length?SubmitTarget.POOL[--SubmitTarget.POOL._length]:new SubmitTarget;if(a._mesh=t,a.srcRT=i,a._startIdx=t.indexNum*Const.BYTES_PIDX,a._ref=1,a._key.clear(),a._numEle=0,a.blendType=e._nBlendType,a._key.blendShader=a.blendType,a.shaderValue=r,a.shaderValue.setValue(e._shader2D),e._colorFiler){var s=e._colorFiler;r.defines.add(s.type),r.colorMat=s._mat,r.colorAlpha=s._alpha}return a}}SubmitTarget.POOL=[],SubmitTarget.POOL._length=0;class SubmitTexture extends SubmitBase{constructor(e=SubmitBase.TYPE_2D){super(e)}releaseRender(){--this._ref<1&&(SubmitTexture.POOL[SubmitTexture._poolSize++]=this,this.shaderValue.release(),this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}renderSubmit(){if(0===this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var r=t?t._getSource():null;if(!r)return 1}this._mesh.useMesh();var i=SubmitBase.preRender,a=SubmitBase.preRender._key;return 0===this._key.blendShader&&this._key.submitType===a.submitType&&this._key.blendShader===a.blendShader&&BaseShader.activeShader&&SubmitBase.preRender.clipInfoID==this.clipInfoID&&i.shaderValue.defines._value===this.shaderValue.defines._value&&0==(this.shaderValue.defines._value&ShaderDefines2D.NOOPTMASK)?BaseShader.activeShader.uploadTexture2D(r):(BlendMode.activeBlendFunction!==this._blendFn&&(RenderStateContext.setBlend(!0),this._blendFn(),BlendMode.activeBlendFunction=this._blendFn),this.shaderValue.texture=r,this.shaderValue.upload()),LayaGL.renderDrawContext.drawElements(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx),1}static create(e,t,r){var i=SubmitTexture._poolSize?SubmitTexture.POOL[--SubmitTexture._poolSize]:new SubmitTexture(SubmitBase.TYPE_TEXTURE);i._mesh=t,i._key.clear(),i._key.submitType=SubmitBase.KEY_DRAWTEXTURE,i._ref=1,i._startIdx=t.indexNum*Const.BYTES_PIDX,i._numEle=0;var a=e._nBlendType;if(i._key.blendShader=a,i._blendFn=e._targets?BlendMode.targetFns[a]:BlendMode.fns[a],i.shaderValue=r,e._colorFiler){var s=e._colorFiler;r.defines.add(s.type),r.colorMat=s._mat,r.colorAlpha=s._alpha}return i}}SubmitTexture._poolSize=0,SubmitTexture.POOL=[];class CharSubmitCache{constructor(){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new Matrix,this._enable=!1}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(e,t,r,i,a,s){this._ndata>0&&(this._tex!=t||this._imgId!=r||this._clipid>=0&&this._clipid!=e._clipInfoID)&&this.submit(e),this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix),this._tex=t,this._imgId=r,this._colorFiler=e._colorFiler,this._data[this._ndata]=i,this._data[this._ndata+1]=a,this._data[this._ndata+2]=s,this._ndata+=3}getPos(){return 0==CharSubmitCache.__nPosPool?new Array(8):CharSubmitCache.__posPool[--CharSubmitCache.__nPosPool]}enable(e,t){e!==this._enable&&(this._enable=e,this._enable||this.submit(t))}submit(e){var t=this._ndata;if(t){var r=e._mesh,i=e._colorFiler;e._colorFiler=this._colorFiler;var a=SubmitTexture.create(e,r,Value2D.create(ShaderDefines2D.TEXTURE2D,0));e._submits[e._submits._length++]=e._curSubmit=a,a.shaderValue.textureHost=this._tex,a._key.other=this._imgId,e._colorFiler=i,e._copyClipInfo(a,this._clipMatrix),a.clipInfoID=this._clipid;for(var s=0;s<t;s+=3)r.addQuad(this._data[s],this._data[s+1],this._data[s+2],!0),CharSubmitCache.__posPool[CharSubmitCache.__nPosPool++]=this._data[s];t/=3,a._numEle+=6*t,r.indexNum+=6*t,r.vertNum+=4*t,e._drawCount+=t,this._ndata=0,RenderInfo.loopCount%100==0&&(this._data.length=0)}}}CharSubmitCache.__posPool=[],CharSubmitCache.__nPosPool=0;class AtlasGrid{constructor(e=0,t=0,r=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=r,this._init(e,t)}addRect(e,t,r,i){return!!this._get(t,r,i)&&(this._fill(i.x,i.y,t,r,e),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(e,t){return this._width=e,this._height=t,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(e,t,r){if(e>this._width||t>this._height)return!1;for(var i=-1,a=-1,s=this._width,n=this._height,o=this._cells,l=0;l<n;l++)if(!(this._rowInfo[l]<e))for(var h=0;h<s;){var u=3*(l*s+h);if(0!=o[u]||o[u+1]<e||o[u+2]<t)h+=o[u+1];else{i=h,a=l;for(var d=0;d<e;d++)if(o[3*d+u+2]<t){i=-1;break}if(!(i<0))return r.x=i,r.y=a,!0;h+=o[u+1]}}return!1}_fill(e,t,r,i,a){var s=this._width,n=this._height;this._check(e+r<=s&&t+i<=n);for(var o=t;o<i+t;++o){this._check(this._rowInfo[o]>=r),this._rowInfo[o]-=r;for(var l=0;l<r;l++){var h=3*(e+o*s+l);this._check(0==this._cells[h]),this._cells[h]=a,this._cells[h+1]=r,this._cells[h+2]=i}}if(e>0)for(o=0;o<i;++o){var u=0;for(l=e-1;l>=0&&0==this._cells[3*((t+o)*s+l)];--l,++u);for(l=u;l>0;--l)this._cells[3*((t+o)*s+e-l)+1]=l,this._check(l>0)}if(t>0)for(l=e;l<e+r;++l){for(u=0,o=t-1;o>=0&&0==this._cells[3*(l+o*s)];--o,u++);for(o=u;o>0;--o)this._cells[3*(l+(t-o)*s)+2]=o,this._check(o>0)}this._used+=r*i/(this._width*this._height)}_check(e){0==e&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var e=0;e<this._height;e++)this._rowInfo[e]=this._width;for(var t=0;t<this._height;t++)for(var r=0;r<this._width;r++){var i=3*(t*this._width+r);this._cells[i]=0,this._cells[i+1]=this._width-r,this._cells[i+2]=this._width-t}}}e.WrapMode=void 0,(W=e.WrapMode||(e.WrapMode={}))[W.Repeat=0]="Repeat",W[W.Clamp=1]="Clamp",W[W.Mirrored=2]="Mirrored";class TextTexture extends Resource{get gammaCorrection(){return this.bitmap._glTexture.gammaCorrection}constructor(e,t){super(),this._texW=0,this._texH=0,this._discardTm=0,this.genID=0,this.bitmap={id:0,_glTexture:null},this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this._texW=e||TextRender.atlasWidth,this._texH=t||TextRender.atlasWidth,this.bitmap.id=this.id,this.lock=!0,this._render2DContext=LayaGL.render2DContext}recreateResource(){if(!this._source){var t=this._source=new Texture2D(this._texW,this._texH,e.TextureFormat.R8G8B8A8,!1,!1,!0);t.setPixelsData(null,!0,!1),t.lock=!0,this.bitmap._glTexture=t,this._source.filterMode=e.FilterMode.Bilinear,this._source.wrapModeU=e.WrapMode.Clamp,this._source.wrapModeV=e.WrapMode.Clamp,TextRender.debugUV&&this.fillWhite()}}addChar(e,t,r,i=null){if(TextRender.isWan1Wan)return this.addCharCanvas(e,t,r,i);var a,s,n,o,l=e.data;return e.data instanceof Uint8ClampedArray&&(l=new Uint8Array(l.buffer)),!this._source&&this.recreateResource(),LayaGL.textureContext.setTextureSubPixelsData(this._source._texture,l,0,!1,t,r,e.width,e.height,!0,!1),a=t/this._texW,s=r/this._texH,n=(t+e.width)/this._texW,o=(r+e.height)/this._texH,(i=i||new Array(8))[0]=a,i[1]=s,i[2]=n,i[3]=s,i[4]=n,i[5]=o,i[6]=a,i[7]=o,i}addCharCanvas(e,t,r,i=null){var a,s,n,o;return!this._source&&this.recreateResource(),LayaGL.textureContext.setTextureSubImageData(this._source._texture,e,t,r,!0,!1),LayaEnv.isConch?(a=t/this._texW,s=r/this._texH,n=(t+e.width)/this._texW,o=(r+e.height)/this._texH):(a=(t+1)/this._texW,s=(r+1)/this._texH,n=(t+e.width-1)/this._texW,o=(r+e.height-1)/this._texH),(i=i||new Array(8))[0]=a,i[1]=s,i[2]=n,i[3]=s,i[4]=n,i[5]=o,i[6]=a,i[7]=o,i}fillWhite(){!this._source&&this.recreateResource();var e=new Uint8Array(this._texW*this._texH*4);e.fill(255),LayaGL.textureContext.setTextureImageData(this._source._getSource(),e,!0,!1)}discard(){ILaya.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(e,t){return new TextTexture(e,t)}_disposeResource(){this._source&&this._source.destroy(),this._source=null}static clean(){var e=RenderInfo.loopStTm;if(0===TextTexture.cleanTm&&(TextTexture.cleanTm=e),e-TextTexture.cleanTm>=TextRender.checkCleanTextureDt){for(var t=0;t<TextTexture.poolLen;t++){var r=TextTexture.pool[t];e-r._discardTm>=TextRender.destroyUnusedTextureDt&&(r.destroy(),TextTexture.pool[t]=TextTexture.pool[TextTexture.poolLen-1],TextTexture.poolLen--,t--)}TextTexture.cleanTm=e}}touchRect(e,t){this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t);var r=TextRender.atlasWidth*TextRender.atlasWidth,i=TextAtlas.atlasGridW*TextAtlas.atlasGridW;this.curUsedCovRate+=e.bmpWidth*e.bmpHeight/r,this.curUsedCovRateAtlas+=Math.ceil(e.bmpWidth/TextAtlas.atlasGridW)*Math.ceil(e.bmpHeight/TextAtlas.atlasGridW)/(r/i)}get texture(){return this}_getSource(){return this._source._getSource()}drawOnScreen(e,t){}}TextTexture.pool=new Array(10),TextTexture.poolLen=0,TextTexture.cleanTm=0;class TextAtlas{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=TextRender.atlasWidth,this.texture=TextTexture.getTextTexture(this.texWidth,this.texHeight),this.texWidth/TextAtlas.atlasGridW>256&&(TextAtlas.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new AtlasGrid(this.texWidth/TextAtlas.atlasGridW,this.texHeight/TextAtlas.atlasGridW,this.texture.id)}setProtecteDist(e){}getAEmpty(e,t,r){var i=this.atlasgrid.addRect(1,Math.ceil(e/TextAtlas.atlasGridW),Math.ceil(t/TextAtlas.atlasGridW),r);return i&&(r.x*=TextAtlas.atlasGridW,r.y*=TextAtlas.atlasGridW),i}get usedRate(){return this.atlasgrid._used}destroy(){for(var e in this.charMaps){this.charMaps[e].deleted=!0}this.texture.discard()}printDebugInfo(){}}TextAtlas.atlasGridW=16;class FontInfo{static parse(e){if(e===$)return q;let t=FontInfo._cache[e];return t||(t=FontInfo._cache[e]=new FontInfo(e)),$=e,q=t,t}constructor(e){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(e||"14px Arial")}setFont(e){this._font=e;var t=e.split(" "),r=t.length;if(r<2)1==r&&t[0].indexOf("px")>0&&(this._size=parseInt(t[0]));else{var i=-1;for(let a=0;a<r;a++)if(t[a].indexOf("px")>0||t[a].indexOf("pt")>0){i=a,this._size=parseInt(t[a]),this._size<=0&&(console.debug("font parse error:"+e),this._size=14);break}var a=i+1,s=t[a];for(a++;a<r;a++)s+=" "+t[a];this._family=s.split(",")[0],this._italic=t.indexOf("italic")>=0,this._bold=t.indexOf("bold")>=0}}}FontInfo._cache={};var q,Q,$="";class WordText{constructor(){this.pagecharsCtx=null,window.conch&&!window.conchConfig.conchWebGL?this._nativeObj=new window._conchWordText:(this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1)}setText(e){this.text=e,this._nativeObj?this._nativeObj._text=e:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let e=this.pageChars;if(e.length>0){for(let t of e){let e=t.tex;1==t.words.length&&e&&e.ri&&e.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(e){this._splitRender=e,this._nativeObj&&(this._nativeObj.splitRender=e)}}class CharRenderInfo{constructor(){this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var e=RenderInfo.loopCount;this.touchTick!=e&&this.tex.touchRect(this,e),this.touchTick=e}}class ICharRender{constructor(){this.fontsz=16}getWidth(e,t){return 0}scale(e,t){}get canvasWidth(){return 0}set canvasWidth(e){}getCharBmp(e,t,r,i,a,s,n,o,l,h,u=null){return null}}class Browser{static __init__(){let e=window.Laya||ILaya.Laya;if(Browser._window)return Browser._window;let t=Browser._window=window,r=Browser._document=t.document,i=Browser.userAgent=t.navigator.userAgent,a=t.navigator.maxTouchPoints||0,s=t.navigator.platform;window.conch&&"conchUseWXAdapter"in Browser.window&&(window.wxMiniGame(e,e),e.MiniAdpter.enable()),"my"in Browser.window&&(i.indexOf("TB/")>-1||i.indexOf("Taobao/")>-1||i.indexOf("TM/")>-1?(window.tbMiniGame(e,e),e.TBMiniAdapter?e.TBMiniAdapter.enable():console.error("请先添加淘宝适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-6-0")):i.indexOf("AlipayMiniGame")>-1&&(window.aliPayMiniGame(e,e),e.ALIMiniAdapter?e.ALIMiniAdapter.enable():console.error("请先添加阿里小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-6-0"))),(-1==i.indexOf("OPPO")&&i.indexOf("MiniGame")>-1||-1!=i.indexOf("runtime")||-1!=i.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in Browser.window&&("tt"in Browser.window?(window.ttMiniGame(e,e),e.TTMiniAdapter?e.TTMiniAdapter.enable():console.error("请引入字节跳动小游戏的适配库")):"bl"in Browser.window?(window.biliMiniGame(e,e),e.BLMiniAdapter?e.BLMiniAdapter.enable():console.error("请引入bilibili小游戏的适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-7-0")):"qq"in Browser.window?(window.qqMiniGame(e,e),e.QQMiniAdapter?e.QQMiniAdapter.enable():console.error("请引入手机QQ小游戏的适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-0-0")):(window.wxMiniGame(e,e),e.MiniAdpter?e.MiniAdpter.enable():console.error("请先添加小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?nav=zh-ts-5-0-0"))),"hbs"in Browser.window&&(window.hwMiniGame(e,e),e.HWMiniAdapter?e.HWMiniAdapter.enable():console.error("请先添加小游戏适配库!")),i.indexOf("SwanGame")>-1&&(window.bdMiniGame(e,e),e.BMiniAdapter?e.BMiniAdapter.enable():console.error("请先添加百度小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-1-0")),i.indexOf("QuickGame")>-1&&(window.miMiniGame(e,e),e.KGMiniAdapter?e.KGMiniAdapter.enable():console.error("请先添加小米小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-2-0")),i.indexOf("OPPO")>-1&&i.indexOf("MiniGame")>-1&&(window.qgMiniGame(e,e),e.QGMiniAdapter?(Config.fixedFrames=!1,e.QGMiniAdapter.enable()):console.error("请先添加OPPO小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-3-0")),i.indexOf("VVGame")>-1&&(window.vvMiniGame(e,e),e.VVMiniAdapter?(Config.fixedFrames=!1,e.VVMiniAdapter.enable()):console.error("请先添加VIVO小游戏适配库,详细教程：https://ldc2.layabox.com/doc/?language=zh&nav=zh-ts-5-4-0")),t.trace=console.log,t.requestAnimationFrame=t.requestAnimationFrame||t.webkitRequestAnimationFrame||t.mozRequestAnimationFrame||t.oRequestAnimationFrame||t.msRequestAnimationFrame||function(e){return t.setTimeout(e,1e3/60)};var n=r.body.style;n.margin=0,n.overflow="hidden",n["-webkit-user-select"]="none",n["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";for(var o=r.getElementsByTagName("meta"),l=0,h=!1,u="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no";l<o.length;){var d=o[l];if("viewport"==d.name){d.content=u,h=!0;break}l++}return h||((d=r.createElement("meta")).name="viewport",d.content=u,r.getElementsByTagName("head")[0].appendChild(d)),Browser.onMobile=!!window.conch||i.indexOf("Mobile")>-1,Browser.onIOS=!!i.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),Browser.onIPhone=i.indexOf("iPhone")>-1,Browser.onMac=i.indexOf("Mac OS X")>-1,Browser.onIPad=i.indexOf("iPad")>-1||"MacIntel"===s&&a>1,Browser.onAndroid=i.indexOf("Android")>-1||i.indexOf("Adr")>-1,Browser.onWP=i.indexOf("Windows Phone")>-1,Browser.onQQBrowser=i.indexOf("QQBrowser")>-1,Browser.onMQQBrowser=i.indexOf("MQQBrowser")>-1||i.indexOf("Mobile")>-1&&i.indexOf("QQ")>-1,Browser.onIE=!!t.ActiveXObject||"ActiveXObject"in t,Browser.onWeiXin=i.indexOf("MicroMessenger")>-1,Browser.onSafari=i.indexOf("Safari")>-1,Browser.onChrome=i.indexOf("Chrome")>-1,Browser.onPC=!Browser.onMobile,Browser.onFirefox=i.indexOf("Firefox")>-1,Browser.onEdge=i.indexOf("Edge")>-1,Browser.onMiniGame=i.indexOf("MiniGame")>-1,Browser.onBDMiniGame=i.indexOf("SwanGame")>-1,Browser.onLayaRuntime=!!window.conch,i.indexOf("OPPO")>-1&&i.indexOf("MiniGame")>-1?(Browser.onQGMiniGame=!0,Browser.onMiniGame=!1):"qq"in Browser.window&&i.indexOf("MiniGame")>-1?(Browser.onQQMiniGame=!0,Browser.onMiniGame=!1):"bl"in Browser.window&&i.indexOf("MiniGame")>-1?(Browser.onBLMiniGame=!0,Browser.onMiniGame=!1):"tt"in Browser.window&&i.indexOf("MiniGame")>-1&&(Browser.onTTMiniGame=!0,Browser.onMiniGame=!1),Browser.onHWMiniGame="hbs"in Browser.window,Browser.onVVMiniGame=i.indexOf("VVGame")>-1,Browser.onKGMiniGame=i.indexOf("QuickGame")>-1,i.indexOf("AlipayMiniGame")>-1&&(Browser.onAlipayMiniGame=!0,Browser.onMiniGame=!1),(i.indexOf("TB/")>-1||i.indexOf("Taobao/")>-1||i.indexOf("TM/")>-1)&&(Browser.onTBMiniGame=!0),(Browser.onAndroid||Browser.onIOS)&&(!s||-1==s.indexOf("Win")&&-1==s.indexOf("Mac"))?Browser.onAndroid?Browser.platform=Browser.PLATFORM_ANDROID:Browser.platform=Browser.PLATFORM_IOS:Browser.platform=Browser.PLATFORM_PC,t}static get _isMiniGame(){return Browser.onMiniGame||Browser.onBDMiniGame||Browser.onQGMiniGame||Browser.onKGMiniGame||Browser.onVVMiniGame||Browser.onAlipayMiniGame||Browser.onQQMiniGame||Browser.onBLMiniGame||Browser.onTTMiniGame||Browser.onHWMiniGame||Browser.onTBMiniGame||Browser.window&&Browser.window.isWXMiMi}static createElement(e){return Browser.__init__(),Browser._document.createElement(e)}static getElementById(e){return Browser.__init__(),Browser._document.getElementById(e)}static removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}static now(){return Date.now()}static get clientWidth(){return Browser.__init__(),Browser._clientWidth||Browser._window.innerWidth||Browser._document.body.clientWidth}static set clientWidth(e){Browser._clientWidth=e}static get clientHeight(){return Browser.__init__(),Browser._clientHeight||Browser._window.innerHeight||Browser._document.body.clientHeight||Browser._document.documentElement.clientHeight}static set clientHeight(e){Browser._clientHeight=e}static get width(){return Browser.__init__(),(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientHeight:Browser.clientWidth)*Browser.pixelRatio}static get height(){return Browser.__init__(),(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientWidth:Browser.clientHeight)*Browser.pixelRatio}static get pixelRatio(){return Browser._pixelRatio<0&&(Browser.__init__(),Browser.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?Browser._pixelRatio=2:(Browser._pixelRatio=Browser._window.devicePixelRatio||1,Browser._pixelRatio<1&&(Browser._pixelRatio=1))),Browser._pixelRatio}static get container(){return Browser._container||(Browser.__init__(),Browser._container=Browser.createElement("div"),Browser._container.id="layaContainer",Browser._document.body.appendChild(Browser._container)),Browser._container}static set container(e){Browser._container=e}static get window(){return Browser._window||Browser.__init__()}static get document(){return Browser.__init__(),Browser._document}static getQueryString(e){if(Browser.onMiniGame)return null;if(!window.location||!window.location.search)return null;var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),r=window.location.search.substring(1).match(t);return null!=r?unescape(r[2]):null}}Browser.PLATFORM_PC=0,Browser.PLATFORM_ANDROID=1,Browser.PLATFORM_IOS=2,Browser._pixelRatio=-1,Browser.mainCanvas=null,Browser.hanzi=new RegExp("^[一-龥]$"),Browser.fontMap={},Browser.measureText=function(e,t){let r=Browser.hanzi.test(e);if(r&&Browser.fontMap[t])return Browser.fontMap[t];let i=Browser.context;i.font=t;let a=i.measureText(e);return r&&(Browser.fontMap[t]=a),a};class CharRender_Canvas extends ICharRender{constructor(e,t,r=!0,i=!0,a=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=e,this.maxTexH=t,this.scaleFontSize=r,this.supportImageData=i,this.showDbgInfo=a,CharRender_Canvas.canvas||(CharRender_Canvas.canvas=Browser.createElement("canvas"),CharRender_Canvas.canvas.width=1024,CharRender_Canvas.canvas.height=512,CharRender_Canvas.canvas.style.left="-10000px",CharRender_Canvas.canvas.style.position="absolute",document.body.appendChild(CharRender_Canvas.canvas),this.ctx=CharRender_Canvas.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return CharRender_Canvas.canvas.width}set canvasWidth(e){CharRender_Canvas.canvas.width!=e&&(CharRender_Canvas.canvas.width=e,e>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(e,t){return this.ctx?(this.ctx._lastFont!=e&&(this.ctx.font=e,this.ctx._lastFont=e),this.ctx.measureText(t).width):0}scale(e,t){if(!this.supportImageData)return this.lastScaleX=e,void(this.lastScaleY=t);this.lastScaleX==e&&this.lastScaleY==t||(this.ctx.setTransform(e,0,0,t,0,0),this.lastScaleX=e,this.lastScaleY=t)}getCharBmp(e,t,r,i,a,s,n,o,l,h,u=null){if(!this.supportImageData)return this.getCharCanvas(e,t,r,i,a,s,n,o,l,h);var d=this.ctx,_=this.fontsz;d.font!=t&&(d.font=t,d._lastFont=t),s.width=d.measureText(e).width;var c=s.width*this.lastScaleX,m=s.height*this.lastScaleY;c+=(n+l)*this.lastScaleX,m+=(o+h)*this.lastScaleY,c=Math.ceil(c),m=Math.ceil(m);var p=(c=Math.min(c,CharRender_Canvas.canvas.width))+2*r+1,f=(m=Math.min(m,CharRender_Canvas.canvas.height))+2*r+1;u&&(p=Math.max(p,u[0]+u[2]+1),f=Math.max(f,u[1]+u[3]+1)),d.clearRect(0,0,p/this.lastScaleX+1,f/this.lastScaleY+1),d.save(),d.textBaseline="middle",r>0&&(d.strokeStyle=a,d.lineWidth=r,d.strokeText(e,n,o+_/2)),i&&(d.fillStyle=i,d.fillText(e,n,o+_/2)),this.showDbgInfo&&(d.strokeStyle="#ff0000",d.strokeRect(1,1,c-2,m-2),d.strokeStyle="#00ff00",d.strokeRect(n,o,s.width,s.height)),u&&(-1==u[2]&&(u[2]=Math.ceil((s.width+2*r)*this.lastScaleX)),u[2]<=0&&(u[2]=1));var g=u?d.getImageData(u[0],u[1],u[2],u[3]+1):d.getImageData(0,0,c,m+1);return d.restore(),s.bmpWidth=g.width,s.bmpHeight=g.height,g}getCharCanvas(e,t,r,i,a,s,n,o,l,h){var u=this.ctx;u.font!=t&&(u.font=t,u._lastFont=t),s.width=u.measureText(e).width;var d=s.width*this.lastScaleX,_=s.height*this.lastScaleY;d+=(n+l)*this.lastScaleX,_+=(o+h)*this.lastScaleY+1,d=Math.min(d,this.maxTexW),_=Math.min(_,this.maxTexH),CharRender_Canvas.canvas.width=Math.min(d+1,this.maxTexW),CharRender_Canvas.canvas.height=Math.min(_+1,this.maxTexH),u.font=t,u.clearRect(0,0,d+1+r,_+1+r),u.setTransform(1,0,0,1,0,0),u.save(),this.scaleFontSize&&u.scale(this.lastScaleX,this.lastScaleY),u.translate(n,o),u.textAlign="left";var c=this.fontsz;return u.textBaseline="middle",r>0?(u.strokeStyle=a,u.fillStyle=i,u.lineWidth=r,u.fillAndStrokeText?u.fillAndStrokeText(e,0,c/2):(u.strokeText(e,0,c/2),u.fillText(e,0,c/2))):i&&(u.fillStyle=i,u.fillText(e,0,c/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(0,0,d,_),u.strokeStyle="#00ff00",u.strokeRect(0,0,s.width,s.height)),u.restore(),s.bmpWidth=CharRender_Canvas.canvas.width,s.bmpHeight=CharRender_Canvas.canvas.height,CharRender_Canvas.canvas}}CharRender_Canvas.canvas=null;class CharRender_Native extends ICharRender{constructor(){super(),this.lastFont="",this.lastScaleX=1,this.lastScaleY=1}getWidth(e,t){return window.conchTextCanvas?(window.conchTextCanvas.font=e,this.lastFont=e,window.conchTextCanvas.measureText(t).width):0}scale(e,t){this.lastScaleX=e,this.lastScaleY=t}getCharBmp(e,t,r,i,a,s,n,o,l,h,u=null){if(!window.conchTextCanvas)return null;window.conchTextCanvas.font=t,this.lastFont=t,s.width=window.conchTextCanvas.measureText(e).width,s.height,window.conchTextCanvas.scale&&window.conchTextCanvas.scale(this.lastScaleX,this.lastScaleY);var d=ColorUtils.create(a).numColor,_=ColorUtils.create(i).numColor,c=window.conchTextCanvas.getTextBitmapData(e,_,r>2?2:r,d);return s.bmpWidth=c.width,s.bmpHeight=c.height,c}}class TextRender{constructor(){this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this.tmpAtlasPos=new Point,this.textureMem=0;var e=!1,t=ILaya.Laya.MiniAdpter;t&&t.systemInfo&&t.systemInfo.system&&(e="ios 10.1.1"===t.systemInfo.system.toLowerCase()),(ILaya.Browser.onMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onTBMiniGame)&&!e&&(TextRender.isWan1Wan=!0),this.charRender=LayaEnv.isConch?new CharRender_Native:new CharRender_Canvas(2048,2048,TextRender.scaleFontWithCtx,!TextRender.isWan1Wan,!1),TextRender.textRenderInst=this,ILaya.Laya.textRender=this,TextRender.atlasWidth2=TextRender.atlasWidth*TextRender.atlasWidth}setFont(e){if(this.lastFont!=e){this.lastFont=e;var t=this.getFontSizeInfo(e._family),r=t>>24,i=t>>16&255,a=t>>8&255,s=255&t,n=e._size/TextRender.standardFontSize;this.fontSizeOffX=Math.ceil(r*n),this.fontSizeOffY=Math.ceil(i*n),this.fontSizeW=Math.ceil(a*n),this.fontSizeH=Math.ceil(s*n),e._font.indexOf("italic")>=0?this.fontStr=e._font.replace("italic",""):this.fontStr=e._font}}getNextChar(e){var t=e.length,r=this._curStrPos;if(!e.substring)return null;if(r>=t)return null;for(var i=r,a=0;i<t;i++){var s=e.charCodeAt(i);if(s>>>11==27){if(1==a)break;a=1,i++}else if(65038===s||65039===s);else if(8205==s)a=2;else if(0==a)a=1;else if(1==a)break}return this._curStrPos=i,e.substring(r,i)}filltext(e,t,r,i,a,s,n,o,l){if(!(t.length<=0)){var h=FontInfo.parse(a),u=0;switch(l){case"center":u=Const.ENUM_TEXTALIGN_CENTER;break;case"right":u=Const.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(e,t,r,i,h,s,n,o,u)}}_fast_filltext(e,t,r,i,a,s,n,o,l){if(!t||t.length>=1){if(o<0&&(o=0),this.setFont(a),this.fontScaleX=this.fontScaleY=1,TextRender.scaleFontWithCtx){let t=1,r=1;if(LayaEnv.isConch&&!window.conchTextCanvas.scale||(t=e.getMatScaleX(),r=e.getMatScaleY()),t<1e-4||r<.1)return;t>1&&(this.fontScaleX=Math.min(TextRender.maxFontScale,t)),r>1&&(this.fontScaleY=Math.min(TextRender.maxFontScale,r))}a._italic&&(e._italicDeg=13);var h=t,u=t instanceof WordText,d=t&&t.toString(),_=u?h.pageChars:[],c=0;switch(u?(d=h.text,(c=h.width)<0&&(c=h.width=this.charRender.getWidth(this.fontStr,d))):c=d?this.charRender.getWidth(this.fontStr,d):0,l){case Const.ENUM_TEXTALIGN_CENTER:r-=c/2;break;case Const.ENUM_TEXTALIGN_RIGHT:r-=c}u&&(this.hasFreedText(_)||h.pagecharsCtx!=e)&&(_=h.pageChars=[]);var m=null,p=this.renderPerChar=!u||TextRender.forceSplitRender||u&&h.splitRender;if(!_||_.length<1){if(u&&(h.scalex=this.fontScaleX,h.scaley=this.fontScaleY),p){var f,g=0;for(this._curStrPos=0;(f=this.getNextChar(d))&&(m=this.getCharRenderInfo(f,a,s,n,o,!1));)if(m.isSpace);else{var T=_[m.tex.id];if(T)T=T.words;else{var x={texgen:m.tex.genID,tex:m.tex,words:new Array};_[m.tex.id]=x,T=x.words}T.push({ri:m,x:g,y:0,w:m.bmpWidth/this.fontScaleX,h:m.bmpHeight/this.fontScaleY}),g+=m.width}}else{var S=LayaEnv.isConch?0:a._size/3|0,y=TextRender.noAtlas||(c+S+S)*this.fontScaleX>TextRender.atlasWidth;m=this.getCharRenderInfo(d,a,s,n,o,y),_[0]={texgen:m.tex.genID,tex:m.tex,words:[{ri:m,x:0,y:0,w:m.bmpWidth/this.fontScaleX,h:m.bmpHeight/this.fontScaleY}]}}u&&(h.pagecharsCtx=e)}this._drawResortedWords(e,r,i,_),e._italicDeg=0}}_drawResortedWords(e,t,r,i){var a=!!e._charSubmitCache&&e._charSubmitCache._enable,s=e._curMat;for(var n in i){var o=i[n];if(o){var l=o.words,h=l.length;if(!(h<=0))for(var u=i[n].tex,d=0;d<h;d++){var _=l[d],c=_.ri;if(!c.isSpace){if(c.touch(),e.drawTexAlign=!0,LayaEnv.isConch)e._drawTextureM(u.texture,t+_.x-c.orix,r+_.y-c.oriy,_.w,_.h,null,1,c.uv,4294967295);else{let i=u;e._inner_drawTexture(i.texture,i.id,t+_.x-c.orix,r+_.y-c.oriy,_.w,_.h,s,c.uv,1,a,4294967295)}e.touches&&e.touches.push(c)}}}}}hasFreedText(e){for(let i in e){var t=e[i];if(t){var r=t.tex;if(r.destroyed||r.genID!=t.texgen)return!0}}return!1}getCharRenderInfo(e,t,r,i,a,s=!1){var n=this.mapFont[t._family];null==n&&(this.mapFont[t._family]=n=this.fontID++);var o=e+"_"+n+"_"+t._size+"_"+r;a>0&&(o+="_"+i+a),t._bold&&(o+="P"),1==this.fontScaleX&&1==this.fontScaleY||(o+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var l,h,u=0,d=this.textAtlases.length;if(!s)for(u=0;u<d;u++)if(l=(h=this.textAtlases[u]).charMaps[o])return l.touch(),l;l=new CharRenderInfo,this.charRender.scale(this.fontScaleX,this.fontScaleY),l.char=e,l.height=t._size;var _=LayaEnv.isConch?0:t._size/3|0,c=null;a||(a=0);var m=Math.ceil((this.charRender.getWidth(this.fontStr,e)+2*a)*this.fontScaleX);if(m>this.charRender.canvasWidth&&(this.charRender.canvasWidth=Math.min(2048,m+2*_)),s){if(this.charRender.fontsz=t._size,c=this.charRender.getCharBmp(e,this.fontStr,a,r,i,l,_,_,_,_,null)){var p=TextTexture.getTextTexture(c.width,c.height);p.addChar(c,0,0,l.uv),l.tex=p,l.orix=_,l.oriy=_,p.ri=l,this.isoTextures.push(p)}}else{var f=e.length,g=1*a,T=Math.ceil((this.fontSizeW+2*g)*this.fontScaleX),x=Math.ceil((this.fontSizeH+2*g)*this.fontScaleY);TextRender.imgdtRect[0]=(_-this.fontSizeOffX-g)*this.fontScaleX|0,TextRender.imgdtRect[1]=(_-this.fontSizeOffY-g)*this.fontScaleY|0,this.renderPerChar||1==f?(TextRender.imgdtRect[2]=Math.max(m,T),TextRender.imgdtRect[3]=Math.max(m,x)):(TextRender.imgdtRect[2]=-1,TextRender.imgdtRect[3]=x),this.charRender.fontsz=t._size,(c=this.charRender.getCharBmp(e,this.fontStr,a,r,i,l,_,_,_,_,TextRender.imgdtRect))&&(h=this.addBmpData(c,l),TextRender.isWan1Wan?(l.orix=_,l.oriy=_):(l.orix=this.fontSizeOffX+g,l.oriy=this.fontSizeOffY+g),h.charMaps[o]=l)}return l}addBmpData(e,t){for(var r,i=e.width,a=e.height,s=this.textAtlases.length,n=!1,o=0;o<s&&!(n=(r=this.textAtlases[o]).getAEmpty(i,a,this.tmpAtlasPos));o++);if(!n){if(r=new TextAtlas,this.textAtlases.push(r),!(n=r.getAEmpty(i,a,this.tmpAtlasPos)))throw"err1";this.cleanAtlases()}return n&&(r.texture.addChar(e,this.tmpAtlasPos.x,this.tmpAtlasPos.y,t.uv),t.tex=r.texture),r}GC(){for(var e=0,t=this.textAtlases.length,r=TextRender.destroyAtlasDt,i=0,a=RenderInfo.loopCount,s=-1,n=0,o=null,l=null;e<t;e++){if(o=(l=this.textAtlases[e]).texture){o.curUsedCovRate,i+=o.curUsedCovRateAtlas;var h=l.usedRate-o.curUsedCovRateAtlas;n<h&&(n=h,s=e)}a-l.texture.lastTouchTm>r&&(TextRender.showLog&&console.log(l.texture.id),l.destroy(),this.textAtlases[e]=this.textAtlases[t-1],t--,e--,s=-1)}for(this.textAtlases.length=t,t=this.isoTextures.length,e=0;e<t;e++)a-(o=this.isoTextures[e]).lastTouchTm>TextRender.destroyUnusedTextureDt&&(o.ri.deleted=!0,o.ri.tex=null,o.destroy(),this.isoTextures[e]=this.isoTextures[t-1],t--,e--);this.isoTextures.length=t;var u=this.textAtlases.length>1&&this.textAtlases.length-i>=2;(TextRender.atlasWidth*TextRender.atlasWidth*4*this.textAtlases.length>TextRender.cleanMem||u||TextRender.simClean)&&(TextRender.simClean=!1,TextRender.showLog&&console.log("清理使用率低的贴图。总使用率:",i,":",this.textAtlases.length,"最差贴图:"+s),s>=0&&((l=this.textAtlases[s]).destroy(),this.textAtlases[s]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1)),TextTexture.clean()}cleanAtlases(){}getCharBmp(e){}checkBmpLine(e,t,r,i){this.bmpData32.buffer!=e.data.buffer&&(this.bmpData32=new Uint32Array(e.data.buffer));for(var a=e.width*t+r,s=r;s<i;s++)if(0!=this.bmpData32[a++])return!0;return!1}updateBbx(e,t,r=!1){var i=e.width,a=e.height,s=0,n=t[1],o=0,l=n;if(this.checkBmpLine(e,n,0,i))for(;;){if((l=(n+o)/2|0)+1>=n){t[1]=l;break}this.checkBmpLine(e,l,0,i)?n=l:o=l}if(t[3]>a)t[3]=a;else if(l=n=t[3],o=a,this.checkBmpLine(e,n,0,i))for(;;){if((l=(n+o)/2|0)-1<=n){t[3]=l;break}this.checkBmpLine(e,l,0,i)?n=l:o=l}if(!r){var h=t[0],u=i*t[1];for(l=t[1];l<t[3];l++){for(s=0;s<h;s++)if(0!=this.bmpData32[u+s]){h=s;break}u+=i}t[0]=h;var d=t[2];for(u=i*t[1],l=t[1];l<t[3];l++){for(s=d;s<i;s++)if(0!=this.bmpData32[u+s]){d=s;break}u+=i}t[2]=d}}getFontSizeInfo(e){var t=this.fontSizeInfo[e];if(null!=t)return t;var r="bold "+TextRender.standardFontSize+"px "+e;if(TextRender.isWan1Wan){this.fontSizeW=1.5*this.charRender.getWidth(r,"有"),this.fontSizeH=1.5*TextRender.standardFontSize;var i=this.fontSizeW<<8|this.fontSizeH;return this.fontSizeInfo[e]=i,i}TextRender.pixelBBX[0]=TextRender.standardFontSize/2,TextRender.pixelBBX[1]=TextRender.standardFontSize/2,TextRender.pixelBBX[2]=TextRender.standardFontSize,TextRender.pixelBBX[3]=TextRender.standardFontSize;var a=16,s=16;this.charRender.scale(1,1),TextRender.tmpRI.height=TextRender.standardFontSize,this.charRender.fontsz=TextRender.standardFontSize;var n=this.charRender.getCharBmp("g",r,0,"red",null,TextRender.tmpRI,a,s,16,16);LayaEnv.isConch&&(n.data=new Uint8ClampedArray(n.data)),this.bmpData32=new Uint32Array(n.data.buffer),this.updateBbx(n,TextRender.pixelBBX,!1),n=this.charRender.getCharBmp("有",r,0,"red",null,TextRender.tmpRI,s,s,16,16),LayaEnv.isConch&&(n.data=new Uint8ClampedArray(n.data)),this.bmpData32=new Uint32Array(n.data.buffer),TextRender.pixelBBX[2]<a+TextRender.tmpRI.width&&(TextRender.pixelBBX[2]=a+TextRender.tmpRI.width),this.updateBbx(n,TextRender.pixelBBX,!1),LayaEnv.isConch&&(a=0,s=0);var o=Math.max(a-TextRender.pixelBBX[0],0)<<24|Math.max(s-TextRender.pixelBBX[1],0)<<16|TextRender.pixelBBX[2]-TextRender.pixelBBX[0]<<8|TextRender.pixelBBX[3]-TextRender.pixelBBX[1];return this.fontSizeInfo[e]=o,o}printDbgInfo(){for(var e in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+TextRender.atlasWidth+"x"+TextRender.atlasWidth," 用canvas:",TextRender.isWan1Wan),console.log("图集占用空间:"+TextRender.atlasWidth*TextRender.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var t=this.getFontSizeInfo(e),r=t>>24,i=t>>16&255,a=t>>8&255,s=255&t;console.log("    "+e," off:",r,i," size:",a,s)}var n=0;console.log("缓存数据:");var o=0,l=0;this.textAtlases.forEach((function(e){var t=e.texture.id,r=RenderInfo.loopCount-e.texture.lastTouchTm,i=r>0?r+"帧以前":"当前帧";for(var a in o+=e.texture.curUsedCovRate,l+=e.texture.curUsedCovRateAtlas,console.log("--图集(id:"+t+",当前使用率:"+(1e3*e.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*e.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*e.usedRate|0,"%, 使用于:"+i+")--:"),e.charMaps){var s=e.charMaps[a];console.log("     off:",s.orix,s.oriy," bmp宽高:",s.bmpWidth,s.bmpHeight,"无效:",s.deleted,"touchdt:",RenderInfo.loopCount-s.touchTick,"位置:",s.uv[0]*TextRender.atlasWidth|0,s.uv[1]*TextRender.atlasWidth|0,"字符:",s.char,"key:",a),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(e){console.log("    size:",e._texW,e._texH,"touch间隔:",RenderInfo.loopCount-e.lastTouchTm,"char:",e.ri.char)})),console.log("总缓存:",n,"总使用率:",o,"总当前图集使用率:",l)}showAtlas(e,t,r,i,a,s){if(!this.textAtlases[e])return console.log("没有这个图集"),null;var n=new Sprite,o=this.textAtlases[e].texture,l={width:TextRender.atlasWidth,height:TextRender.atlasWidth,sourceWidth:TextRender.atlasWidth,sourceHeight:TextRender.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:Texture.DEF_UV};return n.size=function(e,r){return this.width=e,this.height=r,n.graphics.clear(),n.graphics.drawRect(0,0,n.width,n.height,t),n.graphics.drawTexture(l,0,0,n.width,n.height),this},n.graphics.drawRect(0,0,a,s,t),n.graphics.drawTexture(l,0,0,a,s),n.pos(r,i),ILaya.stage.addChild(n),n}filltext_native(e,t,r,i,a,s,n,o,l){if(!(t&&t.length<=0)){var h=FontInfo.parse(a),u=0;switch(l){case"center":u=Const.ENUM_TEXTALIGN_CENTER;break;case"right":u=Const.ENUM_TEXTALIGN_RIGHT}return this._fast_filltext(e,t,r,i,h,s,n,o,u)}}}TextRender.useOldCharBook=!1,TextRender.atlasWidth=1024,TextRender.noAtlas=!1,TextRender.forceSplitRender=!1,TextRender.forceWholeRender=!1,TextRender.scaleFontWithCtx=!0,TextRender.maxFontScale=4,TextRender.standardFontSize=32,TextRender.destroyAtlasDt=10,TextRender.checkCleanTextureDt=2e3,TextRender.destroyUnusedTextureDt=3e3,TextRender.cleanMem=104857600,TextRender.isWan1Wan=!1,TextRender.showLog=!1,TextRender.debugUV=!1,TextRender.tmpRI=new CharRenderInfo,TextRender.pixelBBX=[0,0,0,0],TextRender.imgdtRect=[0,0,0,0],TextRender.simClean=!1;class MathUtils3D{constructor(){}static isZero(e){return Math.abs(e)<MathUtils3D.zeroTolerance}static nearEqual(e,t){return!!MathUtils3D.isZero(e-t)}static fastInvSqrt(e){return MathUtils3D.isZero(e)?e:1/Math.sqrt(e)}}MathUtils3D.zeroTolerance=1e-6,MathUtils3D.MaxValue=340282347e30,MathUtils3D.MinValue=-340282347e30,MathUtils3D.Deg2Rad=Math.PI/180;class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){this.x=e,this.y=t}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t}static equals(e,t){return MathUtils3D.nearEqual(e.x,t.x)&&MathUtils3D.nearEqual(e.y,t.y)}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}toArray(){return[this.x,this.y]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y}cloneTo(e){var t=e;t.x=this.x,t.y=this.y}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var r=e.x,i=e.y,a=r*r+i*i;a>0&&(a=1/Math.sqrt(a),t.x=r*a,t.y=i*a)}static scalarLength(e){var t=e.x,r=e.y;return Math.sqrt(t*t+r*r)}clone(){var e=new Vector2;return this.cloneTo(e),e}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1)}static rewriteNumProperty(e,t,r){Object.defineProperty(e,t,{get:function(){return this.elements[r]},set:function(e){this.elements[r]=e}})}}Vector2.ZERO=new Vector2(0,0),Vector2.ONE=new Vector2(1,1);class Vector4{constructor(e=0,t=0,r=0,i=0){this.x=e,this.y=t,this.z=r,this.w=i}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var e=new Vector4;return this.cloneTo(e),e}static lerp(e,t,r,i){var a=e.x,s=e.y,n=e.z,o=e.w;i.x=a+r*(t.x-a),i.y=s+r*(t.y-s),i.z=n+r*(t.z-n),i.w=o+r*(t.w-o)}static transformByM4x4(e,t,r){var i=e.x,a=e.y,s=e.z,n=e.w,o=t.elements;r.x=i*o[0]+a*o[4]+s*o[8]+n*o[12],r.y=i*o[1]+a*o[5]+s*o[9]+n*o[13],r.z=i*o[2]+a*o[6]+s*o[10]+n*o[14],r.w=i*o[3]+a*o[7]+s*o[11]+n*o[15]}static equals(e,t){return MathUtils3D.nearEqual(Math.abs(e.x),Math.abs(t.x))&&MathUtils3D.nearEqual(Math.abs(e.y),Math.abs(t.y))&&MathUtils3D.nearEqual(Math.abs(e.z),Math.abs(t.z))&&MathUtils3D.nearEqual(Math.abs(e.w),Math.abs(t.w))}equal(e){return Vector4.equals(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var r=e.length();if(r>0){var i=1/r;t.x=e.x*i,t.y=e.y*i,t.z=e.z*i,t.w=e.w*i}}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t}static Clamp(e,t,r,i){var a=e.x,s=e.y,n=e.z,o=e.w,l=t.x,h=t.y,u=t.z,d=t.w,_=r.x,c=r.y,m=r.z,p=r.w;a=(a=a>_?_:a)<l?l:a,s=(s=s>c?c:s)<h?h:s,n=(n=n>m?m:n)<u?u:n,o=(o=o>p?p:o)<d?d:o,i.x=a,i.y=s,i.z=n,i.w=o}static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return r*r+i*i+a*a+s*s}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z,s=e.w-t.w;return Math.sqrt(r*r+i*i+a*a+s*s)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1),Vector2.rewriteNumProperty(this,"z",2),Vector2.rewriteNumProperty(this,"w",3)}}Vector4.ZERO=new Vector4,Vector4.ONE=new Vector4(1,1,1,1),Vector4.UnitX=new Vector4(1,0,0,0),Vector4.UnitY=new Vector4(0,1,0,0),Vector4.UnitZ=new Vector4(0,0,1,0),Vector4.UnitW=new Vector4(0,0,0,1),Vector4.tempVec4=new Vector4(0,0,0,0);class Vector3{static distanceSquared(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return r*r+i*i+a*a}static distance(e,t){var r=e.x-t.x,i=e.y-t.y,a=e.z-t.z;return Math.sqrt(r*r+i*i+a*a)}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)}static transformQuat(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.x,o=t.y,l=t.z,h=t.w,u=h*i+o*s-l*a,d=h*a+l*i-n*s,_=h*s+n*a-o*i,c=-n*i-o*a-l*s;r.x=u*h+c*-n+d*-l-_*-o,r.y=d*h+c*-o+_*-n-u*-l,r.z=_*h+c*-l+u*-o-d*-n}static scalarLength(e){var t=e.x,r=e.y,i=e.z;return Math.sqrt(t*t+r*r+i*i)}static scalarLengthSquared(e){var t=e.x,r=e.y,i=e.z;return t*t+r*r+i*i}static normalize(e,t){var r=e.x,i=e.y,a=e.z,s=r*r+i*i+a*a;s>0&&(s=1/Math.sqrt(s),t.x=r*s,t.y=i*s,t.z=a*s)}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t}static lerp(e,t,r,i){var a=e.x,s=e.y,n=e.z;i.x=a+r*(t.x-a),i.y=s+r*(t.y-s),i.z=n+r*(t.z-n)}static transformV3ToV3(e,t,r){var i=Vector3._tempVector4;Vector3.transformV3ToV4(e,t,i),r.x=i.x,r.y=i.y,r.z=i.z}static transformV3ToV4(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.elements;r.x=i*n[0]+a*n[4]+s*n[8]+n[12],r.y=i*n[1]+a*n[5]+s*n[9]+n[13],r.z=i*n[2]+a*n[6]+s*n[10]+n[14],r.w=i*n[3]+a*n[7]+s*n[11]+n[15]}static TransformNormal(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.elements;r.x=i*n[0]+a*n[4]+s*n[8],r.y=i*n[1]+a*n[5]+s*n[9],r.z=i*n[2]+a*n[6]+s*n[10]}static transformCoordinate(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.elements,o=i*n[3]+a*n[7]+s*n[11]+n[15];r.x=(i*n[0]+a*n[4]+s*n[8]+n[12])/o,r.y=(i*n[1]+a*n[5]+s*n[9]+n[13])/o,r.z=(i*n[2]+a*n[6]+s*n[10]+n[14])/o}static Clamp(e,t,r,i){var a=e.x,s=e.y,n=e.z,o=t.x,l=t.y,h=t.z,u=r.x,d=r.y,_=r.z;a=(a=a>u?u:a)<o?o:a,s=(s=s>d?d:s)<l?l:s,n=(n=n>_?_:n)<h?h:n,i.x=a,i.y=s,i.z=n}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z}static cross(e,t,r){var i=e.x,a=e.y,s=e.z,n=t.x,o=t.y,l=t.z;r.x=a*l-s*o,r.y=s*n-i*l,r.z=i*o-a*n}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return MathUtils3D.nearEqual(e.x,t.x)&&MathUtils3D.nearEqual(e.y,t.y)&&MathUtils3D.nearEqual(e.z,t.z)}constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}equal(e){return Vector3.equals(this,e)}setValue(e,t,r){return this.x=e,this.y=t,this.z=r,this}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}toArray(){return[this.x,this.y,this.z]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}vadd(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}scale(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}normalize(){let e=this.x,t=this.y,r=this.z;var i=e*e+t*t+r*r;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=r*i),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e,t){var r=this.x,i=this.y,a=this.z,s=e.x,n=e.y,o=e.z;return t.x=i*o-a*n,t.y=a*s-r*o,t.z=r*n-i*s,t}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}clone(){var e=new Vector3;return this.cloneTo(e),e}toDefault(){this.x=0,this.y=0,this.z=0}}Vector3._tempVector4=new Vector4,Vector3.ZERO=new Vector3(0,0,0),Vector3.ONE=new Vector3(1,1,1),Vector3.NegativeUnitX=new Vector3(-1,0,0),Vector3.UnitX=new Vector3(1,0,0),Vector3.UnitY=new Vector3(0,1,0),Vector3.UnitZ=new Vector3(0,0,1),Vector3.ForwardRH=new Vector3(0,0,-1),Vector3.ForwardLH=new Vector3(0,0,1),Vector3.Up=new Vector3(0,1,0);class Config3D{static setResolution(e,t){Config3D.customResolution=!0,Config3D._resoluWidth=e,Config3D._resoluHeight=t}}Config3D.enableDynamicBatch=!0,Config3D.enableStaticBatch=!0,Config3D.enableUniformBufferObject=!0,Config3D.pixelRatio=1,Config3D.customResolution=!1,Config3D.defaultCacheRTMemory=256,Config3D.defaultPhysicsMemory=16,Config3D.enableMultiLight=!0,Config3D.maxLightCount=32,Config3D.lightClusterCount=new Vector3(12,12,12),Config3D.maxMorphTargetCount=32,Config3D.useBVHCull=!1,Config3D.BVH_max_SpatialCount=7,Config3D.BVH_limit_size=32,Config3D.BVH_Min_Build_nums=10,Config3D._resoluWidth=-1,Config3D._resoluHeight=-1,Config3D.debugFrustumCulling=!1,Config.isStencil=!0;class RenderTexture extends BaseTexture{static get currentActive(){return RenderTexture._currentActive}static configRenderContextInstance(e){RenderTexture._configInstance=e}static createFromPool(e,t,r,i,a=!1,s=1,n=!1,o=!1){a=a&&0==(e&e-1)&&0==(t&t-1);let l=RenderTexture._pool.length;for(let h=0;h<l;h++){let u=RenderTexture._pool[h];if(u.width==e&&u.height==t&&u.colorFormat==r&&u.depthStencilFormat==i&&u._generateMipmap==a&&u.multiSamples==s&&u.generateDepthTexture==n&&u._gammaSpace==o){u._inPool=!1;let e=RenderTexture._pool[l-1];return RenderTexture._pool[h]=e,RenderTexture._pool.length-=1,RenderTexture._poolMemory-=u._renderTarget.gpuMemory/1024/1024,u}}let h=new RenderTexture(e,t,r,i,a,s,n,o);return h.lock=!0,h}static recoverToPool(e){e._inPool||e.destroyed||(RenderTexture._pool.push(e),RenderTexture._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0)}static clearPool(){if(!(RenderTexture._poolMemory<Config3D.defaultCacheRTMemory)){for(var e in RenderTexture._pool)RenderTexture._pool[e].destroy();RenderTexture._pool=[],RenderTexture._poolMemory=0}}static get bindCanvasRender(){return RenderTexture._bindCanvasRender}static set bindCanvasRender(e){e!=this._bindCanvasRender&&(this._bindCanvasRender=e)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(t){t&&!this._depthStencilTexture&&(this._depthStencilTexture=new BaseTexture(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=e.TextureDimension.Tex2D,this._depthStencilTexture._texture=LayaGL.textureContext.createRenderTextureInternal(e.TextureDimension.Tex2D,this.width,this.height,this.depthStencilFormat,!1,!1),LayaGL.textureContext.setupRendertargetTextureAttachment(this._renderTarget,this._depthStencilTexture._texture)),this._generateDepthTexture=t}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(t,r,i,a,s=!1,n=1,o=!1,l=!1){super(t,r,i),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=l,this._depthStencilFormat=null==a?e.RenderTargetFormat.None:a,this._generateMipmap=s,this._multiSamples=n,this._generateDepthTexture=o,this._createRenderTarget()}_createRenderTarget(){this._dimension=e.TextureDimension.Tex2D,this._renderTarget=LayaGL.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(t,r,i,a,s=!1,n=1,o=!1,l=!1){this._width=t,this._height=r,this._format=i,this._gammaSpace=l,this._depthStencilFormat=null==a?e.RenderTargetFormat.None:a,this._generateMipmap=s,this._multiSamples=n,this._generateDepthTexture=o,this._disposeResource(),this._createRenderTarget()}_start(){RenderTexture._configInstance.invertY=this._isCameraTarget,RenderTexture._currentActive!=this&&(RenderTexture._currentActive&&RenderTexture._currentActive._end(),RenderTexture._currentActive=this,LayaGL.textureContext.bindRenderTarget(this._renderTarget))}_end(){RenderTexture._currentActive=null,LayaGL.textureContext.unbindRenderTarget(this._renderTarget),this._isCameraTarget&&(RenderTexture._configInstance.invertY=!1)}getData(e,t,r,i,a){return LayaGL.textureContext.readRenderTargetPixelData(this._renderTarget,e,t,r,i,a),a}_disposeResource(){var e;RenderTexture._currentActive==this&&this._end(),this._renderTarget.dispose(),this._renderTarget=null,null===(e=this._depthStencilTexture)||void 0===e||e.destroy(),this._depthStencilTexture=null}}RenderTexture._currentActive=null,RenderTexture._configInstance={},RenderTexture._pool=[],RenderTexture._poolMemory=0,function(e){e[e.SIZE=0]="SIZE",e[e.CLEAR=1]="CLEAR",e[e.SAVE=2]="SAVE",e[e.TRANSFORM=3]="TRANSFORM",e[e.ALPHA=4]="ALPHA",e[e.RESTORE=5]="RESTORE",e[e.FILL_STYLE=6]="FILL_STYLE",e[e.FILL_RECT=7]="FILL_RECT",e[e.STROKE_STYLE=8]="STROKE_STYLE",e[e.LINE_WIDTH=9]="LINE_WIDTH",e[e.STROKE_RECT=10]="STROKE_RECT",e[e.FILL_WORD_TEXT=11]="FILL_WORD_TEXT",e[e.DRAW_TEXTURE_SIZE_GRID=12]="DRAW_TEXTURE_SIZE_GRID",e[e.DRAW_TEXTURE=13]="DRAW_TEXTURE",e[e.CLIP_RECT=14]="CLIP_RECT",e[e.DRAW_LINE=15]="DRAW_LINE",e[e.DRAW_LINES=16]="DRAW_LINES",e[e.SCALE=17]="SCALE",e[e.TRANSLATE=18]="TRANSLATE",e[e.ROTATE=19]="ROTATE",e[e.DRAW_CIRCLE=20]="DRAW_CIRCLE",e[e.DRAW_PIE=21]="DRAW_PIE",e[e.DRAW_POLY=22]="DRAW_POLY",e[e.DRAW_CURVES=23]="DRAW_CURVES",e[e.BEGIN_PATH=24]="BEGIN_PATH",e[e.MOVE_TO=25]="MOVE_TO",e[e.LINE_TO=26]="LINE_TO",e[e.ARC_TO=27]="ARC_TO",e[e.CLOSE_PATH=28]="CLOSE_PATH",e[e.FILL=29]="FILL",e[e.STROKE=30]="STROKE",e[e.SET_AS_BITMAP=31]="SET_AS_BITMAP",e[e.DRAW_MASKED=32]="DRAW_MASKED",e[e.DRAW_TRANGLES=33]="DRAW_TRANGLES",e[e.SET_GLOBAL_COMPOSITE_OPERTAION=34]="SET_GLOBAL_COMPOSITE_OPERTAION",e[e.FILL_WORDS=35]="FILL_WORDS",e[e.FILL_TEXTURE=36]="FILL_TEXTURE"}(Q||(Q={}));class NativeContext{static __init__(){}constructor(){this._byteLen=0,this.sprite=null,this._renderObject3DList=[],this._tmpMatrix=new Matrix,this._nativeObj=new window._conchContext(LayaGL.renderEngine._nativeObj),this._byteLen=524288,this._tempRenderTexture2D=new NativeRenderTexture2D(0,0,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None,!1),this._init(!1)}_init(e){this._buffer=new ArrayBuffer(this._byteLen),this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._byteArray=new Uint8Array(this._buffer);var t=window.webglPlus.createArrayBufferRef(this._buffer,NativeContext.ARRAY_BUFFER_TYPE_CMD,e,NativeContext.ARRAY_BUFFER_REF_REFERENCE);this._nativeObj.setSharedCommandBuffer(t),this._idata[0]=1}_need(e){if(!(this._byteLen-(this._idata[0]<<2)>=e)&&(this._nativeObj.flushCommand(),e>this._byteLen))throw"too big"}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}clearRect(e,t,r,i){}set isMain(e){this._nativeObj.flushCommand(),this._nativeObj.isMain=e}get isMain(){return this._nativeObj.flushCommand(),this._nativeObj.isMain}set _targets(e){e&&(this._nativeObj.flushCommand(),this._nativeObj._target=e._nativeObj)}get _targets(){this._nativeObj.flushCommand();let e=this._nativeObj._target;return e?(this._tempRenderTexture2D.width=this._nativeObj.width,this._tempRenderTexture2D.height=this._nativeObj.height,this._tempRenderTexture2D._nativeObj=e,this._tempRenderTexture2D._renderTarget=e._renderTarget,this._tempRenderTexture2D._texture=e._renderTarget._textures[0],this._tempRenderTexture2D):null}alpha(e){this.globalAlpha*=e}flush(){BufferState._curBindedBufferState&&BufferState._curBindedBufferState.unBind(),this._nativeObj.flushCommand(),this._nativeObj.flush()}clear(){this.add_i(Q.CLEAR),this._nativeObj.flushCommand(),this._renderObject3DList.length=0}destroy(e=!1){this._nativeObj.flushCommand(),this._tempRenderTexture2D._nativeObj&&(this._tempRenderTexture2D._nativeObj._deleteRT=e),this._nativeObj.destroy(e)}static set2DRenderConfig(){if(!NativeContext.const2DRenderCMD){const t=NativeContext.const2DRenderCMD=LayaGL.renderEngine.createRenderStateComand();t.addCMD(e.RenderStateType.BlendType,!0),t.addCMD(e.RenderStateType.BlendEquation,e.BlendEquationSeparate.ADD),BlendMode.activeBlendFunction=null,t.addCMD(e.RenderStateType.BlendFunc,[e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha]),t.addCMD(e.RenderStateType.DepthTest,!1),t.addCMD(e.RenderStateType.DepthMask,!0),t.addCMD(e.RenderStateType.CullFace,!1),t.addCMD(e.RenderStateType.FrontFace,e.CullMode.Front)}NativeContext.const2DRenderCMD.applyCMD(),RenderTexture.currentActive&&RenderTexture.currentActive._end(),window.set2DRenderConfig(),BufferState._curBindedBufferState&&BufferState._curBindedBufferState.unBind()}set globalCompositeOperation(e){this.add_i_String(Q.SET_GLOBAL_COMPOSITE_OPERTAION,e)}get globalCompositeOperation(){return this._nativeObj.flushCommand(),this._nativeObj.globalCompositeOperation}set fillStyle(e){var t=ColorUtils.create(e);this.add_ii(Q.FILL_STYLE,t.numColor)}get fillStyle(){return this._nativeObj.flushCommand(),this._nativeObj.fillStyle}set globalAlpha(e){this.add_if(Q.ALPHA,e)}get globalAlpha(){return this._nativeObj.flushCommand(),this._nativeObj.globalAlpha}save(){this.add_i(Q.SAVE)}restore(){this.add_i(Q.RESTORE)}saveTransform(e){this.add_i(Q.SAVE)}transformByMatrix(e,t,r){this.add_iffffff(Q.TRANSFORM,e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}restoreTransform(e){this.add_i(Q.RESTORE)}clipRect(e,t,r,i){this.add_iffff(Q.CLIP_RECT,e,t,r,i)}transform(e,t,r,i,a,s){this.add_iffffff(Q.TRANSFORM,e,t,r,i,a,s)}scale(e,t){this.add_iff(Q.SCALE,e,t)}drawTexture(e,t,r,i,a,s=4294967295){this.checkTexture(e)&&this.add_iiffffffffffffi(Q.DRAW_TEXTURE,e.bitmap._texture.id,t,r,i,a,e.uv[0],e.uv[1],e.uv[2],e.uv[3],e.uv[4],e.uv[5],e.uv[6],e.uv[7],s)}drawTextureWithTransform(e,t,r,i,a,s,n,o,l,h,u,d=4294967295){if(this.checkTexture(e)){this.save(),this.alpha(l);var _=u||e.uv;s?(this.add_iffffff(Q.TRANSFORM,s.a,s.b,s.c,s.d,s.tx+n,s.ty+o),this.add_iiffffffffffffi(Q.DRAW_TEXTURE,e.bitmap._texture.id,t,r,i||e.width,a||e.height,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],d)):this.add_iiffffffffffffi(Q.DRAW_TEXTURE,e.bitmap._texture.id,t+n,r+o,i||e.width,a||e.height,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],d),this.restore()}}drawTextureWithSizeGrid(e,t,r,i,a,s,n,o,l){if(this.checkTexture(e)){var h=e.uv;e.bitmap.width,e.bitmap.height;var u=s[0],d=s[3],_=s[1],c=s[2],m=s[4];this.add_iiffffffffiffffffffffi(Q.DRAW_TEXTURE_SIZE_GRID,e.bitmap._texture.id,t,r,i,a,u,_,c,d,m?1:0,n,o,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],l)}}_drawTextureM(e,t,r,i,a,s,n,o,l){if(this.checkTexture(e)){this.save(),this.alpha(n),s&&this.add_iffffff(Q.TRANSFORM,s.a,s.b,s.c,s.d,s.tx,s.ty);var h=o||e.uv;this.add_iiffffffffffffi(Q.DRAW_TEXTURE,e.bitmap._texture.id,t,r,i||e.width,a||e.height,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],l),this.restore()}}translate(e,t){this.add_iff(Q.TRANSLATE,e,t)}_transform(e,t,r){this.add_iff(Q.TRANSLATE,t,r),this.add_iffffff(Q.TRANSFORM,e.a,e.b,e.c,e.d,e.tx,e.ty),this.add_iff(Q.TRANSLATE,-t,-r)}_rotate(e,t,r){this.add_iff(Q.TRANSLATE,t,r),this.add_if(Q.ROTATE,e),this.add_iff(Q.TRANSLATE,-t,-r)}_scale(e,t,r,i){this.add_iff(Q.TRANSLATE,r,i),this.add_iff(Q.SCALE,e,t),this.add_iff(Q.TRANSLATE,-r,-i)}_drawLine(e,t,r,i,a,s,n,o,l){var h=ColorUtils.create(n);this.add_iffffffif(Q.DRAW_LINE,e,t,r,i,a,s,h.numColor,o)}_drawLines(e,t,r,i,a,s){var n=ColorUtils.create(i);this.add_iffif_ab(Q.DRAW_LINES,e,t,n.numColor,a,new Float32Array(r))}_drawCircle(e,t,r,i,a,s,n){var o=ColorUtils.create(i),l=ColorUtils.create(a);this.add_ifffiiiif(Q.DRAW_CIRCLE,e,t,r,i?1:0,o.numColor,a?1:0,l.numColor,s)}_drawPie(e,t,r,i,a,s,n,o,l){var h=ColorUtils.create(s),u=ColorUtils.create(n);this.add_ifffffiiiif(Q.DRAW_PIE,e,t,r,i,a,s?1:0,h.numColor,n?1:0,u.numColor,o)}_drawPoly(e,t,r,i,a,s,n,o){var l=ColorUtils.create(i),h=ColorUtils.create(a);this.add_iffiiiifi_ab(Q.DRAW_POLY,e,t,i?1:0,l.numColor,a?1:0,h.numColor,s,n?1:0,new Float32Array(r))}fillRect(e,t,r,i,a){if(null!=a){var s=ColorUtils.create(a);this.add_ii(Q.FILL_STYLE,s.numColor)}this.add_i(Q.SAVE),this.add_iffff(Q.FILL_RECT,e,t,r,i),this.add_i(Q.RESTORE)}fillTexture(e,t,r,i,a,s,n,o){if(this.checkTexture(e)){var l=0;switch(s){case"repeat":l=0;break;case"repeat-x":l=1;break;case"repeat-y":l=2;break;case"no-repeat":l=3}this.add_iiffffiffi(Q.FILL_TEXTURE,e.bitmap._texture.id,t,r,i,a,l,n.x,n.y,o)}}drawRect(e,t,r,i,a,s,n){if(null!=a){var o=ColorUtils.create(a);this.add_i(Q.SAVE),this.add_ii(Q.FILL_STYLE,o.numColor),this.add_iffff(Q.FILL_RECT,e,t,r,i),this.add_i(Q.RESTORE)}if(null!=s){var l=ColorUtils.create(s);this.add_i(Q.SAVE),this.add_ii(Q.STROKE_STYLE,l.numColor),this.add_if(Q.LINE_WIDTH,n),this.add_iffff(Q.STROKE_RECT,e,t,r,i),this.add_i(Q.RESTORE)}}_drawPath(e,t,r,i,a){this.add_ii(Q.BEGIN_PATH,0);for(var s=0,n=r.length;s<n;s++){var o=r[s];switch(o[0]){case"moveTo":this.add_iff(Q.MOVE_TO,e+o[1],t+o[2]);break;case"lineTo":this.add_iff(Q.LINE_TO,e+o[1],t+o[2]);break;case"arcTo":this.add_ifffff(Q.ARC_TO,e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.add_i(Q.CLOSE_PATH)}}if(null!=i){var l=ColorUtils.create(i.fillStyle);this.add_ii(Q.FILL_STYLE,l.numColor),this.add_i(Q.FILL)}if(null!=a){var h=ColorUtils.create(a.strokeStyle);this.add_ii(Q.STROKE_STYLE,h.numColor),this.add_if(Q.LINE_WIDTH,a.lineWidth||1),this.add_i(Q.STROKE)}}drawCurves(e,t,r,i,a){var s=ColorUtils.create(i);this.add_iffif_ab(Q.DRAW_CURVES,e,t,s.numColor,a,new Float32Array(r))}drawCanvas(e,t,r,i,a){e&&(this._nativeObj.flushCommand(),e instanceof NativeWebGLCacheAsNormalCanvas?this._nativeObj.drawCanvasNormal(e._nativeObj,t,r,i,a):this._nativeObj.drawCanvasBitmap(e.context._nativeObj,t,r,i,a))}fillText(e,t,r,i,a,s,n=0,o=""){var l=0;switch(s){case"center":l=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l=Const.ENUM_TEXTALIGN_RIGHT}var h=ColorUtils.create(a),u=ColorUtils.create(o);"string"==typeof e?this.add_iiiifff_String_String(Q.FILL_WORDS,h.numColor,u.numColor,l,t,r,n,e,i):this.add_iiffiifi_String(Q.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,l,i)}drawText(e,t,r,i,a,s){var n=0;switch(s){case"center":n=Const.ENUM_TEXTALIGN_CENTER;break;case"right":n=Const.ENUM_TEXTALIGN_RIGHT}var o=ColorUtils.create(a),l=ColorUtils.create(null);"string"==typeof e?this.add_iiiifff_String_String(Q.FILL_WORDS,o.numColor,l.numColor,n,t,r,0,e,i):this.add_iiffiifi_String(Q.FILL_WORD_TEXT,e._nativeObj.id,t,r,o.numColor,l.numColor,0,n,i)}strokeWord(e,t,r,i,a,s,n){var o=0;switch(n){case"center":o=Const.ENUM_TEXTALIGN_CENTER;break;case"right":o=Const.ENUM_TEXTALIGN_RIGHT}var l=ColorUtils.create(a),h=ColorUtils.create(null);"string"==typeof e?this.add_iiiifff_String_String(Q.FILL_WORDS,l.numColor,h.numColor,o,t,r,s,e,i):this.add_iiffiifi_String(Q.FILL_WORD_TEXT,e._nativeObj.id,t,r,l.numColor,h.numColor,s,o,i)}fillBorderText(e,t,r,i,a,s,n,o){var l=0;switch(o){case"center":l=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l=Const.ENUM_TEXTALIGN_RIGHT}var h=ColorUtils.create(a),u=ColorUtils.create(s);"string"==typeof e?this.add_iiiifff_String_String(Q.FILL_WORDS,h.numColor,u.numColor,l,t,r,n,e,i):this.add_iiffiifi_String(Q.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,l,i)}filltext11(e,t,r,i,a,s,n,o){var l=0;switch(o){case"center":l=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l=Const.ENUM_TEXTALIGN_RIGHT}var h=ColorUtils.create(a),u=ColorUtils.create(s);"string"==typeof e?this.add_iiiifff_String_String(Q.FILL_WORDS,h.numColor,u.numColor,l,t,r,n,e,i):this.add_iiffiifi_String(Q.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,l,i)}_fast_filltext(e,t,r,i,a,s,n,o,l=0){var h=ColorUtils.create(a),u=ColorUtils.create(s);"string"==typeof e?this.add_iiiifff_String_String(Q.FILL_WORDS,h.numColor,u.numColor,o,t,r,n,e,i._font):this.add_iiffiifi_String(Q.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,o,i._font)}drawTriangles(e,t,r,i,a,s,n,o,l,h=4294967295){if(this.checkTexture(e)){var u=n||this._tmpMatrix;null!=l?(this.add_i(Q.SAVE),this.add_i_String(Q.SET_GLOBAL_COMPOSITE_OPERTAION,l),this.add_iiifffffffff_ab_ab_ab(Q.DRAW_TRANGLES,e.bitmap._texture.id,h,t,r,o,u.a,u.b,u.c,u.d,u.tx,u.ty,i instanceof Array?Float32Array.from(i):i,a instanceof Array?Float32Array.from(a):a,s instanceof Array?Uint16Array.from(s):s),this.add_i(Q.RESTORE)):this.add_iiifffffffff_ab_ab_ab(Q.DRAW_TRANGLES,e.bitmap._texture.id,h,t,r,o,u.a,u.b,u.c,u.d,u.tx,u.ty,i instanceof Array?Float32Array.from(i):i,a instanceof Array?Float32Array.from(a):a,s instanceof Array?Uint16Array.from(s):s)}}drawMask(e,t){return this._nativeObj.flushCommand(),this._nativeObj.drawMask(e,t)}drawMasked(e,t,r,i){this.add_iffff(Q.DRAW_MASKED,e,t,r,i)}drawMaskComposite(e,t,r,i,a){this._nativeObj.flushCommand(),this._nativeObj.drawMaskComposite(e,t,r,i,a)}set asBitmap(e){this.add_ii(Q.SET_AS_BITMAP,e?1:0)}size(e,t){this.add_iii(Q.SIZE,e,t)}setColorFilter(e){this._nativeObj.flushCommand(),e?this._nativeObj.setColorFilter(!0,e._alpha,e._mat):this._nativeObj.setColorFilter(!1,null,null)}drawTarget(e,t,r,i,a,s,n,o=null,l=-1){return this._nativeObj.flushCommand(),this._nativeObj.drawTarget(e,t,r,i,a,s.a,s.b,s.c,s.d,s.tx,s.ty,l)}drawTargetBlurFilter(e,t,r,i,a,s){this._nativeObj.flushCommand(),this._nativeObj.drawTargetBlurFilter(e,t,r,i,a,s)}get _curMat(){this._nativeObj.flushCommand();var e=this._nativeObj._curMat,t=Matrix.create();return t.a=e[0],t.b=e[1],t.c=e[2],t.d=e[3],t.tx=e[4],t.ty=e[5],t}addRenderObject3D(e){this._renderObject3DList.push(e._nativeObj),this._nativeObj.flushCommand(),this._nativeObj.addRenderObject3D(e._nativeObj)}pushRT(){this._nativeObj.flushCommand(),this._nativeObj.pushRT()}popRT(){this._nativeObj.flushCommand(),this._nativeObj.popRT()}useRT(e){this._nativeObj.flushCommand(),this._nativeObj.useRT(e)}drawFilter(e,t,r,i,a,s){this._nativeObj.flushCommand(),this._nativeObj.drawFilter(e,t,r,i,a,s)}checkTexture(e){var t=this.sprite;return!!e._getSource((function(){t&&t.repaint()}))}add_i(e){this._need(4),this._idata[this._idata[0]++]=e}add_ii(e,t){this._need(8);var r=this._idata[0];this._idata[r++]=e,this._idata[r++]=t,this._idata[0]=r}add_if(e,t){this._need(8);var r=this._idata[0];this._idata[r++]=e,this._fdata[r++]=t,this._idata[0]=r}add_iff(e,t,r){this._need(12);var i=this._idata[0];this._idata[i++]=e,this._fdata[i++]=t,this._fdata[i++]=r,this._idata[0]=i}add_iffif(e,t,r,i,a){this._need(20);var s=this._idata[0],n=this._fdata;this._idata[s++]=e,n[s++]=t,n[s++]=r,this._idata[s++]=i,n[s++]=a,this._idata[0]=s}add_iffff(e,t,r,i,a){this._need(20);var s=this._idata[0],n=this._fdata;this._idata[s++]=e,n[s++]=t,n[s++]=r,n[s++]=i,n[s++]=a,this._idata[0]=s}add_iii(e,t,r){this._need(12);var i=this._idata,a=this._idata[0];i[a++]=e,i[a++]=t,i[a++]=r,this._idata[0]=a}add_iiffff(e,t,r,i,a,s){this._need(24);var n=this._idata[0],o=this._fdata;this._idata[n++]=e,this._idata[n++]=t,o[n++]=r,o[n++]=i,o[n++]=a,o[n++]=s,this._idata[0]=n}add_ifffff(e,t,r,i,a,s){this._need(24);var n=this._idata[0],o=this._fdata;this._idata[n++]=e,o[n++]=t,o[n++]=r,o[n++]=i,o[n++]=a,o[n++]=s,this._idata[0]=n}add_iffffff(e,t,r,i,a,s,n){this._need(28);var o=this._idata[0],l=this._fdata;this._idata[o++]=e,l[o++]=t,l[o++]=r,l[o++]=i,l[o++]=a,l[o++]=s,l[o++]=n,this._idata[0]=o}add_ifffiiiif(e,t,r,i,a,s,n,o,l){this._need(36);var h=this._idata,u=h[0],d=this._fdata;h[u++]=e,d[u++]=t,d[u++]=r,d[u++]=i,h[u++]=a,h[u++]=s,h[u++]=n,h[u++]=o,d[u++]=l,h[0]=u}add_ifffffiiiif(e,t,r,i,a,s,n,o,l,h,u){this._need(44);var d=this._idata,_=d[0],c=this._fdata;d[_++]=e,c[_++]=t,c[_++]=r,c[_++]=i,c[_++]=a,c[_++]=s,d[_++]=n,d[_++]=o,d[_++]=l,d[_++]=h,c[_++]=u,d[0]=_}add_iffffffif(e,t,r,i,a,s,n,o,l){this._need(36);var h=this._idata,u=h[0],d=this._fdata;h[u++]=e,d[u++]=t,d[u++]=r,d[u++]=i,d[u++]=a,d[u++]=s,d[u++]=n,h[u++]=o,d[u++]=l,h[0]=u}add_String(e){var t=e.byteLength;if(this._need(t+4),this._idata[this._idata[0]++]=t,0!=t){var r=new Uint8Array(e);this._byteArray.set(r,4*this._idata[0]),this._idata[0]+=t/4}}add_iffiiiifi(e,t,r,i,a,s,n,o,l){this._need(45);var h=this._idata[0],u=this._fdata;this._idata[h++]=e,u[h++]=t,u[h++]=r,this._idata[h++]=i,this._idata[h++]=a,this._idata[h++]=s,this._idata[h++]=n,u[h++]=o,this._idata[h++]=l,this._idata[0]=h}add_iiffiifi(e,t,r,i,a,s,n,o){this._need(32);var l=this._idata[0],h=this._fdata;this._idata[l++]=e,this._idata[l++]=t,h[l++]=r,h[l++]=i,this._idata[l++]=a,this._idata[l++]=s,h[l++]=n,this._idata[l++]=o,this._idata[0]=l}add_i_String(e,t){var r=window.conch.strTobufer(t);this._need(4+r.byteLength+4),this.add_i(e),this.add_String(r)}add_iiiifff(e,t,r,i,a,s,n){this._need(28);var o=this._idata[0],l=this._fdata;this._idata[o++]=e,this._idata[o++]=t,this._idata[o++]=r,this._idata[o++]=i,l[o++]=a,l[o++]=s,l[o++]=n,this._idata[0]=o}add_iiffiifi_String(e,t,r,i,a,s,n,o,l){var h=window.conch.strTobufer(l);this._need(32+h.byteLength+4),this.add_iiffiifi(e,t,r,i,a,s,n,o),this.add_String(h)}add_iiiifff_String_String(e,t,r,i,a,s,n,o,l){var h=window.conch.strTobufer(o),u=window.conch.strTobufer(l);this._need(28+(h.byteLength+4)+(u.byteLength+4)),this.add_iiiifff(e,t,r,i,a,s,n),this.add_String(h),this.add_String(u)}add_iiffffffffffffi(e,t,r,i,a,s,n,o,l,h,u,d,_,c,m){this._need(60);var p=this._idata,f=p[0],g=this._fdata;p[f++]=e,p[f++]=t,g[f++]=r,g[f++]=i,g[f++]=a,g[f++]=s,g[f++]=n,g[f++]=o,g[f++]=l,g[f++]=h,g[f++]=u,g[f++]=d,g[f++]=_,g[f++]=c,p[f++]=m,p[0]=f}add_iiffffffffiffffffffffi(e,t,r,i,a,s,n,o,l,h,u,d,_,c,m,p,f,g,T,x,S,y){this._need(88);var E=this._idata,C=this._fdata,v=E[0];E[v++]=e,E[v++]=t,C[v++]=r,C[v++]=i,C[v++]=a,C[v++]=s,C[v++]=n,C[v++]=o,C[v++]=l,C[v++]=h,E[v++]=u,C[v++]=d,C[v++]=_,C[v++]=c,C[v++]=m,C[v++]=p,C[v++]=f,C[v++]=g,C[v++]=T,C[v++]=x,C[v++]=S,E[v++]=y,E[0]=v}add_iiifffffffff(e,t,r,i,a,s,n,o,l,h,u,d){this._need(48);var _=this._idata,c=this._fdata,m=_[0];_[m++]=e,_[m++]=t,_[m++]=r,c[m++]=i,c[m++]=a,c[m++]=s,c[m++]=n,c[m++]=o,c[m++]=l,c[m++]=h,c[m++]=u,c[m++]=d,_[0]=m}add_iiffffiffi(e,t,r,i,a,s,n,o,l,h){this._need(40);let u=this._idata,d=this._fdata;var _=u[0];u[_++]=e,u[_++]=t,d[_++]=r,d[_++]=i,d[_++]=a,d[_++]=s,u[_++]=n,d[_++]=o,d[_++]=l,u[_++]=h,u[0]=_}add_iiifffffffff_ab_ab_ab(e,t,r,i,a,s,n,o,l,h,u,d,_,c,m){var p=this.getAlignLength(_),f=this.getAlignLength(c),g=this.getAlignLength(m);this._need(48+(p+4)+(f+4)+(g+4)),this.add_iiifffffffff(e,t,r,i,a,s,n,o,l,h,u,d),this.wab(_,_.byteLength,p,0),this.wab(c,c.byteLength,f,0),this.wab(m,m.byteLength,g,0)}wab(e,t,r,i){i=i||0,this._need(r+4),this._idata[this._idata[0]++]=t;var a=null;if(e instanceof Float32Array&&0==i)this._fdata.set(e,this._idata[0]);else{if(e instanceof ArrayBuffer)a=new Uint8Array(e,i,t);else{if(!e.buffer)return void console.log("not arraybuffer/dataview");a=new Uint8Array(e.buffer,i+e.byteOffset,t)}this._byteArray.set(a,4*this._idata[0])}this._idata[0]+=r/4}getAlignLength(e){return e.byteLength+3&4294967292}add_iif_ab(e,t,r,i){var a=this.getAlignLength(i);this._need(12+a+4),this.add_iff(e,t,r),this.wab(i,i.byteLength,a,0)}add_iffif_ab(e,t,r,i,a,s){var n=this.getAlignLength(s);this._need(20+n+4),this.add_iffif(e,t,r,i,a),this.wab(s,s.byteLength,n,0)}add_iffiiiifi_ab(e,t,r,i,a,s,n,o,l,h){var u=this.getAlignLength(h);this._need(45+u+4),this.add_iffiiiifi(e,t,r,i,a,s,n,o,l),this.wab(h,h.byteLength,u,0)}}NativeContext.ARRAY_BUFFER_TYPE_DATA=0,NativeContext.ARRAY_BUFFER_TYPE_CMD=1,NativeContext.ARRAY_BUFFER_REF_REFERENCE=0,NativeContext.ARRAY_BUFFER_REF_COPY=1,NativeContext.ENUM_TEXTALIGN_DEFAULT=0,NativeContext.ENUM_TEXTALIGN_CENTER=1,NativeContext.ENUM_TEXTALIGN_RIGHT=2;const Z=new Matrix(Const.MAX_CLIP_SIZE,0,0,Const.MAX_CLIP_SIZE,0,0);class Context{static __init__(){Context.MAXCLIPRECT=new Rectangle(0,0,Const.MAX_CLIP_SIZE,Const.MAX_CLIP_SIZE),ContextParams.DEFAULT=new ContextParams}drawImage(...e){}getImageData(...e){}measureText(e){return null}setTransform(...e){}$transform(e,t,r,i,a,s){}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}clearRect(e,t,r,i){}_drawRect(e,t,r,i,a){a&&(this.fillStyle=a),this.fillRect(e,t,r,i,null)}drawTexture2(e,t,r,i,a,s){}transformByMatrix(e,t,r){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}saveTransform(e){this.save()}restoreTransform(e){this.restore()}drawRect(e,t,r,i,a,s,n){var o=this;null!=a&&(o.fillStyle=a,o.fillRect(e,t,r,i)),null!=s&&(o.strokeStyle=s,o.lineWidth=n,o.strokeRect(e,t,r,i))}alpha(e){this.globalAlpha*=e}_transform(e,t,r){this.translate(t,r),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-r)}_rotate(e,t,r){this.translate(t,r),this.rotate(e),this.translate(-t,-r)}_scale(e,t,r,i){this.translate(r,i),this.scale(e,t),this.translate(-r,-i)}_drawLine(e,t,r,i,a,s,n,o,l){this.beginPath(),this.strokeStyle=n,this.lineWidth=o,this.moveTo(e+r,t+i),this.lineTo(e+a,t+s),this.stroke()}_drawLines(e,t,r,i,a,s){this.beginPath(),this.strokeStyle=i,this.lineWidth=a,this.addPath(r.slice(),!1,!1,e,t),this.stroke()}drawCurves(e,t,r,i,a){this.beginPath(),this.strokeStyle=i,this.lineWidth=a,this.moveTo(e+r[0],t+r[1]);for(var s=2,n=r.length;s<n;)this.quadraticCurveTo(e+r[s++],t+r[s++],e+r[s++],t+r[s++]);this.stroke()}_fillAndStroke(e,t,r,i=!1){null!=e&&(this.fillStyle=e,this.fill()),null!=t&&r>0&&(this.strokeStyle=t,this.lineWidth=r,this.stroke())}_drawCircle(e,t,r,i,a,s,n){this.beginPath(!0),this.arc(e,t,r,0,Context.PI2),this.closePath(),this._fillAndStroke(i,a,s)}_drawPie(e,t,r,i,a,s,n,o,l){this.beginPath(),this.moveTo(e,t),this.arc(e,t,r,i,a),this.closePath(),this._fillAndStroke(s,n,o)}_drawPoly(e,t,r,i,a,s,n,o){this.beginPath(),this.addPath(r.slice(),!0,n,e,t),this.closePath(),this._fillAndStroke(i,a,s,n)}_drawPath(e,t,r,i,a){this.beginPath();for(var s=0,n=r.length;s<n;s++){var o=r[s];switch(o[0]){case"moveTo":this.moveTo(e+o[1],t+o[2]);break;case"lineTo":this.lineTo(e+o[1],t+o[2]);break;case"arcTo":this.arcTo(e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.closePath()}}null!=i&&(this.fillStyle=i.fillStyle,this.fill()),null!=a&&(this.strokeStyle=a.strokeStyle,this.lineWidth=a.lineWidth||1,this.lineJoin=a.lineJoin,this.lineCap=a.lineCap,this.miterLimit=a.miterLimit,this.stroke())}static set2DRenderConfig(){if(!Context.const2DRenderCMD){const t=Context.const2DRenderCMD=LayaGL.renderEngine.createRenderStateComand();t.addCMD(e.RenderStateType.BlendType,!0),t.addCMD(e.RenderStateType.BlendEquation,e.BlendEquationSeparate.ADD),BlendMode.activeBlendFunction=null,t.addCMD(e.RenderStateType.BlendFunc,[e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha]),t.addCMD(e.RenderStateType.DepthTest,!1),t.addCMD(e.RenderStateType.DepthMask,!0),t.addCMD(e.RenderStateType.CullFace,!1),t.addCMD(e.RenderStateType.FrontFace,e.CullMode.Front)}Context.const2DRenderCMD.applyCMD(),RenderTexture.currentActive&&RenderTexture.currentActive._end(),RenderTexture2D.currentActive&&RenderTexture2D.currentActive.end(),LayaGL.renderEngine.viewport(0,0,RenderState2D.width,RenderState2D.height),LayaGL.renderEngine.scissorTest(!0),LayaGL.renderEngine.scissor(0,0,RenderState2D.width,RenderState2D.height)}constructor(){if(this._tmpMatrix=new Matrix,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._id=++Context._COUNT,this._other=null,this._renderNextSubmitIndex=0,this._path=null,this._drawCount=1,this._width=Const.MAX_CLIP_SIZE,this._height=Const.MAX_CLIP_SIZE,this._renderCount=0,this._submits=null,this._curSubmit=null,this._submitKey=new SubmitKey,this._pathMesh=null,this._triangleMesh=null,this.meshlist=[],this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=Context.MAXCLIPRECT,this._globalClipMatrix=Z.clone(),this._clipInCache=!1,this._clipInfoID=0,this._clipID_Gen=0,this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._targets=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Shader2D,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this.isMain=!1,this.clearColor=new Color,Context._contextcount++,Context._textRender=Context._textRender||new TextRender,!this.defTexture){var t=new Texture2D(2,2,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setPixelsData(new Uint8Array(16),!1,!1),t.lock=!0,this.defTexture=new Texture(t)}this._lastTex=this.defTexture,this.clear()}clearBG(t,r,i,a){this.clearColor.r=t,this.clearColor.g=r,this.clearColor.b=i,this.clearColor.a=a,LayaGL.renderEngine.clearRenderTexture(e.RenderClearFlag.Color,this.clearColor,1)}_getSubmits(){return this._submits}_releaseMem(e=!1){if(this._submits){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear();for(var t=0,r=this._submits._length;t<r;t++)this._submits[t].releaseRender();var i;for(this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=null,this._path=null,this._save=null,t=0,i=this.meshlist.length;t<i;t++){this.meshlist[t].destroy()}this.meshlist.length=0,this.sprite=null,e||(this._targets&&this._targets.destroy(),this._targets=null)}}destroy(e=!1){--Context._contextcount,this.sprite=null,this._releaseMem(e),this._charSubmitCache&&this._charSubmitCache.destroy(),this._mesh.destroy(),e||(this._targets&&this._targets.destroy(),this._targets=null),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy())}clear(){this._submits||(this._other=ContextParams.DEFAULT,this._curMat=Matrix.create(),this._charSubmitCache=new CharSubmitCache,this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh),this._pathMesh=MeshVG.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._triangleMesh=MeshTexture.getAMesh(this.isMain),this.meshlist.push(this._triangleMesh),this._submits=[],this._save=[SaveMark.Create(this)],this._save.length=10,this._shader2D=new Shader2D),this._submitKey.clear(),this._mesh.clearVB(),this._drawCount=1,this._other=ContextParams.DEFAULT,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=Context.MAXCLIPRECT,this._curSubmit=SubmitBase.RENDERBASE,SubmitBase.RENDERBASE._ref=16777215,SubmitBase.RENDERBASE._numEle=0,this._shader2D.fillStyle=this._shader2D.strokeStyle=DrawStyle.DEFAULT;for(let e=0,t=this._submits._length;e<t;e++)this._submits[e].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(t,r){this._width==t&&this._height==r||(this._width=t,this._height=r,this._targets&&(this._targets.destroy(),this._targets=new RenderTexture2D(t,r,e.RenderTargetFormat.R8G8B8A8,-1)),this.isMain&&(LayaGL.renderEngine.viewport(0,0,t,r),LayaGL.renderEngine.scissor(0,0,t,r),RenderState2D.width=t,RenderState2D.height=r)),0===t&&0===r&&this._releaseMem()}set asBitmap(t){if(t){let t=this._targets;if(!this._width||!this._height)throw Error("asBitmap no size!");t&&t.width==this._width&&t.height==this._height||(t&&t.destroy(),this._targets=new RenderTexture2D(this._width,this._height,e.RenderTargetFormat.R8G8B8A8))}else this._targets&&this._targets.destroy(),this._targets=null}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}setFillColor(e){this._fillColor=e}getFillColor(){return this._fillColor}set fillStyle(e){this._shader2D.fillStyle.equal(e)||(SaveBase.save(this,SaveBase.TYPE_FILESTYLE,this._shader2D,!1),this._shader2D.fillStyle=DrawStyle.create(e),this._submitKey.other=-this._shader2D.fillStyle.toInt())}get fillStyle(){return this._shader2D.fillStyle}set globalAlpha(e){(e=Math.floor(1e3*e)/1e3)!=this._shader2D.ALPHA&&(SaveBase.save(this,SaveBase.TYPE_ALPHA,this._shader2D,!1),this._shader2D.ALPHA=e)}get globalAlpha(){return this._shader2D.ALPHA}set textAlign(e){this._other.textAlign===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)}get textAlign(){return this._other.textAlign}set textBaseline(e){this._other.textBaseline===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(e){var t=BlendMode.TOINT[e];null==t||this._nBlendType===t||(SaveBase.save(this,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=SubmitBase.RENDERBASE,this._nBlendType=t)}get globalCompositeOperation(){return BlendMode.NAMES[this._nBlendType]}set strokeStyle(e){this._shader2D.strokeStyle.equal(e)||(SaveBase.save(this,SaveBase.TYPE_STROKESTYLE,this._shader2D,!1),this._shader2D.strokeStyle=DrawStyle.create(e),this._submitKey.other=-this._shader2D.strokeStyle.toInt())}get strokeStyle(){return this._shader2D.strokeStyle}translate(e,t){0===e&&0===t||(SaveTranslate.save(this),this._curMat._bTransform?(SaveTransform.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t))}set lineWidth(e){this._other.lineWidth===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=SaveMark.Create(this)}restore(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var r=e-1;r>=0;r--){var i=this._save[r];if(i.restore(this),i.isSaveMark())return void(this._save._length=r)}t!=this._nBlendType&&(this._curSubmit=SubmitBase.RENDERBASE)}}set font(e){this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_FONT,this._other,!1)}fillText(e,t,r,i,a,s,n=0,o=""){Context._textRender.filltext(this,e,t,r,i,a,o,n,s)}drawText(e,t,r,i,a,s){Context._textRender.filltext(this,e,t,r,i,a,null,0,s)}strokeWord(e,t,r,i,a,s,n){Context._textRender.filltext(this,e,t,r,i,null,a,s,n)}fillBorderText(e,t,r,i,a,s,n,o){Context._textRender.filltext(this,e,t,r,i,a,s,n,o)}_fast_filltext(e,t,r,i,a,s,n,o){Context._textRender._fast_filltext(this,e,t,r,i,a,s,n,o)}filltext11(e,t,r,i,a,s,n,o){Context._textRender.filltext(this,e,t,r,i,a,s,n,o)}_fillRect(e,t,r,i,a){var s=this._curSubmit,n=s&&s._key.submitType===SubmitBase.KEY_DRAWTEXTURE&&s._key.blendShader===this._nBlendType;this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh),n=!1),n&&(n=n&&this.isSameClipInfo(s)),this.transformQuad(e,t,r,i,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,Texture.NO_UV,a,!1),n||(s=this._curSubmit=SubmitTexture.create(this,this._mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0)),this._submits[this._submits._length++]=s,this._copyClipInfo(s,this._globalClipMatrix),!this._lastTex||this._lastTex.destroyed?s.shaderValue.textureHost=this.defTexture:s.shaderValue.textureHost=this._lastTex,s._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1,s._renderType=SubmitBase.TYPE_TEXTURE),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}fillRect(e,t,r,i,a){var s=a?DrawStyle.create(a):this._shader2D.fillStyle,n=this.mixRGBandAlpha(s.toInt());this._fillRect(e,t,r,i,n)}fillTexture(e,t,r,i,a,s,n,o){e._getSource()?this._fillTexture(e,e.width,e.height,e.uvrect,t,r,i,a,s,n.x,n.y,o):this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(e,t,r,i,a,s,n,o,l,h,u,d){var _=this._curSubmit;this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh));var c=!0,m=!0;switch(l){case"repeat":break;case"repeat-x":m=!1;break;case"repeat-y":c=!1;break;case"no-repeat":c=m=!1}var p=this._temp4Points,f=0,g=0,T=0,x=0,S=0,y=0;if(h<0?(T=a,f=-h%t/t):T=a+h,u<0?(x=s,g=-u%r/r):x=s+u,S=a+n,y=s+o,!c&&(S=Math.min(S,a+h+t)),!m&&(y=Math.min(y,s+u+r)),!(S<a||y<s||T>S||x>y)){var E=(S-a-h)/t,C=(y-s-u)/r;if(this.transformQuad(T,x,S-T,y-x,0,this._curMat,this._transedPoints),p[0]=f,p[1]=g,p[2]=E,p[3]=g,p[4]=E,p[5]=C,p[6]=f,p[7]=C,!this.clipedOff(this._transedPoints)){var v=this._mixRGBandAlpha(d,this._shader2D.ALPHA);this._mesh.addQuad(this._transedPoints,p,v,!0);var R=Value2D.create(ShaderDefines2D.TEXTURE2D,0);R.defines.add(ShaderDefines2D.FILLTEXTURE),R.u_TexRange=i.concat(),_=this._curSubmit=SubmitTexture.create(this,this._mesh,R),this._submits[this._submits._length++]=_,this._copyClipInfo(_,this._globalClipMatrix),_.shaderValue.textureHost=e,_._renderType=SubmitBase.TYPE_TEXTURE,this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4}this.breakNextMerge()}}setColorFilter(e){SaveBase.save(this,SaveBase.TYPE_COLORFILTER,this,!0),this._colorFiler=e,this._curSubmit=SubmitBase.RENDERBASE}drawTexture(e,t,r,i,a,s=4294967295){this._drawTextureM(e,t,r,i,a,null,1,null,s)}drawTextures(e,t,r,i,a){if(e._getSource())for(var s=t.length/2,n=0,o=e.bitmap.id,l=0;l<s;l++){const s="number"==typeof a[l]?a[l]:4294967295;this._inner_drawTexture(e,o,t[n++]+r,t[n++]+i,0,0,null,null,1,!1,s)}else this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}_drawTextureAddSubmit(e,t){var r=null;r=SubmitTexture.create(this,this._mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0)),this._submits[this._submits._length++]=r,r.shaderValue.textureHost=t,r._key.other=e,r._renderType=SubmitBase.TYPE_TEXTURE,this._curSubmit=r}_drawTextureM(e,t,r,i,a,s,n,o,l){var h=this.sprite;return!!e._getSource((function(){h&&h.repaint()}))&&this._inner_drawTexture(e,e.bitmap.id,t,r,i,a,s,o,n,!1,l)}_drawRenderTexture(e,t,r,i,a,s,n,o,l=4294967295){return this._inner_drawTexture(e,-1,t,r,i,a,s,o,n,!1,l)}submitDebugger(){this._submits[this._submits._length++]=SubmitCMD.create([],(function(){}),this)}_copyClipInfo(e,t){var r=e.shaderValue.clipMatDir;r[0]=t.a,r[1]=t.b,r[2]=t.c,r[3]=t.d;var i=e.shaderValue.clipMatPos;i[0]=t.tx,i[1]=t.ty,e.clipInfoID=this._clipInfoID,this._clipInCache&&(e.shaderValue.clipOff[0]=1)}isSameClipInfo(e){return e.clipInfoID===this._clipInfoID}_useNewTex2DSubmit(e,t){this._mesh.vertNum+t>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh));var r=SubmitTexture.create(this,this._mesh,Value2D.create(ShaderDefines2D.TEXTURE2D,0));this._submits[this._submits._length++]=this._curSubmit=r,r.shaderValue.textureHost=e,this._copyClipInfo(r,this._globalClipMatrix)}_drawTexRect(e,t,r,i,a){this.transformQuad(e,t,r,i,this._italicDeg,this._curMat,this._transedPoints);var s=this._transedPoints;s[0]=s[0]+.5|0,s[1]=s[1]+.5|0,s[2]=s[2]+.5|0,s[3]=s[3]+.5|0,s[4]=s[4]+.5|0,s[5]=s[5]+.5|0,s[6]=s[6]+.5|0,s[7]=s[7]+.5|0,this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,a,this._fillColor,!0),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}drawCallOptimize(e){return this._charSubmitCache.enable(e,this),e}_inner_drawTexture(e,t,r,i,a,s,n,o,l,h,u){if(a<=0||s<=0)return!1;var d=this._curSubmit._key;if(o=o||e._uv,d.submitType===SubmitBase.KEY_TRIANGLES&&d.other===t){var _=this._drawTexToDrawTri_Vert;_[0]=r,_[1]=i,_[2]=r+a,_[3]=i,_[4]=r+a,_[5]=i+s,_[6]=r,_[7]=i+s,this._drawTriUseAbsMatrix=!0;var c=this._tempUV;return c[0]=o[0],c[1]=o[1],c[2]=o[2],c[3]=o[3],c[4]=o[4],c[5]=o[5],c[6]=o[6],c[7]=o[7],this.drawTriangles(e,0,0,_,c,this._drawTexToDrawTri_Index,n||this._curMat,l,null,null),this._drawTriUseAbsMatrix=!1,!0}var m=this._mesh,p=this._curSubmit,f=h?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(r,i,a||e.width,s||e.height,this._italicDeg,n||this._curMat,f),this.drawTexAlign){var g=Math.round;f[0]=g(f[0]),f[1]=g(f[1]),f[2]=g(f[2]),f[3]=g(f[3]),f[4]=g(f[4]),f[5]=g(f[5]),f[6]=g(f[6]),f[7]=g(f[7]),this.drawTexAlign=!1}var T=this._mixRGBandAlpha(u,this._shader2D.ALPHA*l);if(h)return this._charSubmitCache.add(this,e,t,f,o,T),!0;this._drawCount++;var x=t>=0&&d.submitType===SubmitBase.KEY_DRAWTEXTURE&&d.other===t;return x&&(x=x&&this.isSameClipInfo(p)),this._lastTex=e,m.vertNum+4>Context._MAXVERTNUM&&(m=this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(m),x=!1),m.addQuad(f,o,T,!0),x||(this._submits[this._submits._length++]=this._curSubmit=p=SubmitTexture.create(this,m,Value2D.create(ShaderDefines2D.TEXTURE2D,0)),p.shaderValue.textureHost=e,p._key.other=t,this._copyClipInfo(p,this._globalClipMatrix)),p._numEle+=6,m.indexNum+=6,m.vertNum+=4,!0}transform4Points(e,t,r){var i=t.tx,a=t.ty,s=t.a,n=t.b,o=t.c,l=t.d,h=e[0],u=e[1],d=e[2],_=e[3],c=e[4],m=e[5],p=e[6],f=e[7];t._bTransform?(r[0]=h*s+u*o+i,r[1]=h*n+u*l+a,r[2]=d*s+_*o+i,r[3]=d*n+_*l+a,r[4]=c*s+m*o+i,r[5]=c*n+m*l+a,r[6]=p*s+f*o+i,r[7]=p*n+f*l+a):(r[0]=h+i,r[1]=u+a,r[2]=d+i,r[3]=_+a,r[4]=c+i,r[5]=m+a,r[6]=p+i,r[7]=f+a)}clipedOff(e){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(e,t,r,i,a,s,n){var o=0;0!=a&&(o=Math.tan(a*Math.PI/180)*i);var l=e+r,h=t+i,u=s.tx,d=s.ty,_=s.a,c=s.b,m=s.c,p=s.d,f=e+o,g=t,T=l+o,x=t,S=l,y=h,E=e,C=h;s._bTransform?(n[0]=f*_+g*m+u,n[1]=f*c+g*p+d,n[2]=T*_+x*m+u,n[3]=T*c+x*p+d,n[4]=S*_+y*m+u,n[5]=S*c+y*p+d,n[6]=E*_+C*m+u,n[7]=E*c+C*p+d):(n[0]=f+u,n[1]=g+d,n[2]=T+u,n[3]=x+d,n[4]=S+u,n[5]=y+d,n[6]=E+u,n[7]=C+d)}pushRT(){this.addRenderObject(SubmitCMD.create(null,RenderTexture2D.pushRT,this))}popRT(){this.addRenderObject(SubmitCMD.create(null,RenderTexture2D.popRT,this)),this.breakNextMerge()}useRT(e){this.addRenderObject(SubmitCMD.create([e],(function(e){if(!e)throw"error useRT";e.start(),e.clear(0,0,0,0)}),this)),this.breakNextMerge()}RTRestore(e){this.addRenderObject(SubmitCMD.create([e],(function(e){e.restore()}),this)),this.breakNextMerge()}breakNextMerge(){this._curSubmit=SubmitBase.RENDERBASE}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(e,t,r,i,a,s,n,o,l,h,u,d=4294967295){var _,c=this._curMat;if(h&&(_=this.globalCompositeOperation,this.globalCompositeOperation=h),!s)return this._drawTextureM(e,t+n,r+o,i,a,c,l,u,d),void(h&&(this.globalCompositeOperation=_));var m=this._tmpMatrix;m.a=s.a,m.b=s.b,m.c=s.c,m.d=s.d,m.tx=s.tx+n,m.ty=s.ty+o,m._bTransform=s._bTransform,s&&c._bTransform?(Matrix.mul(m,c,m),(s=m)._bTransform=!0):(m.tx+=c.tx,m.ty+=c.ty,s=m),this._drawTextureM(e,t,r,i,a,s,l,u,d),h&&(this.globalCompositeOperation=_)}_flushToTarget(e,t){RenderState2D.worldScissorTest=!1,LayaGL.renderEngine.scissorTest(!1);var r=RenderState2D.worldAlpha,i=RenderState2D.worldMatrix4,a=RenderState2D.worldMatrix;RenderState2D.worldShaderDefines,RenderState2D.worldMatrix=Matrix.EMPTY,RenderState2D.restoreTempArray(),RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY,RenderState2D.worldAlpha=1,BaseShader.activeShader=null,t.start(),e._submits._length>0&&t.clear(0,0,0,0),e._curSubmit=SubmitBase.RENDERBASE,e.flush(),e.clear(),t.restore(),e._curSubmit=SubmitBase.RENDERBASE,BaseShader.activeShader=null,RenderState2D.worldAlpha=r,RenderState2D.worldMatrix4=i,RenderState2D.worldMatrix=a}drawCanvas(e,t,r,i,a){if(e){var s,n=e.context;if(n._targets)n._submits._length>0&&(s=SubmitCMD.create([n,n._targets],this._flushToTarget,this),this._submits[this._submits._length++]=s),this._drawRenderTexture(n._targets,t,r,i,a,null,1,RenderTexture2D.flipyuv),this._curSubmit=SubmitBase.RENDERBASE;else{var o=e;o.touches&&o.touches.forEach((function(e){e.touch()})),s=SubmitCanvas.create(e,this._shader2D.ALPHA,this._shader2D.filters),this._submits[this._submits._length++]=s,s._key.clear();var l=s._matrix;this._curMat.copyTo(l);var h=l.tx,u=l.ty;l.tx=l.ty=0,l.transformPoint(Point.TEMP.setTo(t,r)),l.translate(Point.TEMP.x+h,Point.TEMP.y+u),Matrix.mul(o.invMat,l,l),this._curSubmit=SubmitBase.RENDERBASE}}}drawTarget(e,t,r,i,a,s,n,o=null,l=-1,h=4294967295){if(this._drawCount++,this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh)),this.transformQuad(t,r,i,a,0,s||this._curMat,this._transedPoints),!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,o||Texture.DEF_UV,h,!0);var u=this._curSubmit=SubmitTarget.create(this,this._mesh,n,e);return u.blendType=-1==l?this._nBlendType:l,this._copyClipInfo(u,this._globalClipMatrix),u._numEle=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4,this._submits[this._submits._length++]=u,this._curSubmit=SubmitBase.RENDERBASE,!0}return this._curSubmit=SubmitBase.RENDERBASE,!1}drawTriangles(e,t,r,i,a,s,n,o,l,h=4294967295){if(e._getSource()){var u=null;l&&(u=this.globalCompositeOperation,this.globalCompositeOperation=l),this._drawCount++;var d=this._tmpMatrix,_=this._triangleMesh,c=e.bitmap,m=this._curSubmit._key,p=m.submitType===SubmitBase.KEY_TRIANGLES&&m.other===c.id&&m.blendShader==this._nBlendType;if(_.vertNum+i.length/2>Context._MAXVERTNUM&&(_=this._triangleMesh=MeshTexture.getAMesh(this.isMain),this.meshlist.push(_),p=!1),!p){var f=this._curSubmit=SubmitTexture.create(this,_,Value2D.create(ShaderDefines2D.TEXTURE2D,0));f.shaderValue.textureHost=e,f._renderType=SubmitBase.TYPE_TEXTURE,f._key.submitType=SubmitBase.KEY_TRIANGLES,f._key.other=c.id,this._copyClipInfo(f,this._globalClipMatrix),this._submits[this._submits._length++]=f}var g=this._mixRGBandAlpha(h,this._shader2D.ALPHA*o);this._drawTriUseAbsMatrix?_.addData(i,a,s,n,g):(n?(d.a=n.a,d.b=n.b,d.c=n.c,d.d=n.d,d.tx=n.tx+t,d.ty=n.ty+r):(d.a=1,d.b=0,d.c=0,d.d=1,d.tx=t,d.ty=r),Matrix.mul(d,this._curMat,d),_.addData(i,a,s,d||this._curMat,g)),this._curSubmit._numEle+=s.length,l&&(this.globalCompositeOperation=u)}else this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}transform(e,t,r,i,a,s){SaveTransform.save(this),Matrix.mul(Matrix.TEMP.setTo(e,t,r,i,a,s),this._curMat,this._curMat),this._curMat._checkTransform()}_transformByMatrix(e,t,r){e.setTranslate(t,r),Matrix.mul(e,this._curMat,this._curMat),e.setTranslate(0,0),this._curMat._bTransform=!0}setTransformByMatrix(e){e.copyTo(this._curMat)}rotate(e){SaveTransform.save(this),this._curMat.rotateEx(e)}scale(e,t){SaveTransform.save(this),this._curMat.scaleEx(e,t)}clipRect(e,t,r,i,a){if(SaveClipRect.save(this),this._clipRect==Context.MAXCLIPRECT?this._clipRect=new Rectangle(e,t,r,i):(this._clipRect.width=r,this._clipRect.height=i,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,a)Z.copyTo(this._globalClipMatrix);else{var s=this._globalClipMatrix,n=s.tx,o=s.ty,l=n+s.a,h=o+s.d;if(this._clipRect.width>=Const.MAX_CLIP_SIZE?(s.a=s.d=Const.MAX_CLIP_SIZE,s.b=s.c=s.tx=s.ty=0):(this._curMat._bTransform?(s.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,s.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,s.a=this._clipRect.width*this._curMat.a,s.b=this._clipRect.width*this._curMat.b,s.c=this._clipRect.height*this._curMat.c,s.d=this._clipRect.height*this._curMat.d):(s.tx=this._clipRect.x+this._curMat.tx,s.ty=this._clipRect.y+this._curMat.ty,s.a=this._clipRect.width,s.b=s.c=0,s.d=this._clipRect.height),this._incache&&(this._clipInCache=!0)),s.a>0&&s.d>0){var u=s.tx+s.a,d=s.ty+s.d;u<=n||d<=o||s.tx>=l||s.ty>=h?(s.a=-.1,s.d=-.1):(s.tx<n&&(s.a-=n-s.tx,s.tx=n),u>l&&(s.a-=u-l),s.ty<o&&(s.d-=o-s.ty,s.ty=o),d>h&&(s.d-=d-h),s.a<=0&&(s.a=-.1),s.d<=0&&(s.d=-.1))}}}addRenderObject(e){this._submits[this._submits._length++]=e}submitElement(e,t){this.isMain;var r=this._submits,i=r._length;t<0&&(t=r._length);for(var a=SubmitBase.RENDERBASE;e<t;)this._renderNextSubmitIndex=e+1,r[e]!==SubmitBase.RENDERBASE?(SubmitBase.preRender=a,e+=(a=r[e]).renderSubmit()):e++;return i}flush(){this._clipID_Gen=0;var e=this.submitElement(0,this._submits._length);this._path&&this._path.reset(),SkinMeshBuffer.instance&&SkinMeshBuffer.getInstance().reset(),this._curSubmit=SubmitBase.RENDERBASE;for(var t=0,r=this.meshlist.length;t<r;t++){var i=this.meshlist[t];i.canReuse?i.releaseMesh():i.destroy()}return this.meshlist.length=0,this._mesh=MeshQuadTexture.getAMesh(this.isMain),this._pathMesh=MeshVG.getAMesh(this.isMain),this._triangleMesh=MeshTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh,this._pathMesh,this._triangleMesh),this._flushCnt++,this._flushCnt%60==0&&this.isMain&&TextRender.textRenderInst&&TextRender.textRenderInst.GC(),e}beginPath(e=!1){this._getPath().beginPath(e)}closePath(){this._path.closePath()}addPath(e,t,r,i,a){let s=e.length;for(let t=0;t<s-1;t+=2)e[t]+=i,e[t+1]+=a;t&&s>5&&(e[s-2]!=e[0]||e[s-1]!=e[1])&&e.push(e[0],e[1]),this._getPath().push(e,r)}fill(){var e=this._curMat,t=this._getPath(),r=this._curSubmit,i=r._key.submitType===SubmitBase.KEY_VG&&r._key.blendShader===this._nBlendType;i&&(i=i&&this.isSameClipInfo(r)),i||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var a,s=this.mixRGBandAlpha(this.fillStyle.toInt()),n=0,o=0,l=t.paths.length;o<l;o++){var h=t.paths[o],u=h.path.length/2;if(!(u<3||3==u&&!h.convex)){var d,_,c,m,p=h.path.concat(),f=0;if(e._bTransform)for(f=0;f<u;f++)_=(d=f<<1)+1,c=p[d],m=p[_],p[d]=e.a*c+e.c*m+e.tx,p[_]=e.b*c+e.d*m+e.ty;else for(f=0;f<u;f++)_=(d=f<<1)+1,c=p[d],m=p[_],p[d]=c+e.tx,p[_]=m+e.ty;this._pathMesh.vertNum+u>Context._MAXVERTNUM&&(this._curSubmit._numEle+=n,n=0,this._pathMesh=MeshVG.getAMesh(this.isMain),this._curSubmit=this.addVGSubmit(this._pathMesh));var g=this._pathMesh.vertNum;if(h.convex){var T=u-2;a=new Array(3*T);for(var x=0,S=0;S<T;S++)a[x++]=g,a[x++]=S+1+g,a[x++]=S+2+g}else if(a=Earcut.earcut(p,null,2),g>0)for(var y=0;y<a.length;y++)a[y]+=g;this._pathMesh.addVertAndIBToMesh(this,p,s,a),n+=a.length}}this._curSubmit._numEle+=n}addVGSubmit(e){var t=Submit.createShape(this,e,0,Value2D.create(ShaderDefines2D.PRIMITIVE,0));return t._key.submitType=SubmitBase.KEY_VG,this._submits[this._submits._length++]=t,this._copyClipInfo(t,this._globalClipMatrix),t}stroke(){if(this.lineWidth>0){var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),r=this._curSubmit,i=r._key.submitType===SubmitBase.KEY_VG&&r._key.blendShader===this._nBlendType;i&&(i=i&&this.isSameClipInfo(r)),i||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var a=0,s=0,n=t.paths.length;s<n;s++){var o=t.paths[s];if(!(o.path.length<=0)){var l=[],h=[],u=2*o.path.length;if(!(u<2)){this._pathMesh.vertNum+u>Context._MAXVERTNUM&&(this._curSubmit._numEle+=a,a=0,this._pathMesh=MeshVG.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._curSubmit=this.addVGSubmit(this._pathMesh)),BasePoly.createLine2(o.path,l,this.lineWidth,this._pathMesh.vertNum,h,o.loop);var d,_,c,m,p=h.length/2,f=this._curMat,g=0;if(f._bTransform)for(g=0;g<p;g++)_=(d=g<<1)+1,c=h[d],m=h[_],h[d]=f.a*c+f.c*m+f.tx,h[_]=f.b*c+f.d*m+f.ty;else for(g=0;g<p;g++)_=(d=g<<1)+1,c=h[d],m=h[_],h[d]=c+f.tx,h[_]=m+f.ty;this._pathMesh.addVertAndIBToMesh(this,h,e,l),a+=l.length}}}this._curSubmit._numEle+=a}}moveTo(e,t){var r=this._getPath();r.newPath(),r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t)}lineTo(e,t){var r=this._getPath();Math.abs(e-r._lastOriX)<.001&&Math.abs(t-r._lastOriY)<.001||(r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t))}arcTo(e,t,r,i,a){var s=0,n=0,o=0,l=this._path._lastOriX-e,h=this._path._lastOriY-t,u=Math.sqrt(l*l+h*h);if(!(u<=1e-6)){var d=l/u,_=h/u,c=r-e,m=i-t,p=c*c+m*m,f=Math.sqrt(p);if(!(f<=1e-6)){var g=c/f,T=m/f,x=d+g,S=_+T,y=Math.sqrt(x*x+S*S);if(!(y<=1e-6)){var E=x/y,C=S/y,v=Math.acos(E*d+C*_),R=Math.PI/2-v,b=(u=a/Math.tan(R))*d+e,D=u*_+t,A=Math.sqrt(u*u+a*a),M=e+E*A,L=t+C*A,w=0,I=0;if(d*T-_*g>=0){var B=2*R/Context.SEGNUM;w=Math.sin(B),I=Math.cos(B)}else B=2*-R/Context.SEGNUM,w=Math.sin(B),I=Math.cos(B);var P=this._path._lastOriX,F=this._path._lastOriY,U=b,N=D;(Math.abs(U-this._path._lastOriX)>.1||Math.abs(N-this._path._lastOriY)>.1)&&(n=U,o=N,P=U,F=N,this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o));var O=b-M,G=D-L;for(s=0;s<Context.SEGNUM;s++){var k=O*I+G*w,V=-O*w+G*I;n=k+M,o=V+L,(Math.abs(P-n)>.1||Math.abs(F-o)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o),P=n,F=o),O=k,G=V}}}}}arc(e,t,r,i,a,s=!1,n=!0){var o,l,h=0,u=0,d=0,_=0,c=0;if(u=a-i,s)if(Math.abs(u)>=2*Math.PI)u=2*-Math.PI;else for(;u>0;)u-=2*Math.PI;else if(Math.abs(u)>=2*Math.PI)u=2*Math.PI;else for(;u<0;)u+=2*Math.PI;var m=this.getMatScaleX(),p=this.getMatScaleY(),f=r*(m>p?m:p),g=2*Math.PI*f;l=0|Math.max(g/10,10);var T=this._getPath();for(o=0;o<=l;o++)h=i+u*(o/l),d=Math.cos(h),c=t+Math.sin(h)*r,(_=e+d*r)==this._path._lastOriX&&c==this._path._lastOriY||T.addPoint(_,c);d=Math.cos(a),c=t+Math.sin(a)*r,(_=e+d*r)==this._path._lastOriX&&c==this._path._lastOriY||T.addPoint(_,c)}quadraticCurveTo(e,t,r,i){for(var a=Bezier.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,e,t,r,i],30,2),s=0,n=a.length/2;s<n;s++)this.lineTo(a[2*s],a[2*s+1]);this.lineTo(r,i)}mixRGBandAlpha(e){return this._mixRGBandAlpha(e,this._shader2D.ALPHA)}_mixRGBandAlpha(e,t){if(t>=1)return e;var r=(4278190080&e)>>>24;return 0!=r?r*=t:r=255*t,16777215&e|r<<24}strokeRect(e,t,r,i,a){if(this.lineWidth>0){var s=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(e-n,t-n,r+this.lineWidth,this.lineWidth,s),this._fillRect(e-n,t-n+i,r+this.lineWidth,this.lineWidth,s),this._fillRect(e-n,t+n,this.lineWidth,i-this.lineWidth,s),this._fillRect(e-n+r,t+n,this.lineWidth,i-this.lineWidth,s)}}clip(){}drawParticle(e,t,r){r.x=e,r.y=t,this._submits[this._submits._length++]=r}_getPath(){return this._path||(this._path=new Path)}get canvas(){return this._canvas}_fillTexture_h(e,t,r,i,a,s,n,o,l){i<=0&&console.error("_fillTexture_h error: oriw must>0");for(var h=s,u=Math.floor(o/i),d=o%i,_=0;_<u;_++)this._inner_drawTexture(e,t,h,n,i,a,this._curMat,r,1,!1,l),h+=i;if(d>0){var c=r[2]-r[0],m=r[0]+c*(d/i),p=Context.tmpuv1;p[0]=r[0],p[1]=r[1],p[2]=m,p[3]=r[3],p[4]=m,p[5]=r[5],p[6]=r[6],p[7]=r[7],this._inner_drawTexture(e,t,h,n,d,a,this._curMat,p,1,!1,l)}}_fillTexture_v(e,t,r,i,a,s,n,o,l){a<=0&&console.error("_fillTexture_v error: orih must>0");for(var h=n,u=Math.floor(o/a),d=o%a,_=0;_<u;_++)this._inner_drawTexture(e,t,s,h,i,a,this._curMat,r,1,!1,l),h+=a;if(d>0){var c=r[7]-r[1],m=r[1]+c*(d/a),p=Context.tmpuv1;p[0]=r[0],p[1]=r[1],p[2]=r[2],p[3]=r[3],p[4]=r[4],p[5]=m,p[6]=r[6],p[7]=m,this._inner_drawTexture(e,t,s,h,i,d,this._curMat,p,1,!1,l)}}drawTextureWithSizeGrid(e,t,r,i,a,s,n,o,l){if(e._getSource()){t+=n,r+=o;var h=e.uv,u=e.bitmap.width,d=e.bitmap.height,_=s[0],c=s[3],m=s[1],p=s[2],f=s[4];i==e.width&&(c=m=0),a==e.height&&(_=p=0);var g=_/d,T=c/u,x=m/u,S=p/d,y=e.bitmap.id,E=this._curMat,C=this._tempUV,v=1,R=1;c+m>i&&(v=i/(c+m)),_+p>a&&(R=a/(_+p)),c*=v,m*=v,_*=R,p*=R;var b=h[0],D=h[1],A=h[4],M=h[5],L=b,w=D,I=A,B=M;if(c&&_&&(I=b+T,B=D+g,C[0]=b,C[1]=D,C[2]=I,C[3]=D,C[4]=I,C[5]=B,C[6]=b,C[7]=B,this._inner_drawTexture(e,y,t,r,c,_,E,C,1,!1,l)),m&&_&&(L=A-x,w=D,I=A,B=D+g,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,this._inner_drawTexture(e,y,i-m+t,0+r,m,_,E,C,1,!1,l)),c&&p&&(L=b,w=M-S,I=b+T,B=M,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,this._inner_drawTexture(e,y,0+t,a-p+r,c,p,E,C,1,!1,l)),m&&p&&(L=A-x,w=M-S,I=A,B=M,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,this._inner_drawTexture(e,y,i-m+t,a-p+r,m,p,E,C,1,!1,l)),_&&(L=b+T,w=D,I=A-x,B=D+g,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,f?this._fillTexture_h(e,y,C,e.width-c-m,_,c+t,r,i-c-m,l):this._inner_drawTexture(e,y,c+t,r,i-c-m,_,E,C,1,!1,l)),p&&(L=b+T,w=M-S,I=A-x,B=M,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,f?this._fillTexture_h(e,y,C,e.width-c-m,p,c+t,a-p+r,i-c-m,l):this._inner_drawTexture(e,y,c+t,a-p+r,i-c-m,p,E,C,1,!1,l)),c&&(L=b,w=D+g,I=b+T,B=M-S,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,f?this._fillTexture_v(e,y,C,c,e.height-_-p,t,_+r,a-_-p,l):this._inner_drawTexture(e,y,t,_+r,c,a-_-p,E,C,1,!1,l)),m&&(L=A-x,w=D+g,I=A,B=M-S,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,f?this._fillTexture_v(e,y,C,m,e.height-_-p,i-m+t,_+r,a-_-p,l):this._inner_drawTexture(e,y,i-m+t,_+r,m,a-_-p,E,C,1,!1,l)),L=b+T,w=D+g,I=A-x,B=M-S,C[0]=L,C[1]=w,C[2]=I,C[3]=w,C[4]=I,C[5]=B,C[6]=L,C[7]=B,f){var P=Context.tmpUVRect;P[0]=L,P[1]=w,P[2]=I-L,P[3]=B-w,this._fillTexture(e,e.width-c-m,e.height-_-p,P,c+t,_+r,i-c-m,a-_-p,"repeat",0,0,l)}else this._inner_drawTexture(e,y,c+t,_+r,i-c-m,a-_-p,E,C,1,!1,l)}}addRenderObject3D(e){this._curSubmit=SubmitBase.RENDERBASE,this.addRenderObject(e)}}Context._SUBMITVBSIZE=32e3,Context._MAXVERTNUM=65535,Context.MAXCLIPRECT=null,Context._COUNT=0,Context.SEGNUM=32,Context._contextcount=0,Context.PI2=2*Math.PI,Context._textRender=null,Context.tmpuv1=[0,0,0,0,0,0,0,0],Context.tmpUV=[0,0,0,0,0,0,0,0],Context.tmpUVRect=[0,0,0,0];class ContextParams{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===ContextParams.DEFAULT?new ContextParams:this}}window.conch&&!window.conchConfig.conchWebGL&&(Context=NativeContext);class HTMLCanvas extends Resource{get source(){return this._source}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}_getSource(){return this._source}constructor(e=!1){super(),this._source=e?Browser.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new Context:this._ctx=this._source.getContext(LayaEnv.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(e){this._ctx=e}getContext(e,t=null){return this.context}getMemSize(){return 0}size(e,t){(this._width!=e||this._height!=t||this._source&&(this._source.width!=e||this._source.height!=t))&&(this._width=e,this._height=t,this._setCPUMemory(e*t*4),this._ctx&&this._ctx.size&&this._ctx.size(e,t),this._source&&(this._source.height=t,this._source.width=e),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var t=new Texture2D(this.source.width,this.source.height,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setImageData(this.source,!1,!1),this._texture=new Texture(t)}return this._texture}toBase64(e,t){if(this._source){if(LayaEnv.isConch){var r=window,i=this._ctx._targets.sourceWidth,a=this._ctx._targets.sourceHeight,s=this._ctx._targets.getData(0,0,i,a);return r.conchToBase64FlipY?r.conchToBase64FlipY(e,t,s.buffer,i,a):r.conchToBase64(e,t,s.buffer,i,a)}return this._source.toDataURL(e,t)}return null}toBase64Async(e,t,r){var i=this._ctx._targets.sourceWidth,a=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,i,a,(function(s){let n=window;var o=n.conchToBase64FlipY?n.conchToBase64FlipY(e,t,s.buffer,i,a):n.conchToBase64(e,t,s.buffer,i,a);r(o)}))}}class BoundsStyle{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){Pool.recover("BoundsStyle",this.reset())}static create(){return Pool.getItemByClass("BoundsStyle",BoundsStyle)}}class CacheStyle{constructor(){this.reset()}needBitmapCache(){return this.cacheForFilters||!!this.mask}needEnableCanvasRender(){return"none"!=this.userSetCache||this.cacheForFilters||!!this.mask}releaseContext(){if(this.canvas&&this.canvas.size){Pool.recover("CacheCanvas",this.canvas),this.canvas.size(0,0);try{this.canvas.width=0,this.canvas.height=0}catch(e){}}this.canvas=null}createContext(){if(!this.canvas){this.canvas=Pool.getItem("CacheCanvas")||new HTMLCanvas(!1);var e=this.canvas.context;e||(e=this.canvas.getContext("2d"))}}releaseFilterCache(){var e=this.filterCache;e&&(e.destroy(),e.recycle(),this.filterCache=null)}recover(){this!==CacheStyle.EMPTY&&Pool.recover("SpriteCache",this.reset())}reset(){return this.releaseContext(),this.releaseFilterCache(),this.cacheAs="none",this.enableCanvasRender=!1,this.userSetCache="none",this.cacheForFilters=!1,this.staticCache=!1,this.reCache=!0,this.mask=null,this.maskParent=null,this.filterCache=null,this.filters=null,this.hasGlowFilter=!1,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this}static create(){return Pool.getItemByClass("SpriteCache",CacheStyle)}_calculateCacheRect(e,t,r,i){var a,s=e._cacheStyle;if(s.cacheRect||(s.cacheRect=Rectangle.create()),"bitmap"===t?((a=e.getSelfBounds()).width=a.width+2*CacheStyle.CANVAS_EXTEND_EDGE,a.height=a.height+2*CacheStyle.CANVAS_EXTEND_EDGE,a.x=a.x-e.pivotX,a.y=a.y-e.pivotY,a.x=a.x-CacheStyle.CANVAS_EXTEND_EDGE,a.y=a.y-CacheStyle.CANVAS_EXTEND_EDGE,a.x=Math.floor(a.x+r)-r,a.y=Math.floor(a.y+i)-i,a.width=Math.floor(a.width),a.height=Math.floor(a.height),s.cacheRect.copyFrom(a)):s.cacheRect.setTo(-e._style.pivotX,-e._style.pivotY,1,1),a=s.cacheRect,e._style.scrollRect){var n=e._style.scrollRect;a.x-=n.x,a.y-=n.y}return CacheStyle._scaleInfo.setTo(1,1),CacheStyle._scaleInfo}}CacheStyle.EMPTY=new CacheStyle,CacheStyle._scaleInfo=new Point,CacheStyle.CANVAS_EXTEND_EDGE=16;class SpriteStyle{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==SpriteStyle.EMPTY&&Pool.recover("SpriteStyle",this.reset())}static create(){return Pool.getItemByClass("SpriteStyle",SpriteStyle)}}SpriteStyle.EMPTY=new SpriteStyle;class AlphaCmd{static create(e){var t=Pool.getItemByClass("AlphaCmd",AlphaCmd);return t.alpha=e,t}recover(){Pool.recover("AlphaCmd",this)}run(e,t,r){e.alpha(this.alpha)}get cmdID(){return AlphaCmd.ID}}AlphaCmd.ID="Alpha";class DrawCircleCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s){var n=Pool.getItemByClass("DrawCircleCmd",DrawCircleCmd);return n.x=e,n.y=t,n.radius=r,n.fillColor=i,n.lineColor=a,n.lineWidth=s,n}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawCircleCmd",this)}run(e,t,r){let i=this.lineWidth/2;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e._drawCircle(this.x*a+t,this.y*s+r,this.radius*Math.min(a,s)-i,this.fillColor,this.lineColor,this.lineWidth,0)}else e._drawCircle(this.x+t,this.y+r,this.radius-i,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawCircleCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?e:null)}}DrawCircleCmd.ID="DrawCircle",ClassUtils.regClass("DrawCircleCmd",DrawCircleCmd);class DrawCurvesCmd{static create(e,t,r,i,a){var s=Pool.getItemByClass("DrawCurvesCmd",DrawCurvesCmd);return s.x=e,s.y=t,s.points=r,s.lineColor=i,s.lineWidth=a,s}recover(){this.points=null,this.lineColor=null,Pool.recover("DrawCurvesCmd",this)}run(e,t,r){this.points&&e.drawCurves(this.x+t,this.y+r,this.points,this.lineColor,this.lineWidth)}get cmdID(){return DrawCurvesCmd.ID}getBoundPoints(e){return Bezier.I.getBezierPoints(this.points)}}DrawCurvesCmd.ID="DrawCurves",ClassUtils.regClass("DrawCurvesCmd",DrawCurvesCmd);class DrawImageCmd{constructor(){this.color=4294967295}static create(e,t,r,i,a,s){null==i&&(i=e.sourceWidth),null==a&&(a=e.sourceHeight);let n=i/e.sourceWidth,o=a/e.sourceHeight;i=e.width*n,a=e.height*o,t+=e.offsetX*n,r+=e.offsetY*o;var l=Pool.getItemByClass("DrawImageCmd",DrawImageCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=i,l.height=a,l.color=null!=s?ColorUtils.create(s).numColor:4294967295,l}recover(){this.texture&&this.texture._removeReference(),this.texture=null,Pool.recover("DrawImageCmd",this)}run(e,t,r){this.texture&&e.drawTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.color)}get cmdID(){return DrawImageCmd.ID}}DrawImageCmd.ID="DrawImage";class DrawLineCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s){var n=Pool.getItemByClass("DrawLineCmd",DrawLineCmd);return n.fromX=e,n.fromY=t,n.toX=r,n.toY=i,n.lineColor=a,n.lineWidth=s,n}recover(){Pool.recover("DrawLineCmd",this)}run(e,t,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e._drawLine(t,r,this.fromX*a+i,this.fromY*s+i,this.toX*a+i,this.toY*s+i,this.lineColor,this.lineWidth,0)}else e._drawLine(t,r,this.fromX+i,this.fromY+i,this.toX+i,this.toY+i,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawLineCmd.ID}getBoundPoints(e){let t;J.length=0,t=.5*this.lineWidth;let r=this.fromX,i=this.fromY,a=this.toX,s=this.toY;return this.percent&&(r*=e.width,i*=e.height,a*=e.width,s*=e.height),r==a?J.push(r+t,i,a+t,s,r-t,i,a-t,s):i==s?J.push(r,i+t,a,s+t,r,i-t,a,s-t):J.push(r,i,a,s),J}}DrawLineCmd.ID="DrawLine";const J=[];ClassUtils.regClass("DrawLineCmd",DrawLineCmd);class DrawLinesCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a){var s=Pool.getItemByClass("DrawLinesCmd",DrawLinesCmd);return s.x=e,s.y=t,s.points=r,s.lineColor=i,s.lineWidth=a,s}recover(){this.points=null,this.lineColor=null,Pool.recover("DrawLinesCmd",this)}run(e,t,r){let i=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&e._drawLines(this.x+i+t,this.y+i+r,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawLinesCmd.ID}}DrawLinesCmd.ID="DrawLines",ClassUtils.regClass("DrawLinesCmd",DrawLinesCmd);class DrawPathCmd{static create(e,t,r,i,a){var s=Pool.getItemByClass("DrawPathCmd",DrawPathCmd);return s.x=e,s.y=t,s.paths=r,s.brush=i,s.pen=a,s}recover(){this.paths=null,this.brush=null,this.pen=null,Pool.recover("DrawPathCmd",this)}run(e,t,r){this.paths&&e._drawPath(this.x+t,this.y+r,this.paths,this.brush,this.pen)}get cmdID(){return DrawPathCmd.ID}getBoundPoints(e){let t=ee;t.length=0;let r=this.paths,i=r.length;for(let e=0;e<i;e++){let i=r[e];i.length>1&&(t.push(i[1],i[2]),i.length>3&&t.push(i[3],i[4]))}return t}}DrawPathCmd.ID="DrawPath";const ee=[];ClassUtils.regClass("DrawPathCmd",DrawPathCmd);class DrawPieCmd{constructor(){this.radius=0,this.lineWidth=0}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("DrawPieCmd",DrawPieCmd);return l.x=e,l.y=t,l.radius=r,l._startAngle=i,l._endAngle=a,l.fillColor=s,l.lineColor=n,l.lineWidth=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawPieCmd",this)}run(e,t,r){let i=this.lineWidth>=1?this.lineWidth/2:0,a=this.lineWidth;e._drawPie(this.x+i+t,this.y+i+r,this.radius-a,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawPieCmd.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(e){this._startAngle=e*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(e){this._endAngle=e*Math.PI/180}getBoundPoints(e){let t=te;te.length=0;let r=Math.PI/180,i=this.endAngle-this.startAngle,a=this.x,s=this.y,n=this.radius;if(i>=360||i<=-360)return t.push(a-n,s-n),t.push(a+n,s-n),t.push(a+n,s+n),t.push(a-n,s+n),t;t.push(a,s);var o=i%360;o<0&&(o+=360);var l=this.startAngle+o,h=this.startAngle*r,u=l*r;t.push(a+n*Math.cos(h),s+n*Math.sin(h)),t.push(a+n*Math.cos(u),s+n*Math.sin(u));for(var d=90*Math.ceil(this.startAngle/90),_=90*Math.floor(l/90),c=d;c<=_;c+=90){var m=c*r;t.push(a+n*Math.cos(m),s+n*Math.sin(m))}return t}}DrawPieCmd.ID="DrawPie";const te=[];ClassUtils.regClass("DrawPieCmd",DrawPieCmd);class DrawPolyCmd{static create(e,t,r,i,a,s){var n=Pool.getItemByClass("DrawPolyCmd",DrawPolyCmd);return n.x=e,n.y=t,n.points=r,n.fillColor=i,n.lineColor=a,n.lineWidth=s,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,Pool.recover("DrawPolyCmd",this)}run(e,t,r){let i=this.points.length<=6,a=this.lineWidth>=1?this.lineWidth%2==0?0:.5:0;this.points&&e._drawPoly(this.x+a+t,this.y+a+r,this.points,this.fillColor,this.lineColor,this.lineWidth,i,0)}get cmdID(){return DrawPolyCmd.ID}}DrawPolyCmd.ID="DrawPoly",ClassUtils.regClass("DrawPolyCmd",DrawPolyCmd);class DrawRectCmd{constructor(){this.lineWidth=0}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("DrawRectCmd",DrawRectCmd);return l.x=e,l.y=t,l.width=r,l.height=i,l.fillColor=a,l.lineColor=s,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawRectCmd",this)}run(e,t,r){let i=this.lineWidth>=1?this.lineWidth/2:0,a=this.lineWidth;if(this.percent&&e.sprite){let s=e.sprite.width,n=e.sprite.height;e.drawRect(this.x*s+i+t,this.y*n+i+r,this.width*s-a,this.height*n-a,this.fillColor,this.lineColor,this.lineWidth)}else e.drawRect(this.x+i+t,this.y+i+r,this.width-a,this.height-a,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawRectCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}DrawRectCmd.ID="DrawRect",ClassUtils.regClass("DrawRectCmd",DrawRectCmd);class DrawTextureCmd{constructor(){this.color=4294967295,this.uv=null}static create(e,t,r,i,a,s,n,o,l,h){null==i&&(i=e.sourceWidth),null==a&&(a=e.sourceHeight);let u=i/e.sourceWidth,d=a/e.sourceHeight;i=e.width*u,a=e.height*d,t+=e.offsetX*u,r+=e.offsetY*d;var _=Pool.getItemByClass("DrawTextureCmd",DrawTextureCmd);return _.texture=e,e._addReference(),_.x=t,_.y=r,_.width=i,_.height=a,_.matrix=s,_.alpha=n,_.blendMode=l,_.uv=h||null,_.color=null!=o?ColorUtils.create(o).numColor:4294967295,_}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,Pool.recover("DrawTextureCmd",this)}run(e,t,r){this.texture&&e.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,t,r,this.alpha,this.blendMode,this.uv,this.color)}get cmdID(){return DrawTextureCmd.ID}}DrawTextureCmd.ID="DrawTexture",ClassUtils.regClass("DrawTextureCmd",DrawTextureCmd);class FillTextureCmd{constructor(){this.color=4294967295}static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("FillTextureCmd",FillTextureCmd);return l.texture=e,l.x=t,l.y=r,l.width=i,l.height=a,l.type=s,l.offset=n,l.color=null!=o?ColorUtils.create(o).numColor:4294967295,l}recover(){this.texture=null,this.offset=null,Pool.recover("FillTextureCmd",this)}run(e,t,r){if(this.texture)if(this.percent&&e.sprite){let i=e.sprite.width,a=e.sprite.height;e.fillTexture(this.texture,this.x*i+t,this.y*a+r,this.width*i,this.height*a,this.type,this.offset||Point.EMPTY,this.color)}else e.fillTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.type,this.offset||Point.EMPTY,this.color)}get cmdID(){return FillTextureCmd.ID}getBoundPoints(e){return this.width&&this.height?Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null):Rectangle._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}FillTextureCmd.ID="FillTexture",ClassUtils.regClass("FillTextureCmd",FillTextureCmd);class RestoreCmd{static create(){return Pool.getItemByClass("RestoreCmd",RestoreCmd)}recover(){Pool.recover("RestoreCmd",this)}run(e,t,r){e.restore()}get cmdID(){return RestoreCmd.ID}}RestoreCmd.ID="Restore";class RotateCmd{static create(e,t,r){var i=Pool.getItemByClass("RotateCmd",RotateCmd);return i.angle=e,i.pivotX=t,i.pivotY=r,i}recover(){Pool.recover("RotateCmd",this)}run(e,t,r){e._rotate(this.angle,this.pivotX+t,this.pivotY+r)}get cmdID(){return RotateCmd.ID}}RotateCmd.ID="Rotate";class ScaleCmd{static create(e,t,r,i){var a=Pool.getItemByClass("ScaleCmd",ScaleCmd);return a.scaleX=e,a.scaleY=t,a.pivotX=r,a.pivotY=i,a}recover(){Pool.recover("ScaleCmd",this)}run(e,t,r){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+r)}get cmdID(){return ScaleCmd.ID}}ScaleCmd.ID="Scale";class TransformCmd{static create(e,t,r){var i=Pool.getItemByClass("TransformCmd",TransformCmd);return i.matrix=e,i.pivotX=t,i.pivotY=r,i}recover(){this.matrix=null,Pool.recover("TransformCmd",this)}run(e,t,r){e._transform(this.matrix,this.pivotX+t,this.pivotY+r)}get cmdID(){return TransformCmd.ID}}TransformCmd.ID="Transform";class TranslateCmd{static create(e,t){var r=Pool.getItemByClass("TranslateCmd",TranslateCmd);return r.tx=e,r.ty=t,r}recover(){Pool.recover("TranslateCmd",this)}run(e,t,r){e.translate(this.tx,this.ty)}get cmdID(){return TranslateCmd.ID}}TranslateCmd.ID="Translate";class DrawTrianglesCmd{static create(e,t,r,i,a,s,n,o,l,h){var u=Pool.getItemByClass("DrawTrianglesCmd",DrawTrianglesCmd);return u.texture=e,u.x=t,u.y=r,u.vertices=i,u.uvs=a,u.indices=s,u.matrix=n,u.alpha=o,u.color=null!=l?ColorUtils.create(l).numColor:4294967295,u.blendMode=h,u}recover(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,Pool.recover("DrawTrianglesCmd",this)}run(e,t,r){e.drawTriangles(this.texture,this.x+t,this.y+r,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return DrawTrianglesCmd.ID}getBoundPoints(e){let t=this.vertices;var r=t.length;if(r<2)return[];for(var i=t[0],a=t[1],s=i,n=a,o=2;o<r;){var l=t[o++],h=t[o++];i>l&&(i=l),a>h&&(a=h),s<l&&(s=l),n<h&&(n=h)}return[i,a,s,a,s,n,i,n]}}DrawTrianglesCmd.ID="DrawTriangles",ClassUtils.regClass("DrawTrianglesCmd",DrawTrianglesCmd);class Draw9GridTextureCmd{constructor(){this.color=4294967295}static create(e,t,r,i,a,s,n=!1,o=null){let l=Pool.getItemByClass("Draw9GridTextureCmd",Draw9GridTextureCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=i,l.height=a,l.sizeGrid=s,l.percent=n,l.color=null!=o?ColorUtils.create(o).numColor:4294967295,l}recover(){this.texture._removeReference(),Pool.recover("Draw9GridTextureCmd",this)}run(e,t,r){if(this.texture){let i=this.sizeGrid||this.texture._sizeGrid||re;if(this.percent&&e.sprite){let a=e.sprite.width,s=e.sprite.height;e.drawTextureWithSizeGrid(this.texture,this.x*a,this.y*s,this.width*a,this.height*s,i,t,r,this.color)}else e.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,i,t,r,this.color)}}get cmdID(){return Draw9GridTextureCmd.ID}getBoundPoints(e){let t=this.x,r=this.y,i=this.width,a=this.height;return this.percent&&(t*=e.width,r*=e.height,i*=e.width,a*=e.height),[t,r,i,r,i,a,t,a]}}Draw9GridTextureCmd.ID="Draw9GridTexture";const re=[0,0,0,0,0];ClassUtils.regClass("Draw9GridTextureCmd",Draw9GridTextureCmd);class SaveCmd{static create(){return Pool.getItemByClass("SaveCmd",SaveCmd)}recover(){Pool.recover("SaveCmd",this)}run(e,t,r){e.save()}get cmdID(){return SaveCmd.ID}}SaveCmd.ID="Save";const ie=new Matrix,ae=new Matrix,se=[];class GraphicsBounds{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,Pool.recover("GraphicsBounds",this)}static create(){return Pool.getItemByClass("GraphicsBounds",GraphicsBounds)}reset(){this._temp&&(this._temp.length=0)}getBounds(e=!1){return(!this._bounds||!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._bounds=Rectangle._getWrapRec(this.getBoundPoints(e),this._bounds)),this._cacheBoundsType=e,this._bounds}getBoundPoints(e=!1){return(!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(e)),this._cacheBoundsType=e,this._rstBoundPoints=Utils.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(e=!1){let t=this._graphics.cmds,r=this._graphics._sp;this._affectBySize=!1;let i=this._temp||(this._temp=[]);if(i.length=0,0==t.length)return i;let a=se;a.length=0;let s=ae;s.identity();let n=ie;for(let e=0,o=t.length;e<o;e++){let o=t[e];switch(o.percent&&(this._affectBySize=!0),o.cmdID){case AlphaCmd.ID:case SaveCmd.ID:a.push(s),s=s.clone();break;case RestoreCmd.ID:s=a.pop();break;case ScaleCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.scale(o.scaleX,o.scaleY),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case RotateCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.rotate(o.angle),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case TranslateCmd.ID:n.identity(),n.translate(o.tx,o.ty),this._switchMatrix(s,n);break;case TransformCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.concat(o.matrix),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case DrawImageCmd.ID:case FillTextureCmd.ID:addPointArrToRst(i,Rectangle._getBoundPointS(o.x,o.y,o.width,o.height),s);break;case DrawTextureCmd.ID:s.copyTo(n),o.matrix&&n.concat(o.matrix),addPointArrToRst(i,Rectangle._getBoundPointS(o.x,o.y,o.width,o.height),n);break;case DrawRectCmd.ID:case DrawCircleCmd.ID:case DrawLineCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s);break;case DrawCurvesCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s,o.x,o.y);break;case DrawLinesCmd.ID:case DrawPolyCmd.ID:addPointArrToRst(i,o.points,s,o.x,o.y);break;case DrawPathCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s,o.x,o.y);break;case DrawPieCmd.ID:case DrawTrianglesCmd.ID:case Draw9GridTextureCmd.ID:addPointArrToRst(i,o.getBoundPoints(r),s)}}return i.length>200?i=Utils.copyArray(i,Rectangle._getWrapRec(i)._getBoundPoints()):i.length>8&&(i=GrahamScan.scanPList(i)),i}_switchMatrix(e,t){t.concat(e),t.copyTo(e)}}function addPointArrToRst(e,t,r,i=0,a=0){let s=t.length;for(let n=0;n<s;n+=2)addPointToRst(e,t[n]+i,t[n+1]+a,r)}function addPointToRst(e,t,r,i){var a=Point.TEMP;a.setTo(t||0,r||0),i.transformPoint(a),e.push(a.x,a.y)}class ClipRectCmd{static create(e,t,r,i){var a=Pool.getItemByClass("ClipRectCmd",ClipRectCmd);return a.x=e,a.y=t,a.width=r,a.height=i,a}recover(){Pool.recover("ClipRectCmd",this)}run(e,t,r){e.clipRect(this.x+t,this.y+r,this.width,this.height)}get cmdID(){return ClipRectCmd.ID}}ClipRectCmd.ID="ClipRect";class DrawTexturesCmd{static create(e,t,r){var i=Pool.getItemByClass("DrawTexturesCmd",DrawTexturesCmd);return i.texture=e,e._addReference(),i.pos=t,i.colors=r||[],i}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,Pool.recover("DrawTexturesCmd",this)}run(e,t,r){e.drawTextures(this.texture,this.pos,t,r,this.colors)}get cmdID(){return DrawTexturesCmd.ID}}DrawTexturesCmd.ID="DrawTextures";class FillTextCmd{static create(e,t,r,i,a,s,n,o){var l=Pool.getItemByClass("FillTextCmd",FillTextCmd);switch(l._text=null,l._wordText=null,l.x=t,l.y=r,l.font=i,l.color=a,l._lineWidth=n,l._borderColor=o,s){case"center":l._textAlign=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l._textAlign=Const.ENUM_TEXTALIGN_RIGHT;break;default:l._textAlign=Const.ENUM_TEXTALIGN_DEFAULT}return e instanceof WordText?(l._wordText=e,e.cleanCache()):l._text=e,l}recover(){Pool.recover("FillTextCmd",this)}run(e,t,r){ILaya.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),e._fast_filltext(this._wordText||this._text,this.x+t,this.y+r,this._fontObj,this._color,this._borderColor,this._lineWidth,this._textAlign)}get cmdID(){return FillTextCmd.ID}get font(){return this._font}set font(e){this._font=e,e||(e=Config.defaultFontSize+"px "+Config.defaultFont),this._fontObj=FontInfo.parse(e),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(e){this._color=e,this._wordText&&this._wordText.cleanCache()}}FillTextCmd.ID="FillText",ClassUtils.regClass("FillTextCmd",FillTextCmd);class CacheManger{constructor(){}static regCacheByFunction(e,t){var r;CacheManger.unRegCacheByFunction(e,t),r={tryDispose:e,getCacheList:t},CacheManger._cacheList.push(r)}static unRegCacheByFunction(e,t){var r,i;for(i=CacheManger._cacheList.length,r=0;r<i;r++)if(CacheManger._cacheList[r].tryDispose==e&&CacheManger._cacheList[r].getCacheList==t)return void CacheManger._cacheList.splice(r,1)}static forceDispose(){var e,t=CacheManger._cacheList.length;for(e=0;e<t;e++)CacheManger._cacheList[e].tryDispose(!0)}static beginCheck(e=15e3){ILaya.systemTimer.loop(e,null,CacheManger._checkLoop)}static stopCheck(){ILaya.systemTimer.clear(null,CacheManger._checkLoop)}static _checkLoop(){var e=CacheManger._cacheList;if(!(e.length<1)){var t,r,i=ILaya.Browser.now();for(r=t=e.length;t>0&&(CacheManger._index++,CacheManger._index=CacheManger._index%r,e[CacheManger._index].tryDispose(!1),!(ILaya.Browser.now()-i>CacheManger.loopTimeLimit));)t--}}}CacheManger.loopTimeLimit=2,CacheManger._cacheList=[],CacheManger._index=0;class VectorGraphManager{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],CacheManger.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return VectorGraphManager.instance=VectorGraphManager.instance||new VectorGraphManager}getId(){return this._id++}addShape(e,t){this.shapeDic[e]=t,this.useDic[e]||(this.useDic[e]=!0)}addLine(e,t){this.shapeLineDic[e]=t,this.shapeLineDic[e]||(this.shapeLineDic[e]=!0)}getShape(e){this._checkKey&&null!=this.useDic[e]&&(this.useDic[e]=!0)}deleteShape(e){this.shapeDic[e]&&(this.shapeDic[e]=null,delete this.shapeDic[e]),this.shapeLineDic[e]&&(this.shapeLineDic[e]=null,delete this.shapeLineDic[e]),null!=this.useDic[e]&&delete this.useDic[e]}getCacheList(){var e,t=[];for(e in this.shapeDic)t.push(this.shapeDic[e]);for(e in this.shapeLineDic)t.push(this.shapeLineDic[e]);return t}startDispose(e){var t;for(t in this.useDic)this.useDic[t]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var e;for(e in this.useDic)this.useDic[e]||this.deleteShape(e);this._checkKey=!1}}}class Graphics{constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._destroyData()}clear(e=!0){if(e)for(let e=0,t=this._cmds.length;e<t;e++)this._cmds[e].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~SpriteConst.GRAPHICS),this._repaint(),this._vectorgraphArray){for(let e=0,t=this._vectorgraphArray.length;e<t;e++)VectorGraphManager.getInstance().deleteShape(this._vectorgraphArray[e]);this._vectorgraphArray.length=0}}_clearBoundsCache(e){this._graphicBounds&&(e&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=GraphicsBounds.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(e){this._sp&&(this._sp._renderType|=SpriteConst.GRAPHICS),this._cmds=e;let t=e.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}addCmd(e){if(null!=e)return this._sp&&(this._sp._renderType|=SpriteConst.GRAPHICS),this._cmds.push(e),this._render=1===this._cmds.length?this._renderOne:this._renderAll,this._repaint(),e;console.warn("null cmd")}removeCmd(e){let t=this.cmds.indexOf(e);if(-1!=t){this._cmds.splice(t,1);let e=this._cmds.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}}getBounds(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(e)}getBoundPoints(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(e)}drawImage(e,t=0,r=0,i=null,a=null,s=null){return e&&e.bitmap?this.addCmd(DrawImageCmd.create(e,t,r,i,a,s)):null}drawTexture(e,t=0,r=0,i=null,a=null,s=null,n=1,o=null,l=null,h){return!e||n<.01?null:e.bitmap?this.addCmd(DrawTextureCmd.create(e,t,r,i,a,s,n,o,l,h)):null}drawTextures(e,t,r){return e?this.addCmd(DrawTexturesCmd.create(e,t,r)):null}drawTriangles(e,t,r,i,a,s,n=null,o=1,l=null,h=null){return this.addCmd(DrawTrianglesCmd.create(e,t,r,i,a,s,n,o,l,h))}fillTexture(e,t,r,i=0,a=0,s="repeat",n=null,o=null){return e&&e.bitmap?this.addCmd(FillTextureCmd.create(e,t,r,i,a,s,n||Point.EMPTY,o)):null}clipRect(e,t,r,i){return this.addCmd(ClipRectCmd.create(e,t,r,i))}fillText(e,t,r,i,a,s){return this.addCmd(FillTextCmd.create(e,t,r,i,a,s,0,""))}fillBorderText(e,t,r,i,a,s,n,o){return this.addCmd(FillTextCmd.create(e,t,r,i,a,s,n,o))}strokeText(e,t,r,i,a,s,n){return this.addCmd(FillTextCmd.create(e,t,r,i,null,n,s,a))}alpha(e){return this.addCmd(AlphaCmd.create(e))}transform(e,t=0,r=0){return this.addCmd(TransformCmd.create(e,t,r))}rotate(e,t=0,r=0){return this.addCmd(RotateCmd.create(e,t,r))}scale(e,t,r=0,i=0){return this.addCmd(ScaleCmd.create(e,t,r,i))}translate(e,t){return this.addCmd(TranslateCmd.create(e,t))}save(){return this.addCmd(SaveCmd.create())}restore(){return this.addCmd(RestoreCmd.create())}replaceTextColor(e){this._repaint();let t=this._cmds;for(let r=t.length-1;r>-1;r--){let i=t[r];switch(i.cmdID){case FillTextCmd.ID:i.color=e;break;case DrawImageCmd.ID:i.color=null!=e?ColorUtils.create(e).numColor:4294967295}}}loadImage(e,t=0,r=0,i=null,a=null,s=null){let n=ILaya.loader.getRes(e);n?(this.drawImage(n,t,r,i,a),s&&s.call(this._sp)):ILaya.loader.load(e).then((e=>{this.drawImage(e,t,r,i,a),s&&s.call(this._sp)}))}_renderEmpty(e,t,r,i){}_renderAll(e,t,r,i){t.sprite=e;var a=this._cmds;for(let e=0,s=a.length;e<s;e++)a[e].run(t,r,i)}_renderOne(e,t,r,i){t.sprite=e,this._cmds[0].run(t,r,i)}drawLine(e,t,r,i,a,s=1){return this.addCmd(DrawLineCmd.create(e,t,r,i,a,s))}drawLines(e,t,r,i,a=1){return!r||r.length<4?null:this.addCmd(DrawLinesCmd.create(e,t,r,i,a))}drawCurves(e,t,r,i,a=1){return this.addCmd(DrawCurvesCmd.create(e,t,r,i,a))}drawRect(e,t,r,i,a,s=null,n=1,o){return this.addCmd(DrawRectCmd.create(e,t,r,i,a,s,n,o))}drawCircle(e,t,r,i,a=null,s=1){return this.addCmd(DrawCircleCmd.create(e,t,r,i,a,s))}drawPie(e,t,r,i,a,s,n=null,o=1){return this.addCmd(DrawPieCmd.create(e,t,r,Utils.toRadian(i),Utils.toRadian(a),s,n,o))}drawPoly(e,t,r,i,a=null,s=1){return this.addCmd(DrawPolyCmd.create(e,t,r,i,a,s))}drawPath(e,t,r,i=null,a=null){return this.addCmd(DrawPathCmd.create(e,t,r,i,a))}draw9Grid(e,t=0,r=0,i=0,a=0,s,n){this.addCmd(Draw9GridTextureCmd.create(e,t,r,i,a,s,!1,n))}}const ne=[];class Node extends EventDispatcher{get url(){return this._url}set url(e){this._url=e}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}get is3D(){return this._is3D}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._hideFlags=0,this._children=ne,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}_initialize(){this._extra={}}_setBit(e,t){e===NodeFlags.DISPLAY&&(this._getBit(e)!=t&&this._updateDisplayedInstage());t?this._bits|=e:this._bits&=~e}_getBit(e){return 0!=(this._bits&e)}_setUpNoticeChain(){this._getBit(NodeFlags.DISPLAY)&&this._setBitUp(NodeFlags.DISPLAY)}_setBitUp(e){var t=this;for(t._setBit(e,!0),t=t._parent;t;){if(t._getBit(e))return;t._setBit(e,!0),t=t._parent}}onStartListeningToType(e){e!==Event.DISPLAY&&e!==Event.UNDISPLAY||this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY)}bubbleEvent(e,t){let r=oe.length>0?oe.pop():[];r.length=0;let i=this;for(;i;)i.activeInHierarchy&&r.push(i),i=i.parent;if(t instanceof Event){t._stopped=!1;for(let i of r)if(t.setTo(e,i,this),i.event(e,t),t._stopped)break}else for(let i of r)i.event(e,t);oe.push(r)}hasHideFlag(e){return 0!=(this._hideFlags&e)}destroy(e=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(e?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let e=0,t=this._children.length;e<t;e++)this._children[0]&&this._children[0].destroy(!0)}addChild(e){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(NodeFlags.HAS_ZORDER,!0),e._parent===this){var t=this.getChildIndex(e);t!==this._children.length-1&&(this._children.splice(t,1),this._children.push(e),this._childChanged())}else e._parent&&e._parent.removeChild(e),this._children===ne&&(this._children=[]),this._children.push(e),e._setParent(this);return e}addChildren(...e){for(var t=0,r=e.length;t<r;)this.addChild(e[t++])}addChildAt(e,t){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(NodeFlags.HAS_ZORDER,!0),t>=0&&t<=this._children.length){if(e._parent===this){var r=this.getChildIndex(e);this._children.splice(r,1),this._children.splice(t,0,e),this._childChanged()}else e._parent&&e._parent.removeChild(e),this._children===ne&&(this._children=[]),this._children.splice(t,0,e),e._setParent(this);return e}throw new Error("appendChildAt:The index is out of bounds")}getChildIndex(e){return this._children.indexOf(e)}getChildByName(e){for(let t of this._children)if(t&&t.name===e)return t;return null}getChildAt(e){return this._children[e]||null}setChildIndex(e,t){var r=this._children;if(t<0||t>=r.length)throw new Error("setChildIndex:The index is out of bounds.");var i=this.getChildIndex(e);if(i<0)throw new Error("setChildIndex:node is must child of this object.");return r.splice(i,1),r.splice(t,0,e),this._childChanged(),e}_childChanged(e=null){}removeChild(e){if(!this._children)return e;var t=this._children.indexOf(e);return this.removeChildAt(t)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(e){var t=this.getChildByName(e);return t&&this.removeChild(t),t}removeChildAt(e){var t=this.getChildAt(e);return t&&(this._children.splice(e,1),t._setParent(null)),t}removeChildren(e=0,t=2147483647){if(this._children&&this._children.length>0){var r=this._children;if(0===e&&t>=r.length-1){var i=r;this._children=ne}else i=r.splice(e,t-e+1);for(var a=0,s=i.length;a<s;a++)i[a]._setParent(null)}return this}replaceChild(e,t){var r=this._children.indexOf(t);return r>-1?(this._children.splice(r,1,e),t._setParent(null),e._setParent(this),e):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(e){let t=e.parent;for(;t;){if(t==this)return!0;t=t.parent}return!1}_setParent(e){if(this._parent!==e)if(e)this._parent=e,this._onAdded(),this.event(Event.ADDED),this._getBit(NodeFlags.DISPLAY)&&(this._setUpNoticeChain(),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this);else{this._onRemoved(),this.event(Event.REMOVED);let t=this._parent;this._getBit(NodeFlags.DISPLAY)&&this._displayChild(this,!1),this._parent=e,t._childChanged(this)}}get displayedInStage(){return this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY),this._getBit(NodeFlags.DISPLAYED_INSTAGE)}_updateDisplayedInstage(){var e;e=this;for(var t=ILaya.stage,r=!1;e;){if(e._getBit(NodeFlags.DISPLAY)){r=e._getBit(NodeFlags.DISPLAYED_INSTAGE);break}if(e===t||e._getBit(NodeFlags.DISPLAYED_INSTAGE)){r=!0;break}e=e._parent}this._setBit(NodeFlags.DISPLAYED_INSTAGE,r)}_setDisplay(e){this._getBit(NodeFlags.DISPLAYED_INSTAGE)!==e&&(this._setBit(NodeFlags.DISPLAYED_INSTAGE,e),e?this.event(Event.DISPLAY):this.event(Event.UNDISPLAY))}_displayChild(e,t){var r=e._children;if(r)for(var i=0,a=r.length;i<a;i++){var s=r[i];s&&(s._getBit(NodeFlags.DISPLAY)&&(s._children.length>0?this._displayChild(s,t):s._setDisplay(t)))}e._setDisplay(t)}contains(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}timerLoop(e,t,r,i=null,a=!0,s=!1){this.timer.loop(e,t,r,i,a,s)}timerOnce(e,t,r,i=null,a=!0){this.timer._create(!1,!1,e,t,r,i,a)}frameLoop(e,t,r,i=null,a=!0){this.timer._create(!0,!0,e,t,r,i,a)}frameOnce(e,t,r,i=null,a=!0){this.timer._create(!0,!1,e,t,r,i,a)}clearTimer(e,t){this.timer.clear(e,t)}callLater(e,t=null){this.timer.callLater(this,e,t)}runCallLater(e){this.timer.runCallLater(this,e)}get scene(){return this._scene}get active(){return!this._getBit(NodeFlags.NOT_READY)&&!this._getBit(NodeFlags.NOT_ACTIVE)}set active(e){if(e=!!e,!this._getBit(NodeFlags.NOT_ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw e?"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.":"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._setBit(NodeFlags.NOT_ACTIVE,!e),this._parent&&this._parent.activeInHierarchy&&this._processActive(e,!0)}}get activeInHierarchy(){return this._getBit(NodeFlags.ACTIVE_INHIERARCHY)}_onActive(){Stat.spriteCount++}_onInActive(){Stat.spriteCount--}_onActiveInScene(){}_onInActiveInScene(){}onAwake(){}onEnable(){}onDisable(){}_parse(e,t){}_setBelongScene(e){if(!this._scene||this.scene!=e){this._scene=e,this._onActiveInScene();for(let t=0,r=this._children.length;t<r;t++)this._children[t]._setBelongScene(e)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setUnBelongScene()}}_processActive(e,t){this._activeChangeScripts||(this._activeChangeScripts=[]);let r=this._activeChangeScripts;e?this._activeHierarchy(r,t):this._inActiveHierarchy(r,t);for(let t=0,i=r.length;t<i;t++){let i=r[t];i.owner&&i._setActive(e)}r.length=0}_activeHierarchy(e,t){if(this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!0),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!0)}this._onActive();for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];!i._getBit(NodeFlags.NOT_ACTIVE)&&!i._getBit(NodeFlags.NOT_READY)&&i._activeHierarchy(e,t)}this._getBit(NodeFlags.AWAKED)||(this._setBit(NodeFlags.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(e,t){if(this._onInActive(),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!1)}this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!1);for(let r=0,i=this._children.length;r<i;r++){let i=this._children[r];i&&!i._getBit(NodeFlags.NOT_ACTIVE)&&i._inActiveHierarchy(e,t)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";{let e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(e){var t;this._components||(this._components=[]),this._components.push(e),e._setOwner(this),this.activeInHierarchy&&e._setActive(!0),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,0)}_destroyComponent(e){var t;if(!this._components)return;let r=this._components.indexOf(e);-1!=r&&(this._components.splice(r,1),e._destroy(),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,1))}destroyAllComponent(){var e;if(this._components){for(let e=0,t=this._components.length;e<t;e++){let t=this._components[e];t&&!t.destroyed&&t._destroy()}this._components.length=0,null===(e=this._componentsChanged)||void 0===e||e.call(this,null,2)}}_cloneTo(e,t,r){var i=e;if(this._components)for(let e=0,t=this._components.length;e<t;e++){var a=i.addComponent(this._components[e].constructor);this._components[e]._cloneTo(a)}}addComponentInstance(e){if(e.owner)throw"Node:the component has belong to other node.";if(e._singleton&&this.getComponent(e.constructor))throw"Node:the component is singleton, can't add the second one.";return this._addComponentInstance(e),e}addComponent(e){let t=Pool.createByClass(e);if(!t)throw e.toString()+"组件不存在";if(t._singleton&&this.getComponent(e))throw"无法实例"+e+"组件，"+e+"组件已存在！";return this._addComponentInstance(t),t}getComponent(e){if(this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];if(r instanceof e)return r}return null}get components(){return this._components||ne}getComponents(e){var t;if(this._components)for(let r=0,i=this._components.length;r<i;r++){let i=this._components[r];i instanceof e&&(t=t||[]).push(i)}return t}get timer(){return this._scene?this._scene.timer:ILaya.timer}onAfterDeserialize(){}}const oe=[],le=.5*Math.PI,he=2*Math.PI;class Ease{static linearNone(e,t,r,i){return r*e/i+t}static linearIn(e,t,r,i){return r*e/i+t}static linearInOut(e,t,r,i){return r*e/i+t}static linearOut(e,t,r,i){return r*e/i+t}static bounceIn(e,t,r,i){return r-Ease.bounceOut(i-e,0,r,i)+t}static bounceInOut(e,t,r,i){return e<.5*i?.5*Ease.bounceIn(2*e,0,r,i)+t:.5*Ease.bounceOut(2*e-i,0,r,i)+.5*r+t}static bounceOut(e,t,r,i){return(e/=i)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t}static backIn(e,t,r,i,a=1.70158){return r*(e/=i)*e*((a+1)*e-a)+t}static backInOut(e,t,r,i,a=1.70158){return(e/=.5*i)<1?.5*r*(e*e*((1+(a*=1.525))*e-a))+t:r/2*((e-=2)*e*((1+(a*=1.525))*e+a)+2)+t}static backOut(e,t,r,i,a=1.70158){return r*((e=e/i-1)*e*((a+1)*e+a)+1)+t}static elasticIn(e,t,r,i,a=0,s=0){var n;return 0==e?t:1==(e/=i)?t+r:(s||(s=.3*i),!a||r>0&&a<r||r<0&&a<-r?(a=r,n=s/4):n=s/he*Math.asin(r/a),-a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*he/s)+t)}static elasticInOut(e,t,r,i,a=0,s=0){var n;return 0==e?t:2==(e/=.5*i)?t+r:(s||(s=i*(.3*1.5)),!a||r>0&&a<r||r<0&&a<-r?(a=r,n=s/4):n=s/he*Math.asin(r/a),e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*he/s)*-.5+t:a*Math.pow(2,-10*(e-=1))*Math.sin((e*i-n)*he/s)*.5+r+t)}static elasticOut(e,t,r,i,a=0,s=0){var n;return 0==e?t:1==(e/=i)?t+r:(s||(s=.3*i),!a||r>0&&a<r||r<0&&a<-r?(a=r,n=s/4):n=s/he*Math.asin(r/a),a*Math.pow(2,-10*e)*Math.sin((e*i-n)*he/s)+r+t)}static strongIn(e,t,r,i){return r*(e/=i)*e*e*e*e+t}static strongInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static strongOut(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t}static sineInOut(e,t,r,i){return.5*-r*(Math.cos(Math.PI*e/i)-1)+t}static sineIn(e,t,r,i){return-r*Math.cos(e/i*le)+r+t}static sineOut(e,t,r,i){return r*Math.sin(e/i*le)+t}static quintIn(e,t,r,i){return r*(e/=i)*e*e*e*e+t}static quintInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static quintOut(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t}static quartIn(e,t,r,i){return r*(e/=i)*e*e*e+t}static quartInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e*e+t:.5*-r*((e-=2)*e*e*e-2)+t}static quartOut(e,t,r,i){return-r*((e=e/i-1)*e*e*e-1)+t}static cubicIn(e,t,r,i){return r*(e/=i)*e*e+t}static cubicInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e*e+t:.5*r*((e-=2)*e*e+2)+t}static cubicOut(e,t,r,i){return r*((e=e/i-1)*e*e+1)+t}static quadIn(e,t,r,i){return r*(e/=i)*e+t}static quadInOut(e,t,r,i){return(e/=.5*i)<1?.5*r*e*e+t:.5*-r*(--e*(e-2)-1)+t}static quadOut(e,t,r,i){return-r*(e/=i)*(e-2)+t}static expoIn(e,t,r,i){return 0==e?t:r*Math.pow(2,10*(e/i-1))+t-.001*r}static expoInOut(e,t,r,i){return 0==e?t:e==i?t+r:(e/=.5*i)<1?.5*r*Math.pow(2,10*(e-1))+t:.5*r*(2-Math.pow(2,-10*--e))+t}static expoOut(e,t,r,i){return e==i?t+r:r*(1-Math.pow(2,-10*e/i))+t}static circIn(e,t,r,i){return-r*(Math.sqrt(1-(e/=i)*e)-1)+t}static circInOut(e,t,r,i){return(e/=.5*i)<1?.5*-r*(Math.sqrt(1-e*e)-1)+t:.5*r*(Math.sqrt(1-(e-=2)*e)+1)+t}static circOut(e,t,r,i){return r*Math.sqrt(1-(e=e/i-1)*e)+t}}class Handler{constructor(e=null,t=null,r=null,i=!1){this.once=!1,this._id=0,this.setTo(e,t,r,i)}setTo(e,t,r,i=!1){return this._id=Handler._gid++,this.caller=e,this.method=t,this.args=r,this.once=i,this}run(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}runWith(e){if(null==this.method)return null;var t=this._id;if(null==e)var r=this.method.apply(this.caller,this.args);else r=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),r}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,Handler._pool.push(this.clear()))}static create(e,t,r=null,i=!0){return Handler._pool.length?Handler._pool.pop().setTo(e,t,r,i):new Handler(e,t,r,i)}}Handler._pool=[],Handler._gid=1;class Tween{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(e,t,r,i=null,a=null,s=0,n=!1,o=!0){return Pool.getItemByClass("tween",Tween)._create(e,t,r,i,a,s,n,!0,o,!0)}static from(e,t,r,i=null,a=null,s=0,n=!1,o=!0){return Pool.getItemByClass("tween",Tween)._create(e,t,r,i,a,s,n,!1,o,!0)}to(e,t,r,i=null,a=null,s=0,n=!1){return this._create(e,t,r,i,a,s,n,!0,!1,!0)}from(e,t,r,i=null,a=null,s=0,n=!1){return this._create(e,t,r,i,a,s,n,!1,!1,!0)}_create(e,t,r,i,a,s,n,o,l,h){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=r,this._ease=i||t.ease||Tween.easeNone,this._complete=a||t.complete,this._delay=s,this._props=[],this._usedTimer=0,this._startTimer=Browser.now(),this._usedPool=l,this._delayParam=null,this.update=t.update;var u=e.$_GID||(e.$_GID=Utils.getGID());return Tween.tweenMap[u]?(n&&Tween.clearTween(e),Tween.tweenMap[u].push(this)):Tween.tweenMap[u]=[this],h?s<=0?this.firstStart(e,t,o):(this._delayParam=[e,t,o],ILaya.timer.once(s,this,this.firstStart,this._delayParam)):this._initProps(e,t,o),this}firstStart(e,t,r){this._delayParam=null,e.destroyed?this.clear():(this._initProps(e,t,r),this._beginLoop())}_initProps(e,t,r){for(var i in t)if("number"==typeof e[i]){var a=r?e[i]:t[i],s=r?t[i]:e[i];this._props.push([i,a,s-a]),r||(e[i]=a)}}_beginLoop(){ILaya.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(Browser.now())}_updateEase(e){var t=this._target;if(t){if(t.destroyed)return Tween.clearTween(t);var r=this._usedTimer=e-this._startTimer-this._delay;if(!(r<0)){if(r>=this._duration)return this.complete();for(var i=r>0?this._ease(r,0,1,this._duration):0,a=this._props,s=0,n=a.length;s<n;s++){var o=a[s];t[o[0]]=o[1]+i*o[2]}this.update&&this.update.run()}}}set progress(e){var t=e*this._duration;this._startTimer=Browser.now()-this._delay-t}complete(){if(this._target){ILaya.timer.runTimer(this,this.firstStart);for(var e=this._target,t=this._props,r=this._complete,i=0,a=t.length;i<a;i++){var s=t[i];e[s[0]]=s[1]+s[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),r&&r.run()):this.restart()}}pause(){var e;ILaya.timer.clear(this,this._beginLoop),ILaya.timer.clear(this,this._doEase),ILaya.timer.clear(this,this.firstStart),(e=Browser.now()-this._startTimer-this._delay)<0&&(this._usedTimer=e)}setStartTime(e){this._startTimer=e}static clearAll(e){if(e&&e.$_GID){var t=Tween.tweenMap[e.$_GID];if(t){for(var r=0,i=t.length;r<i;r++)t[r]._clear();t.length=0}}}static clear(e){e.clear()}static clearTween(e){Tween.clearAll(e)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),ILaya.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,Pool.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var e=Tween.tweenMap[this._target.$_GID];if(e)for(var t=0,r=e.length;t<r;t++)if(e[t]===this){e.splice(t,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=Browser.now(),this._delayParam)ILaya.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var e=this._props,t=0,r=e.length;t<r;t++){var i=e[t];this._target[i[0]]=i[1]}ILaya.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=Browser.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?ILaya.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(e,t,r,i){return r*e/i+t}}Tween.tweenMap=[];class Dragging{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(e,t,r,i,a,s,n=.92){this.clearTimer(),this.target=e,this.area=t,this.hasInertia=r,this.elasticDistance=t?i:0,this.elasticBackTime=a,this.data=s,this.ratio=n,this._parent=e.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,ILaya.stage.on(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.on(Event.MOUSE_OUT,this,this.onStageMouseUp),ILaya.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){ILaya.systemTimer.clear(this,this.loop),ILaya.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var e=this._parent.getMousePoint(),t=e.x,r=e.y,i=t-this._lastX,a=r-this._lastY;if(this._clickOnly){if(!(Math.abs(i*ILaya.stage._canvasTransform.getScaleX())>1||Math.abs(a*ILaya.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(Event.DRAG_START,this.data)}else this._offsets.push(i,a);0===i&&0===a||(this._lastX=t,this._lastY=r,this.target.x+=i*this._elasticRateX,this.target.y+=a*this._elasticRateY,this.area&&this.checkArea(),this.target.event(Event.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var e=this.area.x-this.target._x;else e=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-e/this.elasticDistance),this.target._y<this.area.y)var t=this.area.y-this.target.y;else t=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-t/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(e){if(ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp),ILaya.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var t=this._offsets.length,r=Math.min(t,6),i=this._offsets.length-r,a=t-1;a>i;a--)this._offsetY+=this._offsets[a--],this._offsetX+=this._offsets[a];this._offsetX=this._offsetX/r*2,this._offsetY=this._offsetY/r*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),ILaya.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var e=NaN,t=NaN;if(this.target.x<this.area.x?e=this.area.x:this.target._x>this.area.x+this.area.width&&(e=this.area.x+this.area.width),this.target.y<this.area.y?t=this.area.y:this.target._y>this.area.y+this.area.height&&(t=this.area.y+this.area.height),isNaN(e)&&isNaN(t))this.clear();else{var r={};isNaN(e)||(r.x=e),isNaN(t)||(r.y=t),this._tween=Tween.to(this.target,r,this.elasticBackTime,Ease.sineOut,Handler.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(Event.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(ILaya.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var e=this.target;this.target=null,this._parent=null,e.event(Event.DRAG_END,this.data)}}}class SpriteUtils{static getGlobalRecByPoints(e,t,r,i,a){var s,n;s=Point.create().setTo(t,r),s=e.localToGlobal(s),n=Point.create().setTo(i,a),n=e.localToGlobal(n);var o=Rectangle._getWrapRec([s.x,s.y,n.x,n.y]);return s.recover(),n.recover(),o}static getGlobalPosAndScale(e){return SpriteUtils.getGlobalRecByPoints(e,0,0,1,1)}static getTransformRelativeToWindow(e,t,r){var i=ILaya.stage,a=SpriteUtils.getGlobalPosAndScale(e),s=i._canvasTransform.clone(),n=s.tx,o=s.ty;s.rotate(-Math.PI/180*i.canvasDegree),s.scale(i.clientScaleX,i.clientScaleY);var l,h,u,d,_=i.canvasDegree%180!=0;return _?(l=r+a.y,h=t+a.x,l*=s.d,h*=s.a,90==i.canvasDegree?(l=n-l,h+=o):(l+=n,h=o-h)):(l=t+a.x,h=r+a.y,l*=s.a,h*=s.d,l+=n,h+=o),h+=i._safariOffsetY,_?(u=s.d*a.height,d=s.a*a.width):(u=s.a*a.width,d=s.d*a.height),{x:l,y:h,scaleX:u,scaleY:d}}static fitDOMElementInArea(e,t,r,i,a,s){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var n=SpriteUtils.getTransformRelativeToWindow(t,r,i);e.style.transform=e.style.webkitTransform="scale("+n.scaleX+","+n.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)",e.style.width=a+"px",e.style.height=s+"px",e.style.left=n.x+"px",e.style.top=n.y+"px"}static updateOrder(e){if(!e||e.length<2)return!1;for(var t,r,i,a=1,s=e.length;a<s;){for(i=e[t=a],r=e[t]._zOrder;--t>-1&&e[t]._zOrder>r;)e[t+1]=e[t];e[t+1]=i,a++}return!0}}class Sprite extends Node{destroy(e=!0){super.destroy(e),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=SpriteConst.REPAINT_NONE,this._texture=null,this._sizeFlag=0,this._style=SpriteStyle.EMPTY,this._cacheStyle=CacheStyle.EMPTY,this._boundStyle=null,this._graphics=null,this._ownGraphics=!1,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1}get scene(){return this._scene}updateZOrder(){SpriteUtils.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=BoundsStyle.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(e){e&&(this._renderType|=SpriteConst.CUSTOM,this._setCustomRender())}get cacheAs(){return this._cacheStyle.userSetCache}_setCacheAs(e){}set cacheAs(e){e!==this._cacheStyle.userSetCache&&("bitmap"!=e||this._cacheStyle.canvas instanceof HTMLCanvas||(this._cacheStyle.canvas=null),this._getCacheStyle().userSetCache=e,this.mask&&"normal"===e||(this._setCacheAs(e),this._checkCanvasEnable(),this.repaint()))}_checkCanvasEnable(){var e=this._cacheStyle.needEnableCanvasRender();this._getCacheStyle().enableCanvasRender=e,e?(this._cacheStyle.needBitmapCache()?this._cacheStyle.cacheAs="bitmap":this._cacheStyle.cacheAs=this._cacheStyle.userSetCache,this._cacheStyle.reCache=!0,this._renderType|=SpriteConst.CANVAS):(this._cacheStyle.cacheAs="none",this._cacheStyle.releaseContext(),this._renderType&=~SpriteConst.CANVAS),this._setCacheAs(this._cacheStyle.cacheAs)}get staticCache(){return this._cacheStyle.staticCache}set staticCache(e){this._getCacheStyle().staticCache=e,e||this.reCache()}reCache(){this._cacheStyle.reCache=!0,this._repaint|=SpriteConst.REPAINT_CACHE}getRepaint(){return this._repaint}_setX(e){this._x=e}_setY(e){this._y=e}get x(){return this._x}set x(e){if(!this._destroyed&&this._x!==e){this._setX(e),this.parentRepaint(SpriteConst.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(SpriteConst.REPAINT_CACHE)}}get y(){return this._y}set y(e){if(!this._destroyed&&this._y!==e){this._setY(e),this.parentRepaint(SpriteConst.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(SpriteConst.REPAINT_CACHE)}}get width(){return this.get_width()}set width(e){this.set_width(e)}set_width(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-2):0==e?this._sizeFlag|=1:this._sizeFlag&=-2,this._width===e&&t==this._sizeFlag||(this._width=e,this._setWidth(e),this._setPivotX(this._anchorX*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:0==this._width&&0==(1&this._sizeFlag)&&this.texture?this.texture.width:this._width}get height(){return this.get_height()}set height(e){this.set_height(e)}set_height(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-3):0==e?this._sizeFlag|=2:this._sizeFlag&=-3,this._height===e&&t==this._sizeFlag||(this._height=e,this._setHeight(e),this._setPivotY(this._anchorY*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:0==this._height&&0==(2&this._sizeFlag)&&this.texture?this.texture.height:this._height}get _isWidthSet(){return 0!=this._width||0!=(1&this._sizeFlag)}get _isHeightSet(){return 0!=this._height||0!=(2&this._sizeFlag)}_setWidth(e){}_setHeight(e){}_shouldRefreshLayout(){}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(e){this._getBoundsStyle().userBounds=e}getBounds(){return this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._getBoundPointsM(!1)):Rectangle.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(e=!1){let t=0,r=0;this._style&&(t=this.pivotX,r=this.pivotY,e=e||0!==this._style.rotation,this._style.scrollRect&&(t+=this._style.scrollRect.x,r+=this._style.scrollRect.y));let i=this._getBoundPointsM(e);if(!i||i.length<1)return i;if(8!=i.length&&(i=e?GrahamScan.scanPList(i):Rectangle._getWrapRec(i,Rectangle.TEMP)._getBoundPoints()),!this.transform)return Utils.transPointList(i,this._x-t,this._y-r),i;let a=Point.TEMP,s=i.length;for(let e=0;e<s;e+=2)a.x=i[e],a.y=i[e+1],this.toParentPoint(a),i[e]=a.x,i[e+1]=a.y;return i}getGraphicBounds(e=!1){return this._graphics?this._graphics.getBounds(e):Rectangle.TEMP.setTo(0,0,0,0)}_getBoundPointsM(e=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let t,r=this._boundStyle.temBM;if(r||(r=this._boundStyle.temBM=[]),this._style.scrollRect){r.length=0;var i=Rectangle.TEMP;return i.copyFrom(this._style.scrollRect),r.push(...i._getBoundPoints()),r}this._graphics?t=this._graphics.getBoundPoints():(r.length=0,t=r),this._texture&&((i=Rectangle.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),t.push(...i._getBoundPoints()));let a=this._children;for(let r=0,i=a.length;r<i;r++){let i=a[r];if(!0===i._visible&&i._cacheStyle.maskParent!=this){let r=i._boundPointsToParent(e);r&&(t?t.push(...r):t=r)}}return t}_getCacheStyle(){return this._cacheStyle===CacheStyle.EMPTY&&(this._cacheStyle=CacheStyle.create()),this._cacheStyle}getStyle(){return this._style===SpriteStyle.EMPTY&&(this._style=SpriteStyle.create()),this._style}setStyle(e){this._style=e}get scaleX(){return this._style.scaleX}set scaleX(e){this.set_scaleX(e)}get scaleY(){return this._style.scaleY}set scaleY(e){this.set_scaleY(e)}set_scaleX(e){this.getStyle().scaleX!==e&&(this._setScaleX(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleX(){return this._style.scaleX}set_scaleY(e){this.getStyle().scaleY!==e&&(this._setScaleY(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleY(){return this._style.scaleY}_setScaleX(e){this._style.scaleX=e}_setScaleY(e){this._style.scaleY=e}get rotation(){return this._style.rotation}set rotation(e){this.getStyle().rotation!==e&&(this._setRotation(e),this._setTranformChange())}_setRotation(e){this._style.rotation=e}get skewX(){return this._style.skewX}set skewX(e){this.getStyle().skewX!==e&&(this._setSkewX(e),this._setTranformChange())}_setSkewX(e){this._style.skewX=e}get skewY(){return this._style.skewY}set skewY(e){this.getStyle().skewY!==e&&(this._setSkewY(e),this._setTranformChange())}_setSkewY(e){this._style.skewY=e}_createTransform(){return Matrix.create()}_adjustTransform(){this._tfChanged=!1;var e=this._style,t=e.scaleX,r=e.scaleY,i=e.skewX,a=e.skewY,s=e.rotation,n=this._transform||(this._transform=this._createTransform());if(s||1!==t||1!==r||0!==i||0!==a){n._bTransform=!0;var o=.0174532922222222*(s-i),l=.0174532922222222*(s+a),h=Math.cos(l),u=Math.sin(l),d=Math.sin(o),_=Math.cos(o);n.a=t*h,n.b=t*u,n.c=-r*d,n.d=r*_,n.tx=n.ty=0}else n.identity(),this._renderType&=~SpriteConst.TRANSFORM;return n}_setTransform(e){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(e){this.set_transform(e)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(e){this._tfChanged=!1;var t=this._transform||(this._transform=this._createTransform());e.copyTo(t),this._setTransform(t),e&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0),e?this._renderType|=SpriteConst.TRANSFORM:this._renderType&=~SpriteConst.TRANSFORM,this.parentRepaint()}_setPivotX(e){this.getStyle().pivotX=e}_getPivotX(){return this._style.pivotX}_setPivotY(e){this.getStyle().pivotY=e}_getPivotY(){return this._style.pivotY}get pivotX(){return this._getPivotX()}set pivotX(e){if(this.getStyle().pivotX!=e){this._setPivotX(e);let t=this.width;0!=t&&(this._anchorX=e/t),this._shouldRefreshLayout(),this.repaint()}}get pivotY(){return this._getPivotY()}set pivotY(e){if(this.getStyle().pivotY!=e){this._setPivotY(e);let t=this.height;0!=t&&(this._anchorY=e/t),this._shouldRefreshLayout(),this.repaint()}}get anchorX(){return this.get_anchorX()}get_anchorX(){return this._anchorX}set anchorX(e){this.set_anchorX(e)}set_anchorX(e){isNaN(e)&&(e=null),this._anchorX!=e&&(this._anchorX=e,null!=e&&(this._setPivotX(e*this.width),this._shouldRefreshLayout(),this.repaint()))}get anchorY(){return this.get_anchorY()}get_anchorY(){return this._anchorY}set anchorY(e){this.set_anchorY(e)}set_anchorY(e){isNaN(e)&&(e=null),this._anchorY!=e&&(this._anchorY=e,null!=e&&(this._setPivotY(e*this.height),this._shouldRefreshLayout(),this.repaint()))}_setAlpha(e){this._style.alpha!==e&&(this.getStyle().alpha=e,1!==e?this._renderType|=SpriteConst.ALPHA:this._renderType&=~SpriteConst.ALPHA,this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(e){e=e<0?0:e>1?1:e,this._setAlpha(e)}get visible(){return this.get_visible()}set visible(e){this.set_visible(e)}get_visible(){return this._visible}set_visible(e){this._visible!==e&&(this._visible=e,this.parentRepaint(SpriteConst.REPAINT_ALL))}get blendMode(){return this._style.blendMode}set blendMode(e){this.getStyle().blendMode!=e&&(this.getStyle().blendMode=e,e&&"source-over"!=e?this._renderType|=SpriteConst.BLEND:this._renderType&=~SpriteConst.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new Graphics,this._ownGraphics=!0),this._graphics}set graphics(e){this._graphics&&(this._graphics._sp=null),this._graphics=e,e?(this._renderType|=SpriteConst.GRAPHICS,e._sp=this):this._renderType&=~SpriteConst.GRAPHICS,this.repaint()}get scrollRect(){return this._style.scrollRect}set scrollRect(e){null==this.getStyle().scrollRect&&null==e||(this.getStyle().scrollRect=e,e?this._renderType|=SpriteConst.CLIP:this._renderType&=~SpriteConst.CLIP,this.repaint())}pos(e,t,r=!1){if(this._x!==e||this._y!==t){if(this._destroyed)return this;if(r){this._setX(e),this._setY(t),this.parentRepaint(SpriteConst.REPAINT_CACHE);var i=this._cacheStyle.maskParent;i&&i.repaint(SpriteConst.REPAINT_CACHE)}else this.x=e,this.y=t}return this}pivot(e,t){return this.pivotX=e,this.pivotY=t,this}size(e,t){return this.width=e,this.height=t,this}scale(e,t,r){if(this._destroyed)return this;var i=this.getStyle();return i.scaleX==e&&i.scaleY==t||(r?(this._setScaleX(e),this._setScaleY(t),this._setTranformChange(),this._shouldRefreshLayout()):(this.scaleX=e,this.scaleY=t)),this}skew(e,t){return this.skewX=e,this.skewY=t,this}render(e,t,r){RenderSprite.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}drawToCanvas(e,t,r,i){return Sprite.drawToCanvas(this,this._renderType,e,t,r,i)}drawToTexture(e,t,r,i,a=null){return Sprite.drawToTexture(this,this._renderType,e,t,r,i,a)}drawToTexture3D(e,t,r){throw"not implement"}static drawToCanvas(e,t,r,i,a,s){a-=e.x,s-=e.y,a|=0,s|=0,r|=0,i|=0;var n=new Context;n.size(r,i),n.asBitmap=!0,n._targets.start(),n._targets.clear(0,0,0,0),RenderSprite.renders[t]._fun(e,n,a,s),n.flush(),n._targets.end(),n._targets.restore();var o=n._targets.getData(0,0,r,i);n.destroy();for(var l=new ImageData(r,i),h=4*r,u=l.data,d=i-1,_=d*h,c=0;d>=0;d--)u.set(o.subarray(c,c+h),_),_-=h,c+=h;var m=new HTMLCanvas(!0);return m.size(r,i),m.getContext("2d").putImageData(l,0,0),m}static drawToTexture(e,t,r,i,a,s,n=null){Sprite.drawtocanvCtx||(Sprite.drawtocanvCtx=new Context),a-=e.x,s-=e.y,a|=0,s|=0,r|=0,i|=0;var o=n?Sprite.drawtocanvCtx:new Context;let l;if(o.clear(),o.size(r,i),n?o._targets=n:o.asBitmap=!0,o._targets){o._targets.start();let r=RenderTexture2D._clearColor;o._targets.clear(r.r,r.g,r.b,r.a),o._drawingToTexture=!0,RenderSprite.renders[t]._fun(e,o,a,s),o._drawingToTexture=!1,o.flush(),o._targets.end(),o._targets.restore(),n||(l=o._targets),o._targets=null}if(!n){var h=new Texture(o._targets?o._targets:l,Texture.INV_UV);return o.destroy(!0),h}return e._repaint=0,n}customRender(e,t,r){this._repaint=SpriteConst.REPAINT_ALL}_applyFilters(){}get filters(){return this._cacheStyle.filters}set filters(e){e&&0===e.length&&(e=null),this._getCacheStyle().filters=e?e.slice():null,e?this._renderType|=SpriteConst.FILTERS:this._renderType&=~SpriteConst.FILTERS,e&&e.length>0?(this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY),1==e.length&&e[0]instanceof ColorFilter||(this._getCacheStyle().cacheForFilters=!0,this._checkCanvasEnable())):this._cacheStyle.cacheForFilters&&(this._cacheStyle.cacheForFilters=!1,this._checkCanvasEnable()),this._getCacheStyle().hasGlowFilter=this._isHaveGlowFilter(),this.repaint()}_isHaveGlowFilter(){var e,t;if(this.filters)for(e=0;e<this.filters.length;e++)if(this.filters[e].type==Filter.GLOW)return!0;for(e=0,t=this._children.length;e<t;e++)if(this._children[e]._isHaveGlowFilter())return!0;return!1}localToGlobal(e,t=!1,r=null){!0===t&&(e=new Point(e.x,e.y));var i=this;for(r=r||ILaya.stage;i&&!i._destroyed&&i!=r;)e=i.toParentPoint(e),i=i.parent;return e}globalToLocal(e,t=!1,r=null){t&&(e=new Point(e.x,e.y));var i=this,a=[];for(r=r||ILaya.stage;i&&!i._destroyed&&i!=r;)a.push(i),i=i.parent;for(var s=a.length-1;s>=0;)e=(i=a[s]).fromParentPoint(e),s--;return e}toParentPoint(e){if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,this.transform&&this._transform.transformPoint(e),e.x+=this._x,e.y+=this._y;var t=this._style.scrollRect;return t&&(e.x-=t.x,e.y-=t.y),e}fromParentPoint(e){if(!e)return e;e.x-=this._x,e.y-=this._y;var t=this._style.scrollRect;return t&&(e.x+=t.x,e.y+=t.y),this.transform&&this._transform.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}onStartListeningToType(e){super.onStartListeningToType(e),1!==this._mouseState&&Event.isMouseEvent(e)&&(this.mouseEnabled=!0,this._setBit(NodeFlags.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(e){if(1!==this._mouseState){var t=this;for(t=t.parent;t&&1!==t._mouseState&&!t._getBit(NodeFlags.HAS_MOUSE);)t.mouseEnabled=!0,t._setBit(NodeFlags.HAS_MOUSE,!0),t=t.parent}}_setParent(e){super._setParent(e),e&&this._getBit(NodeFlags.HAS_MOUSE)&&this._onDisplay()}loadImage(e,t=null){if(e){let r=ILaya.loader.getRes(e);r?(this.texture=r,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run()):(this._skinBaseUrl&&(e=URL.formatURL(e,this._skinBaseUrl)),ILaya.loader.load(e).then((e=>{this.texture=e,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run()})))}else this.texture=null,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run();return this}static fromImage(e){return(new Sprite).loadImage(e)}repaint(e=SpriteConst.REPAINT_CACHE){this._repaint&e||(this._repaint|=e,this.parentRepaint(e)),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(e)}_needRepaint(){return this._repaint&SpriteConst.REPAINT_CACHE&&this._cacheStyle.enableCanvasRender&&this._cacheStyle.reCache}_childChanged(e=null){super._childChanged(e),this._children.length?this._renderType|=SpriteConst.CHILDS:this._renderType&=~SpriteConst.CHILDS,e&&this._getBit(NodeFlags.HAS_ZORDER)&&ILaya.systemTimer.callLater(this,this.updateZOrder),this.repaint(SpriteConst.REPAINT_ALL)}parentRepaint(e=SpriteConst.REPAINT_CACHE){var t=this._parent;!t||t._repaint&e||(t._repaint|=e,t.parentRepaint(e))}get stage(){return ILaya.stage}get hitArea(){return this._style.hitArea}set hitArea(e){this.getStyle().hitArea=e}_setMask(e){}get mask(){return this._cacheStyle.mask}set mask(e){e&&this.mask==e&&e._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=e,this._setMask(e),this._checkCanvasEnable(),e?(e._getCacheStyle().maskParent=this,this._renderType|=SpriteConst.MASK):this._renderType&=~SpriteConst.MASK,this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(e){this._mouseState=e?2:1}startDrag(e=null,t=!1,r=0,i=300,a=null,s=.92){this._style.dragging||(this.getStyle().dragging=new Dragging),this._style.dragging.start(this,e,t,r,i,a,s)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(e){e||this._cacheStyle&&(this._cacheStyle.releaseContext(),this._cacheStyle.releaseFilterCache(),this._cacheStyle.hasGlowFilter&&(this._cacheStyle.hasGlowFilter=!1)),super._setDisplay(e)}hitTestPoint(e,t){var r=this.globalToLocal(Point.TEMP.setTo(e,t));return e=r.x,t=r.y,(this._style.hitArea?this._style.hitArea:this._isWidthSet&&this._isHeightSet?Rectangle.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(e,t)}getMousePoint(){return this.globalToLocal(Point.TEMP.setTo(ILaya.stage.mouseX,ILaya.stage.mouseY))}get globalScaleX(){for(var e=1,t=this;t&&t!==ILaya.stage;)e*=t.scaleX,t=t.parent;return e}get globalRotation(){for(var e=0,t=this;t&&t!==ILaya.stage;)e+=t.rotation,t=t.parent;return e}get globalScaleY(){for(var e=1,t=this;t&&t!==ILaya.stage;)e*=t.scaleY,t=t.parent;return e}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(NodeFlags.HAS_ZORDER,!0),ILaya.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(e){}set texture(e){"string"==typeof e?this.loadImage(e):this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e&&e._addReference(),this._setTexture(e),this._setWidth(this.width),this._setHeight(this.height),e?this._renderType|=SpriteConst.TEXTURE:this._renderType&=~SpriteConst.TEXTURE,this.repaint())}get viewport(){return this._style.viewport}set viewport(e){if("string"==typeof e){let t=e.split(",");t.length>3&&(e=new Rectangle(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])))}this.getStyle().viewport=e}_setTranformChange(){this._tfChanged=!0,this._renderType|=SpriteConst.TRANSFORM,this.parentRepaint(SpriteConst.REPAINT_CACHE)}set drawCallOptimize(e){this._setBit(NodeFlags.DRAWCALL_OPTIMIZE,e)}get drawCallOptimize(){return this._getBit(NodeFlags.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),LayaEnv.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}}class AnimationBase extends Sprite{constructor(){super(),this.wrapMode=0,this._interval=Config.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(NodeFlags.DISPLAY)}play(e=0,t=!0,r=""){this._isPlaying=!0,this._actionName=r,this.index="string"==typeof e?this._getFrameByLabel(e):e,this.loop=t,this._isReverse=this.wrapMode===AnimationBase.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(e){this._interval!=e&&(this._frameRateChanged=!0,this._interval=e,this._isPlaying&&e>0&&this.timerLoop(e,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(e){for(var t=0;t<this._count;t++){var r=this._labels[t];if(r&&r.indexOf(e)>-1)return t}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(Event.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(Event.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(Event.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(Event.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(e){this._controlNode&&(this._controlNode.off(Event.DISPLAY,this,this._resumePlay),this._controlNode.off(Event.UNDISPLAY,this,this._resumePlay)),this._controlNode=e,e&&e!=this&&(e.on(Event.DISPLAY,this,this._resumePlay),e.on(Event.UNDISPLAY,this,this._resumePlay))}_setDisplay(e){super._setDisplay(e),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(e,t){this._labels||(this._labels={}),this._labels[t]||(this._labels[t]=[]),this._labels[t].push(e)}removeLabel(e){if(e){if(this._labels)for(var t in this._labels)this._removeLabelFromList(this._labels[t],e)}else this._labels=null}_removeLabelFromList(e,t){if(e)for(var r=e.length-1;r>=0;r--)e[r]==t&&e.splice(r,1)}gotoAndStop(e){this.index="string"==typeof e?this._getFrameByLabel(e):e,this.stop()}get index(){return this._index}set index(e){if(this._index=e,this._displayToIndex(e),this._labels&&this._labels[e])for(var t=this._labels[e],r=0,i=t.length;r<i;r++)this.event(Event.LABEL,t[r])}_displayToIndex(e){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}AnimationBase.WRAP_POSITIVE=0,AnimationBase.WRAP_REVERSE=1,AnimationBase.WRAP_PINGPONG=2;class AtlasInfoManager{static enable(e,t=null){ILaya.loader.fetch(e,"json").then((e=>{e&&(AtlasInfoManager.addAtlases(e),t&&t.run())}))}static addAtlases(e){let t=AtlasInfoManager._fileLoadDic;for(let r in e){let i=e[r],a=URL.formatURL(i[0]),s=i[1],n=s.length,o={url:r};for(let e=0;e<n;e++)t[a+s[e]]=o}}static addAtlas(e,t,r){t=URL.formatURL(t);let i=AtlasInfoManager._fileLoadDic,a={url:e};for(let e of r)i[t+e]=a}static getFileLoadPath(e){return AtlasInfoManager._fileLoadDic[e]}}AtlasInfoManager._fileLoadDic={};class WorkerLoader{static workerSupported(){return!!Worker}static set enable(e){if(WorkerLoader._enable!=e){if(e){if(!Worker)return;WorkerLoader._worker||(WorkerLoader._worker=new Worker(WorkerLoader.workerPath),WorkerLoader._worker.onmessage=WorkerLoader.workerMessage,WorkerLoader._dispatcher=new EventDispatcher)}WorkerLoader._enable=e}}static get enable(){return WorkerLoader._enable}static load(e,t){return new Promise((r=>{WorkerLoader._worker.postMessage({url:e,options:t}),WorkerLoader._dispatcher.once(e,r)}))}static workerMessage(e){let t=e.data;if(t)switch(t.type){case"Image":WorkerLoader._dispatcher.event(t.url,t.imageBitmap);break;case"Disable":WorkerLoader.enable=!1}}}WorkerLoader.workerPath="libs/laya.workerloader.js",WorkerLoader._enable=!1;class AtlasResource extends Resource{constructor(e,t,r){super(),this.dir=e,this.textures=t,this.frames=r,this.lock=!0}_disposeResource(){for(let e of this.textures)e&&e.destroy();for(let e of this.frames)e.destroy();this.frames.length=0,this.textures.length=0}}class BatchProgress{constructor(e){this._callback=e,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(e){let t=this._items.length;return this._items.push(0),null==e?this._weights.push(null):this._weights.push(Math.max(0,Math.min(e,1))),e=>this.update(t,e)}update(e,t){if(-1!=e){this._items[e]=Math.max(0,Math.min(t,1));let r=0,i=this._items,a=this._weights,s=1/i.length;for(let e=0;e<i.length;e++){let t=i[e],n=a[e];null!=t&&(r+=t*(null!=n?n:s))}(t=r)>1&&(t=1)}t>this._progress&&(this._progress=t,this._callback(t))}}class ImgUtils{static compareVersion(e,t){let r=e.split("."),i=t.split(".");const a=Math.max(r.length,i.length);for(;r.length<a;)r.push("0");for(;i.length<a;)i.push("0");for(let e=0;e<a;e++){const t=parseInt(r[e]),a=parseInt(i[e]);if(t>a)return!0;if(t<a)return!1}return!0}static get isSupport(){if(Browser._isMiniGame){var e=Browser.window.wx.getSystemInfoSync().SDKVersion;return ImgUtils.compareVersion(e,"2.14.0")}return!!Browser.onLayaRuntime||!!Browser.window.Blob&&!!Browser.window.Blob}static arrayBufferToURL(e,t){if(!ImgUtils.isSupport)return e;if(ImgUtils.data[e])return ImgUtils.data[e];var r="";if(Browser._isMiniGame||Browser.onLayaRuntime)r=Browser.window.wx.createBufferURL(t);else if(Browser.window.Blob){let e=new Blob([t],{type:"application/octet-binary"});r=Browser.window.URL.createObjectURL(e)}return ImgUtils.isSavaData&&(ImgUtils.data[e]=r),r}static _arrayBufferToURL(e){if(!ImgUtils.isSupport)return null;var t="";if(Browser._isMiniGame||Browser.onLayaRuntime)t=Browser.window.wx.createBufferURL(e);else if(Browser.window.Blob){let r=new Blob([e],{type:"application/octet-binary"});t=Browser.window.URL.createObjectURL(r)}return t}static destroy(e){if(ImgUtils.isSupport){var t=ImgUtils.data[e];t&&(Browser._isMiniGame||Browser.onLayaRuntime?Browser.window.wx.revokeBufferURL(t):Browser.window.Blob&&Browser.window.URL.revokeObjectURL(t),delete ImgUtils.data[e])}}}ImgUtils.data={},ImgUtils.isSavaData=!1;class XMLUtils{static decodeString(e){let t=e.length,r="",i=0,a=0;for(;;){if(a=e.indexOf("&",i),-1==a){r+=e.substring(i);break}r+=e.substring(i,a),i=a+1,a=i;let s=Math.min(t,a+10);for(;a<s&&";"!=e[a];a++);if(a<s&&a>i){let t=e.substring(i,a),s=0;if("#"==t[0])t.length>1?(s="x"==t[1]?parseInt(t.substring(2),16):parseInt(t.substring(1)),r+=String.fromCharCode(s),i=a+1):r+="&";else{switch(t){case"amp":s=38;break;case"apos":s=39;break;case"gt":s=62;break;case"lt":s=60;break;case"nbsp":s=32;break;case"quot":s=34}s>0?(r+=String.fromCharCode(s),i=a+1):r+="&"}}else r+="&"}return r}static encodeString(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(e,t,r){if(null==e)return null==r?null:r;let i=e[t];return null!=i?""+i:null==r?null:r}static getInt(e,t,r){let i=this.getString(e,t);if(null!=i&&i.length>0)if("%"==i[i.length-1]){let e=parseInt(i.substring(0,i.length-1));if(!isNaN(e))return Math.ceil(e/100*r)}else{let e=parseInt(i);if(!isNaN(e))return e}return null==r?0:r}static getFloat(e,t,r){let i=this.getString(e,t);if(null==i||0==i.length)return null==r?0:r;let a=parseFloat(i);return isNaN(a)?null==r?0:r:a}static getBool(e,t,r){let i=this.getString(e,t);return null==i||0==i.length?null!=r&&r:"true"==i||"1"==i||"false"!=i&&"0"!=i&&(null!=r&&r)}}var ue;e.XMLTagType=void 0,(ue=e.XMLTagType||(e.XMLTagType={}))[ue.Start=0]="Start",ue[ue.End=1]="End",ue[ue.Void=2]="Void",ue[ue.CDATA=3]="CDATA",ue[ue.Comment=4]="Comment",ue[ue.Instruction=5]="Instruction";class XMLIterator{static begin(e,t){XMLIterator.source=e,XMLIterator.lowerCaseName=t,this.sourceLen=e.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let t,r,i="";for(this.tagType=e.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(t=this.source.indexOf("<",this.parsePos))&&(this.parsePos=t,t++,t!=this.sourceLen);){if(r=this.source[t],"!"==r){if(this.sourceLen>t+7&&"<![CDATA["==this.source.substring(t-1,t+8))return t=this.source.indexOf("]]>",t),this.tagType=e.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>t+2&&"\x3c!--"==this.source.substring(t-1,t+3))return t=this.source.indexOf("--\x3e",t),this.tagType=e.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;t++,this.tagType=e.XMLTagType.Instruction}else"/"==r?(t++,this.tagType=e.XMLTagType.End):"?"==r&&(t++,this.tagType=e.XMLTagType.Instruction);for(;t<this.sourceLen&&(r=this.source[t],-1==" \t\n\r\v".indexOf(r)&&">"!=r&&"/"!=r);t++);if(t==this.sourceLen)break;i+=this.source.substring(this.parsePos+1,t),i.length>0&&"/"==i[0]&&(i=i.substring(1));let a=!1,s=!1,n=-1;for(;t<this.sourceLen;t++)if(r=this.source[t],'"'==r?a||(s=!s):"'"==r&&(s||(a=!a)),">"==r){if(!a&&!s){n=-1;break}n=t}else if("<"==r)break;if(-1!=n&&(t=n),t==this.sourceLen)break;return"/"==this.source[t-1]&&(this.tagType=e.XMLTagType.Void),this.tagName=i,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=t+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":this.source.substring(e,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":XMLUtils.decodeString(this.source.substring(e,this.tagPos)).trimRight()}return XMLUtils.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let e in this._attrs)delete this._attrs[e];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(e){return this.attributes[e]}static parseAttributes(e){let t,r=0,i=0,a=!1,s=0,n="",o=this.tagPos,l=this.tagPos+this.tagLength;if(o<l&&"<"==this.source[o])for(;o<l;o++){let e=this.source[o];if(-1!=" \t\n\r\v".indexOf(e)||">"==e||"/"==e)break}for(;o<l;o++){let h=this.source[o];if("="==h){r=-1,i=-1,s=0;for(let e=o+1;e<l;e++){let t=this.source[e];if(-1!=" \t\n\r\v".indexOf(t)){if(-1!=r&&0==s){i=e-1;break}}else if(">"==t){if(0==s){i=e-1;break}}else if('"'==t)if(-1!=r){if(1!=s){i=e-1;break}}else s=2,r=e+1;else if("'"==t)if(-1!=r){if(2!=s){i=e-1;break}}else s=1,r=e+1;else-1==r&&(r=e)}if(-1==r||-1==i)break;t=n,this.lowerCaseName&&(t=t.toLowerCase()),n="",e[t]=XMLUtils.decodeString(this.source.substring(r,i+1)),o=i+1}else-1==" \t\n\r\v".indexOf(h)?((a||"/"==h||">"==h)&&(n.length>0&&(t=n,this.lowerCaseName&&(t=t.toLowerCase()),e[t]="",n=""),a=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(a=!0)}}}XMLIterator._attrs={};class XML{constructor(e){e&&this.parse(e)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(e,t){return XMLUtils.getString(this._attrs,e,t)}getAttrInt(e,t){return XMLUtils.getInt(this._attrs,e,t)}getAttrFloat(e,t){return XMLUtils.getFloat(this._attrs,e,t)}getAttrBool(e,t){return XMLUtils.getBool(this._attrs,e,t)}setAttribute(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t}getNode(e){return this._children?this._children.find((t=>t.name==e)):null}elements(e){return this._children||(this._children=new Array),e?this._children.filter((t=>t.name==e)):this._children}parse(t){let r;this.reset();let i=new Array;for(XMLIterator.begin(t);XMLIterator.nextTag();)if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t;if(r)t=new XML;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");t=this}t.name=XMLIterator.tagName,t._attrs=Object.assign({},XMLIterator.attributes),r&&(XMLIterator.tagType!=e.XMLTagType.Void&&i.push(r),null==r._children&&(r._children=new Array),r._children.push(t)),XMLIterator.tagType!=e.XMLTagType.Void&&(r=t)}else if(XMLIterator.tagType==e.XMLTagType.End){if(null==r||r.name!=XMLIterator.tagName)throw this.reset(),new Error("Invalid xml format - <"+XMLIterator.tagName+"> dismatched.");null!=r._children&&0!=r._children.length||(r.text=XMLIterator.getText()),r=i.length>0?i.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class HttpRequest extends EventDispatcher{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(e,t=null,r="get",i="text",a){this._responseType=i,this._data=null,(Browser.onVVMiniGame||Browser.onQGMiniGame||Browser.onQQMiniGame||Browser.onAlipayMiniGame||Browser.onBLMiniGame||Browser.onHWMiniGame||Browser.onTTMiniGame||Browser.onTBMiniGame)&&(e=HttpRequest._urlEncode(e)),this._url=e;let s=this._http;if(s.open(r,e,!0),t?"string"==typeof t?s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(s.setRequestHeader("Content-Type","application/json"),t instanceof ArrayBuffer||(t=JSON.stringify(t))):Browser.onBLMiniGame&&Browser.onAndroid&&(t={}),a)for(let e=0;e<a.length;e++)s.setRequestHeader(a[e++],a[e]);let n="arraybuffer"!==i?"text":"arraybuffer";s.responseType=n,s.dataType&&(s.dataType=n),s.onerror=e=>{this._onError(e)},s.onabort=e=>{this._onAbort(e)},s.onprogress=e=>{this._onProgress(e)},s.onload=e=>{this._onLoad(e)},s.send(t)}_onProgress(e){e&&e.lengthComputable&&this.event(Event.PROGRESS,e.loaded/e.total)}_onAbort(e){this.error("Request was aborted by user")}_onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(e){var t=this._http,r=void 0!==t.status?t.status:200;200===r||204===r||0===r?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}error(e){this.clear(),this.event(Event.ERROR,e)}complete(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new XML(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(Event.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}HttpRequest._urlEncode=encodeURI;class Downloader{constructor(){this.httpRequestPool=[]}common(e,t,r,i,a,s){let n=this.getRequestInst();n.on(Event.COMPLETE,(()=>{let e=n.data;this.returnRequestInst(n),s(e)})),n.on(Event.ERROR,null,(e=>{this.returnRequestInst(n),s(null,e)})),a&&n.on(Event.PROGRESS,a),n.send(t,null,"get",i),e.$ref=n}image(e,t,r,i,a){let s=new Browser.window.Image;s.crossOrigin="",s.onload=()=>{s.onload=null,s.onerror=null,a(s)},s.onerror=()=>{s.onload=null,s.onerror=null,a(null,"")},s.src=t,e.$ref=s}imageWithBlob(e,t,r,i,a){let s=ImgUtils.arrayBufferToURL(r,t);this.image(e,s,r,i,a)}imageWithWorker(e,t,r,i,a){WorkerLoader.enable=!0,WorkerLoader.enable?WorkerLoader.load(t,e.workerLoaderOptions).then((e=>{e?a(e):a(null,"workerloader failed!")})):this.image(e,t,r,i,a)}audio(e,t,r,i,a){let s=Browser.createElement("audio");s.crossOrigin="",s.oncanplaythrough=()=>{s.oncanplaythrough=null,s.onerror=null,a(s)},s.onerror=()=>{s.oncanplaythrough=null,s.onerror=null,a(null,"")},s.src=t,e.$ref=s}getRequestInst(){return 0==this.httpRequestPool.length||Browser.onVVMiniGame||Browser.onHWMiniGame?new HttpRequest:this.httpRequestPool.pop()}returnRequestInst(e){e.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(e)}}var de=0;const _e={ext:null,typeId:null,main:!1,loaderType:null};class Loader extends EventDispatcher{static registerLoader(e,t,r){let i;r?(i=Loader.typeMap[r],i?i.loaderType!=t&&(i={typeId:i.typeId,loaderType:t}):Loader.typeMap[r]=i={typeId:de++,loaderType:t}):i={typeId:de++,loaderType:t};for(let a of e){let e=Loader.extMap[a];if(e&&r){let r=e.findIndex((e=>e.typeId==i.typeId));-1==r?e.push(i):e[r].loaderType=t}else Loader.extMap[a]=[i]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(e,t,r,i,a,s,n,o,l){let h,u,d,_,c=me;if(t instanceof Handler?(h=t,u=i):"string"==typeof t?u=t:null!=t&&(u=t.type,c=t),null==a&&null==s&&null==n&&null==l||(c=c===me?{priority:a,cache:s,group:n,useWorkerLoader:l}:Object.assign(c,{priority:a,cache:s,group:n,useWorkerLoader:l})),d=r instanceof Handler?e=>r.runWith(e):r,Array.isArray(e)){let t;d&&(t=new BatchProgress(d));let r=[];for(let i=0;i<e.length;i++){let a=e[i];a&&("string"==typeof a?r.push(this._load1(a,u,c,null==t?void 0:t.createCallback())):r.push(this._load1(a.url,a.type||u,c!==me?Object.assign({},c,a):a,null==t?void 0:t.createCallback())))}_=Promise.all(r)}else _="string"==typeof e?this._load1(e,u,c,d):this._load1(e.url,e.type||u,c!==me?Object.assign({},c,e):e,d);return h?_.then((e=>(h.runWith(e),e))):_}_load1(e,t,r,i){if(LayaEnv.isPreview){if(e.startsWith("res://")){let a=e.substring(6);return AssetDb.inst.UUID_to_URL_async(a).then((s=>s?this._load2(s,a,t,r,i):(!r.silent&&Loader.warnFailed(e),Promise.resolve(null))))}return AssetDb.inst.URL_to_UUID_async(e).then((a=>this._load2(e,a,t,r,i)))}return this._load2(e,null,t,r,i)}_load2(e,t,r,i,a){let{ext:s,typeId:n,main:o,loaderType:l}=Loader.getURLInfo(e,r);if(!l)return!i.silent&&Loader.warnFailed(e),Promise.resolve(null);let h,u=URL.formatURL(e);if(i.group){let e=Loader.groupMap[i.group];e||(e=Loader.groupMap[i.group]=new Set),e.add(u)}if(null==i.cache||i.cache){let e=Loader._getRes(u,r);if(void 0!==e){if(null==e)return Promise.resolve(null);if(!(e instanceof Resource))return Promise.resolve(e);if(e.obsolute&&(h=e),!(h||e.uuid&&t&&t!=e.uuid))return Promise.resolve(e)}}let d=u;o||(d+="@"+n);let _=this._loadings.get(d);if(_)return a&&_.onProgress.add(a),new Promise((e=>_.onComplete.add(e)));let c=AtlasInfoManager.getFileLoadPath(u);if(c)return this.load(c.url,{type:Loader.ATLAS,baseUrl:c.baseUrl}).then((()=>Loader.getRes(e,r)));_=ce.length>0?ce.pop():new LoadTask,_.type=r,_.url=e,_.uuid=t,_.ext=s,delete(i=Object.assign(_.options,i)).type,null==i.priority&&(i.priority=0),null==i.useWorkerLoader&&(i.useWorkerLoader=WorkerLoader.enable),a&&_.onProgress.add(a),_.loader=this,_.obsoluteInst=h;let m,p=new l;this._loadings.set(d,_);try{m=p.load(_)}catch(t){!i.silent&&Loader.warnFailed(e,t),m=Promise.resolve(null)}return m.then((r=>(r instanceof Resource&&r._setCreateURL(e,t),(null==_.options.cache||_.options.cache)&&Loader._cacheRes(u,r,n,o),_.progress.update(-1,1),_.onComplete.invoke(r),r))).catch((t=>(!i.silent&&Loader.warnFailed(e,t),(null==_.options.cache||_.options.cache)&&Loader._cacheRes(u,null,n,o),_.onComplete.invoke(null),null))).then((e=>(this._loadings.delete(d),_.reset(),ce.push(_),0==this._loadings.size&&this.event(Event.COMPLETE),e)))}fetch(e,t,r,i){var a;let s={originalUrl:e,url:e,contentType:t,priority:null!==(a=(i=i||me).priority)&&void 0!==a?a:1,retryCnt:0,onProgress:r,onComplete:null};return i.useWorkerLoader&&(s.useWorkerLoader=!0,s.workerLoaderOptions=i.workerLoaderOptions),i.blob&&(s.blob=i.blob),i.noRetry&&(s.retryCnt=-1),i.silent&&(s.silent=!0),AssetDb.inst.resolveURL(e).then((e=>new Promise((t=>{s.url=URL.formatURL(e),s.onComplete=t,this.queueToDownload(s)}))))}queueToDownload(e){if(this._downloadings.size<this.maxLoader)return void this.download(e);let t=e.priority;if(0==t)this._queue.push(e);else{let r=this._queue.findIndex((e=>e.priority<t));-1!=r?this._queue.splice(r,0,e):this._queue.push(e)}}download(e){this._downloadings.add(e);let t=URL.postFormatURL(e.url);if("image"==e.contentType){let r=Loader.preLoadedMap[e.url];if(r){if(!(r instanceof ArrayBuffer))return void this.completeItem(e,r);e.blob=r}e.blob?Loader.downloader.imageWithBlob(e,e.blob,e.originalUrl,e.onProgress,((t,r)=>{t||(e.retryCnt=-1),this.completeItem(e,t,r)})):e.useWorkerLoader?Loader.downloader.imageWithWorker(e,t,e.originalUrl,e.onProgress,((t,r)=>{t||(e.useWorkerLoader=!1),this.completeItem(e,t,r)})):Loader.downloader.image(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}else if("sound"==e.contentType)Loader.downloader.audio(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)));else{let r=Loader.preLoadedMap[e.url];if(r)return void this.completeItem(e,r);Loader.downloader.common(e,t,e.originalUrl,e.contentType,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}}completeItem(e,t,r){this._downloadings.delete(e),t?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onProgress&&e.onProgress(1),e.onComplete(t)):-1!=e.retryCnt&&e.retryCnt<this.retryNum?(e.retryCnt++,e.silent||console.debug(`Retry to load ${e.url} (${e.retryCnt})`),ILaya.systemTimer.once(this.retryDelay,this,this.queueToDownload,[e],!1)):(!e.silent&&Loader.warnFailed(e.url),e.onProgress&&e.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onComplete(null))}static getURLInfo(e,t){let r,i,a,s,n=e.startsWith("data:")?"png":Utils.getFileExtension(e);if(n.length>0&&(r=Loader.extMap[n]),t){let e=Loader.typeMap[t];if(!e)return Loader.warn(`not recognize type: '${t}'`),_e;i=e.typeId;let n=0;r?r[0].typeId===i||-1!=(n=r.findIndex((e=>e.typeId===i)))?(a=0==n,s=r[n].loaderType):(a=!1,s=e.loaderType):(a=t!=Loader.TEXTURE2D,s=e.loaderType)}else{if(!r)return Loader.warn(`not recognize the resource suffix: '${e}'`),_e;a=!0,i=r[0].typeId,s=r[0].loaderType}return{ext:n,main:a,typeId:i,loaderType:s}}static warnFailed(e,t){this.warn(`Failed to load ${e}`,t)}static warn(e,t){let r=t?t.stack?t.stack:t:"";r&&(r=": "+r),console.warn(e+r)}static getRes(e,t){return e=URL.formatURL(e),Loader._getRes(e,t)||null}static _getRes(e,t){let r,i=Loader.loadedMap[e];if(i){if(t){let e=Loader.typeMap[t];if(!e)return;if(2==i.length)i[0]==e.typeId&&(r=i[1]);else{let t=i.indexOf(e.typeId);-1!=t&&(r=i[t+1])}}else r=i[1];return r instanceof Resource&&r.destroyed?void 0:r}}static getTexture2D(e){return Loader.getRes(e,Loader.TEXTURE2D)}static getBaseTexture(e){return Loader.getRes(e,Loader.TEXTURE2D)}static getAtlas(e){return Loader.getRes(e,Loader.ATLAS)}getRes(e,t){return Loader.getRes(e,t)}static createNodes(e){var t;return null===(t=Loader.getRes(e))||void 0===t?void 0:t.create()}static cacheRes(e,t,r){e=URL.formatURL(e);let i=Loader.getURLInfo(e,r);null!=i.typeId&&Loader._cacheRes(e,t,i.typeId,i.main)}static _cacheRes(e,t,r,i){let a=Loader.loadedMap[e];if(i)a?(a[0]=r,a[1]=t):a=Loader.loadedMap[e]=[r,t];else if(a){let e=a.findIndex((e=>e===r));-1!=e?a[e+1]=t:a.push(r,t)}else a=Loader.loadedMap[e]=[null,void 0,r,t]}cacheRes(e,t,r){Loader.cacheRes(e,t,r)}static clearRes(e,t){e=URL.formatURL(e),Loader._clearRes(e,t)}clearRes(e,t){e=URL.formatURL(e),Loader._clearRes(e,t)}static _clearRes(e,t){let r=Loader.loadedMap[e];if(r)if(t){if(r[1]==t)2==r.length?delete Loader.loadedMap[e]:r[1]=void 0;else{let i=r.indexOf(t);if(-1==i)return;4==r.length&&null==r[0]?delete Loader.loadedMap[e]:r.splice(i-1,2)}t instanceof Resource&&!t.destroyed&&t.destroy()}else if(delete Loader.loadedMap[e],r.length>2)for(let e=1;e<r.length;e+=2){let t=r[e];t instanceof Resource&&!t.destroyed&&t.destroy()}else{let e=r[1];e instanceof Resource&&!e.destroyed&&e.destroy()}}clearTextureRes(e){e=URL.formatURL(e);let t=Loader.loadedMap[e];if(!t)return;let r=t[1];if(r instanceof Texture)r.disposeBitmap();else if(r instanceof AtlasResource)for(let e of r.textures)e.disposeBitmap()}static setGroup(e,t){e=URL.formatURL(e);let r=Loader.groupMap[t];r||(r=Loader.groupMap[t]=new Set),r.add(e)}static clearResByGroup(e){let t=Loader.groupMap[e];if(t)for(let e of t)Loader._clearRes(e)}clearUnLoaded(){if(0==this._queue.length)return;let e=this._queue.concat();this._queue.length=0;for(let t of e)t.onComplete(null)}cancelLoadByUrls(e){if(e)for(var t=0,r=e.length;t<r;t++)this.cancelLoadByUrl(e[t])}cancelLoadByUrl(e){e=URL.formatURL(e);let t=this._queue.findIndex((t=>t.url==e));if(-1!=t){let e=this._queue[t];this._queue.splice(t,1),e.onComplete(null)}}loadPackage(e,t,r){let i,a;if("string"==typeof t?(a=t,i=r):i=t,a){a.endsWith("/")||(a+="/");let t=e+"/";return URL.basePaths[t]=a,this._loadSubFileConfig(e,i)}{if(LayaEnv.isPreview)return Promise.resolve();let t=null;if(ILaya.Browser.onMiniGame)t=ILaya.Browser.window.wx;else if(ILaya.Browser.onTTMiniGame)t=ILaya.Browser.window.tt;else if(ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onQGMiniGame)t=ILaya.Browser.window.qg;else{if(!ILaya.Browser.onAlipayMiniGame)return this._loadSubFileConfig(e,i);t=ILaya.Browser.window.my}return this._loadMiniPackage(t,e,i).then((()=>this._loadSubFileConfig(e,i)))}}_loadMiniPackage(e,t,r){return t.length>0?new Promise(((i,a)=>{e.loadSubpackage({name:t,success:e=>{i(e)},fail:e=>{i(e)}}).onProgressUpdate((e=>{r&&r(e)}))})):Promise.resolve()}_loadSubFileConfig(e,t){return e.length>0&&(e+="/"),this.fetch(e+"fileconfig.json","json",t).then((e=>{let t=[],r=e.files;for(let e in r)if(e.length>0)for(let i of r[e])t.push(e+"/"+i);else for(let i of r[e])t.push(i);if(e.hash){let r=0;for(let i of e.hash)null!=i&&(URL.version[t[r]]=i),r++}for(let r of e.config){let e=t[r.i];switch(r.t){case 0:AssetDb.inst.metaMap[e]=r;break;case 1:AtlasInfoManager.addAtlas(e,r.prefix,r.frames);break;case 2:AssetDb.inst.shaderNameMap[r.shaderName]=e;break;case 3:Loader.preLoadedMap[URL.formatURL(e)]=r}}}))}}Loader.TEXT="text",Loader.JSON="json",Loader.XML="xml",Loader.BUFFER="arraybuffer",Loader.IMAGE="image",Loader.SOUND="sound",Loader.VIDEO="video",Loader.ATLAS="atlas",Loader.FONT="font",Loader.TTF="ttf",Loader.HIERARCHY="HIERARCHY",Loader.MESH="MESH",Loader.MATERIAL="MATERIAL",Loader.TEXTURE2D="TEXTURE2D",Loader.TEXTURECUBE="TEXTURE2D",Loader.ANIMATIONCLIP="ANIMATIONCLIP",Loader.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Loader.TERRAINRES="TERRAIN",Loader.SPINE="SPINE",Loader.extMap={},Loader.typeMap={},Loader.downloader=new Downloader,Loader.groupMap={},Loader.loadedMap={},Loader.preLoadedMap={};class LoadTask{constructor(){this.options={},this.onProgress=new Delegate,this.onComplete=new Delegate,this.progress=new BatchProgress((e=>this.onProgress.invoke(e)))}reset(){for(let e in this.options)delete this.options[e];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null}}const ce=[],me={};class MathUtil{static subtractVector3(e,t,r){r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2]}static lerp(e,t,r){return e*(1-r)+t*r}static scaleVector3(e,t,r){r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t}static lerpVector3(e,t,r,i){var a=e[0],s=e[1],n=e[2];i[0]=a+r*(t[0]-a),i[1]=s+r*(t[1]-s),i[2]=n+r*(t[2]-n)}static lerpVector4(e,t,r,i){var a=e[0],s=e[1],n=e[2],o=e[3];i[0]=a+r*(t[0]-a),i[1]=s+r*(t[1]-s),i[2]=n+r*(t[2]-n),i[3]=o+r*(t[3]-o)}static slerpQuaternionArray(e,t,r,i,a,s,n){var o,l,h,u,d,_=e[t+0],c=e[t+1],m=e[t+2],p=e[t+3],f=r[i+0],g=r[i+1],T=r[i+2],x=r[i+3];return(l=_*f+c*g+m*T+p*x)<0&&(l=-l,f=-f,g=-g,T=-T,x=-x),1-l>1e-6?(o=Math.acos(l),h=Math.sin(o),u=Math.sin((1-a)*o)/h,d=Math.sin(a*o)/h):(u=1-a,d=a),s[n+0]=u*_+d*f,s[n+1]=u*c+d*g,s[n+2]=u*m+d*T,s[n+3]=u*p+d*x,s}static getRotation(e,t,r,i){return Math.atan2(i-t,r-e)/Math.PI*180}static sortBigFirst(e,t){return e==t?0:t>e?1:-1}static sortSmallFirst(e,t){return e==t?0:t>e?-1:1}static sortNumBigFirst(e,t){return parseFloat(t)-parseFloat(e)}static sortNumSmallFirst(e,t){return parseFloat(e)-parseFloat(t)}static sortByKey(e,t=!1,r=!0){var i;return i=t?r?MathUtil.sortNumBigFirst:MathUtil.sortBigFirst:r?MathUtil.sortNumSmallFirst:MathUtil.sortSmallFirst,function(t,r){return i(t[e],r[e])}}}class FrameAnimation extends AnimationBase{static _sortIndexFun(e,t){return e.index-t.index}constructor(){super(),void 0===FrameAnimation._sortIndexFun&&(FrameAnimation._sortIndexFun=MathUtil.sortByKey("index",!1,!0))}_setUp(e,t){this._targetDic=e,this._animationData=t,this.interval=1e3/t.frameRate,t.parsed?(this._count=t.count,this._labels=t.labels,this._usedFrames=t.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),t.parsed=!0,t.labels=this._labels,t.count=this._count,t.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,i=r.length;for(t=0;t<i;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){r||(r=this._targetDic);var i=r[e.target];if(i){var a,s,n,o,l=e.frames,h=e.keys,u=h.length;for(o=0;o<u;o++)n=(s=l[a=h[o]]).length>t?s[t]:s[s.length-1],i[a]=n;var d,_=e.funkeys;if(0!=(u=_.length))for(o=0;o<u;o++)void 0!==(d=l[a=_[o]])[t]&&i[a]&&i[a].apply(i,d[t])}}_calculateDatas(){if(this._animationData){var e,t,r=this._animationData.nodes,i=r.length;for(this._count=0,e=0;e<i;e++)t=r[e],this._calculateKeyFrames(t);this._count+=1}}_calculateKeyFrames(e){var t,r,i=e.keyframes,a=e.target;for(t in e.frames||(e.frames={}),e.keys?e.keys.length=0:e.keys=[],e.funkeys?e.funkeys.length=0:e.funkeys=[],e.initValues||(e.initValues={}),i){var s=-1!=t.indexOf("()");if(r=i[t],s&&(t=t.substr(0,t.length-2)),e.frames[t]||(e.frames[t]=[]),s){e.funkeys.push(t);for(var n=e.frames[t],o=0;o<r.length;o++){var l=r[o];n[l.index]=l.value,l.index>this._count&&(this._count=l.index)}}else this._targetDic&&this._targetDic[a]&&(e.initValues[t]=this._targetDic[a][t]),r.sort(FrameAnimation._sortIndexFun),e.keys.push(t),this._calculateNodePropFrames(r,e.frames[t],t,a)}}resetNodes(){if(this._targetDic&&this._animationData){var e,t,r,i=this._animationData.nodes,a=i.length;for(e=0;e<a;e++)if(r=(t=i[e]).initValues){var s,n=this._targetDic[t.target];if(n)for(s in r)n[s]=r[s]}}}_calculateNodePropFrames(e,t,r,i){var a,s=e.length-1;for(t.length=e[s].index+1,a=0;a<s;a++)this._dealKeyFrame(e[a]),this._calculateFrameValues(e[a],e[a+1],t);0==s&&(t[0]=e[0].value,this._usedFrames&&(this._usedFrames[e[0].index]=!0)),this._dealKeyFrame(e[a])}_dealKeyFrame(e){e.label&&""!=e.label&&this.addLabel(e.label,e.index)}_calculateFrameValues(e,t,r){var i,a,s=e.index,n=t.index,o=e.value,l=t.value-e.value,h=n-s,u=this._usedFrames;if(n>this._count&&(this._count=n),e.tween)for(null==(a=Ease[e.tweenMethod])&&(a=Ease.linearNone),i=s;i<n;i++)r[i]=a(i-s,o,l,h),u&&(u[i]=!0);else for(i=s;i<n;i++)r[i]=o;u&&(u[e.index]=!0,u[t.index]=!0),r[t.index]=t.value}}class GraphicAnimation extends FrameAnimation{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(e){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[e.compId]=e.props,e.compId&&this._nodeList.push(e.compId);var t=e.child;if(t){var r,i=t.length;for(r=0;r<i;r++)this._parseNodeList(t[r])}}_calGraphicData(e){var t;if(this._setUp(null,e),this._createGraphicData(),this._nodeIDAniDic)for(t in this._nodeIDAniDic)this._nodeIDAniDic[t]=null}_createGraphicData(){var e,t,r=[],i=this.count,a=this._usedFrames;for(a||(a=[]),e=0;e<i;e++)!a[e]&&t||(t=this._createFrameGraphic(e)),r.push(t);this._gList=r}_createFrameGraphic(e){var t=new Graphics;return GraphicAnimation._rootMatrix||(GraphicAnimation._rootMatrix=new Matrix),this._updateNodeGraphic(this._rootNode,e,GraphicAnimation._rootMatrix,t),t}_updateNodeGraphic(e,t,r,i,a=1){var s,n,o;(s=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId])).resultTransform||(s.resultTransform=new Matrix),n=s.resultTransform,Matrix.mul(s.transform,r,n);var l=s.alpha*a;if(!(l<.01)){s.skin&&(o=this._getTextureByUrl(s.skin))&&(n._checkTransform()?(i.drawTexture(o,0,0,s.width,s.height,n,l),s.resultTransform=null):i.drawTexture(o,n.tx,n.ty,s.width,s.height,null,l));var h,u,d=e.child;if(d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic(d[h],t,n,i,l)}}_updateNoChilds(e,t){if(e.skin){var r=this._getTextureByUrl(e.skin);if(r){var i=e.transform;i._checkTransform(),!i._bTransform?t.drawTexture(r,i.tx,i.ty,e.width,e.height,null,e.alpha):t.drawTexture(r,0,0,e.width,e.height,i.clone(),e.alpha)}}}_updateNodeGraphic2(e,t,r){var i;if(i=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId]),e.child){var a,s,n,o=i.transform;o._checkTransform(),s=(a=!o._bTransform)&&(0!=o.tx||0!=o.ty),(n=o._bTransform||1!=i.alpha)&&r.save(),1!=i.alpha&&r.alpha(i.alpha),a?s&&r.translate(o.tx,o.ty):r.transform(o.clone());var l,h,u,d=e.child;if(i.skin&&(l=this._getTextureByUrl(i.skin))&&r.drawImage(l,0,0,i.width,i.height),d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic2(d[h],t,r);n?r.restore():a?s&&r.translate(-o.tx,-o.ty):r.transform(o.clone().invert())}else this._updateNoChilds(i,r)}_calculateKeyFrames(e){super._calculateKeyFrames(e),this._nodeIDAniDic[e.target]=e}getNodeDataByID(e){return this._nodeIDAniDic[e]}_getParams(e,t,r,i){var a=GraphicAnimation._temParam;a.length=t.length;var s,n=t.length;for(s=0;s<n;s++)a[s]=this._getObjVar(e,t[s][0],r,t[s][1],i);return a}_getObjVar(e,t,r,i,a){if(t in e){var s=e[t];return r>=s.length&&(r=s.length-1),e[t][r]}return t in a?a[t]:i}_getNodeGraphicData(e,t,r){r||(r=new GraphicNode),r.transform?r.transform.identity():r.transform=new Matrix;var i=this.getNodeDataByID(e);if(!i)return r;var a,s,n,o=i.frames,l=this._getParams(o,GraphicAnimation._drawTextureCmd,t,this._nodeDefaultProps[e]),h=l[0],u=l[5],d=l[6],_=l[13],c=l[14],m=l[7],p=l[8],f=l[9],g=l[11],T=l[12];a=l[3],s=l[4],0!=a&&0!=s||(h=null),-1==a&&(a=0),-1==s&&(s=0),r.skin=h,r.width=a,r.height=s,h&&((n=this._getTextureByUrl(h))?(a||(a=n.sourceWidth),s||(s=n.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),r.alpha=l[10];var x=r.transform;0!=_&&(u=_*a),0!=c&&(d=c*s),0==u&&0==d||x.translate(-u,-d);var S=null;if(f||1!==m||1!==p||g||T){(S=GraphicAnimation._tempMt).identity(),S._bTransform=!0;var y=.0174532922222222*(f-g),E=.0174532922222222*(f+T),C=Math.cos(E),v=Math.sin(E),R=Math.sin(y),b=Math.cos(y);S.a=m*C,S.b=m*v,S.c=-p*R,S.d=p*b,S.tx=S.ty=0}return S&&(x=Matrix.mul(x,S,x)),x.translate(l[1],l[2]),r}_getTextureByUrl(e){return Loader.getRes(e)}setAniData(e,t=null){if(e.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e);var r,i,a={},s=[],n=e.animations,o=n.length;for(r=0;r<o;r++)if(i=n[r],this._labels=null,(!t||t==i.name)&&i){try{this._calGraphicData(i)}catch(e){console.warn("parse animation fail:"+i.name+",empty animation created"),this._gList=[]}var l={};l.interval=1e3/i.frameRate,l.frames=this._gList,l.labels=this._labels,l.name=i.name,s.push(l),a[i.name]=l}this.animationList=s,this.animationDic=a}GraphicAnimation._temParam.length=0}parseByData(e){var t,r;t=e.nodeRoot,r=e.aniO,delete e.nodeRoot,delete e.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t),this._labels=null;try{this._calGraphicData(r)}catch(e){console.warn("parse animation fail:"+r.name+",empty animation created"),this._gList=[]}var i=e;return i.interval=1e3/r.frameRate,i.frames=this._gList,i.labels=this._labels,i.name=r.name,i}setUpAniData(e){if(e.animations){var t,r,i={},a=[],s=e.animations,n=s.length;for(t=0;t<n;t++)if(r=s[t]){var o={};o.name=r.name,o.aniO=r,o.nodeRoot=e,a.push(o),i[r.name]=o}this.animationList=a,this.animationDic=i}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),t=GraphicAnimation._I.parseByData(e),GraphicAnimation._I._clear(),t}static parseAnimationData(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),GraphicAnimation._I.setUpAniData(e),(t={}).animationList=GraphicAnimation._I.animationList,t.animationDic=GraphicAnimation._I.animationDic,GraphicAnimation._I._clear(),t}}GraphicAnimation._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],GraphicAnimation._temParam=[],GraphicAnimation._tempMt=new Matrix;class GraphicNode{constructor(){this.alpha=1}}class Animation extends AnimationBase{constructor(){super(),this._autoPlay=!1,this._setControlNode(this)}destroy(e=!0){this.stop(),super.destroy(e),this._frames=null,this._labels=null}play(e=0,t=!0,r=""){r&&this._setFramesFromCache(r,!0),super.play(e,t,r)}_setFramesFromCache(e,t=!1){if(this._url&&(e=this._url+"#"+e),e&&Animation.framesMap[e]){var r=Animation.framesMap[e];return r instanceof Array?(this._frames=Animation.framesMap[e],this._count=this._frames.length):(r.nodeRoot&&(Animation.framesMap[e]=GraphicAnimation.parseAnimationByData(r),r=Animation.framesMap[e]),this._frames=r.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=r.interval),this._labels=this._copyLabels(r.labels)),!0}return t&&console.log("ani not found:",e),!1}_copyLabels(e){if(!e)return null;var t,r;for(r in t={},e)t[r]=Utils.copyArray([],e[r]);return t}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(e){this._frames&&(this.graphics=this._frames[e])}get frames(){return this._frames}set frames(e){this._frames=e,e&&(this._count=e.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}get source(){return this._source}set source(e){this._source=e,e?e.indexOf(".ani")>-1?this.loadAnimation(e):e.startsWith("res://")||e.indexOf(".json")>-1||e.indexOf("als")>-1||e.indexOf("atlas")>-1?this.loadAtlas(e):this.loadImages(e.split(",")):this.clear()}set autoPlay(e){this._autoPlay=e,e?this.play():this.stop()}get autoPlay(){return this._autoPlay}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(e,t=""){return this._url="",this._setFramesFromCache(t)||(this.frames=Animation.framesMap[t]?Animation.framesMap[t]:Animation.createFrames(e,t)),!this._isPlaying&&this._autoPlay&&this.play(),this}loadAtlas(e,t=null,r=""){if(this._url="",!this._setFramesFromCache(r)){let onLoaded=i=>{e===i&&(this.frames=Animation.framesMap[r]?Animation.framesMap[r]:Animation.createFrames(e,r),!this._isPlaying&&this._autoPlay&&this.play(),t&&t.run())};Loader.getAtlas(e)?onLoaded(e):ILaya.loader.load(e,Handler.create(null,onLoaded,[e]),null,Loader.ATLAS)}return this}loadAnimation(e,t=null,r=null){this._url=e;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,t&&t.run()):!r||Loader.getAtlas(r)?this._loadAnimationData(e,t,r):ILaya.loader.load(r,Handler.create(this,this._loadAnimationData,[e,t,r]),null,Loader.ATLAS),this}_loadAnimationData(e,t=null,r=null){!r||Loader.getAtlas(r)?ILaya.loader.fetch(e,"json").then((r=>{if(this._url!==e)return;if(!r)return void(Animation.framesMap[e+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),t&&t.run()));let i;if(Animation.framesMap[e+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let t=GraphicAnimation.parseAnimationData(r);if(!t)return;let a,s=t.animationList,n=s.length;for(let t=0;t<n;t++)i=s[t],Animation.framesMap[e+"#"+i.name]=i,a||(a=i);a&&(Animation.framesMap[e+"#"]=a,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}t&&t.run()})):console.warn("atlas load fail:"+r)}static createFrames(e,t){var r;if("string"==typeof e){var i=Loader.getAtlas(e);if(i&&i.frames.length){let e=i.frames;r=[];for(var a=0,s=e.length;a<s;a++){var n=new Graphics;n.drawImage(e[a],0,0),r.push(n)}}}else if(e instanceof Array)for(r=[],a=0,s=e.length;a<s;a++)(n=new Graphics).loadImage(e[a],0,0),r.push(n);return t&&(Animation.framesMap[t]=r),r}static clearCache(e){var t,r=Animation.framesMap,i=e+"#";for(t in r)t!==e&&0!==t.indexOf(i)||delete Animation.framesMap[t]}onAfterDeserialize(){super.onAfterDeserialize(),this.images&&(this._source||this.loadImages(this.images),delete this.images)}}Animation.framesMap={};class BitmapFont extends Resource{static loadFont(e,t){ILaya.loader.load(e,Loader.FONT).then((e=>{t&&t.runWith(e)}))}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(e,t){var r;if(null==e||null==t)return;this.texture=t,t._addReference();let i=e.getNode("info");this.fontSize=i.getAttrInt("size",12),this.autoScaleSize=i.getAttrBool("autoScaleSize"),this.lineHeight=i.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let a=i.getAttrString("padding","").split(",");this.padding=[parseInt(a[0]),parseInt(a[1]),parseInt(a[2]),parseInt(a[3])];let s=(null===(r=e.getNode("chars"))||void 0===r?void 0:r.elements("char"))||[],n=0,o=this.dict;for(let e=0,r=s.length;e<r;e++){let r=s[e],i=r.getAttrInt("id"),a=r.getAttrInt("xoffset")/1,l=r.getAttrInt("yoffset")/1,h=r.getAttrInt("xadvance")/1,u=r.getAttrInt("x"),d=r.getAttrInt("y"),_=r.getAttrInt("width"),c=r.getAttrInt("height"),m=Texture.create(t,u,d,_,c,a,l);0==h&&(h=_),h+=this.letterSpacing,n=Math.max(n,h),o[i]={x:0,y:0,width:_,height:c,advance:h,texture:m}}this.maxWidth=n>0?n:this.fontSize,o[32]||(o[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var e;if(this.texture){for(let t in this.dict)null===(e=this.dict[t].texture)||void 0===e||e.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(e,t){let r=0;for(let i=0,a=e.length;i<a;i++){let a=this.dict[e.charCodeAt(i)];if(a){let e=this.autoScaleSize?t/this.fontSize:1;r+=Math.round(a.advance*e)}}return r}getMaxWidth(e){return null!=e&&this.autoScaleSize?Math.round(this.maxWidth*(e/this.fontSize)):this.maxWidth}getMaxHeight(e){return null!=e&&this.autoScaleSize?Math.round(this.lineHeight*(e/this.fontSize)):this.lineHeight}}class EffectAnimation extends FrameAnimation{constructor(){super(...arguments),this._initData={}}set target(e){this._target&&this._target.off(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._target=e,this._target&&this._target.on(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}get target(){return this._target}_onOtherBegin(e){e!==this&&this.stop()}set playEvent(e){this._playEvent=e,e&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(e=0,t=!0,r=""){this._target&&(this._target.event(EffectAnimation.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(e,t,r))}_recordInitData(){var e,t,r;if(this._aniKeys)for(t=this._aniKeys.length,e=0;e<t;e++)r=this._aniKeys[e],this._initData[r]=this._target[r]}set effectClass(e){if(this._effectClass=ClassUtils.getClass(e),this._effectClass){var t=this._effectClass.uiView;if(t){var r=t.animations;if(r&&r[0]){var i=r[0];this._setUp({},i),i.nodes&&i.nodes[0]&&(this._aniKeys=i.nodes[0].keys)}}}}set effectData(e){if(e){var t=e.animations;if(t&&t[0]){var r=t[0];this._setUp({},r),r.nodes&&r.nodes[0]&&(this._aniKeys=r.nodes[0].keys)}}}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,i=r.length;for(i=i>1?1:i,t=0;t<i;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){if(this._target){var i,a,s,n,o,l,h,u,d,_=this._target,c=e.frames,m=e.keys,p=m.length,f=e.secondFrames;for(n=0;n<p;n++)a=c[i=m[n]],-1==(o=f[i])?s=this._initData[i]:t<o?(u=(h=e.keyframes[i])[0]).tween?(null==(l=Ease[u.tweenMethod])&&(l=Ease.linearNone),d=h[1],s=l(t,this._initData[i],d.value-this._initData[i],d.index)):s=this._initData[i]:s=a.length>t?a[t]:a[a.length-1],_[i]=s}}_calculateKeyFrames(e){super._calculateKeyFrames(e);var t,r,i=e.keyframes;e.target;var a={};for(t in e.secondFrames=a,i)(r=i[t]).length<=1?a[t]=-1:a[t]=r[1].index}}EffectAnimation.EFFECT_BEGIN="effectbegin";class TextStyle{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var pe;e.HtmlElementType=void 0,(pe=e.HtmlElementType||(e.HtmlElementType={}))[pe.Text=0]="Text",pe[pe.Link=1]="Link",pe[pe.Image=2]="Image",pe[pe.Input=3]="Input",pe[pe.Select=4]="Select",pe[pe.Object=5]="Object",pe[pe.LinkEnd=6]="LinkEnd";class HtmlElement{constructor(){this.style=new TextStyle}getAttr(e){return null==this._attrs?null:this._attrs[e]}setAttr(e,t){null==this._attrs&&(this._attrs={}),this._attrs[e]=t}getAttrString(e,t){return XMLUtils.getString(this._attrs,e,t)}getAttrInt(e,t){return XMLUtils.getInt(this._attrs,e,t)}getAttrFloat(e,t){return XMLUtils.getFloat(this._attrs,e,t)}getAttrBool(e,t){return XMLUtils.getBool(this._attrs,e,t)}fetchAttributes(){this._attrs=Object.assign({},XMLIterator.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),Pool.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(t){let r;return r=this.pool.length>0?this.pool.pop():new HtmlElement,r.type=t,r.type==e.HtmlElementType.Text||r._attrs||(r._attrs={}),r}static returnToPool(e){if(Array.isArray(e)){for(let t of e)t.reset();this.pool.push(...e),e.length=0}else e.reset(),this.pool.push(e)}}HtmlElement.pool=[];class HtmlImage{constructor(){this.obj=new Sprite}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this.obj);let r=this._element.getAttrString("src");this.loadTexture(r)}loadTexture(e){let t=this._element.getAttrInt("width",-1),r=this._element.getAttrInt("height",-1);-1!=t&&(this.obj.width=t),-1!=r&&(this.obj.height=r);let i=Loader.getRes(e);i?(this.obj.texture=i,-1==t&&(this.obj.width=i.sourceWidth),-1==r&&(this.obj.height=i.sourceHeight)):ILaya.loader.load(e,{silent:!0}).then((e=>{let i=this.obj.width,a=this.obj.height;this.obj.texture=e,-1==t&&(this.obj.width=e?e.sourceWidth:0),-1==r&&(this.obj.height=e?e.sourceHeight:0),!this._owner||i==this.obj.width&&a==this.obj.height||this._owner.refreshLayout()}))}pos(e,t){this.obj.pos(e,t)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null}destroy(){this.obj.destroy()}}class HtmlLink{constructor(){this._shape=new Sprite,this._shape.hitArea=this,this._shape.on(Event.CLICK,(()=>{this._owner.bubbleEvent(Event.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(e,t,r,i){let a=this._rects[this._rectCnt];a||(a=this._rects[this._rectCnt]=new Rectangle),this._rectCnt++,a.setTo(e,t,r,i)}contains(e,t){for(let r=0;r<this._rectCnt;r++)if(this._rects[r].contains(e,t))return!0;return!1}pos(e,t){}release(){this._shape.removeSelf(),this._shape.offAll(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class HtmlParseOptions{constructor(){this.linkUnderline=HtmlParseOptions.defaultLinkUnderline,this.linkColor=HtmlParseOptions.defaultLinkColor}}HtmlParseOptions.defaultLinkUnderline=!0,HtmlParseOptions.defaultLinkColor=null,ClassUtils.regClass("HtmlParseOptions",HtmlParseOptions);const fe=new Array,ge=new Array;class HtmlParser{constructor(){this._styleStack=new Array,this._style=new TextStyle,this._options=new HtmlParseOptions}parse(t,r,i,a){null==a&&(a=this._options),this._elements=i,this._styleStackTop=0,Object.assign(this._style,r),this._style.colorChanged=!1;let s,n=0,o=a.ignoreWhiteSpace,l=!1;for(XMLIterator.begin(t,!0);XMLIterator.nextTag();)switch(0==n&&(s=XMLIterator.getText(o),s.length>0&&(l&&"\n"==s[0]&&(s=s.substring(1)),this.appendText(s))),l=!1,XMLIterator.tagName){case"b":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(XMLIterator.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.fontSize=XMLUtils.getInt(XMLIterator.attributes,"size",this._style.fontSize);let e=XMLIterator.getAttribute("color");null!=e&&(this._style.color=e,this._style.colorChanged=!0)}else XMLIterator.tagType==e.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t=HtmlElement.getFromPool(e.HtmlElementType.Image);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,t.style.underline=this._style.underline,t.style.underlineColor=this._style.underlineColor,this._elements.push(t)}break;case"a":if(XMLIterator.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||a.linkUnderline,this._style.colorChanged||null==a.linkColor||(this._style.color=a.linkColor);let t=HtmlElement.getFromPool(e.HtmlElementType.Link);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,this._elements.push(t)}else if(XMLIterator.tagType==e.XMLTagType.End){this.popStyle();let t=HtmlElement.getFromPool(e.HtmlElementType.LinkEnd);this._elements.push(t)}break;case"input":{let t=HtmlElement.getFromPool(e.HtmlElementType.Input);t.fetchAttributes(),t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"select":if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t=HtmlElement.getFromPool(e.HtmlElementType.Select);if(t.fetchAttributes(),XMLIterator.tagType==e.XMLTagType.Start){for(fe.length=0,ge.length=0;XMLIterator.nextTag()&&"select"!=XMLIterator.tagName;)"option"==XMLIterator.tagName&&(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void?ge.push(XMLUtils.getString(XMLIterator.attributes,"value","")):fe.push(XMLIterator.getText()));t.setAttr("items",fe.slice()),t.setAttr("values",ge.slice())}t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"p":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.align=XMLIterator.getAttribute("align"),this.isNewLine()||this.appendText("\n")):XMLIterator.tagType==e.XMLTagType.End&&(this.appendText("\n"),l=!0,this.popStyle());break;case"ui":case"div":case"li":XMLIterator.tagType==e.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),l=!0);break;case"html":case"body":o=!0;break;case"head":case"style":case"script":case"form":XMLIterator.tagType==e.XMLTagType.Start?n++:XMLIterator.tagType==e.XMLTagType.End&&n--}0==n&&(s=XMLIterator.getText(o),s.length>0&&(l&&"\n"==s[0]&&(s=s.substring(1)),this.appendText(s))),this._elements=null}pushStyle(){let e;this._styleStack.length<=this._styleStackTop?(e=new TextStyle,this._styleStack.push(e)):e=this._styleStack[this._styleStackTop],Object.assign(e,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let e=this._styleStack[this._styleStackTop-1];Object.assign(this._style,e),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let t=this._elements[this._elements.length-1];return!(!t||t.type!=e.HtmlElementType.Text)&&t.text.endsWith("\n")}return!0}appendText(t){let r;this._elements.length>0&&(r=this._elements[this._elements.length-1],r.type==e.HtmlElementType.Text&&function(e,t){for(let r in e)if(!r.startsWith("_")&&e[r]!=t[r])return!1;return!0}(r.style,this._style))?r.text+=t:(r=HtmlElement.getFromPool(e.HtmlElementType.Text),r.text=t,Object.assign(r.style,this._style),this._elements.push(r))}}HtmlParser.defaultParser=new HtmlParser,HtmlParser.classMap={[e.HtmlElementType.Image]:HtmlImage,[e.HtmlElementType.Link]:HtmlLink};class UBBParser{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(e,t,r){return t?"</a>":null!=r?'<a href="'+r+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(e,t,r){if(t)return null;var i=this.getTagText(!0);return i?this.defaultImgWidth?'<img src="'+i+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+i+'"/>':null}onTag_B(e,t,r){return t?"</b>":"<b>"}onTag_I(e,t,r){return t?"</i>":"<i>"}onTag_U(e,t,r){return t?"</u>":"<u>"}onTag_Simple(e,t,r){return t?"</"+e+">":"<"+e+">"}onTag_COLOR(e,t,r){return t?"</font>":(this.lastColor=r,'<font color="'+r+'">')}onTag_FONT(e,t,r){return t?"</font>":'<font face="'+r+'">'}onTag_SIZE(e,t,r){return t?"</font>":(this.lastSize=r,'<font size="'+r+'">')}getTagText(e){for(var t,r=this._readPos,i="";-1!=(t=this._text.indexOf("[",r));){if(92!=this._text.charCodeAt(t-1)){i+=this._text.substring(r,t);break}i+=this._text.substring(r,t-1),i+="[",r=t+1}return-1==t?null:(e&&(this._readPos=t),i)}parse(e,t){this._text=e,this.lastColor=null,this.lastSize=null;for(var r,i,a,s,n,o,l,h=0,u="";-1!=(r=e.indexOf("[",h));)if(r>0&&92==e.charCodeAt(r-1))u+=e.substring(h,r-1),u+="[",h=r+1;else{if(u+=e.substring(h,r),h=r,-1==(r=e.indexOf("]",h)))break;a="/"==e.charAt(h+1),s=e.substring(a?h+2:h+1,r),this._readPos=r+1,n=null,o=null,-1!=(i=s.indexOf("="))&&(n=s.substring(i+1),s=s.substring(0,i)),s=s.toLowerCase(),null!=(l=this._handlers[s])?t||null!=(o=l.call(this,s,a,n))&&(u+=o):u+=e.substring(h,this._readPos),h=this._readPos}return h<e.length&&(u+=e.substring(h)),this._text=null,u}}UBBParser.defaultParser=new UBBParser;class Text extends Sprite{constructor(){super(),this._overflow=Text.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new TextStyle,this._textStyle.fontSize=Config.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(e,t){t._addReference(),Text._bitmapFonts[e]=t}static unregisterBitmapFont(e,t=!0){let r=Text._bitmapFonts[e];r&&(r._removeReference(),t&&r.destroy(),delete Text._bitmapFonts[e])}destroy(e=!0){super.destroy(e),recoverLines(this._lines),HtmlElement.returnToPool(this._elements)}_getBoundPointsM(e=!1){var t=Rectangle.TEMP;return t.setTo(0,0,this.width,this.height),t._getBoundPoints()}getGraphicBounds(e=!1){var t=Rectangle.TEMP;return t.setTo(0,0,this.width,this.height),t}get_width(){return this._isWidthSet?this._width:this.textWidth}_setWidth(e){super._setWidth(e),this._updatingLayout?this.drawBg():this.markChanged()}get_height(){return this._isHeightSet?this._height:this.textHeight}_setHeight(e){super._setHeight(e),this._updatingLayout?this.drawBg():this.markChanged()}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),!this.ignoreLang&&Text.langPacks&&(e=Text.langPacks[e]||e),this._text!=e&&(this._text=e,this.markChanged(),this.event(Event.CHANGE))}changeText(e){this.text=e}get font(){return this._textStyle.font}set font(e){if(this._textStyle.font=e,e||(e=Config.defaultFont)||(e="Arial"),this._realFont=e,this._bitmapFont=Text._bitmapFonts[e],this._bitmapFont)this._text&&this.markChanged();else if(e&&(Utils.getFileExtension(e)||e.startsWith("res://"))){let t=e;ILaya.loader.load(e).then((e=>{e&&this._realFont==t&&(e instanceof BitmapFont?this._bitmapFont=e:this._realFont=e.family,this._text&&this.markChanged())}))}else this._realFont=ILaya.Browser.onIPhone&&Config.fontFamilyMap[e]||e,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(e){this._textStyle.fontSize!=e&&(this._textStyle.fontSize=e,this.markChanged())}get color(){return this._textStyle.color}set color(e){this.set_color(e)}set_color(e){this._textStyle.color!=e&&(this._textStyle.color=e,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(e){this._textStyle.bold!=e&&(this._textStyle.bold=e,this.markChanged())}get italic(){return this._textStyle.italic}set italic(e){this._textStyle.italic!=e&&(this._textStyle.italic=e,this.markChanged())}get align(){return this._textStyle.align}set align(e){this._textStyle.align!=e&&(this._textStyle.align=e,this.markChanged())}get valign(){return this._textStyle.valign}set valign(e){this._textStyle.valign!=e&&(this._textStyle.valign=e,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!=e&&(this._wordWrap=e,this.markChanged())}get leading(){return this._textStyle.leading}set leading(e){this._textStyle.leading!=e&&(this._textStyle.leading=e,this.markChanged())}get padding(){return this._padding}set padding(e){if("string"==typeof e){let t=e.split(",");this._padding.length=0;for(let e=0;e<4;e++){let r=parseFloat(t[e]);isNaN(r)&&(r=0),this._padding.push(r)}}else this._padding=e;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor=e,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(e){this._textStyle.stroke!=e&&(this._textStyle.stroke=e,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(e){this._textStyle.strokeColor!=e&&(this._textStyle.strokeColor=e,this.markChanged())}get overflow(){return this._overflow}set overflow(e){this._overflow!=e&&(this._overflow=e,this.markChanged())}get underline(){return this._textStyle.underline}set underline(e){this._textStyle.underline!=e&&(this._textStyle.underline=e,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(e){this._textStyle.underlineColor!=e&&(this._textStyle.underlineColor=e,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(e){this._singleCharRender=e}get html(){return this._html}set html(e){this._html!=e&&(this._html=e,this.markChanged())}get ubb(){return this._ubb}set ubb(e){this._ubb!=e&&(this._ubb=e,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!=e&&(this._maxWidth=e,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(e){this._htmlParseOptions=e}parseTemplate(e){let t,r,i,a,s=0,n="";for(;-1!=(t=e.indexOf("{",s));)if(t>0&&92==e.charCodeAt(t-1))n+=e.substring(s,t-1),n+="{",s=t+1;else{if(n+=e.substring(s,t),s=t,t=e.indexOf("}",s),-1==t)break;t!=s+1?(i=e.substring(s+1,t),r=i.indexOf("="),-1!=r?(a=this._templateVars[i.substring(0,r)],n+=null==a?i.substring(r+1):a):(a=this._templateVars[i],null!=a&&(n+=a)),s=t+1):(n+=e.substring(s,s+2),s=t+1)}return s<e.length&&(n+=e.substring(s)),n}get templateVars(){return this._templateVars}set templateVars(e){(this._templateVars||e)&&(this._templateVars=!0===e?{}:!1===e?null:e,this.markChanged())}setVar(e,t){return this._templateVars||(this._templateVars={}),this._templateVars[e]=t,this.markChanged(),this}set scrollX(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollX;e=(e=e<0?0:e)>t?t:e,this._scrollPos.x=e,this.renderText()}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollY(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollY;e=(e=e<0?0:e)>t?t:e,this._scrollPos.y=e,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}get maxScrollX(){let e=this.textWidth-this._width;return e<0?0:e}get maxScrollY(){let e=this.textHeight-this._height;return e<0?0:e}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,ILaya.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&ILaya.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){ILaya.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new Sprite,this._objContainer.hideFlags|=HideFlags.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;HtmlElement.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let t,r=this._text;if(!r&&this._prompt&&(r=this._prompt,t=!0),!r)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let i,a=this._html;if(r=r.replace(Ee,"\n"),this._parseEscapeChars&&(r=r.replace(Ce,getReplaceStr)),!t&&this._templateVars&&(r=this.parseTemplate(r)),this._ubb&&(r=UBBParser.defaultParser.parse(r),a=!0),!t&&this._asPassword&&(r=Text._passwordChar.repeat(r.length)),t&&(i=this._textStyle.color,this._textStyle.color=this._promptColor),a)HtmlParser.defaultParser.parse(r,this._textStyle,this._elements,this._htmlParseOptions);else{let t=HtmlElement.getFromPool(e.HtmlElementType.Text);Object.assign(t.style,this._textStyle),t.text=r,this._elements.push(t)}t&&(this._textStyle.color=i),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let t,r=this._wordWrap||this._overflow==Text.ELLIPSIS,i=this._padding;t=this._isWidthSet?this._width-i[3]-i[1]:Number.MAX_VALUE,this._maxWidth>0&&((!r||this._maxWidth<t)&&(t=this._maxWidth),r=!0);let a,s,n,o,l,h,u,d=this._isHeightSet?this._height-i[0]-i[2]:Number.MAX_VALUE,_=this._bitmapFont,getTextWidth=e=>{if(_)return _.getTextWidth(e,u);if(LayaEnv.isConch)return window.conchTextCanvas.measureText(e).width;{let t=ILaya.Browser.context.measureText(e);return t?t.width:100}},buildLines=(e,t)=>{if(_)l=_.getMaxWidth(u),h=_.getMaxHeight(u);else{let e,r=(t.italic?"italic ":"")+(t.bold?"bold ":"")+u+"px "+this._realFont;t._ctxFont=r,LayaEnv.isConch?(window.conchTextCanvas.font=r,e=window.conchTextCanvas.measureText(Text._testWord)):(ILaya.Browser.context.font=r,e=ILaya.Browser.context.measureText(Text._testWord)),e?(l=e.width,h=Math.ceil(e.height||u)):(l=100,h=u)}let i=e.split("\n");if(r)for(let e=0,r=i.length;e<r;e++){let a=i[e];a.length>0&&wrapText(a,t),e!=r-1&&(endLine(),startLine())}else for(let e=0,r=i.length;e<r;e++){let a=i[e];a.length>0&&addCmd(a,t,null),e!=r-1&&(endLine(),startLine())}},addCmd=(e,t,r)=>{let i=Te.length>0?Te.pop():{};i.x=a,i.y=s,"string"==typeof e?(r||(r=getTextWidth(e)),i.wt||(i.wt=new WordText),i.wt.setText(e),i.wt.width=r,i.wt.splitRender=this._singleCharRender,i.width=r,i.height=h):(i.obj=e,i.x++,i.width=e.width+2,i.height=e.height),i.style=t,i.linkEnd=!1,i.next=null,a+=Math.round(i.width),n.cmd?o.next=i:n.cmd=i,o=i},endLine=()=>{let e=0,t=n.cmd;for(;t;)t.height>e&&(e=t.height),t=t.next;for(t=n.cmd;t;)t.y=Math.floor(.5*(e-t.height)),t=t.next;0==e&&(e=h),e++,n.height=e,n.width=a},startLine=()=>(a=0,n&&(s+=n.height+Math.floor(this._textStyle.leading*this._fontSizeScale)),n=xe.length>0?xe.pop():{cmds:[]},n.x=0,n.y=s,this._lines.push(n),n),wrapText=(e,r)=>{let i=Math.max(0,t-a),s=getTextWidth(e);if(s<=i)return void addCmd(e,r,s);let n=0,o=0,h=0,u=testEmoji(e);_||u||(n=Math.floor(i/l),0==n&&(n=1),o=getTextWidth(e.substring(0,n)),i<o&&0!=a&&(endLine(),startLine(),i=t));let d=e.length;for(let l=n;l<d;l++){s=getTextWidth(e.charAt(l)),o+=s;let _=!1;if(u&&l+1<d&&testEmoji(e.charAt(l)+e.charAt(l+1))&&(o+=s>>1,l++,_=!0),o>i){if(_&&(o==s+(s>>1)?l++:l--),0==l){a>0&&(endLine(),startLine(),i=t);continue}let u=e.substring(h,l);o-=s;let c=u.charCodeAt(u.length-1);if(c<19968||c>40869){let t=ye.exec(u);t&&(l=t.index+h,0==t.index?l+=u.length:(o=null,u=e.substring(h,l-1)))}if(addCmd(u,r,o),endLine(),startLine(),i=t,h=l,!(l+n<d)){addCmd(e.substring(h,d),r),h=-1;break}0!=n?(l+=n,s=getTextWidth(e.substring(h,l)),o=s,l--):o=0}}-1!=h&&addCmd(e.substring(h,d),r)},calcTextSize=()=>{let e=0,t=0;for(let t of this._lines)t.width>e&&(e=t.width);e>0&&(e+=i[1]+i[3]),this._textWidth=e;let r=this._lines[this._lines.length-1];r&&(t=r.y+r.height),t>0&&(t+=i[0]+i[2]),this._textHeight=t},run=()=>{a=s=l=h=0,n=null,o=null,recoverLines(this._lines),startLine();let i=this._elements;for(let s=0,n=i.length;s<n;s++){let n=i[s];if(n.type==e.HtmlElementType.Text)u=Math.floor(n.style.fontSize*this._fontSizeScale),0==u&&(u=1),buildLines(n.text,n.style);else if(n.type==e.HtmlElementType.LinkEnd)o&&(o.linkEnd=!0);else{let e=n.obj;if(!e){let t=HtmlParser.classMap[n.type];t&&(e=Pool.createByClass(t),e.create(this,n),n.obj=e)}if(e){if(r){t-a<e.width+1&&a>0&&(endLine(),startLine())}addCmd(e,n.style)}}}endLine(),calcTextSize()};if(run(),this._overflow==Text.SHRINK){if(this._lines.length>1&&this._textHeight>d){let e=0,r=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(d/this._textHeight);let i=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;run(),this._textWidth>t||this._textHeight>d?r=i:e=i,r-e>1||r!=e&&i==r;)i=e+(r-e)/2,this._fontSizeScale=i/this._textStyle.fontSize}else if(this._textWidth>t&&(this._fontSizeScale=t/this._textWidth,run(),this._textWidth>t)){let e=Math.floor(this._textStyle.fontSize*this._fontSizeScale);e--,this._fontSizeScale=e/this._textStyle.fontSize,run()}}else if(this._overflow==Text.ELLIPSIS&&(this._textWidth>t||this._textHeight>d)){let e=this._lines.findIndex((e=>e.y+e.height>d));0==e&&(e=1);let r=!1;-1!=e&&this._lines.length>e&&(recoverLines(this._lines.splice(e,this._lines.length-e)),r=!0);let i,a=this._lines[this._lines.length-1].cmd,s=!1;for(;a;)i=a.next,s?(a.obj?a.obj=null:a.wt&&a.wt.cleanCache(),Te.push(a)):(!i&&r||a.x+a.width>t)&&(a.obj&&(a.obj=null),a.wt||(a.wt=new WordText),a.wt.setText(a.wt.text.substring(0,Math.max(0,a.wt.text.length-2))+Re),u=a.style.fontSize,a.width=a.wt.width=getTextWidth(a.wt.text),a.wt.splitRender=this._singleCharRender,a.next=null,s=!0),a=i;s&&calcTextSize()}this._onPostLayout&&this._onPostLayout();let c="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=c&&this._isWidthSet){let e=this._width-i[3]-i[1];for(let t of this._lines){let r=0;1==c?r=Math.floor(.5*(e-t.width)):2==c&&(r=e-t.width),r>0&&(t.x=r)}}if(this._isHeightSet&&this._textHeight<this._height){let e=0;if("middle"===this._textStyle.valign?e=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(e=this._height-this._textHeight),e>0)for(let t of this._lines)t.y+=e}if(this._overflow==Text.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let e=this.maxScrollX,t=this.maxScrollY;this._scrollPos.x>e&&(this._scrollPos.x=e),this._scrollPos.y>t&&(this._scrollPos.y=t)}else this._scrollPos=new Point(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Text.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new Rectangle),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let t=this.graphics;t.clear(!0),this.drawBg();let r=this._padding,i=r[3],a=r[0],s=this._bitmapFont,n=this._scrollPos,o=(this._isWidthSet?this._width:this._textWidth)-r[3]-r[1],l=(this._isHeightSet?this._height:this._textHeight)-r[0]-r[2],h=a+l,u=this._overflow==Text.HIDDEN||this._overflow==Text.SCROLL;u&&(t.save(),t.clipRect(i,a,o,l),this.repaint());let d,_,c=0,m=0,p=this._lines,f=p.length;for(let r=0;r<f;r++){let l=p[r];c=i+l.x,m=a+l.y,n&&(c-=n.x,m-=n.y);let f=u&&(m+l.height<=a||m>=h),g=l.cmd;for(;g;){if(g.linkEnd&&d&&(d.addRect(_,m,c+g.x+g.width-_,l.height),d=null),g.obj)g.obj.pos(c+g.x,m+g.y),g.obj.element.type==e.HtmlElementType.Link&&(d=g.obj,d.resetArea(),_=c+g.x);else if(!f)if(s){let e=0,r=g.wt.text,i=s.tint?g.style.color:"#FFFFFF",a=Math.floor((s.autoScaleSize?g.style.fontSize:s.fontSize)*this._fontSizeScale)/s.fontSize;for(let n=0,o=r.length;n<o;n++){let o=r.charCodeAt(n),l=s.dict[o];l&&(l.texture&&t.drawImage(l.texture,c+g.x+e+l.x*a,m+g.y+l.y*a,l.width*a,l.height*a,i),e+=Math.round(l.advance*a))}}else{let e=g.style._ctxFont;g.style.stroke?t.fillBorderText(g.wt,c+g.x,m+g.y,e,g.style.color,null,g.style.stroke,g.style.strokeColor):t.fillText(g.wt,c+g.x,m+g.y,e,g.style.color,null)}if(!f&&g.style.underline){let e=Math.max(1,g.style.fontSize*this._fontSizeScale/16);t.drawLine(c+g.x,m+l.height-e,c+g.x+g.width,m+l.height-e,g.style.underlineColor||g.style.color,e)}g=g.next}d&&(d.addRect(_,m,o-_+i,l.height),_=i)}u&&t.restore()}drawBg(){let e=this._bgDrawCmd;if(this._bgColor||this._borderColor){e||(e=new DrawRectCmd,e.x=e.y=0,e.width=e.height=1,e.percent=!0,this._bgDrawCmd=e),e.fillColor=this._bgColor,e.lineColor=this._borderColor,e.lineWidth=this._borderColor?1:0;let t=this.graphics.cmds,r=t.indexOf(e);0!=r&&(-1!=r&&t.splice(r,1),t.unshift(e),this.graphics.cmds=t)}else e&&this.graphics.removeCmd(e)}}Text.VISIBLE="visible",Text.SCROLL="scroll",Text.HIDDEN="hidden",Text.SHRINK="shrink",Text.ELLIPSIS="ellipsis",Text.RightToLeft=!1,Text._testWord="游",Text._passwordChar="●",Text._bitmapFonts={};const Te=[],xe=[];function recoverLines(e){for(let t of e){let e=t.cmd;for(;e;)e.obj?e.obj=null:e.wt&&e.wt.cleanCache(),Te.push(e),e=e.next;t.cmd=null}xe.push(...e),e.length=0}const Se=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;function testEmoji(e){return null!=e&&Se.test(e)}const ye=/(?:[^\s\!-\/])+$/,Ee=/\r\n/g,Ce=/\\(\w)/g,ve={"\\n":"\n","\\t":"\t"},Re="…";function getReplaceStr(e){return ve[e]}var be=!0;const De=new Point,Ae=new Rectangle,Me=[],Le=[];var we;class InputManager{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new TouchInfo(this._touches),this._pressKeys=new Set,this._keyEvent=new Event,this._keyEvent._touches=this._touches}static get inst(){return we}static getTouchPos(e){var t,r;return null==e?(null===(t=we._touches[0])||void 0===t?void 0:t.pos)||Point.EMPTY:(null===(r=we.getTouch(e))||void 0===r?void 0:r.pos)||Point.EMPTY}static get touchTarget(){return we._touchTarget}static get touches(){return we._touches}static get touchCount(){return we._touches.length}static cancelClick(e){let t=null==e?we._touches[0]:we.getTouch(e);t&&(t.clickCancelled=!0)}static hasKeyDown(e){return we._pressKeys.has(e)}static __init__(e,t){let r=we=new InputManager;r._stage=e,t.oncontextmenu=()=>!1,t.addEventListener("mousedown",(e=>{Browser.onIE||e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,0)}),{passive:!1}),t.addEventListener("mouseup",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,1)}),{passive:!1}),t.addEventListener("mousemove",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,2)}),{passive:!1}),t.addEventListener("mouseout",(e=>{r._touchInput||r.handleMouse(e,3)}),{passive:!1}),t.addEventListener("touchstart",(e=>{r._touchInput=!0,be||InputManager.isTextInputting||e.cancelable&&e.preventDefault(),r.handleTouch(e,0)}),{passive:!1}),t.addEventListener("touchend",(e=>{be||InputManager.isTextInputting||e.cancelable&&e.preventDefault(),be=!1,r.handleTouch(e,1)}),{passive:!1}),t.addEventListener("touchmove",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,2)}),{passive:!1}),t.addEventListener("touchcancel",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,3)}),{passive:!1}),t.addEventListener("wheel",(e=>{r.handleMouse(e,4)}),{passive:!1}),t.addEventListener("pointerdown",(e=>{t.setPointerCapture(e.pointerId)})),t.addEventListener("pointerup",(e=>{t.releasePointerCapture(e.pointerId)}),!0);let i=Browser.document;i.addEventListener("keydown",(e=>{r.handleKeys(e)}),!0),i.addEventListener("keypress",(e=>{r.handleKeys(e)}),!0),i.addEventListener("keyup",(e=>{r.handleKeys(e)}),!0)}handleMouse(e,t){var r,i,a,s,n;this._eventType=t,this._nativeEvent=e;let o=this._mouseTouch;De.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(De),InputManager.mouseX=De.x,InputManager.mouseY=De.y;let l=De.x/this._stage.clientScaleX,h=De.y/this._stage.clientScaleY;if(o.event.nativeEvent=e,3!=t&&InputManager.mouseEventsEnabled){o.target=this._touchTarget=this.getNodeUnderPoint(l,h);let e=Math.round(l),t=Math.round(h);if((e!=o.pos.x||t!=o.pos.y)&&(this._stage._mouseMoveTime=Browser.now(),o.pos.setTo(e,t),o.move(),InputManager.mouseEventsEnabled)){o.target.bubbleEvent(Event.MOUSE_MOVE,o.event);for(let e of o.downTargets)e.event(Event.MOUSE_DRAG,o.event)}}else o.target=this._touchTarget=null;if(o.lastRollOver!=o.target&&this.handleRollOver(o),0==t)o.began||(o.begin(),this._touches[0]=o,o.event.button=e.button,InputManager.mouseEventsEnabled&&(this.handleFocus(),0==e.button?null===(r=o.target)||void 0===r||r.bubbleEvent(Event.MOUSE_DOWN,o.event):null===(i=o.target)||void 0===i||i.bubbleEvent(Event.RIGHT_MOUSE_DOWN,o.event)));else if(1==t){if(o.began){if(o.end(),this._touches.length=0,o.event.button=e.button,InputManager.mouseEventsEnabled){if(0==e.button?null===(a=o.target)||void 0===a||a.bubbleEvent(Event.MOUSE_UP,o.event):null===(s=o.target)||void 0===s||s.bubbleEvent(Event.RIGHT_MOUSE_UP,o.event),o.moved)for(let e of o.downTargets)e.event(Event.MOUSE_DRAG_END,o.event);let t=o.clickTest();t&&(0==e.button?(o.event.isDblClick=2==o.clickCount,t.bubbleEvent(Event.CLICK,o.event),2==o.clickCount&&t.bubbleEvent(Event.DOUBLE_CLICK,o.event),o.event.isDblClick=!1):(o.event.isDblClick=2==o.clickCount,t.bubbleEvent(Event.RIGHT_CLICK,o.event),o.event.isDblClick=!1))}o.event.button=0}}else 4==t&&InputManager.mouseEventsEnabled&&(o.event.delta=.025*e.deltaY,null===(n=o.target)||void 0===n||n.bubbleEvent(Event.MOUSE_WHEEL,o.event),o.event.delta=0)}handleTouch(e,t){var r,i;this._eventType=t,this._nativeEvent=e;let a=e.changedTouches;for(let s=0;s<a.length;++s){let n=a[s];if(!InputManager.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=n.identifier)continue;De.setTo(n.pageX,n.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(De),InputManager.mouseX=De.x,InputManager.mouseY=De.y;let o=De.x/this._stage.clientScaleX,l=De.y/this._stage.clientScaleY,h=this.getTouch(n.identifier,0==t);if(h){if(h.event.nativeEvent=e,h.event.touchId=h.touchId,3!=t&&InputManager.mouseEventsEnabled){h.target=this._touchTarget=this.getNodeUnderPoint(o,l),this._stage._mouseMoveTime=Browser.now();let e=Math.round(o),r=Math.round(l);if((Math.abs(e-h.pos.x)>1.5||Math.abs(r-h.pos.y)>1.5)&&(h.pos.setTo(e,r),2==t&&(h.move(),InputManager.mouseEventsEnabled))){h.target.bubbleEvent(Event.MOUSE_MOVE,h.event);for(let e of h.downTargets)e.event(Event.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==t)h.began||(h.begin(),InputManager.mouseEventsEnabled&&(this.handleFocus(),null===(r=h.target)||void 0===r||r.bubbleEvent(Event.MOUSE_DOWN,h.event)));else if((1==t||3==t)&&h.began){if(h.end(),InputManager.mouseEventsEnabled){if(null===(i=h.target)||void 0===i||i.bubbleEvent(Event.MOUSE_UP,h.event),h.moved)for(let e of h.downTargets)e.event(Event.MOUSE_DRAG_END,h.event);if(3!=t){let e=h.clickTest();null!=e&&(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(Event.CLICK,h.event),2==h.clickCount&&e.bubbleEvent(Event.DOUBLE_CLICK,h.event),h.event.isDblClick=!1)}}h.target=null,this.handleRollOver(h),h.reset(),this._touches.splice(this._touches.indexOf(h),1),this._touchPool.push(h)}}}}getTouch(e,t){let r=this._touches.find((t=>t.touchId==e));return r||!t||(r=this._touchPool.length>0?this._touchPool.pop():new TouchInfo(this._touches),r.touchId=e,this._touches.push(r)),r}handleFocus(){if(InputManager.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let e=this._stage.focus._tf||this._stage.focus,t=this._touchTarget._tf||this._touchTarget;t.nativeInput&&t.multiline==e.multiline?e._focusOut():e.focus=!1}}handleKeys(e){let t=e.type,r=e.keyCode;if("keydown"===t?(0!=r&&this._pressKeys.add(r),this._pressKeys.add(e.key)):"keyup"===t&&(0!=r&&this._pressKeys.delete(r),this._pressKeys.delete(e.key)),this._keyEvent.nativeEvent=e,InputManager.keyEventsEnabled){let e=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,r=e;for(;r;)r.event(t,this._keyEvent.setTo(t,r,e)),r=r.parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(e,t){let r=this.getSpriteUnderPoint(this._stage,e,t);return r||(r=this.getSprite3DUnderPoint(e,t)),r||this._stage}getSpriteUnderPoint(e,t,r){let i=e._style.scrollRect;if(i&&!e._getBit(NodeFlags.DISABLE_INNER_CLIPPING)&&(Ae.setTo(i.x,i.y,i.width,i.height),!Ae.contains(t,r)))return null;let a=e._getBit(NodeFlags.EDITING_NODE);if(!a&&e.hitTestPrior&&!e.mouseThrough&&e!=this._stage&&!this.hitTest(e,t,r))return null;for(let i=e._children.length-1;i>-1;i--){let s=e._children[i],n=a||s._getBit(NodeFlags.EDITING_NODE);if(!s._destroyed&&(n?(!s.hasHideFlag(HideFlags.HideInHierarchy)||s.mouseThrough)&&!s._getBit(NodeFlags.HIDE_BY_EDITOR):s._mouseState>1)&&(s._visible||s._getBit(NodeFlags.DISABLE_VISIBILITY))){De.setTo(t,r),s.fromParentPoint(De);let e=this.getSpriteUnderPoint(s,De.x,De.y);if(e)return e}}if(a){if(!e._getBit(NodeFlags.LOCK_BY_EDITOR)&&!e.hasHideFlag(HideFlags.HideInHierarchy)&&this.hitTest(e,t,r,a))return e}else if(e!=this._stage&&(e.hitTestPrior&&!e.mouseThrough||this.hitTest(e,t,r)))return e;return null}getSprite3DUnderPoint(e,t){return null}hitTest(e,t,r,i){let a=!1;e.scrollRect&&(t-=e._style.scrollRect.x,r-=e._style.scrollRect.y);let s=e._style.hitArea,n=e.mouseThrough;return i&&(s=null,n=!1),s?s.contains(t,r,e):((e.width>0&&e.height>0||n||s)&&(a=n?e.getGraphicBounds().contains(t,r):(s||Ae.setTo(0,0,e.width,e.height)).contains(t,r)),a)}handleRollOver(e){if(!InputManager.mouseEventsEnabled)return void(e.lastRollOver=e.target);Me.length=0,Le.length=0;let t=e.lastRollOver;for(;t;)Le.push(t),t=t.parent;for(e.lastRollOver=e.target,t=e.target;t;){let e=Le.indexOf(t);if(-1!=e){Le.splice(e,Le.length-e);break}Me.push(t),t=t.parent}let r=Le.length;if(r>0){for(let i=0;i<r;i++)t=Le[i],t._destroyed||t.event(Event.MOUSE_OUT,e.event.setTo(Event.MOUSE_OUT,t,t));Le.length=0}if(r=Me.length,r>0){for(let i=0;i<r;i++)t=Me[i],t.activeInHierarchy&&t.event(Event.MOUSE_OVER,e.event.setTo(Event.MOUSE_OVER,t,t));Me.length=0}}}InputManager.multiTouchEnabled=!0,InputManager.mouseEventsEnabled=!0,InputManager.keyEventsEnabled=!0,InputManager.clickTestThreshold=10,InputManager.mouseX=0,InputManager.mouseY=0,InputManager.isTextInputting=!1,InputManager.isiOSWKwebView=!1;const Ie={};class TouchInfo{constructor(e){this.downPos=new Point,this.downTargets=[],this.event=new Event,this.event._touches=e,this.pos=this.event.touchPos,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let e=this.target;for(;e;)this.downTargets.push(e),e=e.parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>InputManager.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>InputManager.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let e=performance.now(),t=Ie[this.touchId];t||(t={pos:new Point,time:0,button:0},Ie[this.touchId]=t),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>InputManager.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>InputManager.clickTestThreshold?(this.clickCancelled=!0,t.time=0,this.clickCount=1):(e-t.time<350&&Math.abs(this.pos.x-t.pos.x)<InputManager.clickTestThreshold&&Math.abs(this.pos.y-t.pos.y)<InputManager.clickTestThreshold&&t.button==this.event.button?this.clickCount=2:this.clickCount=1,t.time=e,t.pos.copy(this.pos),t.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let e=this.downTargets[0];if(e.activeInHierarchy)return this.downTargets.length=0,e;for(e=this.target;e;){if(-1!=this.downTargets.indexOf(e)&&e.activeInHierarchy)break;e=e.parent}return this.downTargets.length=0,e}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1}}var Be,Pe,Fe,Ue,Ne,Oe,Ge;e.WebGLMode=void 0,(Be=e.WebGLMode||(e.WebGLMode={}))[Be.Auto=0]="Auto",Be[Be.WebGL2=1]="WebGL2",Be[Be.WebGL1=2]="WebGL1";class RenderStateCommand{constructor(){this.cmdArray=new Map}addCMD(e,t){this.cmdArray.set(e,t)}applyCMD(){LayaGL.renderEngine.applyRenderStateCMD(this)}clear(){this.cmdArray.clear()}}e.WebGLExtension=void 0,(Pe=e.WebGLExtension||(e.WebGLExtension={}))[Pe.OES_vertex_array_object=0]="OES_vertex_array_object",Pe[Pe.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",Pe[Pe.OES_texture_half_float=2]="OES_texture_half_float",Pe[Pe.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",Pe[Pe.OES_texture_float=4]="OES_texture_float",Pe[Pe.OES_element_index_uint=5]="OES_element_index_uint",Pe[Pe.OES_texture_float_linear=6]="OES_texture_float_linear",Pe[Pe.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",Pe[Pe.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",Pe[Pe.WEBGL_depth_texture=9]="WEBGL_depth_texture",Pe[Pe.EXT_sRGB=10]="EXT_sRGB",Pe[Pe.EXT_color_buffer_float=11]="EXT_color_buffer_float",Pe[Pe.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",Pe[Pe.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",Pe[Pe.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",Pe[Pe.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",Pe[Pe.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",Pe[Pe.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",Pe[Pe.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",Pe[Pe.OES_standard_derivatives=19]="OES_standard_derivatives",e.TextureCompareMode=void 0,(Fe=e.TextureCompareMode||(e.TextureCompareMode={}))[Fe.None=0]="None",Fe[Fe.LEQUAL=1]="LEQUAL",Fe[Fe.GEQUAL=2]="GEQUAL",Fe[Fe.LESS=3]="LESS",Fe[Fe.GREATER=4]="GREATER",Fe[Fe.EQUAL=5]="EQUAL",Fe[Fe.NOTEQUAL=6]="NOTEQUAL",Fe[Fe.ALWAYS=7]="ALWAYS",Fe[Fe.NEVER=8]="NEVER";class GLObject{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class WebGLInternalTex extends GLObject{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}get gpuMemory(){return this._gpuMemory}set gpuMemory(t){this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=t,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,this._gpuMemory)}constructor(t,r,i,a,s,n,o,l){super(t),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=i,this.height=a;const isPot=e=>0==(e&e-1);this.isPotSize=isPot(i)&&isPot(a),this._mipmap=n&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(i))+1,Math.ceil(Math.log2(a))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=o,this.gammaCorrection=l,this.target=r,this.filterMode=e.FilterMode.Bilinear,this.wrapU=e.WrapMode.Repeat,this.wrapV=e.WrapMode.Repeat,this.wrapW=e.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=e.TextureCompareMode.None}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,i=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,i);let a=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,a),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(t){if(this._warpW!=t&&this.resource){if(this._engine.getCapable(e.RenderCapable.Texture3D)){let e=this._gl,r=this.getWrapParam(t);this._setWrapMode(e.TEXTURE_WRAP_R,r)}this._warpW=t}}get anisoLevel(){return this._anisoLevel}set anisoLevel(t){let r=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(r){this._gl;let i=this._engine.getParams(e.RenderParams.Max_AnisoLevel_Count),a=Math.max(1,Math.min(i,t));this._setTexParametexf(r.TEXTURE_MAX_ANISOTROPY_EXT,a),this._anisoLevel=a}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,i=this.target;this._engine._bindTexture(i,this.resource),r.texParameteri(i,e,t),this._engine._bindTexture(i,null)}_setTexParametexf(e,t){let r=this._gl,i=this.target;this._engine._bindTexture(i,this.resource),r.texParameterf(i,e,t),this._engine._bindTexture(i,null)}getFilteMinrParam(t,r){let i=this._gl;switch(t){case e.FilterMode.Point:return r?i.NEAREST_MIPMAP_NEAREST:i.NEAREST;case e.FilterMode.Bilinear:return r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR;case e.FilterMode.Trilinear:return r?i.LINEAR_MIPMAP_LINEAR:i.LINEAR;default:return r?i.LINEAR_MIPMAP_NEAREST:i.LINEAR}}getFilterMagParam(t){let r=this._gl;switch(t){case e.FilterMode.Point:return r.NEAREST;case e.FilterMode.Bilinear:case e.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(t){let r=this._gl;switch(t){case e.WrapMode.Repeat:return r.REPEAT;case e.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case e.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}dispose(){this._gl.deleteTexture(this.resource),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=0}}class WebGLInternalRT extends GLObject{get gpuMemory(){return this._gpuMemory}set gpuMemory(t){this._gpuMemory=t,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory,this._gpuMemory)}constructor(e,t,r,i,a,s){super(e),this._gpuMemory=0,this.colorFormat=t,this.depthStencilFormat=r,this._isCube=i,this._generateMipmap=a,this._samples=s,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),s>1&&(this._msaaFramebuffer=this._gl.createFramebuffer())}dispose(){this._textures.forEach((e=>{e&&e.dispose()})),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory,-this._gpuMemory),this._gpuMemory=0}}class GLTextureContext extends GLObject{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}glTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R5G6B5:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_SHORT_5_6_5;break;case e.TextureFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R32G32B32:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.TextureFormat.R16G16B16:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=i.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=i.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_SHORT;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=i.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case e.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=i.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_INT;break;case e.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(t,r){let i=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return{internalFormat:i.DEPTH_COMPONENT16,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:i.DEPTH_STENCIL,attachment:i.DEPTH_STENCIL_ATTACHMENT};case e.RenderTargetFormat.DEPTH_32:return{internalFormat:i.DEPTH_STENCIL,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.STENCIL_8:return{internalFormat:i.STENCIL_INDEX8,attachment:i.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(t){let r=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case e.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case e.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:case e.RenderTargetFormat.R16G16B16:case e.RenderTargetFormat.R16G16B16A16:case e.RenderTargetFormat.R32G32B32:case e.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(t){let r=this._gl;switch(t){case e.TextureDimension.Tex2D:return r.TEXTURE_2D;case e.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(t){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(t){case e.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case e.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case e.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case e.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,i=0,a=0,s=0,n=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,o=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case n:case r.RGB:i=3;break;case o:case r.RGBA:i=4;break;default:i=0}switch(e.type){case r.UNSIGNED_BYTE:a=1;break;case r.UNSIGNED_SHORT_5_6_5:a=2/3;break;case r.FLOAT:a=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:a=2;break;default:a=0}return s=i*a*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D&&(s*=1),s}getGLRTTexMemory(t,r,i,a,s,n,o){let getpixelbyte=t=>{let r=0;switch(t){case e.RenderTargetFormat.R8G8B8:r=3;break;case e.RenderTargetFormat.R8G8B8A8:r=4;break;case e.RenderTargetFormat.R16G16B16A16:r=8;break;case e.RenderTargetFormat.R32G32B32:r=12;break;case e.RenderTargetFormat.R32G32B32A32:r=16;break;case e.RenderTargetFormat.R16G16B16:r=6;break;case e.RenderTargetFormat.DEPTH_16:r=2;break;case e.RenderTargetFormat.STENCIL_8:r=1;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:case e.RenderTargetFormat.DEPTH_32:r=4}return r},l=getpixelbyte(i);return n>1&&(l*=2),o&&(l*=6),s&&(l*=1.333),l*t*r+getpixelbyte(a)*t*r}supportSRGB(t,r){switch(t){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB)&&!r;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return this._engine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(t){switch(t){case e.RenderTargetFormat.DEPTH_16:case e.RenderTargetFormat.DEPTHSTENCIL_24_8:case e.RenderTargetFormat.DEPTH_32:case e.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(t){switch(t){case e.TextureFormat.ETC2SRGB:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,i,a,s){let n=this.isSRGBFormat(i)||s&&this.supportSRGB(i,a),o=1;!n&&s&&(o=2.2);let l=this.getTarget(e),h=new WebGLInternalTex(this._engine,l,t,r,e,a,n,o),u=this.glTextureParam(i,n);return h.internalFormat=u.internalFormat,h.format=u.format,h.type=u.type,h}setTextureImageData(e,t,r,i){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let a=e.target,s=e.internalFormat,n=e.format,o=e.type;e.width,e.height;let l=e._gl;r&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texImage2D(a,0,s,n,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,i,a,s){let n=e.target;e.internalFormat;let o=e.format,l=e.type;t.width,t.height;let h=e._gl;a&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,i,o,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,i=e.type,a=e.width,s=e.height,n=e._gl;this._engine._bindTexture(e.target,e.resource),n.texImage2D(t,0,e.internalFormat,a,s,0,r,i,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&n.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,i){let a=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.width,h=e.height,u=l%4==0&&h%4==0,d=e._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texImage2D(a,0,s,l,h,0,n,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,i,a,s,n,o,l,h){i=i&&0==r;let u=e.target;e.internalFormat;let d=e.format,_=e.type,c=n%4==0&&o%4==0,m=e._gl;l&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!0),c||m.pixelStorei(m.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),m.texSubImage2D(u,r,a,s,n,o,d,_,t),e.mipmap&&i&&m.generateMipmap(e.target),this._engine._bindTexture(e.target,null),l&&m.pixelStorei(m.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&m.pixelStorei(m.UNPACK_FLIP_Y_WEBGL,!1),c||m.pixelStorei(m.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,i=e.internalFormat;e.format,e.type;let a=e.width,s=e.height,n=t.source,o=t.dataOffset,l=t.bpp,h=t.blockBytes,u=t.mipmapCount;e.maxMipmapLevel=u-1;let d=a%4==0&&s%4==0,_=e._gl;d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=a,m=s,p=0;for(let e=0;e<u;e++){let t=Math.max(4,c)/4*Math.max(4,m)/4*h,a=new Uint8Array(n,o,t);_.compressedTexImage2D(r,e,i,c,m,0,a),p+=a.length,o+=l?c*m*(l/8):t,c*=.5,m*=.5,c=Math.max(1,c),m=Math.max(1,m)}e.gpuMemory=p,this._engine._bindTexture(e.target,null),d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,i=t.compress,a=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.mipmapCount,h=e.width,u=e.height;e.maxMipmapLevel=l-1;let d=h%4==0&&u%4==0,_=e._gl;d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=h,m=u,p=t.headerOffset+t.bytesOfKeyValueData,f=0;for(let e=0;e<t.mipmapCount;e++){let l=new Int32Array(r,p,1)[0];if(p+=4,i){let t=new Uint8Array(r,p,l);_.compressedTexImage2D(a,e,s,c,m,0,t),f+=t.length}else{let i=this.getFormatPixelsParams(t.format),h=l/i.typedSize,u=new i.dataTypedCons(r,p,h);_.texImage2D(a,e,s,c,m,0,n,o,u),f+=u.byteLength}p+=l,p+=3-(l+3)%4,c=Math.max(1,.5*c),m=Math.max(1,.5*m)}e.gpuMemory=f,this._engine._bindTexture(e.target,null),d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,i){let a=e._gl;const s=[a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_X,a.TEXTURE_CUBE_MAP_NEGATIVE_X,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.internalFormat,o=e.format,l=e.type;e.width,e.height,r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<s.length;e++){let r=s[e];a.texImage2D(r,0,n,o,l,t[e])}e.mipmap&&a.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,i){let a=e._gl;const s=[a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_X,a.TEXTURE_CUBE_MAP_NEGATIVE_X,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let n=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=h%4==0;if(r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),d||a.pixelStorei(a.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<s.length;e++){let r=s[e];a.texImage2D(r,0,n,h,u,0,o,l,t[e])}e.mipmap&&a.generateMipmap(e.target)}else{for(let e=0;e<s.length;e++){let t=s[e];a.texImage2D(t,0,n,h,u,0,o,l,null)}e.mipmap&&a.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),d||a.pixelStorei(a.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,i,a,s,n,o,l,h){i=i&&0==r;let u=e._gl;const d=[u.TEXTURE_CUBE_MAP_POSITIVE_Z,u.TEXTURE_CUBE_MAP_NEGATIVE_Z,u.TEXTURE_CUBE_MAP_POSITIVE_X,u.TEXTURE_CUBE_MAP_NEGATIVE_X,u.TEXTURE_CUBE_MAP_POSITIVE_Y,u.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let _=e.format,c=e.type,m=n%4==0;l&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),m||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<d.length;e++){let i=d[e];u.texSubImage2D(i,r,a,s,n,o,_,c,t[e])}e.mipmap&&i&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),l&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),m||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setCubeDDSData(t,r){let i=t.internalFormat,a=t.format,s=t.type,n=t.width,o=t.height,l=r.source,h=r.dataOffset,u=r.bpp,d=r.blockBytes,_=r.mipmapCount;t.maxMipmapLevel=_-1;let c=n%4==0&&o%4==0;c=!0;let m=t._gl;this._engine._bindTexture(t.target,t.resource);const p=[m.TEXTURE_CUBE_MAP_POSITIVE_X,m.TEXTURE_CUBE_MAP_NEGATIVE_X,m.TEXTURE_CUBE_MAP_POSITIVE_Y,m.TEXTURE_CUBE_MAP_NEGATIVE_Y,m.TEXTURE_CUBE_MAP_POSITIVE_Z,m.TEXTURE_CUBE_MAP_NEGATIVE_Z];let f=this.getFormatPixelsParams(r.format),g=f.bytesPerPixel/f.channels,T=r.format==e.TextureFormat.R32G32B32A32?Float32Array:Uint16Array,x=0;if(r.compressed)for(let e=0;e<6;e++){let r=p[e],a=n,s=o;for(let e=0;e<_;e++){let n=Math.max(4,a)/4*Math.max(4,s)/4*d,o=new Uint8Array(l,h,n);(t.mipmap||0==e)&&m.compressedTexImage2D(r,e,i,a,s,0,o),x+=o.byteLength,h+=u?a*s*(u/8):n,a*=.5,s*=.5,a=Math.max(1,a),s=Math.max(1,s)}}else for(let e=0;e<6;e++){let t=p[e],r=n,u=o;for(let e=0;e<_;e++){let n=r*u*f.channels,o=new T(l,h,n);m.texImage2D(t,e,i,r,u,0,a,s,o),x+=o.byteLength,h+=n*g,r*=.5,u*=.5,r=Math.max(1,r),u=Math.max(1,u)}}t.gpuMemory=x,this._engine._bindTexture(t.target,null)}setCubeKTXData(e,t){let r=t.source,i=t.compress,a=e.internalFormat,s=e.format,n=e.type,o=t.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=o-1;let u=l%4==0&&h%4==0,d=e._gl;const _=[d.TEXTURE_CUBE_MAP_POSITIVE_X,d.TEXTURE_CUBE_MAP_NEGATIVE_X,d.TEXTURE_CUBE_MAP_POSITIVE_Y,d.TEXTURE_CUBE_MAP_NEGATIVE_Y,d.TEXTURE_CUBE_MAP_POSITIVE_Z,d.TEXTURE_CUBE_MAP_NEGATIVE_Z];u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=l,m=h,p=t.headerOffset+t.bytesOfKeyValueData,f=0;for(let e=0;e<t.mipmapCount;e++){let o=new Int32Array(r,p,1)[0];p+=4;for(let l=0;l<6;l++){let h=_[l];if(i){let t=new Uint8Array(r,p,o);d.compressedTexImage2D(h,e,a,c,m,0,t),f+=t.byteLength}else{let i=this.getFormatPixelsParams(t.format),l=o/i.typedSize,u=new i.dataTypedCons(r,p,l);d.texImage2D(h,e,a,c,m,0,s,n,u),f+=u.byteLength}p+=o,p+=3-(o+3)%4}c=Math.max(1,.5*c),m=Math.max(1,.5*m)}this._engine._bindTexture(e.target,null),e.gpuMemory=f,u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureCompareMode(t,r){return e.TextureCompareMode.None}bindRenderTarget(e,t=0){let r=this._gl,i=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,i),e._isCube){let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}}bindoutScreenTarget(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}unbindRenderTarget(e){let t=e._gl;e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null)}createRenderTextureInternal(t,r,i,a,s,n){s=s&&this.supportGenerateMipmap(a);let o=1;n&&(o=2.2);let l=this.getTarget(t),h=new WebGLInternalTex(this._engine,l,r,i,t,s,false,o),u=this.glRenderTextureParam(a,false);h.internalFormat=u.internalFormat,h.format=u.format,h.type=u.type;let d=h.internalFormat,_=h.format,c=h.type,m=h._gl;return this._engine._bindTexture(h.target,h.resource),m.texImage2D(l,0,d,r,i,0,_,c,null),this._engine._bindTexture(h.target,null),a!=e.RenderTargetFormat.DEPTH_16&&a!=e.RenderTargetFormat.DEPTH_32&&a!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=e.FilterMode.Point),h}createRenderTextureCubeInternal(t,r,i,a,s){a=a&&this.supportGenerateMipmap(i);let n=1;s&&(n=2.2);let o=this.getTarget(t),l=new WebGLInternalTex(this._engine,o,r,r,t,a,false,n),h=this.glRenderTextureParam(i,false);l.internalFormat=h.internalFormat,l.format=h.format,l.type=h.type;let u=l.internalFormat,d=l.format,_=l.type,c=l._gl;const m=[c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z,c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(l.target,l.resource);for(let e=0;e<m.length;e++){let t=m[e];c.texImage2D(t,0,u,r,r,0,d,_,null)}return this._engine._bindTexture(l.target,null),i!=e.RenderTargetFormat.DEPTH_16&&i!=e.RenderTargetFormat.DEPTH_32&&i!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(l.filterMode=e.FilterMode.Point),l}createRenderTargetInternal(t,r,i,a,s,n,o){let l=this.createRenderTextureInternal(e.TextureDimension.Tex2D,t,r,i,s,n),h=new WebGLInternalRT(this._engine,i,a,!1,l.mipmap,1);h.gpuMemory=this.getGLRTTexMemory(t,r,i,a,s,1,!1),h.colorFormat=i,h.depthStencilFormat=a,h._textures.push(l);let u=h._framebuffer,d=h._gl;d.bindFramebuffer(d.FRAMEBUFFER,u);let _=this.glRenderTargetAttachment(i);d.framebufferTexture2D(d.FRAMEBUFFER,_,d.TEXTURE_2D,l.resource,0);let c=this.glRenderBufferParam(a,!1);if(c){let e=this.createRenderbuffer(t,r,c.internalFormat,h._samples);h._depthbuffer=e,d.framebufferRenderbuffer(d.FRAMEBUFFER,c.attachment,d.RENDERBUFFER,e)}return d.bindFramebuffer(d.FRAMEBUFFER,null),h}createRenderTargetCubeInternal(t,r,i,a,s,n){let o=this.createRenderTextureCubeInternal(e.TextureDimension.Cube,t,r,a,s),l=new WebGLInternalRT(this._engine,r,i,!0,o.mipmap,1);l.gpuMemory=this.getGLRTTexMemory(t,t,r,i,a,1,!0),l._textures.push(o);let h=l._framebuffer,u=l._gl;u.bindFramebuffer(u.FRAMEBUFFER,h);let d=this.glRenderBufferParam(i,!1);if(d){let e=this.createRenderbuffer(t,t,d.internalFormat,l._samples);l._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,d.attachment,u.RENDERBUFFER,e)}return u.bindFramebuffer(u.FRAMEBUFFER,null),l}createRenderbuffer(e,t,r,i){let a=this._gl,s=a.createRenderbuffer();return a.bindRenderbuffer(a.RENDERBUFFER,s),a.renderbufferStorage(a.RENDERBUFFER,r,e,t),a.bindRenderbuffer(a.RENDERBUFFER,null),s}setupRendertargetTextureAttachment(e,t){let r=e._gl;e._depthTexture=t;let i=e._depthbuffer;i&&r.deleteRenderbuffer(i),e._depthbuffer=null;let a=this.glRenderTargetAttachment(e.depthStencilFormat),s=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,s),r.framebufferTexture2D(r.FRAMEBUFFER,a,r.TEXTURE_2D,t.resource,0),r.bindFramebuffer(r.FRAMEBUFFER,null)}readRenderTargetPixelData(t,r,i,a,s,n){let o=t._gl;if(this.bindRenderTarget(t),!(o.checkFramebufferStatus(o.FRAMEBUFFER)==o.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(t),null;switch(t.colorFormat){case e.RenderTargetFormat.R8G8B8:o.readPixels(r,i,a,s,o.RGB,o.UNSIGNED_BYTE,n);break;case e.RenderTargetFormat.R8G8B8A8:o.readPixels(r,i,a,s,o.RGBA,o.UNSIGNED_BYTE,n);break;case e.RenderTargetFormat.R16G16B16:o.readPixels(r,i,a,s,o.RGB,o.FLOAT,n);break;case e.RenderTargetFormat.R16G16B16A16:o.readPixels(r,i,a,s,o.RGBA,o.FLOAT,n);break;case e.RenderTargetFormat.R32G32B32:o.readPixels(r,i,a,s,o.RGB,o.FLOAT,n);break;case e.RenderTargetFormat.R32G32B32A32:o.readPixels(r,i,a,s,o.RGBA,o.FLOAT,n)}return this.unbindRenderTarget(t),n}updateVideoTexture(e,t,r,i){let a=e._gl,s=e.target,n=e.internalFormat,o=e.format,l=e.type;e.width,e.height,r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),a.pixelStorei(a.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),a.texImage2D(s,0,n,o,l,t),this._engine._bindTexture(e.target,null),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.pixelStorei(a.UNPACK_ALIGNMENT,4)}getRenderTextureData(t,r,i,a,s){if(t.colorFormat==e.RenderTargetFormat.None)return null;let n=t._gl;if(n.bindFramebuffer(n.FRAMEBUFFER,t._framebuffer),!(n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE))return n.bindFramebuffer(n.FRAMEBUFFER,null),null;let o,l,h=a*s;var u;switch(t.colorFormat){case e.RenderTargetFormat.R8G8B8:o=n.RGB,l=n.UNSIGNED_BYTE,u=new Uint8Array(3*h);break;case e.RenderTargetFormat.R8G8B8A8:o=n.RGBA,l=n.UNSIGNED_BYTE,u=new Uint8Array(4*h);break;case e.RenderTargetFormat.R16G16B16:o=n.RGB,l=n.UNSIGNED_SHORT_4_4_4_4,u=new Uint16Array(3*h);break;case e.RenderTargetFormat.R16G16B16A16:o=n.RGBA,l=n.UNSIGNED_SHORT_4_4_4_4,u=new Uint16Array(4*h);break;case e.RenderTargetFormat.R32G32B32:o=n.RGB,l=n.FLOAT,u=new Float32Array(3*h);break;case e.RenderTargetFormat.R32G32B32A32:o=n.RGBA,l=n.FLOAT,u=new Float32Array(4*h);break;default:return null}return n.readPixels(r,i,a,s,o,l,u),n.bindFramebuffer(n.FRAMEBUFFER,null),u}}class GL2TextureContext extends GLTextureContext{constructor(e){super(e)}getTarget(t){let r=-1;switch(t){case e.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case e.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case e.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case e.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.TextureFormat.R8G8B8:this._glParam.internalFormat=r?i.SRGB8:i.RGB8,this._glParam.format=i.RGB,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?i.SRGB8_ALPHA8:i.RGBA8,this._glParam.format=i.RGBA,this._glParam.type=i.UNSIGNED_BYTE;break;case e.TextureFormat.R5G6B5:this._glParam.internalFormat=i.RGB565,this._glParam.format=i.RGB,this._glParam.type=i.UNSIGNED_SHORT_5_6_5;break;case e.TextureFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA32F,this._glParam.format=i.RGBA,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R32G32B32:this._glParam.internalFormat=i.RGB32F,this._glParam.format=i.RGB,this._glParam.type=i.FLOAT;break;case e.TextureFormat.R16G16B16:this._glParam.internalFormat=i.RGB16F,this._glParam.format=i.RGB,this._glParam.type=i.HALF_FLOAT;break;case e.TextureFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA16F,this._glParam.format=i.RGBA,this._glParam.type=i.HALF_FLOAT;break;case e.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case e.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case e.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case e.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case e.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case e.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case e.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case e.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case e.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case e.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case e.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case e.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case e.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case e.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case e.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case e.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case e.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case e.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(t,r){let i=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return{internalFormat:i.DEPTH_COMPONENT16,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:i.DEPTH24_STENCIL8,attachment:i.DEPTH_STENCIL_ATTACHMENT};case e.RenderTargetFormat.DEPTH_32:return{internalFormat:i.DEPTH_COMPONENT32F,attachment:i.DEPTH_ATTACHMENT};case e.RenderTargetFormat.STENCIL_8:return{internalFormat:i.STENCIL_INDEX8,attachment:i.STENCIL_ATTACHMENT};case e.RenderTargetFormat.R8G8B8:return{internalFormat:r?i.SRGB8:i.RGB8,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?i.SRGB8_ALPHA8:i.RGBA8,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R16G16B16:return{internalFormat:i.RGB16F,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R16G16B16A16:return{internalFormat:i.RGBA16F,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R32G32B32:return{internalFormat:i.RGB32F,attachment:i.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R32G32B32A32:return{internalFormat:i.RGBA32F,attachment:i.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(t,r){let i=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?i.SRGB8:i.RGB8,this._glParam.format=i.RGB,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?i.SRGB8_ALPHA8:i.RGBA8,this._glParam.format=i.RGBA,this._glParam.type=i.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=i.RGB16F,this._glParam.format=i.RGB,this._glParam.type=i.HALF_FLOAT;break;case e.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=i.RGBA16F,this._glParam.format=i.RGBA,this._glParam.type=i.HALF_FLOAT;break;case e.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=i.RGB32F,this._glParam.format=i.RGB,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=i.RGBA32F,this._glParam.format=i.RGBA,this._glParam.type=i.FLOAT;break;case e.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=i.DEPTH_COMPONENT16,this._glParam.format=i.DEPTH_COMPONENT,this._glParam.type=i.UNSIGNED_INT;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=i.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_INT_24_8;break;case e.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=i.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=i.UNSIGNED_INT;break;case e.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,i=0,a=0,s=0;switch(e.internalFormat){case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:i=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:i=4;break;default:i=0}switch(e.type){case r.UNSIGNED_BYTE:a=1;break;case r.UNSIGNED_SHORT_5_6_5:a=2/3;break;case r.FLOAT:a=4;break;case r.HALF_FLOAT:a=2;break;default:a=0}return s=i*a*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D?s*=1:e.target==r.TEXTURE_2D_ARRAY&&(s*=t),s}supportSRGB(t,r){switch(t){case e.TextureFormat.R8G8B8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB)&&!r;case e.TextureFormat.R8G8B8A8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB);case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return this._engine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,i){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let a=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,d=this._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),d.texStorage2D(a,u,s,l,h),d.texSubImage2D(a,0,0,0,l,h,n,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,i,a,s){let n=e.target;e.internalFormat;let o=e.format,l=e.type;e.width,e.height,e.mipmapCount;let h=this._gl;a&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,i,t.width,t.height,o,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,i){let a=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,d=l%4==0&&h%4==0,_=this._gl;r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),_.texStorage2D(a,u,s,l,h),e.gpuMemory=this.getGLtexMemory(e),t&&(_.texSubImage2D(a,0,0,0,l,h,n,o,t),e.mipmap&&_.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setTexture3DImageData(e,t,r,i,a){let s=e.target,n=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=e.mipmapCount,_=this._gl;i&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),_.texStorage3D(s,d,n,h,u,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)_.texSubImage3D(s,0,0,0,e,h,u,1,o,l,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&_.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixlesData(e,t,r,i,a){let s=e.target,n=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=e.mipmapCount,_=h%4==0&&u%4==0,c=this._gl;i&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),_||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),c.texStorage3D(s,d,n,h,u,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(c.texSubImage3D(s,0,0,0,0,h,u,r,o,l,t),e.mipmap&&c.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),i&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),_||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,i,a,s,n,o,l,h,u,d){i=i&&0==r;let _=e.target;e.internalFormat;let c=e.format,m=e.type,p=o%4==0&&l%4==0,f=this._gl;u&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),d&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),p||f.pixelStorei(f.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),f.texSubImage3D(_,r,a,s,n,o,l,h,c,m,t),e.mipmap&&i&&f.generateMipmap(e.target),this._engine._bindTexture(e.target,null),u&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),d&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!1),p||f.pixelStorei(f.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,i=e.internalFormat,a=e.format,s=e.type,n=e.mipmapCount,o=e.width,l=e.height;e.maxMipmapLevel=n-1;let h=t.source,u=t.compress,d=o%4==0&&l%4==0,_=this._gl;d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||_.texStorage2D(r,t.mipmapCount,i,o,l);let c=o,m=l,p=t.headerOffset+t.bytesOfKeyValueData,f=0;for(let e=0;e<t.mipmapCount;e++){let n=new Int32Array(h,p,1)[0];if(p+=4,u){let t=new Uint8Array(h,p,n);_.compressedTexImage2D(r,e,i,c,m,0,t),f+=t.length}else{let i=this.getFormatPixelsParams(t.format),o=n/i.typedSize,l=new i.dataTypedCons(h,p,o);_.texSubImage2D(r,e,0,0,c,m,a,s,l),f+=l.length}p+=n,p+=3-(n+3)%4,c=Math.max(1,.5*c),m=Math.max(1,.5*m)}this._engine._bindTexture(e.target,null),e.gpuMemory=f,d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,i){let a=this._gl;const s=[a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_X,a.TEXTURE_CUBE_MAP_NEGATIVE_X,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,o=e.internalFormat,l=e.format,h=e.type,u=e.width,d=e.height,_=e.mipmapCount;r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),a.texStorage2D(n,_,o,u,d),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<s.length;e++){let r=s[e];a.texSubImage2D(r,0,0,0,l,h,t[e])}e.mipmap&&a.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,i){let a=this._gl;const s=[a.TEXTURE_CUBE_MAP_POSITIVE_Z,a.TEXTURE_CUBE_MAP_NEGATIVE_Z,a.TEXTURE_CUBE_MAP_POSITIVE_X,a.TEXTURE_CUBE_MAP_NEGATIVE_X,a.TEXTURE_CUBE_MAP_POSITIVE_Y,a.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,o=e.internalFormat,l=e.format,h=e.type,u=e.width,d=e.height,_=e.mipmapCount,c=u%4==0;if(r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),c||a.pixelStorei(a.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),a.texStorage2D(n,_,o,u,d),t){for(let e=0;e<s.length;e++){let r=s[e];a.texSubImage2D(r,0,0,0,u,d,l,h,t[e])}e.mipmap&&a.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),c||a.pixelStorei(a.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const i=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let a=e.target,s=e.internalFormat,n=e.format,o=e.type;e.mipmapCount;let l=e.width,h=e.height;e.maxMipmapLevel=t.mipmapCount-1;let u=t.source,d=t.compress,_=l,c=h,m=t.headerOffset+t.bytesOfKeyValueData,p=l%4==0&&h%4==0;p||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d||r.texStorage2D(a,t.mipmapCount,s,l,h);let f=0;for(let e=0;e<t.mipmapCount;e++){let a=new Int32Array(u,m,1)[0];m+=4;for(let l=0;l<6;l++){let h=i[l];if(d){let t=new Uint8Array(u,m,a);r.compressedTexImage2D(h,e,s,_,c,0,t),f+=t.byteLength}else{let i=this.getFormatPixelsParams(t.format),s=a/i.typedSize,l=new i.dataTypedCons(u,m,s);r.texSubImage2D(h,e,0,0,_,c,n,o,l),f+=l.byteLength}m+=a,m+=3-(a+3)%4}_=Math.max(1,.5*_),c=Math.max(1,.5*c)}e.gpuMemory=f,this._engine._bindTexture(e.target,null),p||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const i=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let a=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.mipmapCount,h=e.width,u=e.height;e.maxMipmapLevel=l-1;let d=t.source,_=t.compress,c=h,m=u,p=t.headerOffset+t.bytesOfKeyValueData,f=h%4==0&&u%4==0;f||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),_||r.texStorage2D(a,t.mipmapCount,s,h,u);let g=0;for(let e=0;e<t.mipmapCount;e++){let a=new Int32Array(d,p,1)[0];p+=4;for(let s=0;s<6;s++){let l=i[s],h=this.getFormatPixelsParams(t.format),u=a/h.typedSize,_=new h.dataTypedCons(d,p,u);r.texSubImage2D(l,e,0,0,c,m,n,o,_),g+=_.byteLength}p+=a,p+=3-(a+3)%4}c=Math.max(1,.5*c),m=Math.max(1,.5*m),e.gpuMemory=g,this._engine._bindTexture(e.target,null),f||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(t,r){let i=this._gl;switch(r){case e.TextureCompareMode.LEQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.LEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.GEQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.GEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.LESS:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.LESS),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.GREATER:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.GREATER),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.EQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.EQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.NOTEQUAL:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.NOTEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.ALWAYS:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.ALWAYS),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.NEVER:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.NEVER),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.None:default:t._setTexParameteri(i.TEXTURE_COMPARE_FUNC,i.LEQUAL),t._setTexParameteri(i.TEXTURE_COMPARE_MODE,i.NONE)}return r}createRenderbuffer(e,t,r,i){let a=this._gl,s=a.createRenderbuffer();return a.bindRenderbuffer(a.RENDERBUFFER,s),i>1?a.renderbufferStorageMultisample(a.RENDERBUFFER,i,r,e,t):a.renderbufferStorage(a.RENDERBUFFER,r,e,t),a.bindRenderbuffer(a.RENDERBUFFER,null),s}createRenderTextureInternal(t,r,i,a,s,n){s=s&&this.supportGenerateMipmap(a);let o=this.isSRGBFormat(a)||n&&this.supportSRGB(a,s),l=1;!o&&n&&(l=2.2);let h=this.getTarget(t),u=new WebGLInternalTex(this._engine,h,r,i,t,s,o,l),d=this.glRenderTextureParam(a,o);u.internalFormat=d.internalFormat,u.format=d.format,u.type=d.type;let _=u.internalFormat;u.format,u.type;let c=this._gl;return this._engine._bindTexture(u.target,u.resource),c.texStorage2D(h,u.mipmapCount,_,r,i),this._engine._bindTexture(u.target,null),a!=e.RenderTargetFormat.DEPTH_16&&a!=e.RenderTargetFormat.DEPTH_32&&a!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(u.filterMode=e.FilterMode.Point),u}createRenderTargetInternal(t,r,i,a,s,n,o){let l=this.createRenderTextureInternal(e.TextureDimension.Tex2D,t,r,i,s,n),h=new WebGLInternalRT(this._engine,i,a,!1,l.mipmap,o);h.gpuMemory=this.getGLRTTexMemory(t,r,i,a,s,o,!1),h._textures.push(l);let u=h._gl;if(h._samples>1){let e=h._msaaFramebuffer,s=this.glRenderBufferParam(i,n),o=h._msaaRenderbuffer=this.createRenderbuffer(t,r,s.internalFormat,h._samples);u.bindFramebuffer(u.FRAMEBUFFER,e),u.framebufferRenderbuffer(u.FRAMEBUFFER,s.attachment,u.RENDERBUFFER,o);let d=this.glRenderBufferParam(a,!1);if(d){let e=this.createRenderbuffer(t,r,d.internalFormat,h._samples);h._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,d.attachment,u.RENDERBUFFER,e)}u.bindFramebuffer(u.FRAMEBUFFER,null);let _=h._framebuffer;u.bindFramebuffer(u.FRAMEBUFFER,_);let c=this.glRenderTargetAttachment(i);u.framebufferTexture2D(u.FRAMEBUFFER,c,u.TEXTURE_2D,l.resource,0),u.bindFramebuffer(u.FRAMEBUFFER,null)}else{let e=h._framebuffer;u.bindFramebuffer(u.FRAMEBUFFER,e);let s=this.glRenderTargetAttachment(i);u.framebufferTexture2D(u.FRAMEBUFFER,s,u.TEXTURE_2D,l.resource,0);let n=this.glRenderBufferParam(a,!1);if(n){let e=this.createRenderbuffer(t,r,n.internalFormat,h._samples);h._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,n.attachment,u.RENDERBUFFER,e)}u.bindFramebuffer(u.FRAMEBUFFER,null)}return h}createRenderTargetCubeInternal(t,r,i,a,s,n){let o=this.createRenderTextureCubeInternal(e.TextureDimension.Cube,t,r,a,s),l=new WebGLInternalRT(this._engine,r,i,!0,o.mipmap,n);l.gpuMemory=this.getGLRTTexMemory(t,t,r,i,a,n,!0),l.colorFormat=r,l.depthStencilFormat=i,l._textures.push(o);let h=l._gl;if(l._samples>1){let e=l._msaaFramebuffer,a=this.glRenderBufferParam(r,!1),s=l._msaaRenderbuffer=this.createRenderbuffer(t,t,a.internalFormat,l._samples);h.bindFramebuffer(h.FRAMEBUFFER,e),h.framebufferRenderbuffer(h.FRAMEBUFFER,a.attachment,h.RENDERBUFFER,s);let n=this.glRenderBufferParam(i,!1);if(n){let e=this.createRenderbuffer(t,t,n.internalFormat,l._samples);l._depthbuffer=e,h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,e)}h.bindFramebuffer(h.FRAMEBUFFER,null)}else{let e=l._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,e);let r=this.glRenderBufferParam(i,!1);if(r){let e=this.createRenderbuffer(t,t,r.internalFormat,l._samples);l._depthbuffer=e,h.framebufferRenderbuffer(h.FRAMEBUFFER,r.attachment,h.RENDERBUFFER,e)}h.bindFramebuffer(h.FRAMEBUFFER,null)}return l}createRenderTextureCubeInternal(e,t,r,i,a){i=i&&this.supportGenerateMipmap(r);let s=this.isSRGBFormat(r)||a&&this.supportSRGB(r,i),n=1;!s&&a&&(n=2.2);let o=this.getTarget(e),l=new WebGLInternalTex(this._engine,o,t,t,e,i,s,n),h=this.glRenderTextureParam(r,s);l.internalFormat=h.internalFormat,l.format=h.format,l.type=h.type;let u=l.internalFormat;l.format,l.type;let d=this._gl;return this._engine._bindTexture(l.target,l.resource),d.texStorage2D(o,l.mipmapCount,u,t,t),this._engine._bindTexture(l.target,null),l}bindRenderTarget(e,t=0){let r=this._gl;if(e._isCube){let i=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,i);let a=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}}unbindRenderTarget(e){let t=this._gl;if(e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],i=t.COLOR_BUFFER_BIT;e._depthTexture&&(i|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,i,t.NEAREST)}e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null)}}class GLBuffer extends GLObject{constructor(e,t,r){super(e),this._byteLength=0,this._glTargetType=t,this._glBufferUsageType=r,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer()}_getGLUsage(t){switch(t){case e.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case e.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case e.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(t){switch(t){case e.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case e.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case e.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(t){this._engine._addStatisticsInfo(e.RenderStatisticsInfo.BufferMemory,t),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,t)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(-this._byteLength),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer(),this._memorychange(this._byteLength)}setData(e,t){let r=this._gl;this.bindBuffer(),r.bufferSubData(this._glTarget,t,e),this.unbindBuffer()}setDataEx(e,t,r){let i=this._gl;this.bindBuffer(),i.bufferSubData(this._glTarget,t,e,0,r),this.unbindBuffer()}bindBufferBase(e){if(this._engine._getBindUBOBuffer(e)!=this){this._gl.bindBufferBase(this._glTarget,e,this._glBuffer),this._engine._setBindUBOBuffer(e,this)}}bindBufferRange(e,t,r){this._gl.bindBufferRange(this._glTarget,e,this._glBuffer,t,r)}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();this._gl.deleteBuffer(this._glBuffer),this._memorychange(-this._byteLength),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}!function(){var e={};function synthesizeGLError(t,r){var i;e[t]=!0,void 0!==r&&(i=r,window.console&&window.console.error&&window.console.error(i))}var t=function WebGLVertexArrayObjectOES(e){var t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var r=0;r<this.attribs.length;r++){var i=new WebGLVertexArrayObjectOES.VertexAttrib(t);this.attribs[r]=i}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var i;do{(i=r.apply(t))!=t.NO_ERROR&&(e[i]=!0)}while(i!=t.NO_ERROR);for(var a in e)if(e[a])return delete e[a],parseInt(a);return t.NO_ERROR}}(t);var i=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:i.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!0,i.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;return t.maxAttrib=Math.max(t.maxAttrib,e),t.attribs[e].enabled=!1,i.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,a){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=a;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=a}return i.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,a){var s=r.currentVertexArrayObject.attribs[e];switch(a){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return s.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return s.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return s.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return s.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return s.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return s.normalized;default:return i.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,a,s,n,o){var l=r.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,e);var h=l.attribs[e];return h.buffer=r.currentArrayBuffer,h.size=t,h.type=a,h.normalized=s,h.stride=n,h.offset=o,h.recache(),i.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var r=this.original,i=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var a=this.currentVertexArrayObject;if(i!=a){i&&a.elementArrayBuffer==i.elementArrayBuffer||r.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,a.elementArrayBuffer);for(var s=this.currentArrayBuffer,n=Math.max(i?i.maxAttrib:0,a.maxAttrib),o=0;o<=n;o++){var l=a.attribs[o],h=i?i.attribs[o]:null;if(i&&l.enabled==h.enabled||(l.enabled?r.enableVertexAttribArray.call(t,o):r.disableVertexAttribArray.call(t,o)),l.enabled){var u=!1;i&&l.buffer==h.buffer||(s!=l.buffer&&(r.bindBuffer.call(t,t.ARRAY_BUFFER,l.buffer),s=l.buffer),u=!0),(u||l.cached!=h.cached)&&r.vertexAttribPointer.call(t,o,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=s&&r.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}}();class GlCapable{constructor(e){this._extentionVendorPrefixes=["","WEBKIT_","MOZ_"],this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(t){this._capabilityMap=new Map;let r=t||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(e.RenderCapable.Element_Index_Uint32,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(e.RenderCapable.TextureFormat_R32G32B32A32,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(e.RenderCapable.TextureFormat_R16G16B16A16,r),r=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(e.RenderCapable.Texture_anisotropic,r),r=t?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float):!!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_R16G16B16A16,r),r=t||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_Depth,r),r=t,this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_ShadowMap,r),r=t||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(e.RenderCapable.Vertex_VAO,r),r=t||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(e.RenderCapable.DrawElement_Instance,r),r=t||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(e.RenderCapable.Shader_TextureLod,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_S3TC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_PVRTC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ETC1,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ETC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ASTC,r),r=t||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(e.RenderCapable.Texture_SRGB,r),r=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(e.RenderCapable.Texture_FloatLinearFiltering,r),r=!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(e.RenderCapable.Texture_HalfFloatLinearFiltering,r),r=t,this._capabilityMap.set(e.RenderCapable.MSAA,r),this._capabilityMap.set(e.RenderCapable.UnifromBufferObject,r),this._capabilityMap.set(e.RenderCapable.GRAPHICS_API_GLES3,r),this._capabilityMap.set(e.RenderCapable.Texture3D,r)}initExtension(t){this._extensionMap=new Map;const setExtensionMap=(e,t,r)=>{t&&r.set(e,t)},r=this._getExtension("EXT_texture_filter_anisotropic");setExtensionMap(e.WebGLExtension.EXT_texture_filter_anisotropic,r,this._extensionMap);const i=this._getExtension("WEBGL_compressed_texture_s3tc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc,i,this._extensionMap);const a=this._getExtension("WEBGL_compressed_texture_s3tc_srgb");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,a,this._extensionMap);const s=this._getExtension("WEBGL_compressed_texture_pvrtc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,s,this._extensionMap);const n=this._getExtension("WEBGL_compressed_texture_etc1");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc1,n,this._extensionMap);const o=this._getExtension("WEBGL_compressed_texture_etc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc,o,this._extensionMap);const l=this._getExtension("WEBGL_compressed_texture_astc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_astc,l,this._extensionMap);const h=this._getExtension("OES_texture_float_linear");if(setExtensionMap(e.WebGLExtension.OES_texture_float_linear,h,this._extensionMap),t){const t=this._getExtension("EXT_color_buffer_float");setExtensionMap(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap);const r=this._getExtension("EXT_color_buffer_half_float");setExtensionMap(e.WebGLExtension.EXT_color_buffer_half_float,r,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=this._getExtension("OES_vertex_array_object");setExtensionMap(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const r=this._getExtension("ANGLE_instanced_arrays");setExtensionMap(e.WebGLExtension.ANGLE_instanced_arrays,r,this._extensionMap);const i=this._getExtension("OES_texture_half_float");setExtensionMap(e.WebGLExtension.OES_texture_half_float,i,this._extensionMap);const a=this._getExtension("OES_texture_half_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_half_float_linear,a,this._extensionMap);const s=this._getExtension("OES_texture_float");setExtensionMap(e.WebGLExtension.OES_texture_float,s,this._extensionMap);const n=this._getExtension("OES_element_index_uint");setExtensionMap(e.WebGLExtension.OES_element_index_uint,n,this._extensionMap);const o=this._getExtension("EXT_shader_texture_lod");setExtensionMap(e.WebGLExtension.EXT_shader_texture_lod,o,this._extensionMap);const l=this._getExtension("WEBGL_depth_texture");setExtensionMap(e.WebGLExtension.WEBGL_depth_texture,l,this._extensionMap);const h=this._getExtension("EXT_sRGB");setExtensionMap(e.WebGLExtension.EXT_sRGB,h,this._extensionMap);const u=this._getExtension("OES_standard_derivatives");setExtensionMap(e.WebGLExtension.OES_standard_derivatives,u,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.has(e)?this._extensionMap.get(e):null}_getExtension(e){const t=this._extentionVendorPrefixes;for(const i in t){var r=this._gl.getExtension(t[i]+e);if(r)return r}return null}}class GLParams{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const t=this._gl;this._glParamsData=new Map,this._glParamsData.set(e.RenderParams.Max_Active_Texture_Count,t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const r=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),i=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(e.RenderParams.Max_Uniform_Count,Math.min(r,i)),this._glParamsData.set(e.RenderParams.MAX_Texture_Size,t.getParameter(t.MAX_TEXTURE_SIZE)),this._glParamsData.set(e.RenderParams.MAX_Texture_Image_Uint,t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(e.RenderCapable.Texture_anisotropic)){const r=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(e.RenderParams.Max_AnisoLevel_Count,t.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(e.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(e.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(e.RenderParams.FLOAT,t.FLOAT),this._glParamsData.set(e.RenderParams.UNSIGNED_BYTE,t.UNSIGNED_BYTE),this._glParamsData.set(e.RenderParams.UNSIGNED_SHORT,t.UNSIGNED_SHORT),this._glParamsData.set(e.RenderParams.BYTE,t.BYTE)}getParams(e){return this._glParamsData.get(e)}}class GLRender2DContext extends GLObject{constructor(e){super(e)}activeTexture(e){this._engine._activedTextureID!==e&&(this._gl.activeTexture(e),this._engine._activedTextureID=e)}bindTexture(e,t){this._engine._bindTexture(e,t)}bindUseProgram(e){return this.cacheShaderProgram!=e&&(this._gl.useProgram(e),this._engine._glUseProgram=null,!0)}}e.DrawType=void 0,(Ue=e.DrawType||(e.DrawType={}))[Ue.DrawArray=0]="DrawArray",Ue[Ue.DrawArrayInstance=1]="DrawArrayInstance",Ue[Ue.DrawElement=2]="DrawElement",Ue[Ue.DrawElementInstance=3]="DrawElementInstance";class GLRenderDrawContext extends GLObject{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(t){switch(t){case e.MeshTopology.Points:return this._gl.POINTS;case e.MeshTopology.Lines:return this._gl.LINES;case e.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case e.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case e.MeshTopology.Triangles:return this._gl.TRIANGLES;case e.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case e.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(t){switch(t){case e.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case e.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case e.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(t,r,i,a,s){const n=this.getMeshTopology(t),o=this.getIndexType(i);this._engine.isWebGL2?this._gl.drawElementsInstanced(n,r,o,a,s):this._angleInstancedArrays.drawElementsInstancedANGLE(n,r,o,a,s),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3*s)}drawArraysInstanced(t,r,i,a){const s=this.getMeshTopology(t);this._engine.isWebGL2?this._gl.drawArraysInstanced(s,r,i,a):this._angleInstancedArrays.drawArraysInstancedANGLE(s,r,i,a),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,(i-2)*a)}drawArrays(t,r,i){const a=this.getMeshTopology(t);this._gl.drawArrays(a,r,i),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,i-2)}drawElements(t,r,i,a){const s=this.getMeshTopology(t),n=this.getIndexType(i);this._gl.drawElements(s,r,n,a),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3)}drawGeometryElement(t){t.bufferState.bind();let r=t.drawParams.elements,i=t.drawParams.length;switch(t.drawType){case e.DrawType.DrawArray:for(let e=0;e<i;e+=2)this.drawArrays(t.mode,r[e],r[e+1]);break;case e.DrawType.DrawElement:for(let e=0;e<i;e+=2)this.drawElements(t.mode,r[e+1],t.indexFormat,r[e]);break;case e.DrawType.DrawArrayInstance:for(let e=0;e<i;e+=2)this.drawArraysInstanced(t.mode,r[e],r[e+1],t.instanceCount);break;case e.DrawType.DrawElementInstance:for(let e=0;e<i;e+=2)this.drawElementsInstanced(t.mode,r[e+1],t.indexFormat,r[e],t.instanceCount)}}}e.CompareFunction=void 0,(Ne=e.CompareFunction||(e.CompareFunction={}))[Ne.Never=0]="Never",Ne[Ne.Less=1]="Less",Ne[Ne.Equal=2]="Equal",Ne[Ne.LessEqual=3]="LessEqual",Ne[Ne.Greater=4]="Greater",Ne[Ne.NotEqual=5]="NotEqual",Ne[Ne.GreaterEqual=6]="GreaterEqual",Ne[Ne.Always=7]="Always",e.StencilOperation=void 0,(Oe=e.StencilOperation||(e.StencilOperation={}))[Oe.Keep=0]="Keep",Oe[Oe.Zero=1]="Zero",Oe[Oe.Replace=2]="Replace",Oe[Oe.IncrementSaturate=3]="IncrementSaturate",Oe[Oe.DecrementSaturate=4]="DecrementSaturate",Oe[Oe.Invert=5]="Invert",Oe[Oe.IncrementWrap=6]="IncrementWrap",Oe[Oe.DecrementWrap=7]="DecrementWrap";class GLRenderState{constructor(e){this._depthTest=!0,this._depthMask=!0,this._stencilTest=!1,this._blend=!1,this._cullFace=!1,this._engine=e,this._gl=this._engine.gl,this._initState()}_initState(){const e=this._gl;this.setDepthFunc(e.LESS),this.setBlendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),this._blendEquation=e.FUNC_ADD,this._sFactor=e.ONE,this._dFactor=e.ZERO,this._sFactorAlpha=e.ONE,this._dFactorAlpha=e.ONE}_getBlendFactor(t){const r=this._gl;switch(t){case e.BlendFactor.Zero:return r.ZERO;case e.BlendFactor.One:return r.ONE;case e.BlendFactor.SourceColor:return r.SRC_COLOR;case e.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case e.BlendFactor.DestinationColor:return r.DST_COLOR;case e.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case e.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case e.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case e.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case e.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case e.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case e.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case e.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(t){const r=this._gl;switch(t){case e.BlendEquationSeparate.ADD:return r.FUNC_ADD;case e.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case e.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(t){const r=this._gl;switch(t){case e.CompareFunction.Never:return r.NEVER;case e.CompareFunction.Less:return r.LESS;case e.CompareFunction.Equal:return r.EQUAL;case e.CompareFunction.LessEqual:return r.LEQUAL;case e.CompareFunction.Greater:return r.GREATER;case e.CompareFunction.NotEqual:return r.NOTEQUAL;case e.CompareFunction.GreaterEqual:return r.GEQUAL;case e.CompareFunction.Always:return r.ALWAYS}}_getGLStencilOperation(t){const r=this._gl;switch(t){case e.StencilOperation.Keep:return r.KEEP;case e.StencilOperation.Zero:return r.ZERO;case e.StencilOperation.Replace:return r.REPLACE;case e.StencilOperation.IncrementSaturate:return r.INCR;case e.StencilOperation.DecrementSaturate:return r.DECR;case e.StencilOperation.Invert:return r.INVERT;case e.StencilOperation.IncrementWrap:return r.INCR_WRAP;case e.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(t){return t==e.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(e))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilMask(e){e!==this._stencilMask&&(this._stencilMask=e,e?this._gl.stencilMask(255):this._gl.stencilMask(0))}setStencilFunc(e,t){e==this._stencilFunc&&t==this._stencilRef||(this._stencilFunc=e,this._stencilRef=t,this._gl.stencilFunc(e,t,255))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(e,t,r))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(e))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(e,t))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(e,t))}setBlendFuncSeperate(e,t,r,i){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&i===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=i,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(e,t,r,i))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(e))}applyRenderStateCommand(t){t.cmdArray.forEach(((t,r)=>{switch(r){case e.RenderStateType.DepthTest:this.setDepthTest(t);break;case e.RenderStateType.DepthMask:this.setDepthMask(t);break;case e.RenderStateType.DepthFunc:this.setDepthFunc(this._getGLCompareFunction(t));break;case e.RenderStateType.StencilTest:this.setStencilTest(t);break;case e.RenderStateType.StencilMask:this.setStencilMask(t);break;case e.RenderStateType.StencilFunc:this.setStencilFunc(this._getGLCompareFunction(t[0]),t[1]);break;case e.RenderStateType.StencilOp:this.setstencilOp(this._getGLStencilOperation(t[0]),this._getGLStencilOperation(t[1]),this._getGLStencilOperation(t[2]));break;case e.RenderStateType.BlendType:this.setBlend(t!=e.BlendType.BLEND_DISABLE);break;case e.RenderStateType.BlendEquation:this.setBlendEquation(this._getBlendOperation(t));break;case e.RenderStateType.BlendEquationSeparate:this.setBlendEquationSeparate(this._getBlendOperation(t[0]),this._getBlendOperation(t[1]));break;case e.RenderStateType.BlendFunc:this.setBlendFunc(this._getBlendFactor(t[0]),this._getBlendFactor(t[1]));break;case e.RenderStateType.BlendFuncSeperate:this.setBlendFuncSeperate(this._getBlendFactor(t[0]),this._getBlendFactor(t[1]),this._getBlendFactor(t[2]),this._getBlendFactor(t[3]));break;case e.RenderStateType.CullFace:this.setCullFace(t);break;case e.RenderStateType.FrontFace:this.setFrontFace(this._getGLFrontfaceFactor(t));break;default:throw"unknow type of renderStateType"}}))}}e.TextureCubeFace=void 0,(Ge=e.TextureCubeFace||(e.TextureCubeFace={}))[Ge.PositiveX=0]="PositiveX",Ge[Ge.NegativeX=1]="NegativeX",Ge[Ge.PositiveY=2]="PositiveY",Ge[Ge.NegativeY=3]="NegativeY",Ge[Ge.PositiveZ=4]="PositiveZ",Ge[Ge.NegativeZ=5]="NegativeZ";const ke=new Uint8Array(3);class TextureCube extends BaseTexture{static get blackTexture(){return TextureCube._blackTexture}static get grayTexture(){return TextureCube._grayTexture}static get whiteTexture(){return TextureCube._whiteTexture}static get errorTexture(){return TextureCube._errorTexture}static __init__(){var t=new TextureCube(1,e.TextureFormat.R8G8B8,!1),r=new TextureCube(1,e.TextureFormat.R8G8B8,!1),i=new TextureCube(1,e.TextureFormat.R8G8B8,!1),a=ke;a[0]=0,a[1]=0,a[2]=0,t.setPixelsData([a,a,a,a,a,a],!1,!1),t.lock=!0,a[0]=128,a[1]=128,a[2]=128,r.setPixelsData([a,a,a,a,a,a],!1,!1),r.lock=!0,a[0]=255,a[1]=255,a[2]=255,i.setPixelsData([a,a,a,a,a,a],!1,!1),i.lock=!0,TextureCube._grayTexture=r,TextureCube._blackTexture=t,TextureCube._whiteTexture=i,TextureCube._errorTexture=i}constructor(t,r,i=!0,a=!1){super(t,t,r),this._dimension=e.TextureDimension.Cube,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,t,r,i,a)}setImageData(e,t,r){let i=!1,a=e.findIndex((e=>null!=e));if(-1!=a){let t=e[a];e.every((e=>null!=e&&e.width==t.width&&e.height==t.height))||(i=!0)}else i=!0;let s=this._texture;if(i){let e=ke;LayaGL.textureContext.setCubePixelsData(s,[e,e,e,e,e,e],t,r)}else LayaGL.textureContext.setCubeImageData(s,e,t,r)}setPixelsData(e,t,r){let i=this._texture;LayaGL.textureContext.setCubePixelsData(i,e,t,r)}updateSubPixelsData(e,t,r,i,a,s,n,o,l){let h=this._texture;LayaGL.textureContext.setCubeSubPixelData(h,e,s,n,t,r,i,a,o,l)}setDDSData(e){let t=this._texture;LayaGL.textureContext.setCubeDDSData(t,e)}setKTXData(e){let t=this._texture;LayaGL.textureContext.setCubeKTXData(t,e)}get defaultTexture(){return TextureCube.grayTexture}}class ShaderVariable{constructor(){this.textureID=-1}}class GLShaderInstance extends GLObject{constructor(e,t,r,i){super(e),this._complete=!0,this._vs=t,this._ps=r,this._attributeMap=i,this._uniformMap=[],this._create()}_create(){const e=this._gl;for(var t in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[t][0],t);e.linkProgram(this._program);if(!e.getProgramParameter(this._program,e.LINK_STATUS)){var r=e.getProgramInfoLog(this._program);return console.error(new Error("Could not compile WebGL program. \n\n"+r)),void(this._complete=!1)}const i=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);let a,s;for(this.useProgram(),this._curActTexIndex=0,s=0;s<i;s++){var n=e.getActiveUniform(this._program,s),o=n.name;let t=e.getUniformLocation(this._program,o);(t||0==t)&&(a=new ShaderVariable,a.location=t,o.indexOf("[0]")>0?(a.name=o=o.substr(0,o.length-3),a.isArray=!0):(a.name=o,a.isArray=!1),a.type=n.type,this._addShaderUnifiormFun(a),this._uniformMap.push(a),a.dataOffset=this._engine.propertyNameToID(o))}if(this._engine.isWebGL2){this._uniformObjectMap={};var l=e.getProgramParameter(this._program,e.ACTIVE_UNIFORM_BLOCKS);for(s=0;s<l;s++){let t=e;var h=t.getActiveUniformBlockName(this._program,s);a=new ShaderVariable,a.name=h,a.isArray=!1,a.type=e.UNIFORM_BUFFER,a.dataOffset=this._engine.propertyNameToID(h);let r=a.location=t.getUniformBlockIndex(this._program,h);t.uniformBlockBinding(this._program,r,this._engine.getUBOPointer(h)),this._uniformObjectMap[a.name]=a,this._uniformMap.push(a),this._addShaderUnifiormFun(a)}}}_legalUBObyteLength(e){return 16*Math.ceil(e/16)}_createShader(e,t,r){var i=e.createShader(r);return e.shaderSource(i,t),e.compileShader(i),this._engine._isShaderDebugMode&&!e.getShaderParameter(i,e.COMPILE_STATUS)&&(LayaEnv.isPlaying?console.error(e.getShaderInfoLog(i)):console.warn(e.getShaderInfoLog(i))),i}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:throw new Error("compile shader err!")}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3fv(e,t){return this._gl.uniformMatrix3fv(e.location,!1,t),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,t){var r=t?t._getSource():Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D,r),0}_uniform_sampler2DArray(e,t){var r=t?t._getSource():Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_2D_ARRAY,r),0}_uniform_sampler3D(e,t){var r=t?t._getSource():Texture2D.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_3D,r),0}_uniform_samplerCube(e,t){var r=t?t._getSource():TextureCube.errorTexture._getSource(),i=this._gl;return this._bindTexture(e.textureID,i.TEXTURE_CUBE_MAP,r),0}_uniform_UniformBuffer(e,t){t._bindUniformBufferBase()}_bindTexture(e,t,r){const i=this._gl;this._engine._activedTextureID!==e&&(i.activeTexture(e),this._engine._activedTextureID=e);const a=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[a]!==r&&(i.bindTexture(t,r),this._engine._activeTextures[a]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class GLVertexState extends GLObject{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach((e=>{var r=e.vertexDeclaration;this._vertexDeclaration[t++]=e.vertexDeclaration;var i=r._shaderValues;for(var a in e.bind(),i){var s=parseInt(a),n=i[a];this._gl.enableVertexAttribArray(s),this._gl.vertexAttribPointer(s,n[0],n[1],!!n[2],n[3],n[4]),e.instanceBuffer&&this.vertexAttribDivisor(s,1)}}))}clearVAO(){for(let i=0,a=this._vertexDeclaration.length;i<a;i++){var e=this._vertexDeclaration[i]._shaderValues;for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e.bind(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}class WebGLEngine{constructor(t,r=e.WebGLMode.Auto){this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._curUBOPointer=0,this._GLUBOPointerMap=new Map,this._GLBindPointerUBOMap=new Map,this._lastClearColor=new Color,this._lastClearDepth=1,this._GLStatisticsInfo=new Map,this._config=t,this._isWebGL2=!1,this._lastViewport=new Vector4(0,0,0,0),this._lastClearColor=new Color(0,0,0,0),this._lastScissor=new Vector4(0,0,0,0),this._webglMode=r,this._initStatisticsInfo()}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){this._GLStatisticsInfo.set(e.RenderStatisticsInfo.DrawCall,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.InstanceDrawCall,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.Triangle,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.UniformUpload,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.TextureMemeory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.GPUMemory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.RenderTextureMemory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.BufferMemory,0)}_addStatisticsInfo(e,t){this._GLStatisticsInfo.set(e,this._GLStatisticsInfo.get(e)+t)}clearStatisticsInfo(e){this._GLStatisticsInfo.set(e,0)}getStatisticsInfo(e){return this._GLStatisticsInfo.get(e)}_getBindUBOBuffer(e){return this._GLBindPointerUBOMap.get(e)}_setBindUBOBuffer(e,t){this._GLBindPointerUBOMap.set(e,t)}initRenderEngine(t){let r,i;switch(this._webglMode){case e.WebGLMode.Auto:r=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:r=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:r=["webgl2","experimental-webgl2"]}for(var a=0;a<r.length;a++){try{i=t.getContext(r[a],this._config)}catch(e){}if(i){"webgl2"!==r[a]&&"experimental-webgl2"!==r[a]||(this._isWebGL2=!0);break}}this._context=i,this._initBindBufferMap(),this._supportCapatable=new GlCapable(this),this._GLParams=new GLParams(this),this._GLRenderState=new GLRenderState(this),this._glTextureIDParams=[i.TEXTURE0,i.TEXTURE1,i.TEXTURE2,i.TEXTURE3,i.TEXTURE4,i.TEXTURE5,i.TEXTURE6,i.TEXTURE7,i.TEXTURE8,i.TEXTURE9,i.TEXTURE10,i.TEXTURE11,i.TEXTURE12,i.TEXTURE13,i.TEXTURE14,i.TEXTURE15,i.TEXTURE16,i.TEXTURE17,i.TEXTURE18,i.TEXTURE19,i.TEXTURE20,i.TEXTURE21,i.TEXTURE22,i.TEXTURE23,i.TEXTURE24,i.TEXTURE25,i.TEXTURE26,i.TEXTURE27,i.TEXTURE28,i.TEXTURE29,i.TEXTURE30,i.TEXTURE31],this._activedTextureID=i.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new GL2TextureContext(this):new GLTextureContext(this),this._GLRenderDrawContext=new GLRenderDrawContext(this),this._GL2DRenderContext=new GLRender2DContext(this)}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[e.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[e.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[e.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}bindTexture(e){this._bindTexture(e._texture.target,e._getSource())}applyRenderStateCMD(e){this._GLRenderState.applyRenderStateCommand(e)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,t,r,i){const a=this._context,s=this._lastViewport;LayaEnv.isConch?a.viewport(e,t,r,i):e===s.x&&t===s.y&&r===s.z&&i===s.w||(a.viewport(e,t,r,i),s.setValue(e,t,r,i))}scissor(e,t,r,i){const a=this._context,s=this._lastScissor;LayaEnv.isConch?a.scissor(e,t,r,i):e===s.x&&t===s.y&&r===s.z&&i===s.w||(a.scissor(e,t,r,i),s.setValue(e,t,r,i))}scissorTest(e){e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST)}clearRenderTexture(t,r=null,i=1){var a;t&e.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),a|=this.gl.COLOR_BUFFER_BIT),t&e.RenderClearFlag.Depth&&(this._lastClearDepth!=i&&(this._context.clearDepth(i),this._lastClearDepth=i),this._GLRenderState.setDepthMask(!0),a|=this._context.DEPTH_BUFFER_BIT),t&e.RenderClearFlag.Stencil&&(this._context.clearStencil(0),this._GLRenderState.setStencilMask(!0),a|=this._context.STENCIL_BUFFER_BIT),a&&this._context.clear(a)}copySubFrameBuffertoTex(e,t,r,i,a,s,n,o){this._bindTexture(e._texture.target,e._getSource()),this._context.copyTexSubImage2D(e._texture.target,t,r,i,a,s,n,o)}colorMask(e,t,r,i){this._context.colorMask(e,t,r,i)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new GLBuffer(this,e,t)}createShaderInstance(e,t,r){return new GLShaderInstance(this,e,t,r)}createVertexState(){return new GLVertexState(this)}getUBOPointer(e){return this._GLUBOPointerMap.has(e)||this._GLUBOPointerMap.set(e,this._curUBOPointer++),this._GLUBOPointerMap.get(e)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}uploadUniforms(e,t,r,i){e.bind(),r.applyUBOData();for(var a=r._data,s=t.getArrayData(),n=0,o=0,l=s.length;o<l;o++){var h=s[o];if(i||-1!==h.textureID){var u=a[h.dataOffset];null!=u&&(n+=h.fun.call(h.caller,h,u))}}return n}uploadCustomUniforms(e,t,r,i){e.bind();var a=0,s=t[r];return s&&null!=i&&(a+=s.fun.call(s.caller,s,i)),a}createRenderStateComand(){return new RenderStateCommand}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}class NativeGLObject{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}setResourceManager(){}destroy(){this._destroyed||(this._destroyed=!0)}}class NativeGLTextureContext extends NativeGLObject{constructor(e,t){super(e),this._native=t}createTextureInternal(e,t,r,i,a,s){return this._native.createTextureInternal(e,t,r,i,a,s)}setTextureImageData(e,t,r,i){this._native.setTextureImageData(e,t._nativeObj.conchImgId,r,i)}setTexturePixelsData(e,t,r,i){this._native.setTexturePixelsData(e,t,r,i)}initVideoTextureData(e){this._native.initVideoTextureData(e)}setTextureSubPixelsData(e,t,r,i,a,s,n,o,l,h){this._native.setTextureSubPixelsData(e,t,r,i,a,s,n,o,l,h)}setTextureSubImageData(e,t,r,i,a,s){}setTexture3DImageData(e,t,r,i,a){this._native.setTexture3DImageData(e,t.map((function(e){return e._nativeObj})),r,i,a)}setTexture3DPixlesData(e,t,r,i,a){this._native.setTexture3DPixlesData(e,t,r,i,a)}setTexture3DSubPixelsData(e,t,r,i,a,s,n,o,l,h,u,d){this._native.setTexture3DSubPixelsData(e,t,r,i,a,s,n,o,l,h,u,d)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureDDSData(e,t){this._native.setTextureKTXData(e,t)}setTextureKTXData(e,t){this._native.setTextureKTXData(e,t)}setCubeImageData(e,t,r,i){var a=[],s=t.length;for(let e=0;e<s;e++)a.push(t[e]._nativeObj);this._native.setCubeImageData(e,a,r,i)}setCubePixelsData(e,t,r,i){this._native.setCubePixelsData(e,t,r,i)}setCubeSubPixelData(e,t,r,i,a,s,n,o,l,h){this._native.setCubeSubPixelData(e,t,r,i,a,s,n,o,l,h)}setCubeDDSData(e,t){throw new Error("setCubeDDSData Method not implemented.")}setCubeKTXData(e,t){throw new Error("setCubeKTXData Method not implemented.")}setTextureCompareMode(e,t){return this._native.setTextureCompareMode(e,t)}bindRenderTarget(e){this._native.bindRenderTarget(e)}bindoutScreenTarget(){this._native.bindoutScreenTarget()}unbindRenderTarget(e){this._native.unbindRenderTarget(e)}createRenderTextureInternal(e,t,r,i,a,s){return this._native.createRenderTextureInternal(e,t,r,i,a,s)}createRenderTargetInternal(t,r,i,a,s,n,o){return this._native.createRenderTargetInternal(t,r,i,a||e.RenderTargetFormat.None,s,n,o)}createRenderTargetCubeInternal(e,t,r,i,a,s){return this._native.createRenderTargetCubeInternal(e,t,r,i,a,s)}createRenderTextureCubeInternal(e,t,r,i,a){throw new Error("createRenderTextureCubeInternal Method not implemented.")}setupRendertargetTextureAttachment(e,t){this._native.setupRendertargetTextureAttachment(e,t)}readRenderTargetPixelData(e,t,r,i,a,s){return this._native.readRenderTargetPixelData(e,t,r,i,a,s)}updateVideoTexture(e,t,r,i){this._native.updateVideoTexture(e,t._nativeObj.conchImgId,r,i)}getRenderTextureData(e,t,r,i,a){return this._native.getRenderTextureData(e,t,r,i,a)}}class NativeGL2TextureContext extends NativeGLTextureContext{constructor(e,t){super(e,t)}}class NativeGLVertexState extends NativeGLObject{constructor(e){super(e),this._vertexDeclaration=[],this._nativeObj=new window.conchGLVertexState(e._nativeObj),this._nativeVertexBuffers=[]}bindVertexArray(){this._nativeObj.bindVertexArray()}unbindVertexArray(){this._nativeObj.unbindVertexArray()}applyVertexBuffer(e){this._vertexBuffers=e,this._nativeVertexBuffers.length=0,e.forEach((e=>{this._nativeVertexBuffers.push(e._conchVertexBuffer3D)})),this._nativeObj.applyVertexBuffer(this._nativeVertexBuffers)}applyIndexBuffer(e){null!=e&&(this._bindedIndexBuffer=e,this._nativeObj.applyIndexBuffer(e._conchIndexBuffer3D))}destroy(){this._vertexBuffers=null,this._nativeVertexBuffers=[],this._bindedIndexBuffer=null,super.destroy(),this._nativeObj.destroy()}}class NativeGLRenderDrawContext extends NativeGLObject{constructor(e){super(e),this._nativeObj=new window.conchGLRenderDrawContext(e._nativeObj)}drawElementsInstanced(e,t,r,i,a){this._nativeObj.drawElementsInstanced(e,t,r,i,a)}drawArraysInstanced(e,t,r,i){this._nativeObj.drawArraysInstanced(e,t,r,i)}drawArrays(e,t,r){this._nativeObj.drawArrays(e,t,r)}drawElements(e,t,r,i){this._nativeObj.drawElements(e,t,r,i)}drawGeometryElement(e){this._nativeObj.drawGeometryElement(e._nativeObj)}}class NativeRenderStateCommand extends RenderStateCommand{constructor(){super(),this._nativeObj=new window.conchRenderStateCommand}addCMD(t,r){switch(t){case e.RenderStateType.DepthTest:case e.RenderStateType.DepthMask:case e.RenderStateType.DepthFunc:case e.RenderStateType.StencilTest:case e.RenderStateType.StencilMask:case e.RenderStateType.BlendEquation:case e.RenderStateType.CullFace:case e.RenderStateType.FrontFace:this._nativeObj.addCMDInt1(t,r);break;case e.RenderStateType.StencilFunc:case e.RenderStateType.BlendFunc:case e.RenderStateType.BlendEquationSeparate:this._nativeObj.addCMDInt2(t,r[0],r[1]);break;case e.RenderStateType.StencilOp:this._nativeObj.addCMDInt3(t,r[0],r[1],r[2]);break;case e.RenderStateType.BlendType:this._nativeObj.addCMDInt1(t,r!=e.BlendType.BLEND_DISABLE?1:0);break;case e.RenderStateType.BlendFuncSeperate:this._nativeObj.addCMDInt4(t,r[0],r[1],r[2],r[3]);break;default:throw"unknow type of renderStateType"}}applyCMD(){LayaGL.renderEngine.applyRenderStateCMD(this)}clear(){this._nativeObj.clear()}}class NativeWebGLEngine{constructor(t,r=e.WebGLMode.Auto){this._isShaderDebugMode=!0,this._nativeObj=new window.conchWebGLEngine(r)}createRenderStateComand(){return new NativeRenderStateCommand}getUBOPointer(e){return this._nativeObj.getUBOPointer(e)}_addStatisticsInfo(e,t){this._nativeObj.addStatisticsInfo(e,t)}clearStatisticsInfo(e){this._nativeObj.clearStatisticsInfo(e)}getStatisticsInfo(e){return this._nativeObj.getStatisticsInfo(e)}get gl(){return this._context}get isWebGL2(){return this._nativeObj.isWebGL2}get webglConfig(){return this._config}initRenderEngine(e){this._nativeObj.initRenderEngine(),this._GLRenderDrawContext=new NativeGLRenderDrawContext(this),this.isWebGL2?this._GLTextureContext=new NativeGL2TextureContext(this,new window.conchGL2TextureContext(this._nativeObj)):this._GLTextureContext=new NativeGLTextureContext(this,new window.conchGLTextureContext(this._nativeObj))}bindTexture(e){throw new Error("Method not implemented.")}applyRenderStateCMD(e){this._nativeObj.applyRenderStateCommand(e._nativeObj)}getCapable(e){return this._nativeObj.getCapable(e)}viewport(e,t,r,i){this._nativeObj.viewport(e,t,r,i)}scissor(e,t,r,i){this._nativeObj.scissor(e,t,r,i)}scissorTest(e){this._nativeObj.scissorTest(e)}clearRenderTexture(e,t=null,r=1){t?this._nativeObj.clearRenderTexture(e,!0,t.r,t.g,t.b,t.a,r):this._nativeObj.clearRenderTexture(e,!1,Color.BLACK.r,Color.BLACK.g,Color.BLACK.b,Color.BLACK.a,r)}copySubFrameBuffertoTex(e,t,r,i,a,s,n,o){this._nativeObj.copySubFrameBuffertoTex(e._texture,t,r,i,a,s,n,o)}colorMask(e,t,r,i){this._nativeObj.colorMask(e,t,r,i)}getParams(e){return this._nativeObj.getParams(e)}createBuffer(e,t){return new window.conchGLBuffer(this._nativeObj,e,t)}createShaderInstance(e,t,r){throw new Error("Method not implemented.")}createVertexState(){return new NativeGLVertexState(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){return this._nativeObj.propertyNameToID(e)}propertyIDToName(e){throw new Error("Method not implemented.")}uploadUniforms(e,t,r,i){throw new Error("Method not implemented.")}uploadCustomUniforms(e,t,r,i){throw new Error("Method not implemented.")}unbindVertexState(){this._nativeObj.unbindVertexState&&this._nativeObj.unbindVertexState()}}class Render{static customRequestAnimationFrame(e,t){Render._customRequestAnimationFrame=e,Render._loopFunction=t}static set customRenderEngine(e){Render._customEngine=e}static get customRenderEngine(){return Render._customEngine}constructor(e,t,r){this._first=!0,this._startTm=0,this._timeId=0,Render._Render=this,Render._mainCanvas=r;let i=Render._mainCanvas.source;i.id="layaCanvas",i.width=e,i.height=t,LayaEnv.isConch&&document.body.appendChild(i),this.initRender(Render._mainCanvas,e,t),window.requestAnimationFrame((function loop(e){performance.now(),a._first&&(a._startTm=Math.floor(e/n)*n,a._first=!1);e-=a._startTm;let t=Math.floor(e/n);(t-Render.lastFrm>0||LayaEnv.isConch||!Config.fixedFrames)&&(Render.lastFrm=t,ILaya.stage._loop());Render._customRequestAnimationFrame&&Render._loopFunction?Render._customRequestAnimationFrame(Render._loopFunction):window.requestAnimationFrame(loop)}));let a=this;performance.now();let s=Config.FPS,n=Render.ifps=1e3/s;ILaya.stage.on("visibilitychange",this,this._onVisibilitychange)}_onVisibilitychange(){ILaya.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return Render.lastFrm*Render.ifps}initRender(t,r,i){let a={stencil:Config.isStencil,alpha:Config.isAlpha,antialias:Config.isAntialias,premultipliedAlpha:Config.premultipliedAlpha,preserveDrawingBuffer:Config.preserveDrawingBuffer,depth:Config.isDepth,failIfMajorPerformanceCaveat:Config.isfailIfMajorPerformanceCaveat,powerPreference:Config.powerPreference};const s=Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;let n;if(Render.customRenderEngine)n=Render.customRenderEngine,n.initRenderEngine(Render._mainCanvas.source);else if(LayaEnv.isConch&&!window.conchConfig.conchWebGL)n=new NativeWebGLEngine(a,s),n.initRenderEngine(Render._mainCanvas.source);else{n=new WebGLEngine(a,s),n.initRenderEngine(Render._mainCanvas.source);var o=RenderStateContext.mainContext=n._context;if(Config.printWebglOrder&&this._replaceWebglcall(o),!o)return!1}LayaGL.renderEngine=n,LayaGL.textureContext=n.getTextureContext(),LayaGL.renderDrawContext=n.getDrawContext(),LayaGL.render2DContext=n.get2DRenderContext(),t.size(r,i),VertexElementFormat.__init__(),Context.__init__(),SubmitBase.__init__();var l=new Context;return Context._rendercontex=l,l.isMain=!0,Render._context=l,t._setContext(l),ShaderDefines2D.__init__(),Value2D.__init__(),Shader2D.__init__(),BlendMode._init_(),!0}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let i=[];for(let e=0;e<arguments.length;e++)i.push(arguments[e]);let a=t[r].apply(e,i);e.getError();return a})}_enterFrame(e=null){ILaya.stage._loop()}static get context(){return Render._context}static get canvas(){return Render._mainCanvas.source}}Render.lastFrm=0,Render.ifps=1e3/60;class Input extends Text{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",Input.IOS_IFRAME=ILaya.Browser.onIOS&&ILaya.Browser.window.top!=ILaya.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=Text.SCROLL,this._promptColor="#A9A9A9",this.on(Event.MOUSE_DOWN,this,this._onMouseDown),this.on(Event.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(Input._createInputElement(),ILaya.Browser.onMobile){var e=!1;(ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onHWMiniGame||ILaya.Browser.onTBMiniGame)&&(e=!0),Render.canvas.addEventListener(Input.IOS_IFRAME?e?"touchend":"click":"touchend",Input._popupInputMethod)}}static _popupInputMethod(e){InputManager.isTextInputting&&Input.inputElement.focus()}static _createInputElement(){Input._initInput(Input.area=ILaya.Browser.createElement("textarea")),Input._initInput(Input.input=ILaya.Browser.createElement("input")),Input.inputContainer=ILaya.Browser.createElement("div"),Input.inputContainer.style.position="absolute",Input.inputContainer.style.zIndex="1E5",ILaya.Browser.container.appendChild(Input.inputContainer),Input.inputContainer.setPos=function(e,t){Input.inputContainer.style.left=e+"px",Input.inputContainer.style.top=t+"px"}}static _initInput(e){var t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex="1",e.addEventListener("input",Input._processInputting),e.addEventListener("mousemove",Input._stopEvent,{passive:!1}),e.addEventListener("mousedown",Input._stopEvent,{passive:!1}),e.addEventListener("touchmove",Input._stopEvent,{passive:!1}),e.setFontFace=function(t){e.style.fontFamily=t},LayaEnv.isConch&&!Input.isAppUseNewInput||(e.setColor=function(t){e.style.color=t},e.setFontSize=function(t){e.style.fontSize=t+"px"})}static _processInputting(e){var t=Input.inputElement.target;if(t){var r=Input.inputElement.value;t._restrictPattern&&(r=r.replace(/\u2006|\x27/g,""),t._restrictPattern.test(r)&&(r=r.replace(t._restrictPattern,""),Input.inputElement.value=r)),null==r&&(r=""),t._text=r,t.event(Event.INPUT)}}static _stopEvent(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}setSelection(e,t){this.focus=!0,Input.inputElement.selectionStart=e,Input.inputElement.selectionEnd=t}get multiline(){return this._multiline}set multiline(e){this._multiline=e,this.valign=e?"top":"middle"}get nativeInput(){return this._multiline?Input.area:Input.input}_onUnDisplay(e=null){this.focus=!1}_onMouseDown(e){this.focus=!0}_syncInputTransform(){var e=this.nativeInput,t=SpriteUtils.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),r=this._width-this._padding[1]-this._padding[3],i=this._height-this._padding[0]-this._padding[2];LayaEnv.isConch&&!Input.isAppUseNewInput?(e.setScale(t.scaleX,t.scaleY),e.setSize(r,i),e.setPos(t.x,t.y)):(Input.inputContainer.style.transform=Input.inputContainer.style.webkitTransform="scale("+t.scaleX+","+t.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)",e.style.width=r+"px",e.style.height=i+"px",Input.inputContainer.style.left=t.x+"px",Input.inputContainer.style.top=t.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(e){var t=this.nativeInput;this._focus!==e&&(e?(t.target?t.target._focusOut():this._setInputMethod(),(t=this.nativeInput).target=this,this._focusIn()):(t.target=null,this._focusOut(),ILaya.Browser.document.body.scrollTop=0,t.blur(),LayaEnv.isConch&&!Input.isAppUseNewInput?t.setPos(-1e4,-1e4):Input.inputContainer.contains(t)&&Input.inputContainer.removeChild(t)))}_setInputMethod(){Input.input.parentElement&&Input.inputContainer.removeChild(Input.input),Input.area.parentElement&&Input.inputContainer.removeChild(Input.area),ILaya.Browser.onAndroid&&(Input.input=Input.inputElement=ILaya.Browser.createElement("input"),Input._initInput(Input.input)),Input.inputElement=this._multiline?Input.area:Input.input,Input.inputContainer.appendChild(Input.inputElement),Text.RightToLeft&&(Input.inputElement.style.direction="rtl")}_focusIn(){InputManager.isTextInputting=!0;var e=this.nativeInput;Input.input&&(Input.input.type=this._type),this._focus=!0;var t=e.style;t.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),e.readOnly=!this._editable,LayaEnv.isConch&&!Input.isAppUseNewInput&&(e.setType(this._type),e.setForbidEdit(!this._editable)),e.maxLength=this._maxChars<=0?1e5:this._maxChars,e.value=this._text,e.placeholder=this._prompt,ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.on(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.focus=this,this.event(Event.FOCUS),ILaya.Browser.onPC&&e.focus(),LayaEnv.isConch&&Input.isAppUseNewInput||ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onHWMiniGame||ILaya.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),e.setColor(this.color),e.setFontSize(this.fontSize),e.setFontFace(this._realFont),LayaEnv.isConch&&!Input.isAppUseNewInput&&e.setMultiAble&&e.setMultiAble(this._multiline),t.lineHeight=this.leading+this.fontSize+"px",t.fontStyle=this.italic?"italic":"normal",t.fontWeight=this.bold?"bold":"normal",t.textAlign=this.align,t.padding="0 0",this._syncInputTransform(),!LayaEnv.isConch&&ILaya.Browser.onPC&&ILaya.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){Input.promptStyleDOM=ILaya.Browser.getElementById("promptStyle"),Input.promptStyleDOM||(Input.promptStyleDOM=ILaya.Browser.createElement("style"),Input.promptStyleDOM.setAttribute("id","promptStyle"),ILaya.Browser.document.head.appendChild(Input.promptStyleDOM)),Input.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){InputManager.isTextInputting&&(InputManager.isiOSWKwebView||(InputManager.isTextInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.focus=null,this.event(Event.BLUR),this.event(Event.CHANGE),LayaEnv.isConch&&!Input.isAppUseNewInput&&this.nativeInput.blur(),ILaya.Browser.onPC&&ILaya.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(e){13===e.keyCode&&(ILaya.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(Event.ENTER))}miniGameTxt(e){e+="",this._multiline||(e=e.replace(/\r?\n/g,"")),this.text=e}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),this._focus?(this.nativeInput.value=e,this.event(Event.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),super.text=e)}get text(){return this._focus?this.nativeInput.value:super.text}set_color(e){this._focus&&this.nativeInput.setColor(e),super.set_color(e)}set bgColor(e){super.bgColor=e,LayaEnv.isConch&&!Input.isAppUseNewInput&&this.nativeInput.setBgColor(e)}get bgColor(){return super.bgColor}get restrict(){return this._restrict}set restrict(e){this._restrict=e,e?((e="[^"+e+"]").indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}set editable(e){this._editable=e,LayaEnv.isConch&&!Input.isAppUseNewInput&&Input.input.setForbidEdit(!e)}get editable(){return this._editable}get maxChars(){return this._maxChars}set maxChars(e){this._maxChars=e}get prompt(){return this._prompt}set prompt(e){var t;e=(null===(t=Text.langPacks)||void 0===t?void 0:t[e])||e,this._prompt!=e&&(this._prompt=e,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(e){this._promptColor!=e&&(this._promptColor=e,this.markChanged())}get type(){return this._type}set type(e){this._asPassword="password"===e,this._type=e}}Input.TYPE_TEXT="text",Input.TYPE_PASSWORD="password",Input.TYPE_EMAIL="email",Input.TYPE_URL="url",Input.TYPE_NUMBER="number",Input.TYPE_RANGE="range",Input.TYPE_DATE="date",Input.TYPE_MONTH="month",Input.TYPE_WEEK="week",Input.TYPE_TIME="time",Input.TYPE_DATE_TIME="datetime",Input.TYPE_DATE_TIME_LOCAL="datetime-local",Input.TYPE_SEARCH="search",Input.IOS_IFRAME=!1,Input.isAppUseNewInput=!1;class Widget extends Component{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=HideFlags.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(Event.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(Event.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(Event.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(Event.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var e=this.resetLayoutX(),t=this.resetLayoutY();(e||t)&&this.owner.event(Event.RESIZE)}resetLayoutX(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerX)e.x=Math.round(.5*(t.width-e.displayWidth)+this._centerX+e.pivotX*e.scaleX);else if(null!=this._left){if(e.x=Math.round(this._left+e.pivotX*e.scaleX),null!=this._right){if(!t._width)return!1;var r=(t._width-this._left-this._right)/(e.scaleX||.01);if(r!=e._width)return e.width=r,!0}}else null!=this._right&&(e.x=Math.round(t.width-e.displayWidth-this._right+e.pivotX*e.scaleX));return!1}resetLayoutY(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerY)e.y=Math.round(.5*(t.height-e.displayHeight)+this._centerY+e.pivotY*e.scaleY);else if(null!=this._top){if(e.y=Math.round(this._top+e.pivotY*e.scaleY),null!=this._bottom){if(!t._height)return!1;var r=(t._height-this._top-this._bottom)/(e.scaleY||.01);if(r!=e._height)return e.height=r,!0}}else null!=this._bottom&&(e.y=Math.round(t.height-e.displayHeight-this._bottom+e.pivotY*e.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(e){isNaN(e)&&(e=null),this._top!=e&&(this._top=e,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(e){isNaN(e)&&(e=null),this._bottom!=e&&(this._bottom=e,this.resetLayoutY())}get left(){return this._left}set left(e){isNaN(e)&&(e=null),this._left!=e&&(this._left=e,this.resetLayoutX())}get right(){return this._right}set right(e){isNaN(e)&&(e=null),this._right!=e&&(this._right=e,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(e){isNaN(e)&&(e=null),this._centerX!=e&&(this._centerX=e,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(e){isNaN(e)&&(e=null),this._centerY!=e&&(this._centerY=e,this.resetLayoutY())}}Widget.EMPTY=null,Widget.EMPTY=new Widget;const Ve=new Rectangle,We=new Point;class HitArea{contains(e,t,r){return!!HitArea._isHitGraphic(e,t,r,this._hit)&&!HitArea._isHitGraphic(e,t,r,this._unHit)}static _isHitGraphic(e,t,r,i){if(!i)return!1;let a=i.cmds;if(0==a.length)return!1;let s=a.length;for(let i=0;i<s;i++){let s=a[i];if(s){if("Translate"===s.cmdID)e-=s.tx,t-=s.ty;if(HitArea._isHitCmd(e,t,r,s))return!0}}return!1}static _isHitCmd(e,t,r,i){if(!i)return!1;var a=!1;switch(i.cmdID){case"DrawRect":i.percent?Ve.setTo(i.x*r.width,i.y*r.height,i.width*r.width,i.height*r.height):Ve.setTo(i.x,i.y,i.width,i.height),a=Ve.contains(e,t);break;case"DrawCircle":let s=i.radius;i.percent?(e-=i.x*r.width,t-=i.y*r.height,s*=r.width):(e-=i.x,t-=i.y),a=e*e+t*t<s*s;break;case"DrawPoly":e-=i.x,t-=i.y,a=HitArea._ptInPolygon(e,t,i.points)}return a}static _ptInPolygon(e,t,r){var i=We;i.setTo(e,t);var a,s,n,o,l,h=0;l=r.length;for(var u=0;u<l;u+=2){if(a=r[u],s=r[u+1],n=r[(u+2)%l],s!=(o=r[(u+3)%l]))if(!(i.y<Math.min(s,o)))if(!(i.y>=Math.max(s,o)))(i.y-s)*(n-a)/(o-s)+a>i.x&&h++}return h%2==1}get hit(){return this._hit||(this._hit=new Graphics),this._hit}set hit(e){this._hit=e}get unHit(){return this._unHit||(this._unHit=new Graphics),this._unHit}set unHit(e){this._unHit=e}onAfterDeserialize(){LayaEnv.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}ClassUtils.regClass("HitArea",HitArea);class WeakObject{static __init__(){WeakObject.I=new WeakObject,WeakObject.supportWeakMap||ILaya.systemTimer.loop(WeakObject.delInterval,null,WeakObject.clearCache)}static clearCache(){for(var e=0,t=WeakObject._maps.length;e<t;e++){WeakObject._maps[e]._obj={}}}constructor(){this._obj={},WeakObject._maps.push(this)}set(e,t){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?this._obj[e]=t:(e.$_GID||(e.$_GID=Utils.getGID()),this._obj[e.$_GID]=t)))}get(e){return null==e?null:WeakObject.supportWeakMap?void 0:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[e.$_GID]}del(e){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[this._obj.$_GID]))}has(e){return null!=e&&(!WeakObject.supportWeakMap&&("string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[this._obj.$_GID]))}}WeakObject.supportWeakMap=!1,WeakObject.delInterval=6e5,WeakObject._maps=[];class Prefab extends Resource{constructor(e){super(),this.version=e,this._deps=[]}create(e,t){return this.json?LegacyUIParser.createByData(null,this.json):null}get deps(){return this._deps}addDep(e){e instanceof Resource&&(e._addReference(),this._deps.push(e),!LayaEnv.isPlaying&&e instanceof Prefab&&e.on("obsolute",this,this.onDepObsolute))}addDeps(e){for(let t of e)t instanceof Resource&&(t._addReference(),this._deps.push(t),!LayaEnv.isPlaying&&t instanceof Prefab&&t.on("obsolute",this,this.onDepObsolute))}_disposeResource(){for(let e of this._deps)e._removeReference(),!LayaEnv.isPlaying&&e instanceof Prefab&&e.off("obsolute",this,this.onDepObsolute)}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute!=e&&(this._obsolute=e,e&&!LayaEnv.isPlaying&&this.event("obsolute"))}onDepObsolute(){this.obsolute=!0}}var He,Xe,ze=Prefab;class PrefabImpl extends Prefab{constructor(e,t,r){super(r),this.api=e,this.data=t}create(e,t){let r=this.api.parse(this.data,e,t);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}class LegacyUIParser{static parse(e,t){let r=null==t?void 0:t.root;if(!r){let t=LayaEnv.isPlaying&&e.props.runtime?e.props.runtime:e.type,i=ClassUtils.getClass(t);r="instance"==e.props.renderType?i.instance||(i.instance=new i):new i}return r&&r._viewCreated?r:LegacyUIParser.createByData(r,e)}static getBindFun(e){let t=LegacyUIParser._funMap;t||(t=LegacyUIParser._funMap=new WeakObject);var r=LegacyUIParser._funMap.get(e);if(null==r){var i='"'+e+'"',a="(function(data){if(data==null)return;with(data){try{\nreturn "+(i=i.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";r=window.Laya._runScript(a),LegacyUIParser._funMap.set(e,r)}return r}static createByData(e,t){var r=InitTool.create();if("_idMap"in(e=LegacyUIParser.createComp(t,e,e,null,r))&&(e._idMap=r._idMap),t.animations){var i,a,s,n=[],o=t.animations,l=o.length;for(i=0;i<l;i++){switch(a=new FrameAnimation,s=o[i],a._setUp(r._idMap,s),e[s.name]=a,a._setControlNode(e),s.action){case 1:a.play(0,!1);break;case 2:a.play(0,!0)}n.push(a)}e._aniList=n}return e instanceof Scene&&e._width>0&&null==t.props.hitTestPrior&&!e.mouseThrough&&(e.hitTestPrior=!0),r.finish(),e._setBit(NodeFlags.NOT_READY,!1),e.parent&&e.parent.activeInHierarchy&&e.active&&e._processActive(!0),e}static createInitTool(){return InitTool.create()}static createComp(e,t=null,r=null,i=null,a=null){if(!(t=t||LegacyUIParser.getCompInstance(e)))return e.props&&e.props.runtime?console.warn("runtime not found:"+e.props.runtime):console.warn("can not create:"+e.type),null;var s=e.child;if(s)for(var n=t instanceof(He||(He=ClassUtils.getClass("List"))),o=0,l=s.length;o<l;o++){var h=s[o];if(!("itemRender"in t)||"render"!=h.props.name&&"render"!==h.props.renderType)if("Graphic"==h.type)this._addGraphicsToSprite(h,t);else if(this._isDrawType(h.type))this._addGraphicToSprite(h,t,!0);else{if(n){var u=[],d=LegacyUIParser.createComp(h,null,r,u,a);u.length&&(d._$bindData=u)}else d=LegacyUIParser.createComp(h,null,r,i,a);"Script"==h.type?d instanceof Component?t.addComponentInstance(d):"owner"in d?d.owner=t:"target"in d&&(d.target=t):"mask"==h.props.renderType||"mask"==h.props.name?t.mask=d:d instanceof Node&&t.addChild(d)}else t.itemRender=h}var _=e.props;for(var c in _){var m=_[c];"string"==typeof m&&(m.indexOf("@node:")>=0||m.indexOf("@Prefab:")>=0)?a&&a.addNodeRef(t,c,m):LegacyUIParser.setCompValue(t,c,m,r,i)}return t._afterInited&&t._afterInited(),e.compId&&a&&a._idMap&&(a._idMap[e.compId]=t),t}static setCompValue(e,t,r,i=null,a=null){if("string"==typeof r&&r.indexOf("${")>-1){if(LegacyUIParser._sheet||(LegacyUIParser._sheet=ClassUtils.getClass("laya.data.Table")),!LegacyUIParser._sheet)return void console.warn("Can not find class Sheet");if(a)a.push(e,t,r);else if(i){-1==r.indexOf("].")&&(r=r.replace(".","[0]."));var s,n,o=new DataWatcher(e,t,r);o.exe(i);for(var l=r.replace(/\[.*?\]\./g,".");null!=(s=LegacyUIParser._parseWatchData.exec(l));){for(var h=s[1];null!=(n=LegacyUIParser._parseKeyWord.exec(h));){var u=n[0],d=i._watchMap[u]||(i._watchMap[u]=[]);d.push(o),LegacyUIParser._sheet.I.notifer.on(u,i,i.changeData,[u])}(d=i._watchMap[h]||(i._watchMap[h]=[])).push(o),LegacyUIParser._sheet.I.notifer.on(h,i,i.changeData,[h])}}}else"var"===t&&i?i[r]=e:e[t]="true"===r||"false"!==r&&r}static getCompInstance(e){if("UIView"==e.type&&e.props&&e.props.pageData)return LegacyUIParser.createByData(null,e.props.pageData);var t=LayaEnv.isPlaying&&e.props&&e.props.runtime||e.type,r=ClassUtils.getClass(t);if(!r)throw"Can not find class "+t;if("Script"===e.type&&r.prototype._doAwake){var i=Pool.createByClass(r);return i._destroyed=!1,i}if(e.props&&"renderType"in e.props&&"instance"==e.props.renderType)return r.instance||(r.instance=new r),r.instance;let a=new r;return a instanceof(Xe||(Xe=ClassUtils.getClass("View")))&&(a._scene=a),a}static collectResourceLinks(e){let t=new Set,r=[];function addInnerUrl(e){t.has(e)||(t.add(e),r.push(e))}if(e.loadList)for(let t of e.loadList)addInnerUrl(t);if(e.loadList3D)for(let t of e.loadList3D)addInnerUrl(t);return function check(e){let t=e.props;for(let e in t){let r=t[e];if("string"==typeof r&&r.indexOf("@Prefab:")>=0){addInnerUrl(r.replace("@Prefab:",""))}}let r=e.child;if(r)for(let e=0,t=r.length;e<t;e++){check(r[e])}}(e),r}static createByJson(e,t=null,r=null,i=null,a=null){"string"==typeof e&&(e=JSON.parse(e));var s=e.props;if(!t&&!(t=a?a.runWith(e):ClassUtils.getInstance(LayaEnv.isPlaying&&s.runtime||e.type)))return null;var n=e.child;if(n)for(var o=0,l=n.length;o<l;o++){var h=n[o];if("render"!==h.props.name&&"render"!==h.props.renderType||!t._$set_itemRender)if("Graphic"==h.type)this._addGraphicsToSprite(h,t);else if(this._isDrawType(h.type))this._addGraphicToSprite(h,t,!0);else{var u=this.createByJson(h,null,r,i,a);"Script"===h.type?"owner"in u?u.owner=t:"target"in u&&(u.target=t):"mask"==h.props.renderType?t.mask=u:t.addChild(u)}else t.itemRender=h}if(s)for(var d in s){var _=s[d];"var"===d&&r?r[_]=t:_ instanceof Array&&t[d]instanceof Function?t[d].apply(t,_):t[d]=_}return i&&e.customProps&&i.runWith([t,e]),t.created&&t.created(),t}static _addGraphicsToSprite(e,t){var r=e.child;if(r&&!(r.length<1)){var i,a,s=this._getGraphicsFromSprite(e,t),n=0,o=0;for(e.props&&(n=this._getObjVar(e.props,"x",0),o=this._getObjVar(e.props,"y",0)),0!=n&&0!=o&&s.translate(n,o),a=r.length,i=0;i<a;i++)this._addGraphicToGraphics(r[i],s);0!=n&&0!=o&&s.translate(-n,-o)}}static _addGraphicToSprite(e,t,r=!1){var i=r?this._getGraphicsFromSprite(e,t):t.graphics;this._addGraphicToGraphics(e,i)}static _getGraphicsFromSprite(e,t){if(!e||!e.props)return t.graphics;var r=e.props.renderType;if("hit"===r||"unHit"===r){var i=t._style.hitArea||(t.hitArea=new HitArea);i[r]||(i[r]=new Graphics);var a=i[r]}return a||(a=t.graphics),a}static _getTransformData(e){var t;("pivotX"in e||"pivotY"in e)&&(t=t||new Matrix).translate(-this._getObjVar(e,"pivotX",0),-this._getObjVar(e,"pivotY",0));var r=this._getObjVar(e,"scaleX",1),i=this._getObjVar(e,"scaleY",1),a=this._getObjVar(e,"rotation",0);return this._getObjVar(e,"skewX",0),this._getObjVar(e,"skewY",0),1==r&&1==i&&0==a||((t=t||new Matrix).scale(r,i),t.rotate(.0174532922222222*a)),t}static _addGraphicToGraphics(e,t){var r,i;if((r=e.props)&&(i=this.DrawTypeDic[e.type])){var a=t,s=this._getParams(r,i[1],i[2],i[3]),n=this._tM;(n||1!=this._alpha)&&(a.save(),n&&a.transform(n),1!=this._alpha&&a.alpha(this._alpha)),a[i[0]].apply(a,s),(n||1!=this._alpha)&&a.restore()}}static _adptLineData(e){return e[2]=parseFloat(e[0])+parseFloat(e[2]),e[3]=parseFloat(e[1])+parseFloat(e[3]),e}static _adptTextureData(e){return e[0]=ILaya.Loader.getRes(e[0]),e}static _adptLinesData(e){return e[2]=this._getPointListByStr(e[2]),e}static _isDrawType(e){return"Image"!==e&&e in this.DrawTypeDic}static _getParams(e,t,r=0,i=null){var a,s,n,o=this._temParam;for(o.length=t.length,s=t.length,a=0;a<s;a++)o[a]=this._getObjVar(e,t[a][0],t[a][1]);return this._alpha=this._getObjVar(e,"alpha",1),(n=this._getTransformData(e))?(r||(r=0),n.translate(o[r],o[r+1]),o[r]=o[r+1]=0,this._tM=n):this._tM=null,i&&this[i]&&(o=this[i](o)),o}static _getPointListByStr(e){var t,r,i=e.split(",");for(r=i.length,t=0;t<r;t++)i[t]=parseFloat(i[t]);return i}static _getObjVar(e,t,r){return t in e?e[t]:r}}LegacyUIParser._parseWatchData=/\${(.*?)}/g,LegacyUIParser._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g,LegacyUIParser.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]},LegacyUIParser._temParam=[];class DataWatcher{constructor(e,t,r){this.comp=e,this.prop=t,this.value=r}exe(e){var t=LegacyUIParser.getBindFun(this.value);this.comp[this.prop]=t.call(this,e)}}class InitTool{reset(){this._nodeRefList=null,this._initList=null,this._idMap=null}recover(){this.reset(),Pool.recover("InitTool",this)}static create(){var e=Pool.getItemByClass("InitTool",InitTool);return e._idMap={},e}addNodeRef(e,t,r){this._nodeRefList||(this._nodeRefList=[]),this._nodeRefList.push([e,t,r])}setNodeRef(){if(this._nodeRefList)if(this._idMap){var e,t,r;for(t=this._nodeRefList.length,e=0;e<t;e++)(r=this._nodeRefList[e])[0][r[1]]=this.getReferData(r[2]);this._nodeRefList=null}else this._nodeRefList=null}getReferData(e){if(e.indexOf("@Prefab:")>=0)return new PrefabImpl(LegacyUIParser,Loader.getRes(e.replace("@Prefab:","")),2);if(e.indexOf("@arr:")>=0){var t,r,i,a;i=(t=(e=e.replace("@arr:","")).split(",")).length;var s=[];for(r=0;r<i;r++)(a=t[r])?s.push(this._idMap[a.replace("@node:","")]):s.push(null);return s}return this._idMap[e.replace("@node:","")]}addInitItem(e){this._initList||(this._initList=[]),this._initList.push(e)}doInits(){this._initList&&(this._initList=null)}finish(){this.setNodeRef(),this.doInits(),this.recover()}}class Scene extends Sprite{constructor(e=!0){super(),this.autoDestroyAtClosed=!1,this._viewCreated=!1,this._timer=ILaya.timer,this._widget=Widget.EMPTY,this._scene=this,e&&this.createChildren()}createChildren(){}static setUIMap(e){let t=ILaya.loader.getRes(e);if(!t)throw"请提前加载uimap的json，再使用该接口设置！";for(let e in t)ILaya.Loader.loadedMap[e+".scene"]=t[e]}loadScene(e){Scene.unDestroyedScenes.add(this);let t=e.indexOf(".")>-1?e:e+".scene",r=ILaya.loader.getRes(t);r?this._viewCreated||(r.create({root:this}),this._viewCreated=!0,Scene.unDestroyedScenes.add(this)):(this._setBit(NodeFlags.NOT_READY,!0),ILaya.loader.load(t,null,(e=>{Scene._loadPage&&Scene._loadPage.event("progress",e)})).then((r=>{if(!r)throw"Can not find scene:"+e;this._viewCreated?this._setBit(NodeFlags.NOT_READY,!1):(this.url=t,Scene.hideLoadingPage(),r.create({root:this}),this._viewCreated=!0,Scene.unDestroyedScenes.add(this))})))}createView(e){e&&!this._viewCreated&&(this._viewCreated=!0,LegacyUIParser.createByData(this,e))}getNodeByID(e){return this._idMap?this._idMap[e]:null}open(e=!0,t=null){e&&Scene.closeAll(),Scene.root.addChild(this),this._scene3D&&ILaya.stage.addChildAt(this._scene3D,0),this.onOpened(t)}onOpened(e){}close(e=null){this.onClosed(e),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(e=null){}destroy(e=!0){super.destroy(e),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,Scene.unDestroyedScenes.delete(this)}get_width(){if(this._isWidthSet)return this._width;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._x+r.width*r.scaleX,e))}return e}get_height(){if(this._isHeightSet)return this._height;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._y+r.height*r.scaleY,e))}return e}get timer(){return this._timer}set timer(e){this._timer=e}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}_shouldRefreshLayout(){super._shouldRefreshLayout(),this.callLater(this._sizeChanged)}_sizeChanged(){this.event(Event.RESIZE),this._widget!==Widget.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=Widget.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===Widget.EMPTY&&(this._widget=this.addComponent(Widget)),this._widget}static get root(){let e=Scene._root;return e||(e=Scene._root=ILaya.stage.addChild(new Sprite),e.name="root",e.mouseThrough=!0,ILaya.stage.on("resize",null,(()=>{e.size(ILaya.stage.width,ILaya.stage.height),e.event(Event.RESIZE)})),e.size(ILaya.stage.width,ILaya.stage.height),e.event(Event.RESIZE)),e}static load(e,t=null,r=null){return ILaya.loader.load(e,null,(e=>{Scene._loadPage&&Scene._loadPage.event("progress",e),r&&r.runWith(e)})).then((r=>{if(!r)throw"Can not find scene:"+e;let i,a=[],s=r.create(null,a);if(a.length>0&&console.warn(`Error loading ${e}: \n${a.join("\n")}`),s instanceof Scene)i=s;else{if(!s._is3D)throw"Not a scene:"+e;i=new Scene,i.left=i.right=i.top=i.bottom=0,i._scene3D=s}return i._viewCreated=!0,Scene.unDestroyedScenes.add(i),Scene.hideLoadingPage(),t&&t.runWith(i),i}))}static open(e,t=!0,r=null,i=null,a=null){if(r instanceof Handler){var s=i;i=r,r=s}return Scene.showLoadingPage(),Scene.load(e,Handler.create(null,this._onSceneLoaded,[t,i,r]),a)}static _onSceneLoaded(e,t,r,i){i.open(e,r),t&&t.runWith(i)}static close(e,t){let r=!1;for(let i of Scene.unDestroyedScenes)if(i&&i.parent&&i.url===e&&(null==t||i.name==t)){i.close(),r=!0;break}return r}static closeAll(){let e=Scene.root;for(let r=0,i=e.numChildren;r<i;r++){var t=e.getChildAt(0);t instanceof Scene?t.close():t.removeSelf()}}static destroy(e,t){let r=!1;for(let i of Scene.unDestroyedScenes)if(i.url===e&&(null==t||i.name==t)&&!i._destroyed){i.destroy(),r=!0;break}return r}static gc(){Resource.destroyUnusedResources()}static setLoadingPage(e){Scene._loadPage=e}static showLoadingPage(e=null,t=500){Scene._loadPage&&(ILaya.systemTimer.clear(null,Scene._showLoading),ILaya.systemTimer.clear(null,Scene._hideLoading),ILaya.systemTimer.once(t,null,Scene._showLoading,[e],!1))}static _showLoading(e){ILaya.stage.addChild(Scene._loadPage),Scene._loadPage instanceof Scene&&Scene._loadPage.onOpened(e)}static _hideLoading(){Scene._loadPage instanceof Scene?Scene._loadPage.close():Scene._loadPage.removeSelf()}static hideLoadingPage(e=500){Scene._loadPage&&(ILaya.systemTimer.clear(null,Scene._showLoading),ILaya.systemTimer.clear(null,Scene._hideLoading),ILaya.systemTimer.once(e,null,Scene._hideLoading))}}Scene.unDestroyedScenes=new Set;class Timer{constructor(e=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,e&&Timer.gSysTimer&&Timer.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var e=this.currFrame=this.currFrame+this.scale,t=this._getNowData(),r=t-this._lastTimer>3e4;this._delta=(t-this._lastTimer)*this.scale;var i=this.currTimer=this.currTimer+this._delta;this._lastTimer=t;var a=this._handlers;this._count=0;for(var s=0,n=a.length;s<n;s++){var o=a[s];if(null!==o.method){var l=o.userFrame?e:i;if(l>=o.exeTime)if(o.repeat)if(!o.jumpFrame||r)o.exeTime+=o.delay,o.run(!1),l>o.exeTime&&(o.exeTime+=Math.ceil((l-o.exeTime)/o.delay)*o.delay);else for(;l>=o.exeTime;)o.exeTime+=o.delay,o.run(!1);else o.run(!0)}else this._count++}(this._count>30||e%200==0)&&this._clearHandlers()}_clearHandlers(){for(var e=this._handlers,t=0,r=e.length;t<r;t++){var i=e[t];null!==i.method?this._temp.push(i):this._recoverHandler(i)}this._handlers=this._temp,e.length=0,this._temp=e}_recoverHandler(e){this._map[e.key]==e&&delete this._map[e.key],e.clear(),Timer._pool.push(e)}_getNowData(){return Date.now()}_create(e,t,r,i,a,s,n){if(!r)return a.apply(i,s),null;if(n){var o=this._getHandler(i,a);if(o)return o.repeat=t,o.userFrame=e,o.delay=r,o.caller=i,o.method=a,o.args=s,o.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),o}return(o=Timer._pool.length>0?Timer._pool.pop():new TimerHandler).repeat=t,o.userFrame=e,o.delay=r,o.caller=i,o.method=a,o.args=s,o.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(o),this._handlers.push(o),o}_indexHandler(e){var t=e.caller,r=e.method,i=t?t.$_GID||(t.$_GID=Utils.getGID()):0,a=r.$_TID||(r.$_TID=Timer._mid++);e.key=i+"_"+a,this._map[e.key]=e}once(e,t,r,i=null,a=!0){this._create(!1,!1,e,t,r,i,a)}loop(e,t,r,i=null,a=!0,s=!1){var n=this._create(!1,!0,e,t,r,i,a);n&&(n.jumpFrame=s)}frameOnce(e,t,r,i=null,a=!0){this._create(!0,!1,e,t,r,i,a)}frameLoop(e,t,r,i=null,a=!0){this._create(!0,!0,e,t,r,i,a)}toString(){return" handlers:"+this._handlers.length+" pool:"+Timer._pool.length}clear(e,t){var r=this._getHandler(e,t);r&&r.clear()}clearAll(e){if(e)for(var t=0,r=this._handlers.length;t<r;t++){var i=this._handlers[t];i.caller===e&&i.clear()}}_getHandler(e,t){var r=(e?e.$_GID||(e.$_GID=Utils.getGID()):0)+"_"+(t.$_TID||(t.$_TID=Timer._mid++));return this._map[r]}callLater(e,t,r=null){CallLater.I.callLater(e,t,r)}runCallLater(e,t){CallLater.I.runCallLater(e,t)}clearCallLater(e,t){CallLater.I.clear(e,t)}runTimer(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var e=0,t=this._handlers.length;e<t;e++){this._handlers[e].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}Timer.gSysTimer=null,Timer._pool=[],Timer._mid=1;class TimerHandler{clear(){this.caller=null,this.method=null,this.args=null}run(e){var t=this.caller;if(t&&t.destroyed)return this.clear();var r=this.method,i=this.args;e&&this.clear(),null!=r&&(i?r.apply(t,i):r.call(t))}}class CallLater{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let e=this._laters,t=e.length;if(t>0){for(let r=0,i=t-1;r<=i;r++){let t=e[r];this._map[t.key]=null,null!==t.method&&(t.run(),t.clear()),this._pool.push(t),r===i&&(i=e.length-1)}e.length=0}}_getHandler(e,t){var r=e?e.$_GID||(e.$_GID=Utils.getGID()):0,i=t.$_TID||(t.$_TID=Timer._mid++);return this._map[r+"."+i]}callLater(e,t,r=null){if(null==this._getHandler(e,t)){let s;s=this._pool.length?this._pool.pop():new LaterHandler,s.caller=e,s.method=t,s.args=r;var i=e?e.$_GID:0,a=t.$_TID;s.key=i+"."+a,this._map[s.key]=s,this._laters.push(s)}}runCallLater(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(),r.clear())}clear(e,t){var r=this._getHandler(e,t);return!!r&&(this._map[r.key]=null,r.key="",r.clear(),!0)}clearAll(e){if(e)for(var t=0,r=this._laters.length;t<r;t++){var i=this._laters[t];i.caller===e&&(this._map[i.key]=null,i.key="",i.clear())}}}CallLater.I=new CallLater;class LaterHandler{clear(){this.caller=null,this.method=null,this.args=null}run(){var e=this.caller;if(e&&e.destroyed)return this.clear();var t=this.method,r=this.args;null!=t&&(r?t.apply(e,r):t.call(e))}}class WebGL{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(e,t){LayaGL.renderEngine.viewport(0,0,e,t),RenderState2D.width=e,RenderState2D.height=t}}WebGL.isNativeRender_enable=!1;class RunDriver{}RunDriver.createShaderCondition=function(e){var t="(function() {return "+e+";})";return window.Laya._runScript(t)},RunDriver.changeWebGLSize=function(e,t){WebGL.onStageResize(e,t)};class ComponentDriver{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let e of this._toStarts)if(2==e._status){e._status=3;try{e.onStart()}catch(e){console.log(e)}}this._toStarts.clear()}callUpdate(){for(let e of this._onUpdates)if(3==e._status)try{e.onUpdate()}catch(e){console.log(e)}}callLateUpdate(){for(let e of this._onLateUpdates)if(3==e._status)try{e.onLateUpdate()}catch(e){console.log(e)}}callPreRender(){for(let e of this._onPreRenders)if(3==e._status)try{e.onPreRender()}catch(e){console.log(e)}}callPostRender(){for(let e of this._onPostRenders)if(3==e._status)try{e.onPostRender()}catch(e){console.log(e)}}callDestroy(){for(let e of this._toDestroys)try{e._destroy(!0)}catch(e){console.log(e)}this._toDestroys.clear()}add(e){1==e._status&&(e.onStart?(e._status=2,this._toStarts.add(e)):e._status=3),e.onUpdate&&this._onUpdates.add(e),e.onLateUpdate&&this._onLateUpdates.add(e),e.onPreRender&&this._onPreRenders.add(e),e.onPostRender&&this._onPostRenders.add(e)}remove(e){2==e._status&&(e._status=1),e.onUpdate&&this._onUpdates.delete(e),e.onLateUpdate&&this._onLateUpdates.delete(e),e.onPreRender&&this._onPreRenders.delete(e),e.onPostRender&&this._onPostRenders.delete(e)}destroy(){}}class Stage extends Sprite{constructor(){super(),this.offset=new Point,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new Matrix,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="black",this._mouseMoveTime=0,this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=Browser.window.orientation,this._wgColor=[0,0,0,1],this._scene3Ds=[],this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(NodeFlags.DISPLAYED_INSTAGE,!0),this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=Config.useRetinalCanvas;var e=Browser.window;e.addEventListener("focus",(()=>{this._isFocused=!0,this.event(Event.FOCUS),this.event(Event.FOCUS_CHANGE)})),e.addEventListener("blur",(()=>{this._isFocused=!1,this.event(Event.BLUR),this.event(Event.FOCUS_CHANGE),this._isInputting()&&(Input.inputElement.target.focus=!1)}));var t="visibilityState",r="visibilitychange",i=e.document;void 0!==i.hidden?(r="visibilitychange",t="visibilityState"):void 0!==i.mozHidden?(r="mozvisibilitychange",t="mozVisibilityState"):void 0!==i.msHidden?(r="msvisibilitychange",t="msVisibilityState"):void 0!==i.webkitHidden&&(r="webkitvisibilitychange",t="webkitVisibilityState"),e.document.addEventListener(r,(()=>{"hidden"==Browser.document[t]?(this._isVisibility=!1,this._isInputting()&&(Input.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(Event.VISIBILITY_CHANGE)})),e.addEventListener("resize",(()=>{var e=Browser.window.orientation;null!=e&&e!=this._previousOrientation&&this._isInputting()&&(Input.inputElement.target.focus=!1),this._previousOrientation=e,this._isInputting()||(Browser.onSafari&&(this._safariOffsetY=(Browser.window.__innerHeight||Browser.document.body.clientHeight||Browser.document.documentElement.clientHeight)-Browser.window.innerHeight),this.screenAdaptationEnabled&&(this.event(Event.WILL_RESIZE),this.updateCanvasSize()))})),e.addEventListener("orientationchange",(e=>{this.screenAdaptationEnabled&&(this.event(Event.WILL_RESIZE),this.updateCanvasSize())})),this._componentDriver=new ComponentDriver}_isInputting(){return Browser.onMobile&&InputManager.isTextInputting}set_width(e){this.designWidth=e,super.set_width(e),this.updateCanvasSize(!0)}get_width(){return this.needUpdateCanvasSize(),super.get_width()}set_height(e){this.designHeight=e,super.set_height(e),this.updateCanvasSize(!0)}get_height(){return this.needUpdateCanvasSize(),super.get_height()}set transform(e){super.set_transform(e)}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(e){e?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,ILaya.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(Browser.clientWidth*Browser.pixelRatio,Browser.clientHeight*Browser.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(e,t){this._needUpdateCanvasSize=!1;var r=!1;if(this._screenMode!==Stage.SCREEN_NONE&&(r=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==this._screenMode)){var i=t;t=e,e=i}this.canvasRotation=r;var a=Render._mainCanvas,s=a.source.style,n=this._canvasTransform.identity(),o=this._scaleMode,l=e/this.designWidth,h=t/this.designHeight,u=this.useRetinalCanvas?e:this.designWidth,d=this.useRetinalCanvas?t:this.designHeight,_=e,c=t,m=Browser.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,o){case Stage.SCALE_NOSCALE:l=h=1,_=this.designWidth,c=this.designHeight;break;case Stage.SCALE_SHOWALL:l=h=Math.min(l,h),u=_=Math.round(this.designWidth*l),d=c=Math.round(this.designHeight*h);break;case Stage.SCALE_NOBORDER:l=h=Math.max(l,h),_=Math.round(this.designWidth*l),c=Math.round(this.designHeight*h);break;case Stage.SCALE_FULL:l=h=m,u=e,d=t,this._width=e/m,this._height=t/m;break;case Stage.SCALE_FIXED_WIDTH:h=l,this._height=d=Math.round(t/l);break;case Stage.SCALE_FIXED_HEIGHT:l=h,this._width=u=Math.round(e/h);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(h=l,this._height=d=Math.round(t/l)):(l=h,this._width=u=Math.round(e/h));break;case Stage.SCALE_FIXED_AUTO_LAYAME:e<t?(h=l,this._height=d=Math.round(t/l)):(h=l=t/this.designWidth,this._width=u=Math.round(e/l),this._height=d=Math.round(t/h));break;case Stage.SCALE_FIXED_AUTO_LAYAVERSE:e>t?(l=h,this._width=u=Math.round(e/h)):(h=l=e/this.designHeight,this._width=u=Math.round(e/l),this._height=d=Math.round(t/h))}this.useRetinalCanvas&&(_=u=e,c=d=t),l*=this.scaleX,h*=this.scaleY,1===l&&1===h?this.transform.identity():(this.transform.a=this._formatData(l/(_/u)),this.transform.d=this._formatData(h/(c/d))),a.size(u,d),RunDriver.changeWebGLSize(u,d),n.scale(_/u/m,c/d/m),this._alignH===Stage.ALIGN_LEFT?this.offset.x=0:this._alignH===Stage.ALIGN_RIGHT?this.offset.x=e-_:this.offset.x=.5*(e-_)/m,this._alignV===Stage.ALIGN_TOP?this.offset.y=0:this._alignV===Stage.ALIGN_BOTTOM?this.offset.y=t-c:this.offset.y=.5*(t-c)/m,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),n.translate(this.offset.x,this.offset.y),this._safariOffsetY&&n.translate(0,this._safariOffsetY),this.canvasDegree=0,r&&(this._screenMode===Stage.SCREEN_HORIZONTAL?(n.rotate(Math.PI/2),n.translate(t/m,0),this.canvasDegree=90):(n.rotate(-Math.PI/2),n.translate(0,e/m),this.canvasDegree=-90)),n.a=this._formatData(n.a),n.d=this._formatData(n.d),n.tx=this._formatData(n.tx),n.ty=this._formatData(n.ty),super.set_transform(this.transform),s.transformOrigin=s.webkitTransformOrigin=s.msTransformOrigin=s.mozTransformOrigin=s.oTransformOrigin="0px 0px 0px",s.transform=s.webkitTransform=s.msTransform=s.mozTransform=s.oTransform="matrix("+n.toString()+")",s.width=u,s.height=d,this._safariOffsetY&&n.translate(0,-this._safariOffsetY),n.translate(parseInt(s.left)||0,parseInt(s.top)||0),this.visible=!0,this._repaint|=SpriteConst.REPAINT_CACHE,this.event(Event.RESIZE)}setScreenSizeForScene(e,t,r){var i=!1;if(r!==Stage.SCREEN_NONE&&(i=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==r)){var a=t;t=e,e=a}this.canvasRotation=i,Render._mainCanvas.source.style,this._canvasTransform.clone().identity();var s=this._scaleMode,n=e/this.designWidth,o=t/this.designHeight,l=this.useRetinalCanvas?e:this.designWidth,h=this.useRetinalCanvas?t:this.designHeight,u=e,d=t;Browser.pixelRatio;let _=this.designWidth,c=this.designHeight;switch(s){case Stage.SCALE_NOSCALE:n=o=1,u=this.designWidth,d=this.designHeight;break;case Stage.SCALE_SHOWALL:n=o=Math.min(n,o),l=u=Math.round(this.designWidth*n),h=d=Math.round(this.designHeight*o);break;case Stage.SCALE_NOBORDER:n=o=Math.max(n,o),u=Math.round(this.designWidth*n),d=Math.round(this.designHeight*o);break;case Stage.SCALE_FULL:n=o=1,_=l=e,c=h=t;break;case Stage.SCALE_FIXED_WIDTH:o=n,c=h=Math.round(t/n);break;case Stage.SCALE_FIXED_HEIGHT:n=o,_=l=Math.round(e/o);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(o=n,c=h=Math.round(t/n)):(n=o,_=l=Math.round(e/o))}return this.useRetinalCanvas&&(u=l=e,d=h=t),{stageWidth:_,stageHeight:c,canvasWidth:l,canvasHeight:h,scaleX:n/(u/l),scaleY:o/(d/h)}}_formatData(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}get scaleMode(){return this._scaleMode}set scaleMode(e){this._scaleMode=e,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(e){this._alignH=e,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(e){this._alignV=e,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this._wgColor=e?ColorUtils.create(e).arrColor:null,Render.canvas.style.background=e||"none"}get mouseX(){return Math.round(InputManager.mouseX/this.clientScaleX)}get mouseY(){return Math.round(InputManager.mouseY/this.clientScaleY)}getMousePoint(){return Point.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(e){this._screenMode=e}repaint(e=SpriteConst.REPAINT_CACHE){this._repaint|=e}parentRepaint(e=SpriteConst.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(Render._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return Browser.now()-this._frameStartTime}set visible(e){this.visible!==e&&(super.set_visible(e),Render._mainCanvas.source.style.visibility=e?"visible":"hidden")}get visible(){return super.visible}render(e,t,r){if(LayaEnv.isConch)return void this.renderToNative(e,t,r);let i=ILaya.timer._delta/1e3;if(this._frameRate===Stage.FRAME_SLEEP){var a=Browser.now();if(a-this._frameStartTime<1e3)return;this._frameStartTime=a}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=Browser.now(),RenderInfo.loopStTm=this._frameStartTime}this._renderCount++;var s=(this._frameRate===Stage.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Stage.FRAME_FAST:Stage.FRAME_SLOW:this._frameRate)!==Stage.FRAME_SLOW,n=this._renderCount%2==0;if(Stat.renderSlow=!s,s||n){if(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update(i);this._runComponents(),e.clear(),this._componentDriver.callPreRender(),super.render(e,t,r),Stat._StatRender.renderNotCanvas(e,t,r),Stage.clear(this._bgColor),e.flush(),this._componentDriver.callPostRender(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()}else this._runComponents();this._updateTimers()}}renderToNative(e,t,r){if(this._renderCount++,this._visible){if(this._frameStartTime=Browser.now(),CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._runComponents(),this._componentDriver.callPreRender(),e.clear(),super.render(e,t,r),Stat._StatRender.renderNotCanvas(e,t,r),this._componentDriver.callPostRender()}else this._runComponents();this.renderingEnabled&&(Stage.clear(this._bgColor),e.flush(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()),this._updateTimers()}else this._renderCount%5==0&&(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this._runComponents(),this._updateTimers())}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){ILaya.systemTimer._update(),ILaya.physicsTimer._update(),ILaya.timer._update()}set fullScreenEnabled(e){var t=Browser.document,r=Render.canvas;e?(r.addEventListener("mousedown",this._requestFullscreen),r.addEventListener("touchstart",this._requestFullscreen),t.addEventListener("fullscreenchange",this._fullScreenChanged),t.addEventListener("mozfullscreenchange",this._fullScreenChanged),t.addEventListener("webkitfullscreenchange",this._fullScreenChanged),t.addEventListener("msfullscreenchange",this._fullScreenChanged)):(r.removeEventListener("mousedown",this._requestFullscreen),r.removeEventListener("touchstart",this._requestFullscreen),t.removeEventListener("fullscreenchange",this._fullScreenChanged),t.removeEventListener("mozfullscreenchange",this._fullScreenChanged),t.removeEventListener("webkitfullscreenchange",this._fullScreenChanged),t.removeEventListener("msfullscreenchange",this._fullScreenChanged))}get frameRate(){return LayaEnv.isConch?this._frameRateNative:this._frameRate}set frameRate(e){if(LayaEnv.isConch){var t=window.conch;switch(e){case Stage.FRAME_FAST:t.config.setLimitFPS(60);break;case Stage.FRAME_MOUSE:t.config.setMouseFrame(2e3);break;case Stage.FRAME_SLOW:t.config.setSlowFrame(!0);break;case Stage.FRAME_SLEEP:t.config.setLimitFPS(1)}this._frameRateNative=e}else this._frameRate=e}_requestFullscreen(){var e=Browser.document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen()}_fullScreenChanged(){this.event(Event.FULL_SCREEN_CHANGE)}exitFullscreen(){var e=Browser.document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}Stage.SCALE_NOSCALE="noscale",Stage.SCALE_EXACTFIT="exactfit",Stage.SCALE_SHOWALL="showall",Stage.SCALE_NOBORDER="noborder",Stage.SCALE_FULL="full",Stage.SCALE_FIXED_WIDTH="fixedwidth",Stage.SCALE_FIXED_HEIGHT="fixedheight",Stage.SCALE_FIXED_AUTO="fixedauto",Stage.SCALE_FIXED_AUTO_LAYAME="fixedauto_layame",Stage.SCALE_FIXED_AUTO_LAYAVERSE="fixedauto_layaverse",Stage.ALIGN_LEFT="left",Stage.ALIGN_RIGHT="right",Stage.ALIGN_CENTER="center",Stage.ALIGN_TOP="top",Stage.ALIGN_MIDDLE="middle",Stage.ALIGN_BOTTOM="bottom",Stage.SCREEN_NONE="none",Stage.SCREEN_HORIZONTAL="horizontal",Stage.SCREEN_VERTICAL="vertical",Stage.FRAME_FAST="fast",Stage.FRAME_SLOW="slow",Stage.FRAME_MOUSE="mouse",Stage.FRAME_SLEEP="sleep",Stage.clear=function(e){Context.set2DRenderConfig(),RenderState2D.worldScissorTest&&LayaGL.renderEngine.scissorTest(!1);var t=Render.context,r=0==t._submits._length||Config.preserveDrawingBuffer?ColorUtils.create(e).arrColor:ILaya.stage._wgColor;r?t.clearBG(r[0],r[1],r[2],r[3]):t.clearBG(0,0,0,0),RenderState2D.clear()};class BlurFilterGLRender{render(e,t,r,i,a){var s=Value2D.create(ShaderDefines2D.TEXTURE2D,0);this.setShaderInfo(s,a,e.width,e.height),t.drawTarget(e,0,0,r,i,Matrix.EMPTY.identity(),s)}setShaderInfo(e,t,r,i){e.defines.add(Filter.BLUR);var a=e;BlurFilterGLRender.blurinfo[0]=r,BlurFilterGLRender.blurinfo[1]=i,a.blurInfo=BlurFilterGLRender.blurinfo;var s=t.strength/3,n=s*s;t.strength_sig2_2sig2_gauss1[0]=t.strength,t.strength_sig2_2sig2_gauss1[1]=n,t.strength_sig2_2sig2_gauss1[2]=2*n,t.strength_sig2_2sig2_gauss1[3]=1/(2*Math.PI*n),a.strength_sig2_2sig2_gauss1=t.strength_sig2_2sig2_gauss1}}BlurFilterGLRender.blurinfo=new Array(2);class BlurFilter extends Filter{constructor(e=4){super(),this.strength_sig2_2sig2_gauss1=[],this.strength=e,this._glRender=new BlurFilterGLRender}get type(){return Filter.BLUR}getStrenth_sig2_2sig2_native(){this.strength_sig2_native||(this.strength_sig2_native=new Float32Array(4));var e=this.strength/3,t=e*e;return this.strength_sig2_native[0]=this.strength,this.strength_sig2_native[1]=t,this.strength_sig2_native[2]=2*t,this.strength_sig2_native[3]=1/(2*Math.PI*t),this.strength_sig2_native}}class GlowFilterGLRender{setShaderInfo(e,t,r,i){e.defines.add(i.type);var a=e;a.u_blurInfo1=i._sv_blurInfo1;var s=i._sv_blurInfo2;s[0]=t,s[1]=r,a.u_blurInfo2=s,a.u_color=i.getColor()}render(e,t,r,i,a){var s=r,n=i,o=Value2D.create(ShaderDefines2D.TEXTURE2D,0);this.setShaderInfo(o,s,n,a);var l=Value2D.create(ShaderDefines2D.TEXTURE2D,0),h=Matrix.TEMP.identity();t.drawTarget(e,0,0,s,n,h,o),t.drawTarget(e,0,0,s,n,h,l)}}class GlowFilter extends Filter{constructor(e,t=4,r=6,i=6){super(),this._elements=new Float32Array(9),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._color=new ColorUtils(e||"#000"),this.blur=Math.min(t,20),this.offX=r,this.offY=i,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=this.blur,this._sv_blurInfo1[2]=r,this._sv_blurInfo1[3]=-i,this._glRender=new GlowFilterGLRender}get type(){return BlurFilter.GLOW}get offY(){return this._elements[6]}set offY(e){this._elements[6]=e,this._sv_blurInfo1[3]=-e}get offX(){return this._elements[5]}set offX(e){this._elements[5]=e,this._sv_blurInfo1[2]=e}get color(){return this._color.strColor}set color(e){this._color=new ColorUtils(e)}getColor(){return this._color.arrColor}get blur(){return this._elements[4]}set blur(e){this._elements[4]=e,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=e}getColorNative(){this._color_native||(this._color_native=new Float32Array(4));var e=this.getColor();return this._color_native[0]=e[0],this._color_native[1]=e[1],this._color_native[2]=e[2],this._color_native[3]=e[3],this._color_native}getBlurInfo1Native(){return this._blurInof1_native||(this._blurInof1_native=new Float32Array(4)),this._blurInof1_native[0]=this._blurInof1_native[1]=this.blur,this._blurInof1_native[2]=this.offX,this._blurInof1_native[3]=this.offY,this._blurInof1_native}getBlurInfo2Native(){return this._blurInof2_native||(this._blurInof2_native=new Float32Array(4)),this._blurInof2_native[2]=1,this._blurInof2_native}}class SoundChannel extends EventDispatcher{constructor(){super(...arguments),this.isStopped=!1}set volume(e){}get volume(){return 1}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(e){e&&e.runWith(!0)}}class AudioSoundChannel extends SoundChannel{constructor(e){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),e.addEventListener("ended",this._onEnd),this._audio=e,this._src=e.src}__onEnd(e){if(1==this.loops)return this.completeHandler&&(ILaya.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,Browser.container.appendChild(this._audio),this._audio.play()}catch(e){this.event(Event.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=SoundManager.playbackRate,this._audio.currentTime=this.startTime}catch(e){return void this._audio.addEventListener("canplay",this._resumePlay)}if(SoundManager.addChannel(this),Browser.container.appendChild(this._audio),"play"in this._audio){let e=this._audio.play();e&&e.catch((e=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&LayaEnv.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),ILaya.Browser.onIE||this._audio!=AudioSound._musicAudio&&Pool.recover("audio:"+this.url,this._audio),Browser.removeElement(this._audio),this._audio=null,SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url))}pause(){this.isStopped=!0,SoundManager.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url))}resume(){var e=this._audio;e&&(this.isStopped=!1,0==e.readyState&&(e.src=this._src,e.addEventListener("canplay",this._resumePlay),e.load()),SoundManager.addChannel(this),"play"in e&&e.play())}set volume(e){this._audio&&(this._audio.volume=e)}get volume(){return this._audio?this._audio.volume:1}}class AudioSound extends EventDispatcher{constructor(){super(...arguments),this.loaded=!1}dispose(){var e=AudioSound._audioCache[this.url];Pool.clearBySign("audio:"+this.url),e&&(LayaEnv.isConch||(e.src=""),delete AudioSound._audioCache[this.url])}static _initMusicAudio(){AudioSound._musicAudio||(AudioSound._musicAudio||(AudioSound._musicAudio=Browser.createElement("audio")),LayaEnv.isConch||Browser.document.addEventListener("mousedown",AudioSound._makeMusicOK))}static _makeMusicOK(){Browser.document.removeEventListener("mousedown",AudioSound._makeMusicOK),AudioSound._musicAudio.src?AudioSound._musicAudio.play():(AudioSound._musicAudio.src="",AudioSound._musicAudio.load())}load(e){var t;if(this.url=e,e==SoundManager._bgMusic?(AudioSound._initMusicAudio(),(t=AudioSound._musicAudio).originalUrl!=e&&(delete AudioSound._audioCache[t.originalUrl],t=null)):t=AudioSound._audioCache[e],t&&t.readyState>=2)this.event(Event.COMPLETE);else{t||(e==SoundManager._bgMusic?(AudioSound._initMusicAudio(),t=AudioSound._musicAudio):t=Browser.createElement("audio"),AudioSound._audioCache[e]=t,AssetDb.inst.resolveURL(e,(e=>{t.src=URL.postFormatURL(URL.formatURL(e))}))),t.originalUrl=e,t.addEventListener("canplaythrough",onLoaded),t.addEventListener("error",onErr);var r=this;this.audio=t,t.load?t.load():onErr()}function onLoaded(){offs(),r.loaded=!0,r.event(Event.COMPLETE)}function onErr(){t.load=null,offs(),r.event(Event.ERROR)}function offs(){t.removeEventListener("canplaythrough",onLoaded),t.removeEventListener("error",onErr)}}play(e=0,t=0){if(!this.url)return null;var r,i;if(this.url==SoundManager._bgMusic?""!=(r=AudioSound._musicAudio).src&&r.originalUrl!=this.url&&(delete AudioSound._audioCache[r.originalUrl],AudioSound._audioCache[this.url]=r):r=AudioSound._audioCache[this.url],!r)return null;i=Pool.getItem("audio:"+this.url),LayaEnv.isConch?i||(i=Browser.createElement("audio"),AssetDb.inst.resolveURL(this.url,(e=>{i.src=URL.postFormatURL(URL.formatURL(e))}))):this.url==SoundManager._bgMusic?(AudioSound._initMusicAudio(),i=AudioSound._musicAudio,AssetDb.inst.resolveURL(this.url,(e=>{i.src=URL.postFormatURL(URL.formatURL(e))}))):i=i||r.cloneNode(!0),i.originalUrl=this.url;var a=new AudioSoundChannel(i);return a.url=this.url,a.loops=t,a.startTime=e,a.play(),SoundManager.addChannel(a),a}get duration(){var e;return(e=AudioSound._audioCache[this.url])?e.duration:0}}AudioSound._audioCache={};class WebAudioSoundChannel extends SoundChannel{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=WebAudioSound.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(SoundManager.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var e=this.context,t=this.gain,r=e.createBufferSource();this.bufferSource=r,r.buffer=this.audioBuffer,r.connect(t),t&&t.disconnect(),t.connect(e.destination),r.onended=this._onPlayEnd,this._startTime=Browser.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(r.loop=!0),r.playbackRate.setTargetAtTime?r.playbackRate.setTargetAtTime(SoundManager.playbackRate,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):r.playbackRate.value=SoundManager.playbackRate,r.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(ILaya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(Browser.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var e=this.bufferSource;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,WebAudioSoundChannel._tryCleanFailed||this._tryClearBuffer(e),this.bufferSource=null}}_tryClearBuffer(e){try{e.buffer=null}catch(e){WebAudioSoundChannel._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}set volume(e){this._volume=e,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(e,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=e)}get volume(){return this._volume}}WebAudioSoundChannel._tryCleanFailed=!1,WebAudioSoundChannel.SetTargetDelay=.001;class WebAudioSound extends EventDispatcher{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=WebAudioSound.ctx){var e=WebAudioSound.ctx.createBufferSource();e.buffer=WebAudioSound._miniBuffer,e.connect(WebAudioSound.ctx.destination),e.start(0,0,0)}}static _unlock(){WebAudioSound._unlocked||(WebAudioSound._playEmptySound(),"running"==WebAudioSound.ctx.state&&(window.document.removeEventListener("mousedown",WebAudioSound._unlock,!0),window.document.removeEventListener("touchend",WebAudioSound._unlock,!0),window.document.removeEventListener("touchstart",WebAudioSound._unlock,!0),WebAudioSound._unlocked=!0))}static initWebAudio(){WebAudioSound.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=WebAudioSound.ctx.state&&(WebAudioSound._unlock(),window.document.addEventListener("mousedown",WebAudioSound._unlock,!0),window.document.addEventListener("touchend",WebAudioSound._unlock,!0),window.document.addEventListener("touchstart",WebAudioSound._unlock,!0))}load(e){this.url=e,this.audioBuffer=ILaya.loader.getRes(e),this.audioBuffer?this._loaded(this.audioBuffer):ILaya.loader.load(e,Loader.SOUND).then((e=>this._loaded(e)))}_loaded(e){this._disposed||(this.audioBuffer=e,this.loaded=!0,this.event(Event.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var e,t,r,i;for(t=(r=this.__toPlays).length,e=0;e<t;e++)(i=r[e])[2]&&!i[2].isStopped&&this.play(i[0],i[1],i[2]);this.__toPlays.length=0}}play(e=0,t=0,r=null){return r=r||new WebAudioSoundChannel,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([e,t,r]),this.once(Event.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),r.url=this.url,r.loops=t,r.audioBuffer=this.audioBuffer,r.startTime=e,r.play(),SoundManager.addChannel(r),r}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(ILaya.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}WebAudioSound._miniBuffer=WebAudioSound.ctx?WebAudioSound.ctx.createBuffer(1,1,22050):void 0,WebAudioSound._unlocked=!1;class SoundManager{static __init__(){var e=ILaya.Browser.window,t=!!(e.AudioContext||e.webkitAudioContext||e.mozAudioContext);return t&&WebAudioSound.initWebAudio(),SoundManager._soundClass=t?WebAudioSound:AudioSound,Browser.onTBMiniGame||AudioSound._initMusicAudio(),SoundManager._musicClass=AudioSound,t}static addChannel(e){SoundManager._channels.indexOf(e)>=0||SoundManager._channels.push(e)}static removeChannel(e){for(let t=SoundManager._channels.length-1;t>=0;t--)SoundManager._channels[t]==e&&SoundManager._channels.splice(t,1)}static disposeSoundLater(e){SoundManager._lastSoundUsedTimeDic[e]=ILaya.Browser.now(),SoundManager._isCheckingDispose||(SoundManager._isCheckingDispose=!0,ILaya.timer.loop(5e3,null,SoundManager._checkDisposeSound))}static _checkDisposeSound(){let e=ILaya.Browser.now(),t=!1;for(let r in SoundManager._lastSoundUsedTimeDic)e-SoundManager._lastSoundUsedTimeDic[r]>3e4?(delete SoundManager._lastSoundUsedTimeDic[r],SoundManager.disposeSoundIfNotUsed(r)):t=!0;t||(SoundManager._isCheckingDispose=!1,ILaya.timer.clear(null,SoundManager._checkDisposeSound))}static disposeSoundIfNotUsed(e){for(let t=SoundManager._channels.length-1;t>=0;t--)if(SoundManager._channels[t].url==e)return;SoundManager.destroySound(e)}static set autoStopMusic(e){ILaya.stage.off(Event.BLUR,null,SoundManager._stageOnBlur),ILaya.stage.off(Event.FOCUS,null,SoundManager._stageOnFocus),ILaya.stage.off(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange),SoundManager._autoStopMusic=e,e&&(ILaya.stage.on(Event.BLUR,null,SoundManager._stageOnBlur),ILaya.stage.on(Event.FOCUS,null,SoundManager._stageOnFocus),ILaya.stage.on(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange))}static get autoStopMusic(){return SoundManager._autoStopMusic}static _visibilityChange(){ILaya.stage.isVisibility?SoundManager._stageOnFocus():SoundManager._stageOnBlur()}static _stageOnBlur(){SoundManager._isActive=!1,SoundManager._musicChannel&&(SoundManager._musicChannel.isStopped||(SoundManager._blurPaused=!0,SoundManager._musicChannel.pause())),SoundManager.stopAllSound(),ILaya.stage.once(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus)}static _recoverWebAudio(){WebAudioSound.ctx&&"running"!=WebAudioSound.ctx.state&&WebAudioSound.ctx.resume&&WebAudioSound.ctx.resume()}static _stageOnFocus(){SoundManager._isActive=!0,SoundManager._recoverWebAudio(),ILaya.stage.off(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus),SoundManager._blurPaused&&SoundManager._musicChannel&&SoundManager._musicChannel.isStopped&&(SoundManager._blurPaused=!1,SoundManager._musicChannel.resume())}static set muted(e){e!=SoundManager._muted&&(e&&SoundManager.stopAllSound(),SoundManager.musicMuted=e,SoundManager._muted=e)}static get muted(){return SoundManager._muted}static set soundMuted(e){SoundManager._soundMuted=e}static get soundMuted(){return SoundManager._soundMuted}static set musicMuted(e){e!=SoundManager._musicMuted&&(e?(SoundManager._bgMusic&&SoundManager._musicChannel&&!SoundManager._musicChannel.isStopped?LayaEnv.isConch?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!0):SoundManager._musicChannel.pause():SoundManager._musicChannel=null,SoundManager._musicMuted=e):(SoundManager._musicMuted=e,SoundManager._bgMusic&&SoundManager._musicChannel&&(LayaEnv.isConch?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!1):SoundManager._musicChannel.resume())))}static get musicMuted(){return SoundManager._musicMuted}static get useAudioMusic(){return SoundManager._useAudioMusic}static set useAudioMusic(e){SoundManager._useAudioMusic=e,SoundManager._musicClass=e?AudioSound:null}static playSound(e,t=1,r=null,i=null,a=0){if(!SoundManager._isActive||!e)return null;if(SoundManager._muted)return null;if(SoundManager._recoverWebAudio(),e==SoundManager._bgMusic){if(SoundManager._musicMuted)return null}else if(SoundManager._soundMuted)return null;let s;Browser._isMiniGame||(s=SoundManager._soundCache[e]),i||(i=SoundManager._soundClass),s||(s=new i,s.load(e),Browser._isMiniGame||(SoundManager._soundCache[e]=s));let n=s.play(a,t);return n?(n.url=e,n.volume=e==SoundManager._bgMusic?SoundManager.musicVolume:SoundManager.soundVolume,n.completeHandler=r,n):null}static destroySound(e){let t=SoundManager._soundCache[e];t&&(delete SoundManager._soundCache[e],t.dispose())}static playMusic(e,t=0,r=null,i=0){return SoundManager._bgMusic=e,SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._musicChannel=SoundManager.playSound(e,t,r,SoundManager._musicClass,i)}static stopSound(e){for(let t=SoundManager._channels.length-1;t>=0;t--){let r=SoundManager._channels[t];r.url==e&&r.stop()}}static stopAll(){var e;for(SoundManager._bgMusic=null,e=SoundManager._channels.length-1;e>=0;e--)SoundManager._channels[e].stop()}static stopAllSound(){for(let e=SoundManager._channels.length-1;e>=0;e--){let t=SoundManager._channels[e];t.url!=SoundManager._bgMusic&&t.stop()}}static stopMusic(){SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._bgMusic=null}static setSoundVolume(e,t=null){if(t)SoundManager._setVolume(t,e);else{SoundManager.soundVolume=e;for(let t=SoundManager._channels.length-1;t>=0;t--){let r=SoundManager._channels[t];r.url!=SoundManager._bgMusic&&(r.volume=e)}}}static setMusicVolume(e){SoundManager.musicVolume=e,SoundManager._setVolume(SoundManager._bgMusic,e)}static _setVolume(e,t){for(let r=SoundManager._channels.length-1;r>=0;r--){let i=SoundManager._channels[r];i.url==e&&(i.volume=t)}}}SoundManager.musicVolume=1,SoundManager.soundVolume=1,SoundManager.playbackRate=1,SoundManager._useAudioMusic=!0,SoundManager._muted=!1,SoundManager._soundMuted=!1,SoundManager._musicMuted=!1,SoundManager._bgMusic=null,SoundManager._musicChannel=null,SoundManager._channels=[],SoundManager._blurPaused=!1,SoundManager._isActive=!0,SoundManager._lastSoundUsedTimeDic={},SoundManager._isCheckingDispose=!1,SoundManager._soundCache={},SoundManager.autoReleaseSound=!0;class SoundNode extends Sprite{constructor(){super(),this._loop=1,this.on(Event.ADDED,this,this._onParentChange),this.on(Event.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(e){this._source=e,e?this._autoPlay&&(!this._channel||this._channel.isStopped)&&LayaEnv.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(e){this._isMusic=e}get loop(){return this._loop}set loop(e){this._loop=e}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,e&&this._source&&(!this._channel||this._channel.isStopped)&&LayaEnv.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(e,t){this._source&&((null==e||isNaN(e))&&(e=this._loop),this.stop(),this._isMusic?this._channel=SoundManager.playMusic(this._source,e,t):this._channel=SoundManager.playSound(this._source,e,t))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(e,t,r,i=!0){this[r]&&e&&(i?e.on(t,this,this[r]):e.off(t,this,this[r]))}_setPlayActions(e,t,r,i=!0){if(!e)return;if(!t)return;let a=t.split(","),s=a.length;for(let t=0;t<s;t++)this._setPlayAction(e,a[t],r,i)}set playEvent(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}set target(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}}class VideoTexture extends BaseTexture{constructor(){let t=ILaya.Browser.createElement("video");super(t.videoWidth,t.videoHeight,e.RenderTargetFormat.R8G8B8),this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=t,this._listeningEvents={},this._dimension=e.TextureDimension.Tex2D;var r=this.element.style;r.position="absolute",r.top="0px",r.left="0px",t.setAttribute("crossorigin","anonymous"),ILaya.Browser.onMobile&&(t["x5-playsInline"]=!0,t["x5-playsinline"]=!0,t.x5PlaysInline=!0,t.playsInline=!0,t["webkit-playsInline"]=!0,t["webkit-playsinline"]=!0,t.webkitPlaysInline=!0,t.playsinline=!0,t.style.playsInline=!0,t.crossOrigin="anonymous",t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.autoplay=!0),t.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()}));const i=this;"requestVideoFrameCallback"in t&&t.requestVideoFrameCallback((function updateVideo(){i._needUpdate=!0,t.requestVideoFrameCallback(updateVideo)})),ILaya.Browser.onWeiXin&&this.loadedmetadata()}isNeedUpdate(){return this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8,!1,!1),this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,this.filterMode=e.FilterMode.Bilinear,LayaGL.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(Event.READY,this))}get source(){return this._source}get gammaCorrection(){return 2.2}set source(e){this._source=e,e&&AssetDb.inst.resolveURL(e,(e=>{for(;this.element.childElementCount;)this.element.firstChild.remove();e.startsWith("blob:")?this.element.src=e:this.appendSource(e)}))}appendSource(e){var t=ILaya.Browser.createElement("source");t.src=URL.postFormatURL(URL.formatURL(e));let r=Utils.getFileExtension(e);t.type="m3u8"==r?"application/vnd.apple.mpegurl":"video/"+r,this.element.appendChild(t)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||Browser.onLayaRuntime)&&(LayaGL.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1)}set frameRender(e){this._frameRender&&!e&&ILaya.timer.clear(this,this.render),!this._frameRender&&e&&ILaya.timer.frameLoop(1,this,this.render),this._frameRender=e}get frameRender(){return this._frameRender}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&ILaya.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return Texture2D.whiteTexture}pause(){this.element.pause(),this._frameRender&&ILaya.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(e){return e="m3u8"==e?"application/vnd.apple.mpegurl":"video/"+e,this.element.canPlayType(e)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(e){this.element&&(this.element.currentTime=e,this.render())}set volume(e){this.element&&(this.element.volume=e)}get volume(){return this.element.volume}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(e){this.element&&(this.element.loop=e)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element&&(this.element.playbackRate=e)}get muted(){return this.element.muted}set muted(e){this.element&&(this.element.muted=e)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(e){this.element&&(this.element.preload=e)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(e){if(Ye.has(e)){let t=this._listeningEvents[e];t||(t=this._listeningEvents[e]=()=>{this.event(e)}),this.element.addEventListener(e,t)}}destroy(){LayaEnv.isConch&&this.element._destroy(),ILaya.timer.clear(this,this.render),super.destroy()}}const Ye=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class VideoNode extends Sprite{constructor(){if(super(),this.texture=this._internalTex=new Texture,LayaEnv.isPlaying&&ILaya.Browser.onMobile){let func=()=>{ILaya.Browser.document.removeEventListener("touchend",func),this._videoTexture&&(Browser.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};ILaya.Browser.document.addEventListener("touchend",func)}}get videoTexture(){return this._videoTexture}set videoTexture(e){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(Event.READY,this,this.onVideoMetaLoaded)),this._videoTexture=e,e?(this._videoTexture._addReference(),this._videoTexture.on(Event.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null)}get source(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.source}set source(e){e?(this._videoTexture||(this.videoTexture=new VideoTexture),this._videoTexture.source=e):this._videoTexture&&(this._videoTexture.source=e)}load(e){this.source=e}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(e){return this._videoTexture||(this.videoTexture=new VideoTexture),this._videoTexture.canPlayType(e)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.buffered}get currentSrc(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentSrc}get currentTime(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentTime}set currentTime(e){this._videoTexture&&(this._videoTexture.currentTime=e)}set volume(e){this._videoTexture&&(this._videoTexture.volume=e)}get volume(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.volume}get readyState(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.readyState}get videoWidth(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoWidth}get videoHeight(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoHeight}get duration(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.duration}get ended(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.ended}get error(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.error}get loop(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.loop}set loop(e){this._videoTexture&&(this._videoTexture.loop=e)}get playbackRate(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.playbackRate}set playbackRate(e){this._videoTexture&&(this._videoTexture.playbackRate=e)}get muted(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.muted}set muted(e){this._videoTexture&&(this._videoTexture.muted=e)}get paused(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.paused}get preload(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.preload}set preload(e){this._videoTexture&&(this._videoTexture.preload=e)}get seekable(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seekable}get seeking(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seeking}_setX(e){if(super._setX(e),this._videoTexture&&LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=t.x}}_setY(e){if(super._setY(e),this._videoTexture&&LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=t.y}}set_width(e){if(super.set_width(e),this._videoTexture)if(LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=e*t.scaleX}else this._videoTexture.element.width=this.width/ILaya.Browser.pixelRatio}set_height(e){if(super.set_height(e),this._videoTexture)if(LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=e*t.scaleY}else this._videoTexture.element.height=this.height/ILaya.Browser.pixelRatio}destroy(e=!0){this.videoTexture=null,super.destroy(e)}}class AnimatorPlayState2D{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._playNum=0,this._playAllTime=0;var r=this._elapsedTime/t%1;this._normalizedPlayTime=r<0?r+1:r,this._frontPlay=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playNum=this._playNum,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront,e._frontPlay=this._frontPlay,e._playAllTime=this._playAllTime}}class AnimatorControllerLayer2D{constructor(e){this._referenceCount=0,this._playStateInfo=new AnimatorPlayState2D,this._crossPlayStateInfo=new AnimatorPlayState2D,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=e}set states(e){if(this._states!==e){for(let e=this.states.length-1;e>=0;e--)this.removeState(this.states[e]);for(let t=e.length-1;t>=0;t--)this.addState(e[t])}}get states(){return this._states}set defaultStateName(e){if(this._defaultState=this.getStateByName(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}_removeClip(e,t,r){e.splice(t,1)}_getReferenceCount(){return this._referenceCount}_addReference(e){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(e){for(let t=this._states.length-1;t>=0;t--)if(this._states[t].name==e)return this._states[t];return null}addState(e){var t=e.name;if(this.getStateByName(t))throw"AnimatorControllerLayer:this stat's name has exist.";this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null)}removeState(e){for(var t=this._states,r=-1,i=0,a=t.length;i<a;i++)if(t[i]===e){r=i;break}-1!=r&&this._removeClip(t,r,e)}clone(){var e=new AnimatorControllerLayer2D(this.name);return this.cloneTo(e),e}cloneTo(e){e.name=this.name}destroy(){this._removeReference();for(var e=0,t=this._states.length;e<t;e++)this._states[e].destroy();this._states.length=0}}var je,Ke,qe,Qe,$e;AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE=0,AnimatorControllerLayer2D.BLENDINGMODE_ADDTIVE=1,e.AniParmType=void 0,(je=e.AniParmType||(e.AniParmType={}))[je.Float=0]="Float",je[je.Bool=1]="Bool",je[je.Trigger=2]="Trigger",e.AniStateConditionType=void 0,(Ke=e.AniStateConditionType||(e.AniStateConditionType={}))[Ke.Number=0]="Number",Ke[Ke.Bool=1]="Bool",Ke[Ke.Trigger=2]="Trigger",e.AniStateConditionNumberCompressType=void 0,(qe=e.AniStateConditionNumberCompressType||(e.AniStateConditionNumberCompressType={}))[qe.Less=0]="Less",qe[qe.Greater=1]="Greater";class AnimatorControllerParse{static parse(e){let t=e,r=t.controllerLayers;null==r&&(r=[]);let i=[];for(let e=r.length-1;e>=0;e--){let a=r[e],s=a.states;s||(s=[],a.states=s),a.defaultStateName=null;let n=this.checkStates(s,i,t);n?a.defaultStateName=n.enterName:r.splice(e,1)}return{ret:t,clipsID:i}}static checkStates(e,t,r){let i=null,a=null;for(let s=e.length-1;s>=0;s--){let n=e[s];n.states?null==this.checkStates(n.states,t,r)?e.splice(s,1):(null==i&&(i=[]),i.push(n)):"-1"==n.id?a=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?e.splice(s,1):(0>t.indexOf(n.clip._$uuid)&&t.push(n.clip._$uuid),this.checkNext(n,e,r),null==i&&(i=[]),i.push(n)))}let s=null;if(i&&a){let e=this.checkDefault(a,i);null!=e&&(s={states:i,enterName:e})}return s}static checkNext(e,t,r){let i=e.soloTransitions;if(i)for(let e=i.length-1;e>=0;e--){let a=i[e],s=this.getStateByID(t,a.id);!s||null==s.clip&&"-3"!=s.id&&null==s.states?i.splice(e,1):(a.name=s.name,a.conditions=this.checkConditions(a.conditions,r))}}static checkConditions(t,r){if(!t||0==t.length||null==r.animatorParams||0==r.animatorParams.length)return[];let i=r.animatorParams;for(let r=t.length-1;r>=0;r--){let a=t[r],s=null;for(let e=i.length-1;e>=0;e--)if(i[e].id==a.id){s=i[e];break}if(null==s)t.splice(r,1);else if(a.name=s.name,s.type==e.AniParmType.Float){let e=Number(a.checkValue);isNaN(e)&&(a.checkValue=0),e=Number(a.type),isNaN(e)&&(a.type=0)}}return t}static checkDefault(e,t){let r=e.soloTransitions,i=null;r&&0<r.length&&(i=r[0].id);let a=null;if(null!=i&&(a=this.getStateByID(t,i)),null!=a&&(null!=a.clip||null!=a.states))return a.name;for(let e=t.length-1;e>=0;e--)if(t[e].clip)return t[e].name;return null}static getStateByID(e,t){if(e)for(let r=e.length-1;r>=0;r--)if(e[r].id==t)return e[r];return null}}e.AnimatorUpdateMode=void 0,(Qe=e.AnimatorUpdateMode||(e.AnimatorUpdateMode={}))[Qe.Normal=0]="Normal",Qe[Qe.LowFrame=1]="LowFrame",Qe[Qe.UnScaleTime=2]="UnScaleTime";class Animator2D extends Component{constructor(){super(),this._speed=1,this._updateMode=e.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}set controller(e){this._controller=e,e&&e.updateTo(this)}get controller(){return this._controller}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set speed(e){this._speed=e}get speed(){return this._speed}get isPlaying(){return this._isPlaying}_updateStateFinish(e,t){t._finish&&e._eventExit()}_setClipDatasToNode(e,t,r,i,a=null){for(var s=e._realtimeDatas,n=e._clip._nodes,o=0,l=n.count;o<l;o++)if(null!=s[o]){var h=n.getNodeByIndex(o),u=this.getOwner(h);u&&this._applyFloat(u,t,r,i,s[o])}}_applyFloat(e,t,r,i,a){var s=e.pro;s&&s.ower&&(s.ower[s.key]=t&&"number"==typeof a?s.defVal+r*a:"number"==typeof a?r*a:a)}getOwner(e){var t;if(this._ownerMap&&(t=this._ownerMap.get(e)))return t;for(var r=this.owner,i=0,a=e.ownerPathCount;i<a;i++){var s=e.getOwnerPathByIndex(i);if(""!=s&&!(r=r.getChildByName(s)))break}if(t={ower:r},r){var n=r,o=e.propertyCount;if(1==o){var l=e.getPropertyByIndex(0);t.pro={ower:r,key:l,defVal:r[l]}}else for(var h=0;h<o;h++){l=e.getPropertyByIndex(h);if(h==o-1||null==n){t.pro={ower:n,key:l,defVal:n?n[l]:null};break}if(null==n[l]&&r==n){n=null;var u=ClassUtils.getClass(l);u&&(n=r.getComponent(u))}else n=n[l]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(e,t),t}_updateClipDatas(e,t,r){var i=e._clip,a=i._duration,s=e.clipStart*a+r._normalizedPlayTime*r._duration,n=e._currentFrameIndices;i._evaluateClipDatasRealTime(s,n,t,!0,e._realtimeDatas)}_updatePlayer(e,t,r,i,a){let s=!1;var n=e._clip._duration*(e.clipEnd-e.clipStart),o=t._elapsedTime;let l=t._playAllTime;t._playAllTime+=Math.abs(r),r=o+r,t._lastElapsedTime=o,t._elapsedTime=r;var h=r/n;let u=1;e.yoyo&&(u=2);let d=t._playAllTime/(n*u);Math.floor(l/(n*u))<Math.floor(d)&&(s=!0);var _=h%1;let c=_<0?_+1:_;if(t._normalizedPlayTime=c,t._duration=n,1!=u&&(c=(_=(h=t._playAllTime/(n*u))%1)<0?_+1:_,e.yoyo&&(.5>c?t._frontPlay||(0>e.speed?(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart),t._frontPlay=!0):t._frontPlay&&(t._frontPlay=!1,0>e.speed?(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd)))),e._eventStateUpdate(c),!this._applyTransition(a,e._eventtransition(c,this.parameters,s))&&s){let r=t._playAllTime/(n*u);if(0<i&&i<=r)return t._finish=!0,void(0>e.speed?e.yoyo?(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):e.yoyo?(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd))}}_updateEventScript(e,t){let r=e._clip,i=r._animationEvents;if(!i||0==i.length)return;let a=r._duration,s=t._normalizedPlayTime*a,n=t._frontPlay,o=t._parentPlayTime;null==o&&(o=n?a*t.animatorState.clipStart:a*t.animatorState.clipEnd),n?s<o&&(this._eventScript(i,o,a*t.animatorState.clipEnd,n),o=a*t.animatorState.clipStart):s>o&&(this._eventScript(i,o,a*t.animatorState.clipStart,n),o=a*t.animatorState.clipEnd),this._eventScript(i,o,s,n),t._parentPlayTime=s}_eventScript(e,t,r,i){let a=this.owner.components;if(i)for(let i=0,s=e.length;i<s;i++){let s=e[i];if(s.time>t&&s.time<=r)for(let e=0,t=a.length;e<t;e++){let t=a[e];if(t._isScript()){let e=t[s.eventName];e&&e.apply(t,s.params)}}else if(s.time>r)break}else for(let i=e.length-1;i>=0;i--){let s=e[i];if(s.time<t&&s.time>=r)for(let e=0,t=a.length;e<t;e++){let t=a[e];if(t._isScript()){let e=t[s.eventName];e&&e.apply(t,s.params)}}else if(s.time<r)break}}_applyTransition(e,t){return!!t&&this.crossFade(t.destState.name,t.transduration,e,t.transstartoffset)}_applyUpdateMode(t){let r;switch(this._updateMode){case e.AnimatorUpdateMode.Normal:r=t;break;case e.AnimatorUpdateMode.LowFrame:r=Stat.loopCount%this._lowUpdateDelty==0?t*this._lowUpdateDelty:0;break;case e.AnimatorUpdateMode.UnScaleTime:r=0}return r}play(e,t=0,r=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let e=this._checkEnterIndex.indexOf(t);0<=e&&this._checkEnterIndex.splice(e,1)}this._isPlaying=!0;var i=this._controllerLayers[t];if(i){var a=i.defaultState;if(!e&&!a)throw new Error("Animator:must have default clip value,please set clip property.");var s=i._playStateInfo,n=s._currentState,o=e?i.getStateByName(e):a;if(!o._clip)return;var l=o._clip._duration,h=o._clip._duration*(o.clipEnd-o.clipStart);n!==o?(r!==Number.NEGATIVE_INFINITY?s._resetPlayState(l*r,h):s._resetPlayState(0,h),i._playType=0,s._currentState=o):r!==Number.NEGATIVE_INFINITY&&(s._resetPlayState(l*r,h),i._playType=0),o._eventStart(this,t)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let t=this._checkEnterIndex.length-1;t>=0;t--){let r=this._checkEnterIndex[t];if(this._controllerLayers[r]._enterTransition.check(0,this.parameters,!0)){var e=this.getDefaultState(r);this.play(null,r,e.cycleOffset)}}var t=this.owner.timer._delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var r=0,i=this._controllerLayers.length;r<i;r++){var a=this._controllerLayers[r];if(a.enable){var s=a._playStateInfo,n=a.blendingMode!=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE;if(0===a._playType){var o=s._currentState,l=this._speed*o.speed,h=s._finish,u=o.loop;-1>=u&&(u=o._clip.islooping?0:1);let e=1;s._frontPlay||(e=-1),h||this._updatePlayer(o,s,t*l*e,u,r),o=(s=a._playStateInfo)._currentState,this._updateClipDatas(o,n,s),h||(this._setClipDatasToNode(o,n,a.defaultWeight,0==r,a),this._updateEventScript(o,s)),h||this._updateStateFinish(o,s)}}}}}addControllerLayer(e){this._controllerLayers.push(e)}crossFade(e,t,r=0,i=Number.NEGATIVE_INFINITY){var a=this._controllerLayers[r];if(a){if(a.getStateByName(e))return this.play(e,r,i),!0;console.warn("Invalid layerIndex "+r+".")}return!1}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){var r=this.getDefaultState(e);if(r){let t=this._controllerLayers[e]._enterTransition;t?(this._isPlaying=!0,t.check(0,this.parameters,!0)?this.play(null,e,r.cycleOffset):this._checkEnterIndex.push(e)):this.play(null,e,r.cycleOffset)}}}getDefaultState(e=0){return this._controllerLayers[e].defaultState}setParamsTrigger(t){this._parameters[t]={name:t,type:e.AniParmType.Trigger,value:!0}}setParamsNumber(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}setParamsBool(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}getParamsvalue(e){let t=this._parameters[e];return t?t.value:null}onDestroy(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class AnimatorState2D extends EventDispatcher{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(e){if(this._clip!=e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=e._nodes.count;this._currentFrameIndices=new Int16Array(t),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=t}this._clip=e}}_eventStateUpdate(e){if(this.event(AnimatorState2D.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,r=this._scripts.length;t<r;t++)this._scripts[t].onStateUpdate(e)}_eventStart(e,t){if(this.event(AnimatorState2D.EVENT_OnStateEnter),this._scripts)for(var r=0,i=this._scripts.length;r<i;r++)this._scripts[r].setPlayScriptInfo(e,t,this),this._scripts[r].onStateEnter()}_eventExit(){if(this.event(AnimatorState2D.EVENT_OnStateExit),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventtransition(e,t,r){let i=this.soloTransitions.length;if(i>0){for(var a=0;a<i;a++)if(this.soloTransitions[a].check(e,t,r))return this.soloTransitions[a];return null}let s=this.transitions.length;for(a=0;a<s;a++)if(this.transitions[a].check(e,t,r))return this.transitions[a];return null}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}_getReferenceCount(){return this._referenceCount}_addReference(e){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var i=this._scripts[t];if(i instanceof e)return i}return null}getScripts(e){var t=null;if(this._scripts)for(var r=0,i=this._scripts.length;r<i;r++){var a=this._scripts[r];a instanceof e&&(t=t||[]).push(a)}return t}clone(){var e=new AnimatorState2D;return this.cloneTo(e),e}cloneTo(e){var t=e;t.name=this.name,t.speed=this.speed,t.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}AnimatorState2D.EVENT_OnStateEnter="OnStartEnter",AnimatorState2D.EVENT_OnStateUpdate="OnStateUpdate",AnimatorState2D.EVENT_OnStateExit="OnStateExit";class KeyframeNode2D{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_setKeyframeCount(e){this._keyFrames.length=e}_joinOwnerPath(e){return this._ownerPath.join(e)}_joinProperty(e){return this._propertys.join(e)}getKeyframeByIndex(e){return this._keyFrames[e]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}}class Keyframe2D{clone(){var e=new Keyframe2D;return this.cloneTo(e),e}cloneTo(e){e.time=this.time}}Keyframe2D.defaultWeight=.33333;class Animation2DEvent{constructor(){}}class AnimationClip2DParse01{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var e=this._BLOCK.count=this._reader.getUint16(),t=this._BLOCK.blockStarts=[],r=this._BLOCK.blockLengths=[],i=0;i<e;i++)t.push(this._reader.getUint32()),r.push(this._reader.getUint32())}static READ_STRINGS(){var e=this._reader.getUint32(),t=this._reader.getUint16(),r=this._reader.pos;this._reader.pos=e+this._DATA.offset;for(var i=0;i<t;i++)this._strings[i]=this._reader.readUTFString();this._reader.pos=r}static parse(e,t,r){this._clip=e,this._reader=t,this._version=r,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var i=0,a=this._BLOCK.count;i<a;i++){var s=t.getUint16(),n=this._strings[s],o=this["READ_"+n];if(!o)throw new Error("model file err,no this function:"+s+" "+n);o.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(e,t){return Math.round(e*t)}static READ_ANIMATIONS2D(){var e,t,r,i=this._reader,a=this._clip,s=[],n=i.getUint16();for(s.length=n,e=0;e<n;e++)s[e]=i.getFloat32();a._duration=s[i.getInt16()],a.islooping=!!i.getByte(),a._frameRate=i.getInt16();var o=i.getInt16(),l=a._nodes;l.count=o;var h=a._nodesMap={},u=a._nodesDic={};for(e=0;e<o;e++){r=new KeyframeNode2D,l.setNodeByIndex(e,r),r._indexInList=e;var d=i.getUint16();for(r._setOwnerPathCount(d),t=0;t<d;t++)r._setOwnerPathByIndex(t,this._strings[i.getUint16()]);var _=r._joinOwnerPath("/"),c=h[_];c||(h[_]=c=[]),c.push(r);var m=i.getUint16();for(r._setPropertyCount(m),t=0;t<m;t++)r._setPropertyByIndex(t,this._strings[i.getUint16()]);var p=_+"."+r._joinProperty(".");u[p]=r,r.fullPath=p,r.nodePath=_;var f=i.getUint16();for(t=0;t<f;t++){var g=new Keyframe2D;g.time=s[i.getUint16()],g.data={f:this.timeToFrame(g.time,a._frameRate),val:0},1==i.getByte()&&(g.data.tweenType=this._strings[i.getUint16()]),1==i.getByte()&&(g.data.tweenInfo={},g.data.tweenInfo.inTangent=s[i.getUint16()],g.data.tweenInfo.outTangent=s[i.getUint16()],1==i.getByte()&&(g.data.tweenInfo.inWeight=s[i.getUint16()]),1==i.getByte()&&(g.data.tweenInfo.outWeight=s[i.getUint16()]));var T=i.getByte();if(0==T?g.data.val=s[i.getUint16()]:1==T?g.data.val=this._strings[i.getUint16()]:2==T&&(g.data.val=!!i.getByte()),1==i.getByte())try{g.data.extend=JSON.parse(this._strings[i.getUint16()])}catch(e){}r._keyFrames.push(g)}}var x=i.getUint16();for(e=0;e<x;e++){var S=new Animation2DEvent;S.time=s[i.getUint16()],S.eventName=this._strings[i.getUint16()];var y=[],E=i.getUint16();for(E>0&&(S.params=y=[]),t=0;t<E;t++){switch(i.getByte()){case 0:y.push(!!i.getByte());break;case 1:y.push(i.getInt32());break;case 2:y.push(s[i.getUint16()]);break;case 3:y.push(this._strings[i.getUint16()]);break;default:throw new Error("unknown type.")}}a.addEvent(S)}}}AnimationClip2DParse01._strings=[],AnimationClip2DParse01._DATA={offset:0,size:0},AnimationClip2DParse01._BLOCK={count:0};class KeyframeNodeList2D{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class AnimationClip2D extends Resource{static _parse(e){var t=new AnimationClip2D,r=new Byte(e),i=r.readUTFString();if("LAYAANIMATION2D:01"!==i)throw"unknown animationClip version.";return AnimationClip2DParse01.parse(t,r,i),t}constructor(){super(),this._nodes=new KeyframeNodeList2D,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(e,t,r,i,a){for(var s=this._nodes,n=0,o=s.count;n<o;n++){var l,h=s.getNodeByIndex(n)._keyFrames,u=h.length;if(0!=u){var d=t[n];if(i)for(-1!=d&&e<h[d].time&&(d=-1,t[n]=d),l=d+1;l<u&&!(h[l].time>e);)d++,l++,t[n]=d;else for((l=d+1)!=u&&e>h[l].time&&(d=u-1,t[n]=d),l=d+1;d>-1&&!(h[d].time<e);)d--,l--,t[n]=d;var _=l==u;if(-1!=d){var c=h[d];if(_)a[n]=c.data.val;else{var m,p=h[l],f=p.time-c.time;m=0!==f?(e-c.time)/f:0,a[n]=this._getTweenVal(c,p,m,f)}}else a[n]=h[0].data.val;r&&"number"==typeof h[0].data.val&&(a[n]=a[n]-h[0].data.val)}}}_getTweenVal(e,t,r,i){var a=e.data,s=t.data;if("number"!=typeof a.val||"number"!=typeof s.val)return a.val;var n=AnimationClip2D.tween[a.tweenType],o=a.val,l=s.val;if(null!=n)return n(r,o,l-o,1);var h=0,u=0,d=NaN,_=NaN;return null!=a.tweenInfo&&(h=a.tweenInfo.outTangent,d=a.tweenInfo.outWeight),null!=s.tweenInfo&&(u=s.tweenInfo.inTangent,_=s.tweenInfo.inWeight),(isNaN(d)||0>=d)&&(d=Keyframe2D.defaultWeight),(isNaN(_)||0>=_)&&(_=Keyframe2D.defaultWeight),isNaN(h)&&(h=0),isNaN(u)&&(u=0),Math.abs(h)==Number.MAX_VALUE&&(h=0>h?-1/0:1/0),Math.abs(u)==Number.MAX_VALUE&&(u=0>u?-1/0:1/0),!a.tweenInfo&&!s.tweenInfo||Keyframe2D.defaultWeight==_&&Keyframe2D.defaultWeight==d?AnimationClip2D.tween.hermiteInterpolate(h,u,o,l,r,i):this.hermiteCurveSplineWeight(o,e.time,d,h,l,t.time,_,u,r)}_binarySearchEventIndex(e){for(var t,r=0,i=this._animationEvents.length-1;r<=i;){t=r+i>>1;var a=this._animationEvents[t].time;if(a==e)return t;a>e?i=t-1:r=t+1}return r}hermiteCurveSplineWeight(e,t,r,i,a,s,n,o,l){let h=222e-18,u=l,d=e,_=r,c=n,m=s-t,p=a-d;p=Math.max(Math.abs(p),h)*(p<0?-1:1);let f=i,g=o;if(!Number.isFinite(f)||!Number.isFinite(g))return e;f=f*m/p,g=g*m/p;let T=1-c,x=.5,S=0;if(Math.abs(_-.33333334)<1e-4&&Math.abs(c-.33333334)<1e-4)x=u,S=1-x;else for(;;){S=1-x;let e=3*S*S*x*_+3*S*x*x*T+x*x*x-u;if(Math.abs(e)<=2.5*h)break;let t=3*S*S*_+6*S*x*(T-_)+3*x*x*(1-T),r=6*S*(T-2*_)+6*x*(1-2*T+_);x-=(6*e*t*t-3*e*e*r)/(6*t*t*t-6*e*t*r+e*e*(18*_-18*T+6))}return(3*S*S*x*_*f+3*S*x*x*(1-c*g)+x*x*x)*p+d}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}}AnimationClip2D.tween={Linear:function(e,t,r,i){return r*e/i+t},Quad_EaseIn:function(e,t,r,i){return r*(e/=i)*e+t},Quad_EaseOut:function(e,t,r,i){return-r*(e/=i)*(e-2)+t},Quad_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t},Cubic_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e+t},Cubic_EaseOut:function(e,t,r,i){return r*((e=e/i-1)*e*e+1)+t},Cubic_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e+t:r/2*((e-=2)*e*e+2)+t},Quart_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e*e+t},Quart_EaseOut:function(e,t,r,i){return-r*((e=e/i-1)*e*e*e-1)+t},Quart_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e*e+t:-r/2*((e-=2)*e*e*e-2)+t},Quint_EaseIn:function(e,t,r,i){return r*(e/=i)*e*e*e*e+t},Quint_EaseOut:function(e,t,r,i){return r*((e=e/i-1)*e*e*e*e+1)+t},Quint_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?r/2*e*e*e*e*e+t:r/2*((e-=2)*e*e*e*e+2)+t},Sine_EaseIn:function(e,t,r,i){return-r*Math.cos(e/i*(Math.PI/2))+r+t},Sine_EaseOut:function(e,t,r,i){return r*Math.sin(e/i*(Math.PI/2))+t},Sine_EaseInOut:function(e,t,r,i){return-r/2*(Math.cos(Math.PI*e/i)-1)+t},Expo_EaseIn:function(e,t,r,i){return 0==e?t:r*Math.pow(2,10*(e/i-1))+t},Expo_EaseOut:function(e,t,r,i){return e==i?t+r:r*(1-Math.pow(2,-10*e/i))+t},Expo_EaseInOut:function(e,t,r,i){return 0==e?t:e==i?t+r:(e/=i/2)<1?r/2*Math.pow(2,10*(e-1))+t:r/2*(2-Math.pow(2,-10*--e))+t},Circ_EaseIn:function(e,t,r,i){return-r*(Math.sqrt(1-(e/=i)*e)-1)+t},Circ_EaseOut:function(e,t,r,i){return r*Math.sqrt(1-(e=e/i-1)*e)+t},Circ_EaseInOut:function(e,t,r,i){return(e/=i/2)<1?-r/2*(Math.sqrt(1-e*e)-1)+t:r/2*(Math.sqrt(1-(e-=2)*e)+1)+t},Elastic_EaseIn:function(e,t,r,i,a,s){if(0==e)return t;if(1==(e/=i))return t+r;if(s||(s=.3*i),!a||a<Math.abs(r)){a=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/a);return-a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/s)+t},Elastic_EaseOut:function(e,t,r,i,a,s){if(0==e)return t;if(1==(e/=i))return t+r;if(s||(s=.3*i),!a||a<Math.abs(r)){a=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/a);return a*Math.pow(2,-10*e)*Math.sin((e*i-n)*(2*Math.PI)/s)+r+t},Elastic_EaseInOut:function(e,t,r,i,a,s){if(0==e)return t;if(2==(e/=i/2))return t+r;if(s||(s=i*(.3*1.5)),!a||a<Math.abs(r)){a=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/a);return e<1?a*Math.pow(2,10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/s)*-.5+t:a*Math.pow(2,-10*(e-=1))*Math.sin((e*i-n)*(2*Math.PI)/s)*.5+r+t},Back_EaseIn:function(e,t,r,i,a=undefined){return null==a&&(a=1.70158),r*(e/=i)*e*((a+1)*e-a)+t},Back_EaseOut:function(e,t,r,i,a=undefined){return null==a&&(a=1.70158),r*((e=e/i-1)*e*((a+1)*e+a)+1)+t},Back_EaseInOut:function(e,t,r,i,a=undefined){return null==a&&(a=1.70158),(e/=i/2)<1?r/2*(e*e*((1+(a*=1.525))*e-a))+t:r/2*((e-=2)*e*((1+(a*=1.525))*e+a)+2)+t},Bounce_EaseIn:function(e,t,r,i){return r-AnimationClip2D.tween.Bounce_EaseOut(i-e,0,r,i)+t},Bounce_EaseOut:function(e,t,r,i){return(e/=i)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t},Bounce_EaseInOut:function(e,t,r,i){return e<i/2?.5*AnimationClip2D.tween.Bounce_EaseIn(2*e,0,r,i)+t:.5*AnimationClip2D.tween.Bounce_EaseOut(2*e-i,0,r,i)+.5*r+t},hermiteInterpolate:function(e,t,r,i,a,s){if(Math.abs(e)==1/0||Math.abs(t)==1/0)return r;var n=a*a,o=n*a;return(2*o-3*n+1)*r+(o-2*n+a)*e*s+(o-n)*t*s+(-2*o+3*n)*i}};class Animation2DParm{}e.AniConditionType=void 0,($e=e.AniConditionType||(e.AniConditionType={}))[$e.Greater=0]="Greater",$e[$e.Less=1]="Less",$e[$e.Equals=2]="Equals",$e[$e.NotEqual=3]="NotEqual";class Animation2DCondition{}class AnimatorStateCondition{static conditionNameToID(e){if(null!=AnimatorStateCondition._conditionNameMap[e])return AnimatorStateCondition._conditionNameMap[e];var t=this._propertyNameCounter++;return this._conditionNameMap[e]=t,this._conditionNameMap[t]=e,t}static conditionIDToName(e){return this._conditionNameMap[e]}constructor(e=null){e&&(this._id=AnimatorStateCondition.conditionNameToID(e),this._name=e)}get id(){return this._id}get name(){return this._name}set name(e){this._id=AnimatorStateCondition.conditionNameToID(e),this._name=e}get type(){return this._type}checkState(e){return!1}}AnimatorStateCondition._conditionNameMap={},AnimatorStateCondition._propertyNameCounter=0;class AnimatorStateNumberCondition extends AnimatorStateCondition{constructor(t){super(t),this._numberValue=0,this._numberCompareFlag=e.AniStateConditionNumberCompressType.Greater,this._type=e.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(e){this._numberValue=e}get compareFlag(){return this._numberCompareFlag}set compareFlag(e){this._numberCompareFlag=e}checkState(t){return e.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?t>this._numberValue:t<this._numberValue}}class AnimatorStateBoolCondition extends AnimatorStateCondition{constructor(t){super(t),this._compareFlag=!0,this._type=e.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(e){this._compareFlag=e}checkState(e){return this._compareFlag==e}}class AnimatorStateTriggerCondition extends AnimatorStateCondition{constructor(t){super(t),this._type=e.AniStateConditionType.Trigger}checkState(e){return e}}class AnimatorTransition2D{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(e){-1==this.conditions.indexOf(e)&&this.conditions.push(e)}removeCondition(e){let t=this.conditions.indexOf(e);-1!=t&&this.conditions.splice(t,0)}check(t,r,i){if(this.mute)return!1;if(this.exitByTime&&t<this.exitTime&&!i)return!1;if(null==this.conditions||0==this.conditions.length)return!0;for(var a=0;a<this.conditions.length;a++){let t=this.conditions[a];if(t.checkState(r[t.name].value))return t.type==e.AniStateConditionType.Trigger&&(r[t.name].value=!1),!0}return!1}}class AnimatorController2D extends Resource{constructor(e){super();let t=AnimatorControllerParse.parse(e);this.data=t.ret,this.clipsID=t.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let r=e.length-1;r>=0;r--){let i=e[r],a=new AnimatorControllerLayer2D(i.name);t.unshift(a);for(let e in i)if("name"!=e&&"states"!=e&&null!=i[e])try{a[e]=i[e]}catch(e){}this.getState(i.states,a,this.data)}return t}createState(e,t,r){if(!e)return null;let i={},a=null;for(let s=e.length-1;s>=0;s--){let n=e[s],o=n.states;if(o){let e=this.createState(o,t,r);e&&(t[n.id]=e.states[e.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let e=n.soloTransitions;e&&0<e.length&&(a=e[0].id)}continue}let l=new AnimatorState2D;t[n.id]=l,i[n.id]=l;for(let e in n)try{if("scripts"==e){let t=n[e];if(t&&Array.isArray(t))for(let e=t.length-1;e>=0;e--){let r=t[e];r&&0==r.indexOf("res://")&&(r=r.substring(6));let i=ClassUtils.getClass(r);i&&l.addScript(i)}continue}if("soloTransitions"==e)continue;null!=n[e]&&(l[e]=n[e])}catch(e){}r.addState(l)}return{id:a,states:i}}getState(e,t,r){if(e){let i={};this.createState(e,i,t),this.setTransitions(e,i,t,r)}}setExitTransition(e,t,r,i,a){for(let s in e){let n=r[s];if(n){let o=n.transitions,l=n.soloTransitions,h=e[s];for(let e=t.length-1;e>=0;e--){let n=t[e];if("-3"!=n.id)for(let e=h.length-1;e>=0;e--){let t=h[e],a=new AnimatorTransition2D;a.destState=r[n.id],n.conditions&&this.addConditions(n.conditions,a,i),t.conditions&&this.addConditions(t.conditions,a,i);for(let e in n)"solo"!=e&&"id"!=e&&"conditions"!=e&&(a[e]=n[e]);n.solo?l.unshift(a):o.unshift(a)}else null==a[s]&&(a[s]=[]),a[s].push(n)}}}}_getAnimatorTransition2D(e,t,r){let i=new AnimatorTransition2D;t[e.id]&&(i.destState=t[e.id]),e.conditions&&this.addConditions(e.conditions,i,r);for(let t in e)"solo"!=t&&"id"!=t&&"conditions"!=t&&(i[t]=e[t]);return i}setTransitions(e,t,r,i,a){if(!e)return null;let s={};for(let a=e.length-1;a>=0;a--){let n=e[a];if(n.states){let e=this.setTransitions(n.states,t,r,i,n);if(e){let r=n.soloTransitions;r&&this.setExitTransition(e,r,t,i,s)}}}for(let n=e.length-1;n>=0;n--){let o=e[n];if(o.states)continue;if("-1"==o.id){if(o.soloTransitions&&0<o.soloTransitions.length){null==a?(r.defaultState=t[o.soloTransitions[0].id],r._enterTransition=this._getAnimatorTransition2D(o.soloTransitions[0],t,i)):t[a.id]=t[o.soloTransitions[0].id];continue}}else{if("-2"==o.id){let e=o.soloTransitions;if(e)for(let r=e.length-1;r>=0;r--){let a=e[r];if(t[a.id])for(let e in t){let r=t[e],s=this._getAnimatorTransition2D(a,t,i);a.solo?r.soloTransitions.unshift(s):r.transitions.unshift(s)}}continue}if("-3"==o.id)continue}let l=o.soloTransitions;if(l&&t[o.id]){let e=t[o.id].transitions,r=t[o.id].soloTransitions;for(let a=l.length-1;a>=0;a--){let n=l[a];if("-3"==n.id){null==s[o.id]&&(s[o.id]=[]),s[o.id].push(n);continue}let h=this._getAnimatorTransition2D(n,t,i);n.solo?r.unshift(h):e.unshift(h)}}}return s}addConditions(t,r,i){let a=i.animatorParams;if(null!=a&&0!=a.length)for(let i=0,s=t.length;i<s;i++){let s,n=t[i],o=null;for(let e=a.length-1;e>=0;e--)if(a[e].id==n.id){o=a[e];break}if(null==o)return;if(o.type==e.AniParmType.Bool){let e=new AnimatorStateBoolCondition(o.name);e.compareFlag=Boolean(n.checkValue),s=e}else if(o.type==e.AniParmType.Float){let e=new AnimatorStateNumberCondition(o.name);e.numberValue=Number(n.checkValue),e.compareFlag=n.type,s=e}else if(o.type==e.AniParmType.Trigger){s=new AnimatorStateTriggerCondition(o.name)}r.addCondition(s)}}updateTo(e){let t=e._controllerLayers;for(let e=0,r=t.length;e<r;e++)t[e].destroy();t.length=0;let r=this.getLayers();for(let t=0,i=r.length;t<i;t++)e.addControllerLayer(r[t]);let i=this.data.animatorParams;if(i){let t={};for(let e=i.length-1;e>=0;e--){let r=i[e],a=new Animation2DParm;a.name=r.name,a.type=r.type,a.value=r.val,t[r.name]=a}e.parameters=t}}}const Ze=new Vector3,Je=new Vector3,et=new Vector3,tt=new Vector3,rt=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Matrix4x4{static createRotationX(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=a,r[6]=i,r[9]=-i}static createRotationY(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=a,r[2]=-i,r[8]=i}static createRotationZ(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=a,r[1]=i,r[4]=-i}static createRotationYawPitchRoll(e,t,r,i){Quaternion.createFromYawPitchRoll(e,t,r,Quaternion.TEMP),Matrix4x4.createRotationQuaternion(Quaternion.TEMP,i)}static createRotationAxis(e,t,r){var i=e.x,a=e.y,s=e.z,n=Math.cos(t),o=Math.sin(t),l=i*i,h=a*a,u=s*s,d=i*a,_=i*s,c=a*s,m=r.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=l+n*(1-l),m[1]=d-n*d+o*s,m[2]=_-n*_-o*a,m[4]=d-n*d-o*s,m[5]=h+n*(1-h),m[6]=c-n*c+o*i,m[8]=_-n*_+o*a,m[9]=c-n*c-o*i,m[10]=u+n*(1-u)}static createRotationQuaternion(e,t){var r=t.elements,i=e.x,a=e.y,s=e.z,n=e.w,o=i*i,l=a*a,h=s*s,u=i*a,d=s*n,_=s*i,c=a*n,m=a*s,p=i*n;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(l+h),r[1]=2*(u+d),r[2]=2*(_-c),r[4]=2*(u-d),r[5]=1-2*(h+o),r[6]=2*(m+p),r[8]=2*(_+c),r[9]=2*(m-p),r[10]=1-2*(l+o)}static createTranslate(e,t){var r=t.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}static createScaling(e,t){var r=t.elements;r[0]=e.x,r[5]=e.y,r[10]=e.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}static multiply(e,t,r){var i=t.elements,a=e.elements,s=r.elements,n=i[0],o=i[1],l=i[2],h=i[3],u=i[4],d=i[5],_=i[6],c=i[7],m=i[8],p=i[9],f=i[10],g=i[11],T=i[12],x=i[13],S=i[14],y=i[15],E=a[0],C=a[1],v=a[2],R=a[3],b=a[4],D=a[5],A=a[6],M=a[7],L=a[8],w=a[9],I=a[10],B=a[11],P=a[12],F=a[13],U=a[14],N=a[15];s[0]=n*E+o*b+l*L+h*P,s[1]=n*C+o*D+l*w+h*F,s[2]=n*v+o*A+l*I+h*U,s[3]=n*R+o*M+l*B+h*N,s[4]=u*E+d*b+_*L+c*P,s[5]=u*C+d*D+_*w+c*F,s[6]=u*v+d*A+_*I+c*U,s[7]=u*R+d*M+_*B+c*N,s[8]=m*E+p*b+f*L+g*P,s[9]=m*C+p*D+f*w+g*F,s[10]=m*v+p*A+f*I+g*U,s[11]=m*R+p*M+f*B+g*N,s[12]=T*E+x*b+S*L+y*P,s[13]=T*C+x*D+S*w+y*F,s[14]=T*v+x*A+S*I+y*U,s[15]=T*R+x*M+S*B+y*N}static createFromQuaternion(e,t){var r=t.elements,i=e.x,a=e.y,s=e.z,n=e.w,o=i+i,l=a+a,h=s+s,u=i*o,d=a*o,_=a*l,c=s*o,m=s*l,p=s*h,f=n*o,g=n*l,T=n*h;r[0]=1-_-p,r[1]=d+T,r[2]=c-g,r[3]=0,r[4]=d-T,r[5]=1-u-p,r[6]=m+f,r[7]=0,r[8]=c+g,r[9]=m-f,r[10]=1-u-_,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}static createAffineTransformation(e,t,r,i){var a=i.elements,s=t.x,n=t.y,o=t.z,l=t.w,h=s+s,u=n+n,d=o+o,_=s*h,c=s*u,m=s*d,p=n*u,f=n*d,g=o*d,T=l*h,x=l*u,S=l*d,y=r.x,E=r.y,C=r.z;a[0]=(1-(p+g))*y,a[1]=(c+S)*y,a[2]=(m-x)*y,a[3]=0,a[4]=(c-S)*E,a[5]=(1-(_+g))*E,a[6]=(f+T)*E,a[7]=0,a[8]=(m+x)*C,a[9]=(f-T)*C,a[10]=(1-(_+p))*C,a[11]=0,a[12]=e.x,a[13]=e.y,a[14]=e.z,a[15]=1}static createLookAt(e,t,r,i){var a=i.elements,s=Ze,n=Je,o=et;Vector3.subtract(e,t,o),Vector3.normalize(o,o),Vector3.cross(r,o,s),Vector3.normalize(s,s),Vector3.cross(o,s,n),a[3]=a[7]=a[11]=0,a[15]=1,a[0]=s.x,a[4]=s.y,a[8]=s.z,a[1]=n.x,a[5]=n.y,a[9]=n.z,a[2]=o.x,a[6]=o.y,a[10]=o.z,a[12]=-Vector3.dot(s,e),a[13]=-Vector3.dot(n,e),a[14]=-Vector3.dot(o,e)}static createPerspective(e,t,r,i,a){var s=1/Math.tan(.5*e),n=r/(s/t),o=r/s;Matrix4x4.createPerspectiveOffCenter(-n,n,-o,o,r,i,a)}static createPerspectiveOffCenter(e,t,r,i,a,s,n){var o=n.elements,l=s/(s-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[12]=o[13]=o[15]=0,o[0]=2*a/(t-e),o[5]=2*a/(i-r),o[8]=(e+t)/(t-e),o[9]=(i+r)/(i-r),o[10]=-l,o[11]=-1,o[14]=-a*l}static createOrthoOffCenter(e,t,r,i,a,s,n){var o=n.elements,l=1/(s-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[8]=o[7]=o[9]=o[11]=0,o[15]=1,o[0]=2/(t-e),o[5]=2/(i-r),o[10]=-l,o[12]=(e+t)/(e-t),o[13]=(i+r)/(r-i),o[14]=-a*l}constructor(e=1,t=0,r=0,i=0,a=0,s=1,n=0,o=0,l=0,h=0,u=1,d=0,_=0,c=0,m=0,p=1,f=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var g=this.elements=f||new Float32Array(16);g[0]=e,g[1]=t,g[2]=r,g[3]=i,g[4]=a,g[5]=s,g[6]=n,g[7]=o,g[8]=l,g[9]=h,g[10]=u,g[11]=d,g[12]=_,g[13]=c,g[14]=m,g[15]=p}}else this.elements=rt.slice()}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,r){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=r}setRotation(e){var t=e.x,r=e.y,i=e.z,a=e.w,s=t*t,n=r*r,o=i*i,l=t*r,h=i*a,u=i*t,d=r*a,_=r*i,c=t*a,m=this.elements;m[0]=1-2*(n+o),m[1]=2*(l+h),m[2]=2*(u-d),m[4]=2*(l-h),m[5]=1-2*(o+s),m[6]=2*(_+c),m[8]=2*(u+d),m[9]=2*(_-c),m[10]=1-2*(n+s)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}equalsOtherMatrix(e){var t=this.elements,r=e.elements;return MathUtils3D.nearEqual(t[0],r[0])&&MathUtils3D.nearEqual(t[1],r[1])&&MathUtils3D.nearEqual(t[2],r[2])&&MathUtils3D.nearEqual(t[3],r[3])&&MathUtils3D.nearEqual(t[4],r[4])&&MathUtils3D.nearEqual(t[5],r[5])&&MathUtils3D.nearEqual(t[6],r[6])&&MathUtils3D.nearEqual(t[7],r[7])&&MathUtils3D.nearEqual(t[8],r[8])&&MathUtils3D.nearEqual(t[9],r[9])&&MathUtils3D.nearEqual(t[10],r[10])&&MathUtils3D.nearEqual(t[11],r[11])&&MathUtils3D.nearEqual(t[12],r[12])&&MathUtils3D.nearEqual(t[13],r[13])&&MathUtils3D.nearEqual(t[14],r[14])&&MathUtils3D.nearEqual(t[15],r[15])}decomposeTransRotScale(e,t,r){var i=it;return this.decomposeTransRotMatScale(e,i,r)?(Quaternion.createFromMatrix4x4(i,t),!0):(t.identity(),!1)}decomposeTransRotMatScale(e,t,r){var i=this.elements,a=e,s=t.elements,n=r;a.x=i[12],a.y=i[13],a.z=i[14];var o=i[0],l=i[1],h=i[2],u=i[4],d=i[5],_=i[6],c=i[8],m=i[9],p=i[10],f=n.x=Math.sqrt(o*o+l*l+h*h),g=n.y=Math.sqrt(u*u+d*d+_*_),T=n.z=Math.sqrt(c*c+m*m+p*p);if(MathUtils3D.isZero(f)||MathUtils3D.isZero(g)||MathUtils3D.isZero(T))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var x=Ze;x.x=c/T,x.y=m/T,x.z=p/T;var S=Je;S.x=o/f,S.y=l/f,S.z=h/f;var y=et;Vector3.cross(x,S,y);var E=Je;return Vector3.cross(y,x,E),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=E.x,s[1]=E.y,s[2]=E.z,s[4]=y.x,s[5]=y.y,s[6]=y.z,s[8]=x.x,s[9]=x.y,s[10]=x.z,s[0]*o+s[1]*l+s[2]*h<0&&(n.x=-f),s[4]*u+s[5]*d+s[6]*_<0&&(n.y=-g),s[8]*c+s[9]*m+s[10]*p<0&&(n.z=-T),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>MathUtils3D.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],r=e[1],i=e[2],a=Math.sqrt(t*t+r*r+i*i);if(!a)return e[0]=0,e[1]=0,void(e[2]=0);1!=a&&(a=1/a,e[0]=t*a,e[1]=r*a,e[2]=i*a)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,r=e.elements,i=t[0],a=t[1],s=t[2],n=t[3],o=t[4],l=t[5],h=t[6],u=t[7],d=t[8],_=t[9],c=t[10],m=t[11],p=t[12],f=t[13],g=t[14],T=t[15],x=i*l-a*o,S=i*h-s*o,y=i*u-n*o,E=a*h-s*l,C=a*u-n*l,v=s*u-n*h,R=d*f-_*p,b=d*g-c*p,D=d*T-m*p,A=_*g-c*f,M=_*T-m*f,L=c*T-m*g,w=x*L-S*M+y*A+E*D-C*b+v*R;0!==Math.abs(w)&&(w=1/w,r[0]=(l*L-h*M+u*A)*w,r[1]=(s*M-a*L-n*A)*w,r[2]=(f*v-g*C+T*E)*w,r[3]=(c*C-_*v-m*E)*w,r[4]=(h*D-o*L-u*b)*w,r[5]=(i*L-s*D+n*b)*w,r[6]=(g*y-p*v-T*S)*w,r[7]=(d*v-c*y+m*S)*w,r[8]=(o*M-l*D+u*R)*w,r[9]=(a*D-i*M-n*R)*w,r[10]=(p*C-f*y+T*x)*w,r[11]=(_*y-d*C-m*x)*w,r[12]=(l*b-o*A-h*R)*w,r[13]=(i*A-a*b+s*R)*w,r[14]=(f*S-p*E-g*x)*w,r[15]=(d*E-_*S+c*x)*w)}static billboard(e,t,r,i,a){Vector3.subtract(e,t,Ze);var s=Vector3.scalarLengthSquared(Ze);MathUtils3D.isZero(s)?(Vector3.scale(i,-1,Je),Je.cloneTo(Ze)):Vector3.scale(Ze,1/Math.sqrt(s),Ze),Vector3.cross(r,Ze,et),Vector3.normalize(et,et),Vector3.cross(Ze,et,tt);var n=et,o=tt,l=Ze,h=e,u=a.elements;u[0]=n.x,u[1]=n.y,u[2]=n.z,u[3]=0,u[4]=o.x,u[5]=o.y,u[6]=o.z,u[7]=0,u[8]=l.x,u[9]=l.y,u[10]=l.z,u[11]=0,u[12]=h.x,u[13]=h.y,u[14]=h.z,u[15]=1}identity(){this.elements.set(rt)}isIdentity(){let e=this.elements,t=Matrix4x4.DEFAULT.elements;for(let a=0,s=e.length;a<s;a++)if(r=e[a],i=t[a],!(Math.abs(r-i)<1e-7))return!1;var r,i;return!0}cloneTo(e){this.elements!==e.elements&&e.elements.set(this.elements)}cloneByArray(e){this.elements.set(e)}clone(){var e=new Matrix4x4(null);return e.elements=this.elements.slice(),e}static translation(e,t){var r=t.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,r=e;t[12]=r.x,t[13]=r.y,t[14]=r.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}getInvertFront(){this.decomposeTransRotScale(Ze,Quaternion.TEMP,Je);var e=Je,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}Matrix4x4.TEMPMatrix0=new Matrix4x4,Matrix4x4.TEMPMatrix1=new Matrix4x4,Matrix4x4.DEFAULT=new Matrix4x4,Matrix4x4.DEFAULTINVERT=new Matrix4x4(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),Matrix4x4.ZERO=new Matrix4x4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const it=new Matrix4x4,at=new Float32Array([1,0,0,0,1,0,0,0,1]),st=new Vector3,nt=new Vector3,ot=new Vector3;class Matrix3x3{static createRotationQuaternion(e,t){var r=e.x,i=e.y,a=e.z,s=e.w,n=r*r,o=i*i,l=a*a,h=r*i,u=a*s,d=a*r,_=i*s,c=i*a,m=r*s,p=t.elements;p[0]=1-2*(o+l),p[1]=2*(h+u),p[2]=2*(d-_),p[3]=2*(h-u),p[4]=1-2*(l+n),p[5]=2*(c+m),p[6]=2*(d+_),p[7]=2*(c-m),p[8]=1-2*(o+n)}static createFromTranslation(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1}static createFromRotation(e,t){var r=t.elements,i=Math.sin(e),a=Math.cos(e);r[0]=a,r[1]=i,r[2]=0,r[3]=-i,r[4]=a,r[5]=0,r[6]=0,r[7]=0,r[8]=1}static createFromScaling(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=e.z}static createFromMatrix4x4(e,t){var r=e.elements,i=t.elements;i[0]=r[0],i[1]=r[1],i[2]=r[2],i[3]=r[4],i[4]=r[5],i[5]=r[6],i[6]=r[8],i[7]=r[9],i[8]=r[10]}static multiply(e,t,r){var i=e.elements,a=t.elements,s=r.elements,n=i[0],o=i[1],l=i[2],h=i[3],u=i[4],d=i[5],_=i[6],c=i[7],m=i[8],p=a[0],f=a[1],g=a[2],T=a[3],x=a[4],S=a[5],y=a[6],E=a[7],C=a[8];s[0]=p*n+f*h+g*_,s[1]=p*o+f*u+g*E,s[2]=p*l+f*d+g*m,s[3]=T*n+x*h+S*_,s[4]=T*o+x*u+S*c,s[5]=T*l+x*d+S*m,s[6]=y*n+E*h+C*_,s[7]=y*o+E*u+C*c,s[8]=y*l+E*d+C*m}constructor(e=!0){e&&(this.elements=at.slice())}determinant(){var e=this.elements,t=e[0],r=e[1],i=e[2],a=e[3],s=e[4],n=e[5],o=e[6],l=e[7],h=e[8];return t*(h*s-n*l)+r*(-h*a+n*o)+i*(l*a-s*o)}translate(e,t){var r=t.elements,i=this.elements,a=i[0],s=i[1],n=i[2],o=i[3],l=i[4],h=i[5],u=i[6],d=i[7],_=i[8],c=e.x,m=e.y;r[0]=a,r[1]=s,r[2]=n,r[3]=o,r[4]=l,r[5]=h,r[6]=c*a+m*o+u,r[7]=c*s+m*l+d,r[8]=c*n+m*h+_}rotate(e,t){var r=t.elements,i=this.elements,a=i[0],s=i[1],n=i[2],o=i[3],l=i[4],h=i[5],u=i[6],d=i[7],_=i[8],c=Math.sin(e),m=Math.cos(e);r[0]=m*a+c*o,r[1]=m*s+c*l,r[2]=m*n+c*h,r[3]=m*o-c*a,r[4]=m*l-c*s,r[5]=m*h-c*n,r[6]=u,r[7]=d,r[8]=_}scale(e,t){var r=t.elements,i=this.elements,a=e.x,s=e.y;r[0]=a*i[0],r[1]=a*i[1],r[2]=a*i[2],r[3]=s*i[3],r[4]=s*i[4],r[5]=s*i[5],r[6]=i[6],r[7]=i[7],r[8]=i[8]}invert(e){var t=e.elements,r=this.elements,i=r[0],a=r[1],s=r[2],n=r[3],o=r[4],l=r[5],h=r[6],u=r[7],d=r[8],_=d*o-l*u,c=-d*n+l*h,m=u*n-o*h,p=i*_+a*c+s*m;p&&(p=1/p,t[0]=_*p,t[1]=(-d*a+s*u)*p,t[2]=(l*a-s*o)*p,t[3]=c*p,t[4]=(d*i-s*h)*p,t[5]=(-l*i+s*n)*p,t[6]=m*p,t[7]=(-u*i+a*h)*p,t[8]=(o*i-a*n)*p)}transpose(e){var t=e.elements,r=this.elements;if(e===this){var i=r[1],a=r[2],s=r[5];t[1]=r[3],t[2]=r[6],t[3]=i,t[5]=r[7],t[6]=a,t[7]=s}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8]}identity(){this.elements.set(at)}cloneTo(e){var t,r;(t=this.elements)!==(r=e.elements)&&t.set(r)}clone(){var e=new Matrix3x3(!1);return e.elements=this.elements.slice(),e}static lookAt(e,t,r,i){Vector3.subtract(e,t,st),Vector3.normalize(st,st),Vector3.cross(r,st,nt),Vector3.normalize(nt,nt),Vector3.cross(st,nt,ot);var a=st,s=nt,n=ot,o=i.elements;o[0]=s.x,o[3]=s.y,o[6]=s.z,o[1]=n.x,o[4]=n.y,o[7]=n.z,o[2]=a.x,o[5]=a.y,o[8]=a.z}static forwardLookAt(e,t,r,i){var a=nt,s=ot,n=st;t.vsub(e,n).normalize(),r.cross(n,a).normalize(),n.cross(a,s);var o=i.elements;o[0]=a.x,o[1]=a.y,o[2]=a.z,o[3]=s.x,o[4]=s.y,o[5]=s.z,o[6]=n.x,o[7]=n.y,o[8]=n.z}}Matrix3x3.DEFAULT=new Matrix3x3;const lt=new Vector3,ht=new Vector3,ut=new Vector3,dt=new Vector3,_t=new Matrix3x3;class Quaternion{static createFromYawPitchRoll(e,t,r,i){var a=.5*r,s=.5*t,n=.5*e,o=Math.sin(a),l=Math.cos(a),h=Math.sin(s),u=Math.cos(s),d=Math.sin(n),_=Math.cos(n);i.x=_*h*l+d*u*o,i.y=d*u*l-_*h*o,i.z=_*u*o-d*h*l,i.w=_*u*l+d*h*o}static multiply(e,t,r){var i=e.x,a=e.y,s=e.z,n=e.w,o=t.x,l=t.y,h=t.z,u=t.w,d=a*h-s*l,_=s*o-i*h,c=i*l-a*o,m=i*o+a*l+s*h;r.x=i*u+o*n+d,r.y=a*u+l*n+_,r.z=s*u+h*n+c,r.w=n*u-m}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,t,r){Vector3.subtract(t,e,lt),Vector3.normalize(lt,lt),r.x=Math.asin(lt.y),r.y=Quaternion.arcTanAngle(-lt.z,-lt.x)}static createFromAxisAngle(e,t,r){t*=.5;var i=Math.sin(t);r.x=i*e.x,r.y=i*e.y,r.z=i*e.z,r.w=Math.cos(t)}static createFromMatrix4x4(e,t){var r,i,a=e.elements,s=a[0]+a[5]+a[10];s>0?(r=Math.sqrt(s+1),t.w=.5*r,r=.5/r,t.x=(a[6]-a[9])*r,t.y=(a[8]-a[2])*r,t.z=(a[1]-a[4])*r):a[0]>=a[5]&&a[0]>=a[10]?(i=.5/(r=Math.sqrt(1+a[0]-a[5]-a[10])),t.x=.5*r,t.y=(a[1]+a[4])*i,t.z=(a[2]+a[8])*i,t.w=(a[6]-a[9])*i):a[5]>a[10]?(i=.5/(r=Math.sqrt(1+a[5]-a[0]-a[10])),t.x=(a[4]+a[1])*i,t.y=.5*r,t.z=(a[9]+a[6])*i,t.w=(a[8]-a[2])*i):(i=.5/(r=Math.sqrt(1+a[10]-a[0]-a[5])),t.x=(a[8]+a[2])*i,t.y=(a[9]+a[6])*i,t.z=.5*r,t.w=(a[1]-a[4])*i)}static slerp(e,t,r,i){var a,s,n,o,l,h=e.x,u=e.y,d=e.z,_=e.w,c=t.x,m=t.y,p=t.z,f=t.w;return(s=h*c+u*m+d*p+_*f)<0&&(s=-s,c=-c,m=-m,p=-p,f=-f),1-s>1e-6?(a=Math.acos(s),n=Math.sin(a),o=Math.sin((1-r)*a)/n,l=Math.sin(r*a)/n):(o=1-r,l=r),i.x=o*h+l*c,i.y=o*u+l*m,i.z=o*d+l*p,i.w=o*_+l*f,i}static lerp(e,t,r,i){var a=1-r;Quaternion.dot(e,t)>=0?(i.x=a*e.x+r*t.x,i.y=a*e.y+r*t.y,i.z=a*e.z+r*t.z,i.w=a*e.w+r*t.w):(i.x=a*e.x-r*t.x,i.y=a*e.y-r*t.y,i.z=a*e.z-r*t.z,i.w=a*e.w-r*t.w),i.normalize(i)}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}constructor(e=0,t=0,r=0,i=1){this.x=e,this.y=t,this.z=r,this.w=i}setValue(e,t,r,i){this.x=e,this.y=t,this.z=r,this.w=i}set(e,t,r,i){return this.x=e,this.y=t,this.z=r,this.w=i,this}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.w*r,t.y=this.y*i+this.z*r,t.z=this.z*i-this.y*r,t.w=this.w*i-this.x*r}rotateY(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i-this.z*r,t.y=this.y*i+this.w*r,t.z=this.z*i+this.x*r,t.w=this.w*i-this.y*r}rotateZ(e,t){e*=.5;var r=Math.sin(e),i=Math.cos(e);t.x=this.x*i+this.y*r,t.y=this.y*i-this.x*r,t.z=this.z*i+this.w*r,t.w=this.w*i-this.z*r}getYawPitchRoll(e){Vector3.transformQuat(Vector3.ForwardRH,this,ht),Vector3.transformQuat(Vector3.Up,this,ut);var t=ut;Quaternion.angleTo(Vector3.ZERO,ht,dt);var r=dt;r.x==Math.PI/2?(r.y=Quaternion.arcTanAngle(t.z,t.x),r.z=0):r.x==-Math.PI/2?(r.y=Quaternion.arcTanAngle(-t.z,-t.x),r.z=0):(Matrix4x4.createRotationY(-r.y,Matrix4x4.TEMPMatrix0),Matrix4x4.createRotationX(-r.x,Matrix4x4.TEMPMatrix1),Vector3.transformCoordinate(ut,Matrix4x4.TEMPMatrix0,ut),Vector3.transformCoordinate(ut,Matrix4x4.TEMPMatrix1,ut),r.z=Quaternion.arcTanAngle(t.y,-t.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var i=e;i.x=r.y,i.y=r.x,i.z=r.z}invert(e){var t=this.x,r=this.y,i=this.z,a=this.w,s=t*t+r*r+i*i+a*a,n=s?1/s:0;e.x=-t*n,e.y=-r*n,e.z=-i*n,e.w=a*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var e=new Quaternion;return this.cloneTo(e),e}equals(e){return MathUtils3D.nearEqual(this.x,e.x)&&MathUtils3D.nearEqual(this.y,e.y)&&MathUtils3D.nearEqual(this.z,e.z)&&MathUtils3D.nearEqual(this.w,e.w)}static rotationLookAt(e,t,r){Quaternion.lookAt(Vector3.ZERO,e,t,r)}static lookAt(e,t,r,i){Matrix3x3.lookAt(e,t,r,_t),Quaternion.rotationMatrix(_t,i)}static forwardLookAt(e,t,r,i){Matrix3x3.forwardLookAt(e,t,r,_t),Quaternion.rotationMatrix(_t,i)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var r=e.lengthSquared();MathUtils3D.isZero(r)||(r=1/r,t.x=-e.x*r,t.y=-e.y*r,t.z=-e.z*r,t.w=e.w*r)}static rotationMatrix(e,t){var r,i,a=e.elements,s=a[0],n=a[1],o=a[2],l=a[3],h=a[4],u=a[5],d=a[6],_=a[7],c=a[8],m=s+h+c;m>0?(r=Math.sqrt(m+1),t.w=.5*r,r=.5/r,t.x=(u-_)*r,t.y=(d-o)*r,t.z=(n-l)*r):s>=h&&s>=c?(i=.5/(r=Math.sqrt(1+s-h-c)),t.x=.5*r,t.y=(n+l)*i,t.z=(o+d)*i,t.w=(u-_)*i):h>c?(i=.5/(r=Math.sqrt(1+h-s-c)),t.x=(l+n)*i,t.y=.5*r,t.z=(_+u)*i,t.w=(d-o)*i):(i=.5/(r=Math.sqrt(1+c-s-h)),t.x=(d+o)*i,t.y=(_+u)*i,t.z=.5*r,t.w=(n-l)*i)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1),Vector2.rewriteNumProperty(this,"z",2),Vector2.rewriteNumProperty(this,"w",3)}}Quaternion.TEMP=new Quaternion,Quaternion.DEFAULT=new Quaternion,Quaternion.NAN=new Quaternion(NaN,NaN,NaN,NaN);class Script extends Component{_isScript(){return!0}setupScript(){let e,t=this.owner;(e=this.onTriggerEnter)&&t.on(Event.TRIGGER_ENTER,this,e),(e=this.onTriggerStay)&&t.on(Event.TRIGGER_STAY,this,e),(e=this.onTriggerExit)&&t.on(Event.TRIGGER_EXIT,this,e),(e=this.onCollisionEnter)&&t.on(Event.COLLISION_ENTER,this,e),(e=this.onCollisionStay)&&t.on(Event.COLLISION_STAY,this,e),(e=this.onCollisionExit)&&t.on(Event.COLLISION_EXIT,this,e),(e=this.onJointBreak)&&t.on(Event.JOINT_BREAK,this,e),(e=this.onMouseDown)&&t.on(Event.MOUSE_DOWN,this,e),(e=this.onMouseUp)&&t.on(Event.MOUSE_UP,this,e),(e=this.onRightMouseDown)&&t.on(Event.RIGHT_MOUSE_DOWN,this,e),(e=this.onRightMouseUp)&&t.on(Event.RIGHT_MOUSE_UP,this,e),(e=this.onMouseMove)&&t.on(Event.MOUSE_MOVE,this,e),(e=this.onMouseDrag)&&t.on(Event.MOUSE_DRAG,this,e),(e=this.onMouseDragEnd)&&t.on(Event.MOUSE_DRAG_END,this,e),(e=this.onMouseOver)&&t.on(Event.MOUSE_OVER,this,e),(e=this.onMouseOut)&&t.on(Event.MOUSE_OUT,this,e),(e=this.onMouseClick)&&t.on(Event.CLICK,this,e),(e=this.onMouseDoubleClick)&&t.on(Event.DOUBLE_CLICK,this,e),(e=this.onMouseRightClick)&&t.on(Event.RIGHT_CLICK,this,e),(e=this.onKeyDown)&&ILaya.stage.on(Event.KEY_DOWN,this,e),(e=this.onKeyPress)&&ILaya.stage.on(Event.KEY_PRESS,this,e),(e=this.onKeyUp)&&ILaya.stage.on(Event.KEY_UP,this,e)}}var ct;e.TextResourceFormat=void 0,(ct=e.TextResourceFormat||(e.TextResourceFormat={}))[ct.Buffer=0]="Buffer",ct[ct.Plain=1]="Plain",ct[ct.JSON=2]="JSON",ct[ct.XML=3]="XML";class TextResource extends Resource{constructor(e,t){super(),this.data=e,this.format=t}}Loader.registerLoader(["txt","csv"],class{load(t){return t.loader.fetch(t.url,"text",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.Plain):null))}},Loader.TEXT),Loader.registerLoader(["bin","bytes","fui"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.Buffer):null))}},Loader.BUFFER),Loader.registerLoader(["json"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.JSON):null))}},Loader.JSON),Loader.registerLoader(["xml"],class{load(t){return t.loader.fetch(t.url,"xml",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.XML):null))}},Loader.XML);Loader.registerLoader(["atlas"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{if(!t)return null;let r=[];if(t.meta&&t.meta.image){let i="",a=e.url.lastIndexOf("/");-1!=a&&(i=e.url.substring(0,a+1));let s="";a=e.url.lastIndexOf("?"),-1!=a&&(s=e.url.substring(a));let n=t.meta.image.split(",");for(let t of n)r.push(e.loader.load(i+t+s,null,e.progress.createCallback()))}else r.push(e.loader.load(Utils.replaceFileExtension(e.url,"png"),null,e.progress.createCallback()));return Promise.all(r).then((r=>{let i=e.options.baseUrl||"",a=t.frames,s=t.meta&&null!=t.meta.prefix?t.meta.prefix:e.url.substring(0,e.url.lastIndexOf("."))+"/",n=[],o=1;t.meta&&t.meta.scale&&1!=t.meta.scale&&(o=parseFloat(t.meta.scale));for(let e of r)e&&(e._addReference(),e.scaleRate=o);for(let t in a){let o=a[t],l=r[o.frame.idx?o.frame.idx:0];if(!l)continue;let h=i+s+(o.filename||t),u=Texture.create(l,o.frame.x,o.frame.y,o.frame.w,o.frame.h,o.spriteSourceSize.x,o.spriteSourceSize.y,o.sourceSize.w,o.sourceSize.h);u.lock=!0,u._sizeGrid=o.sizeGrid,u._stateNum=o.stateNum,e.loader.cacheRes(h,u),u.url=h,n.push(u)}return new AtlasResource(s,r,n)}))}))}},Loader.ATLAS);const mt={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};var pt,ft,gt;class SerializeUtil{static decodeObj(e,t,r){r?(pt=r.outErrors,ft=r.getNodeByRef,gt=r.getNodeData):(pt=null,ft=null,gt=null),SerializeUtil.isDeserializing=!0;try{return SerializeUtil._decodeObj(e,t)}finally{SerializeUtil.isDeserializing=!1}}static _decodeObj(e,t){if(null==e)return null;if(Array.isArray(e)){let t=[];for(let r=0;r<e.length;r++){let i=e[r];if(null!=i)try{t[r]=this._decodeObj(i)}catch(e){pt&&pt.push(e),t[r]=null}else t[r]=null}return t}if("object"==typeof e){if(null!=e._$uuid){let t=URL.getResURLByUUID(e._$uuid);return ILaya.loader.getRes(t,SerializeUtil.getLoadTypeByEngineType(e._$type))}if(null!=e._$ref){let t=null==ft?void 0:ft(e._$ref);if(t&&e._$type){let r=ClassUtils.getClass(e._$type);return r?t.getComponent(r):null}return t}let r=e._$type;if("any"===r)return e._$type?e.value:e;let i=mt[r];if(null!=i)return e._$type?new i(e.value):new i(e);if(!t){let e=ClassUtils.getClass(r);if(!e)return null;t=new e}for(let r in e){if(r.startsWith("_$"))continue;let i=e[r];if(null==i||"object"!=typeof i||Array.isArray(i)||i._$type||i._$uuid||i._$ref)try{let e=SerializeUtil._decodeObj(i);t[r]=e,null!=e&&null!=i&&i._$tmpl&&(t[i._$tmpl]=gt(e))}catch(e){pt&&pt.push(e)}else{let e=t[r];if(e)try{SerializeUtil._decodeObj(i,e)}catch(e){pt&&pt.push(e)}}}return t.onAfterDeserialize&&t.onAfterDeserialize(),t}return e}static getLoadTypeByEngineType(e){switch(e){case"Texture2D":case"RenderTexture":return Loader.TEXTURE2D;case"TextureCube":return Loader.TEXTURECUBE;case"Prefab":return Loader.HIERARCHY;default:return null}}static bakeOverrideData(e){let t=null;for(let r=e.length,i=r-1;i>=0;i--){let a=e[i];if(a&&a.length>0)for(let e of a){let a,s=e._$override||e._$parent;if(Array.isArray(s)?a=s[r-i-1]:i==r-1&&(a=s),null!=a){t||(t={});let s=t[a];s||(t[a]=s=[]),s.push(r-i,e)}}}return t}static applyOverrideData(e,t){return function test(e){if(t[e._$id])return!0;let r=e._$child;return!(!r||!r.find((e=>test(e))))}(e)&&(e=function cloneTree(e){let t=Object.assign({},e),r=t._$child;r&&(t._$child=r.map((e=>cloneTree(e))));let i=t._$comp;return i&&(t._$comp=i.map((e=>Object.assign({},e)))),t}(e),function visit(e){let r=e._$child;if(r)for(let e of r)e._$id&&visit(e);let i=t[e._$id];if(i)for(let t=0;t<i.length;t+=2){let a,s=i[t],n=i[t+1];if(a=n._$override){let t;if(Array.isArray(a))if(s==a.length-1){let i=a[s];r?t=r.find((e=>e._$override==i)):e._$child=r=[],t||(t={_$override:i},r.push(t))}else if(s<a.length-1){let i=a.slice(s);r?t=r.find((e=>{let t=e._$override;return Array.isArray(t)&&arrayEquals(t,i)})):e._$child=r=[],t||(t={_$override:i},r.push(t))}else t=e;else t=e;if(mergeData(t,n),n._$comp){let e=t._$comp;e||(t._$comp=e=[]);for(let t of n._$comp){let r=t._$type||t._$override,i=e.find((e=>e._$override==r||e._$type==r));i||(i={},t._$type?i._$type=r:i._$override=r,e.push(i)),mergeData(i,t)}}}else if(a=n._$parent){let t;if(r||(e._$child=r=[]),s<a.length){t=s==a.length-1?a[s]:a.slice(s);let e=Object.assign({},n);e._$parent=t,r.push(e)}else{let t=Object.assign({},n);delete t._$parent,e._$prefab?r.push(t):(delete t._$index,n._$index<r.length?r.splice(n._$index,0,t):r.push(t))}}}}(e)),e}}function mergeData(e,t){for(let r in t){if(r.startsWith("_$"))continue;let i=t[r];if(null==i||"object"!=typeof i||Array.isArray(i)||(i._$type||i._$uuid||i._$ref))e[r]=i;else{let t=e[r];null!=t&&"object"==typeof t?(e[r]=t=Object.assign({},t),mergeData(t,i)):e[r]=i}}}function arrayEquals(e,t){if(e.length===t.length){for(var r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}return!1}SerializeUtil.isDeserializing=!1;const Tt=[];class HierarchyParser{static parse(e,t,r){r=r||Tt;let i,a,s,n,o,l,h,u={},d=[],_=[],c=[];function createChildren(e,t){for(let r of e._$child)if(r._$child){let e=createNode(r,t);createChildren(r,r._$prefab?e:t),d.push(r),_.push(e)}else{let e=createNode(r,t);d.push(r),_.push(e)}}function createNode(e,t,i){let a,n;if(n=e._$override){if(t&&s)if(Array.isArray(n)){a=t;for(let e=0,t=n.length;e<t;e++){let t=s.get(a);if(a=null==t?void 0:t[n[e]],!a)break}}else{let r=s.get(t);r&&(a=r[e._$override])}}else{if(n=e._$prefab){let t=Loader.getRes(URL.getResURLByUUID(n),Loader.HIERARCHY);if(t){s||(s=new Map);let i=[],n=e._$id;if(o)for(let e=0,t=o.length;e<t;e++){let r=o[e];r&&r.length>0?i[e]=r.filter((r=>{let i=r._$override||r._$parent;return Array.isArray(i)&&i.length>t-e&&i[t-e-1]==n})):i[e]=r}i.push(e._$child),a=t.create({inPrefab:!0,prefabNodeDict:s,overrideData:i},r)}}else if(n=e._$type){let e=null!=i?i:ClassUtils.getClass(n);if(e)try{a=new e}catch(e){r.push(e)}else r.push(new Error(`unknown type '${n}'`))}a&&(u[e._$id]=a)}return a}function findNodeInPrefab(e,t,r=0){if(!t)return e;let i=null==s?void 0:s.get(e);if(!i)return null;if(Array.isArray(t)){let e;for(let a=r,n=t.length;a<n;a++){if(!i)return null;if(e=i[t[a]],!e)break;i=s.get(e)}return e}return i[t]}if(t&&(a=t.inPrefab,a&&(s=t.prefabNodeDict),n=t.skinBaseUrl,o=t.overrideData),e._$type||e._$prefab){if(h=e._$runtime){h.startsWith("res://")&&(h=h.substring(6));let e=ClassUtils.getClass(h);e?h=e:r.push(new Error(`unknown runtime '${h}'`))}let t=createNode(e,null,h);t&&(e._$child&&createChildren(e,e._$prefab?t:null),d.push(e),_.push(t),t instanceof Scene&&(i=t))}else e._$child&&createChildren(e,null);let m=d.length,p=0;for(let e=0;e<m;e++){let t=d[e],r=_[e],a=t._$child;if(a){let s=a.length;if(r)if(t._$prefab)for(let t=0;t<s;t++){let i=c[p-s+t];if(i&&!i.parent){let a=d[e-s+t],n=findNodeInPrefab(r,a._$parent);if(n){let e=a._$index;null!=e&&e<n.numChildren?n.addChildAt(i,e):n.addChild(i)}else r.addChildAt(i,0)}}else for(let e=0;e<s;e++){let t=c[p-s+e];t&&(r===i&&t._is3D?i._scene3D=t:r.addChild(t))}p-=s}c[p]=r,p++}c.length=p,c=c.filter((e=>null!=e));let f=c[0],g=[];for(let e=0;e<m;e++){let t=d[e]._$comp;if(!t)continue;let i=_[e];if(i)for(let e of t){let t;if(e._$override){let r=ClassUtils.getClass(e._$override);r&&(t=i.getComponent(r))}else{let a=ClassUtils.getClass(e._$type);if(a&&(t=i.getComponent(a),!t))try{t=i.addComponent(a)}catch(e){r.push(e)}}t&&g.push(e,t)}}const T={outErrors:r,getNodeByRef:function(e){if(Array.isArray(e)){let t=u[e[0]];return t&&e.length>1?findNodeInPrefab(t,e,1):t}return u[e]},getNodeData:function(e){e.visible=!1;let t=_.indexOf(e),r=d[t];return o?(void 0===l&&(l=SerializeUtil.bakeOverrideData(o)),l?SerializeUtil.applyOverrideData(r,l):r):r}};for(let e=0;e<m;e++){let t=d[e],i=_[e];if(i&&(null!=n&&i instanceof Sprite&&(i._skinBaseUrl=n),SerializeUtil.decodeObj(t,i,T),h&&t._$var&&i.name))try{f[i.name]=i}catch(e){r.push(e)}}m=g.length;for(let e=0;e<m;e+=2)SerializeUtil.decodeObj(g[e],g[e+1],T);return a&&s&&f&&s.set(f,u),r==Tt&&(Tt.length=0),c}static collectResourceLinks(e,t){let r={},i=[];function addInnerUrl(e,a){if(!e)return"";let s=r[e];if(void 0===s){let n;n=e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:URL.join(t,e),i.push({url:n,type:a}),r[e]=s=[n,a]}else-1==s.indexOf(a,1)&&(s.push(a),i.push({url:s[0],type:a}));return s[0]}if(function check(e){for(let t in e){let r=e[t];if(null!=r)if(Array.isArray(r))for(let e of r)null!=e&&"object"==typeof e&&(null!=e._$uuid?e._$uuid=addInnerUrl(e._$uuid,SerializeUtil.getLoadTypeByEngineType(e._$type)):null!=e._$prefab?(e._$prefab=addInnerUrl(e._$prefab,Loader.HIERARCHY),check(e)):check(e));else"object"==typeof r&&(null!=r._$uuid?r._$uuid=addInnerUrl(r._$uuid,SerializeUtil.getLoadTypeByEngineType(r._$type)):null!=r._$prefab?(r._$prefab=addInnerUrl(r._$prefab,Loader.HIERARCHY),check(r)):check(r))}}(e),e._$preloads)for(let t of e._$preloads)i.push(t);return i}}class HierarchyLoader{load(e){let t=e.url;return("gltf"==e.ext||"fbx"==e.ext||"glb"==e.ext)&&(t=AssetDb.inst.getSubAssetURL(t,e.uuid,"0","lh")),e.loader.fetch(t,"json",e.progress.createCallback(.2),e.options).then((t=>t?null!=t._$ver?this._load(HierarchyLoader.v3,e,t,3):"ls"==e.ext||"lh"==e.ext?this._load(HierarchyLoader.v2,e,t,2):"scene"==e.ext||"prefab"==e.ext?this._load(HierarchyLoader.legacySceneOrPrefab,e,t,2):null:null))}_load(e,t,r,i){let a=URL.getPath(t.url),s=e.collectResourceLinks(r,a);return t.loader.load(s,null,t.progress.createCallback()).then((t=>{let a=new PrefabImpl(e,r,i);return a.addDeps(t),a}))}}HierarchyLoader.v3=HierarchyParser,HierarchyLoader.v2=null,HierarchyLoader.legacySceneOrPrefab=LegacyUIParser,Loader.registerLoader(["lh","ls","scene","prefab"],HierarchyLoader,Loader.HIERARCHY);class HDRTextureInfo{static _parseHDRTexture(e,t=null,r=null){let i=HDRTextureInfo.getHDRInfo(e),a=new Texture2D(i.width,i.height,i.format,!1,!1,!1);return a.setHDRData(i),a}static getHDRInfo(t){let r=new Uint8Array(t),i=0;const readLine=()=>{let e=HDRTextureInfo.getLineString(r,i);return i+=e.length+1,e};if("#?RADIANCE"!=readLine())throw"HDR image: identifier wrong.";let a=new Map,s="";do{if(s=readLine(),"#"!=s[0]){let e=s.split("=");a.set(e[0],e[1])}}while(""!=s);if("32-bit_rle_rgbe"!=a.get("FORMAT"))throw"HDR image: unsupported format.";let n=readLine().split(" "),o="-Y"==n[0],l="-X"==n[2],h=parseInt(n[1]),u=parseInt(n[3]);return new HDRTextureInfo(t,i,l,o,u,h,e.TextureFormat.R32G32B32)}static getLineString(e,t){let r=e.length,i=t,a="",s="";for(;i<r&&"\n"!=s;)a=`${a}${s}`,s=String.fromCharCode(e[i]),i++;return a}constructor(e,t,r,i,a,s,n){this.source=e,this.byteOffset=t,this.decreaseX=r,this.decreaseY=i,this.width=a,this.height=s,this.format=n}get_32_bit_rle_rgbe(){let e=this.width,t=this.height;this.decreaseX,this.decreaseY;let r=new Uint8Array(this.source,this.byteOffset),i=0,a=new ArrayBuffer(4*e),s=new Uint8Array(a),n=new ArrayBuffer(e*t*4*3),o=new Float32Array(n);for(let a=t;a>0;a--){r[i++],r[i++];let n=r[i++]<<8|r[i++];if(n!=e)throw"HDR info: scanlineLength wrong.";let l=0;for(let e=0;e<4;e++){let t=(e+1)*n;for(;l<t;){let e=r[i++],a=r[i++];if(e>128){let r=e-128;if(r>t-l)throw"HDR info: ??";for(;r-- >0;)s[l++]=a}else{let n=e;if(0==n||n>t-l)throw"HDR info: ??";if(s[l++]=a,--n>0)for(let e=0;e<n;e++)s[l++]=r[i++]}}}for(let e=0;e<n;e++){let r=s[e],i=s[e+n],l=s[e+2*n],h=s[e+3*n],u=(t-a)*n*3+3*e;const Ldexp=(e,t)=>t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t);if(h>0){let e=Ldexp(1,h-136);o[u]=r*e,o[u+1]=i*e,o[u+2]=l*e}else o[u]=0,o[u+1]=0,o[u+2]=0}}return o}readScanLine(){let e=this.width,t=this.height,r=this.decreaseX,i=this.decreaseY,a=new Float32Array(e*t*3),s=new Uint8Array(4*e),n=new Uint8Array(this.source,this.byteOffset),o=n.length,l=0;const getc=()=>{if(l>=o)throw"HDR info: data wrong.";return n[l++]},wrong=()=>{throw"HDR info: data wrong."};for(let n=t-1;n>=0;n--){this.readcolors(s,getc,wrong);for(let o=0;o<e;o++){let l=4*o,h=s[l],u=s[l+1],d=s[l+2],_=s[l+3],c=n,m=o;i&&(c=t-1-n),r&&(m=e-1-o);let p=c*e*3+3*m;if(0==_)a[p]=0,a[p+1]=0,a[p+2]=0;else{let e=ldexp(1,_-136);a[p]=(h+.5)*e,a[p+1]=(u+.5)*e,a[p+2]=(d+.5)*e}}}return a}readcolors(e,t,r){const setScanLineData=(t,r,i)=>{e[4*t+r]=i};let i=this.width,a=t(),s=t(),n=t(),o=t();if(i<8||i>32767)this.olddreadcolors(e,t,a,s,n,o);else if(2!=a||2!=s||128&n)this.olddreadcolors(e,t,a,s,n,o);else{(n<<8|o)!=i&&r();for(let e=0;e<4;e++)for(let a=0;a<i;){let s=t();if(s>128){s&=127;let n=t();for(a+s>i&&r();s--;)setScanLineData(a++,e,n)}else for(a+s>i&&r();s--;){setScanLineData(a++,e,t())}}}}olddreadcolors(e,t,r,i,a,s){let n=0,o=this.width;e[0]=r,e[1]=i,e[2]=a,e[3]=s;for(let r=1;r<o;r++){let i=t(),a=t(),s=t(),o=t(),l=4*r;if(e[l]=i,e[l+1]=a,e[l+2]=s,e[l+3]=o,1==i&&1==a&&1==s){let t=l-4;for(let r=o<<n;r>0;r--)e[l]=e[t],e[l+1]=e[t+1],e[l+2]=e[t+2],e[l+3]=e[t+3];n+=8}else n=0}}color_color(e,t){let r=0;0==t.w?e.x=e.y=e.z=0:(r=ldexp(1,t.w-136),e.x=t.x*r,e.y=t.y*r,e.z=t.z*r)}}function ldexp(e,t){return e*Math.pow(2,t)}var xt;HDRTextureInfo.HDRTEXTURE="HDRTEXTURE";const St={premultiplyAlpha:!0},yt=[null,null,e.TextureFormat.R8G8B8A8,!1,!1,!0];const Et=["ktx","pvr","dds","hdr","lanit.ls"],Ct=["mp4","webm"];Loader.registerLoader(["png","jpg","jpeg","rendertexture",...Ct,...Et],class{wrapTex2D(e,t){if(!t)return null;let r=e.obsoluteInst;return r?(r.setTo(t),r.obsolute=!1,r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum,r.event("reload"),r._clipCache&&r._clipCache.forEach((e=>{e.event("reload"),e._sizeGrid=r._sizeGrid,e._stateNum=r._stateNum}))):(r=new Texture(t),r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum),r}load(e){let t=e.loader.getRes(e.url,Loader.TEXTURE2D);if(!t||t.obsolute){let t={url:e.url,type:Loader.TEXTURE2D};return e.options.propertyParams?null==e.options.propertyParams.premultiplyAlpha&&(t.propertyParams=Object.assign({},St,e.options.propertyParams)):t.propertyParams=St,e.options.constructParams?null==e.options.constructParams[5]&&(t.constructParams=Object.assign([],yt,e.options.constructParams)):t.constructParams=yt,e.loader.load(t,e.options,e.progress.createCallback()).then((t=>this.wrapTex2D(e,t)))}return Promise.resolve(this.wrapTex2D(e,t))}},Loader.IMAGE),Loader.registerLoader([],class{constructor(){xt||(xt={"WhiteTexture.png":Texture2D.whiteTexture,"BlackTexture.png":Texture2D.blackTexture,"GrayTexture.png":Texture2D.grayTexture,"NormalTexture.png":Texture2D.normalTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let t=xt[Utils.getBaseName(e.url)];if(t)return Promise.resolve(t)}let t;return e.url.startsWith("data:")||(t=AssetDb.inst.metaMap[e.url],t||!LayaEnv.isPreview)?this.load2(e,t):AssetDb.inst.getMeta(e.url,e.uuid).then((t=>this.load2(e,t)))}load2(t,r){var i,a;let s,n,o=t.ext,l=t.url;if(r){let e=Browser.platform,h=(null===(i=r.platforms)||void 0===i?void 0:i[e])||0,u=r.files[h];u.file&&(l=AssetDb.inst.getSubAssetURL(l,t.uuid,u.file,u.ext),o=u.ext),s=[0,0,null!==(a=u.format)&&void 0!==a?a:1,r.mipmap,r.readWrite,r.sRGB],n={wrapModeU:r.wrapMode,wrapModeV:r.wrapMode,filterMode:r.filterMode,anisoLevel:r.anisoLevel,premultiplyAlpha:!!r.pma,hdrEncodeFormat:r.hdrEncodeFormat}}else s=t.options.constructParams,n=t.options.propertyParams;let h=-1!=Et.indexOf(o)?o:null;if(null!=h)return t.loader.fetch(l,"arraybuffer",t.progress.createCallback(),t.options).then((i=>{if(!i)return null;let a;switch(h){case"dds":a=Texture2D._parseDDS(i,n,s);break;case"ktx":let t=KTXTextureInfo.getKTXTextureInfo(i);if(t.dimension==e.TextureDimension.Cube){let e=ClassUtils.getClass("TextureCube");if(!e)return null;{let r=new e(t.width,t.format,t.mipmapCount>1,t.sRGB);r.setKTXData(t),a=r}}else t.dimension==e.TextureDimension.Tex2D&&(a=Texture2D._parseKTX(i,n,s));break;case"pvr":a=Texture2D._parsePVR(i,n,s);break;case"hdr":a=HDRTextureInfo._parseHDRTexture(i,n,s);break;case"lanit.ls":a=Texture2D._SimpleAnimatorTextureParse(i,n,s)}let o=t.obsoluteInst;return o&&Object.getPrototypeOf(o)==Object.getPrototypeOf(a)&&(a=this.move(o,a)),n&&n.hdrEncodeFormat&&(a.hdrEncodeFormat=n.hdrEncodeFormat),r&&(a._sizeGrid=r.sizeGrid,a._stateNum=r.stateNum),a}));{let e=t.options;return!e.useWorkerLoader||n&&n.premultiplyAlpha||(e=Object.assign({workerLoaderOptions:{premultiplyAlpha:"none"}},e)),t.loader.fetch(l,"image",t.progress.createCallback(),e).then((e=>{if(!e)return null;let i=Texture2D._parseImage(e,n,s),a=t.obsoluteInst;return a&&Object.getPrototypeOf(a)==Object.getPrototypeOf(i)&&(i=this.move(a,i)),r&&(i._sizeGrid=r.sizeGrid,i._stateNum=r.stateNum),i}))}}move(e,t){return e._texture=t._texture,e.width=t.width,e.height=t.height,e.obsolute=!1,delete Resource._idResourcesMap[t.id],e}},Loader.TEXTURE2D),Loader.registerLoader(["rendertexture"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=e.obsoluteInst;return r?r.recreate(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB):r=new RenderTexture(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB),null!=t.anisoLevel&&(r.anisoLevel=t.anisoLevel),null!=t.filterMode&&(r.filterMode=t.filterMode),null!=t.wrapModeU&&(r.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(r.wrapModeV=t.wrapModeV),r}))}},Loader.TEXTURE2D),Loader.registerLoader(Ct,class{load(e){let t=e.obsoluteInst||new VideoTexture;return t.source=e.url,Promise.resolve(t)}},Loader.TEXTURE2D);Loader.registerLoader(["mc"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?AnimationClip2D._parse(e):null))}});Loader.registerLoader(["mcc"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{let r=new AnimatorController2D(t);if(r.data&&r.data.controllerLayers){let t=r.data.controllerLayers,i=[];for(let r=t.length-1;r>=0;r--){let a=t[r].states;this.loadStates(a,i,e)}return Promise.all(i).then((()=>r))}return r}))}loadStates(e,t,r){let i=URL.getPath(r.url);for(let a=e.length-1;a>=0;a--){if(e[a].clip&&e[a].clip._$uuid){let s=URL.getResURLByUUID(e[a].clip._$uuid);s.startsWith("res://")||(s=URL.join(i,s)),t.push(r.loader.load(s).then((t=>{e[a].clip=t})))}e[a].states&&this.loadStates(e[a].states,t,r)}}});class NullLoader{load(e){return Promise.resolve(null)}}Loader.registerLoader(["lighting"],NullLoader);Loader.registerLoader(["fnt"],class{load(e){let t=Utils.replaceFileExtension(e.url,"png");return Promise.all([e.loader.fetch(e.url,"xml",e.progress.createCallback(.2),e.options),e.loader.load(t,e.options,e.progress.createCallback(.8))]).then((([e,t])=>{if(!e||!t)return null;let r=new BitmapFont;return r.parseFont(e,t),r}))}},Loader.FONT);const vt="LayaTTFFont";Loader.registerLoader(["ttf","woff","woff2","otf"],class{load(e){let t=Utils.replaceFileExtension(Utils.getBaseName(e.url),"");if(LayaEnv.isConch)return e.loader.fetch(e.url,"arraybuffer").then((e=>(e&&window.conchTextCanvas.setFontFaceFromBuffer(t,e),{family:t})));if(window.FontFace){let r=new window.FontFace(t,"url('"+URL.postFormatURL(URL.formatURL(e.url))+"')");return document.fonts.add(r),r.load().then((()=>r))}{let r="40px "+t,i=Browser.measureText(vt,r).width,a=Browser.createElement("style");return a.type="text/css",document.body.appendChild(a),a.textContent="@font-face { font-family:'"+t+"'; src:url('"+URL.postFormatURL(URL.formatURL(e.url))+"');}",new Promise((e=>{let checkComplete=()=>{Browser.measureText(vt,r).width!=i&&complete()},complete=()=>{ILaya.systemTimer.clear(this,checkComplete),ILaya.systemTimer.clear(this,complete),e({family:t})};ILaya.systemTimer.once(1e4,this,complete),ILaya.systemTimer.loop(20,this,checkComplete)}))}}},Loader.TTF);Loader.registerLoader(["mp3","wav","ogg"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?WebAudioSound.ctx.decodeAudioData(e):null))}},Loader.SOUND);let Rt=ClassUtils.regClass;Rt("Record",Object),Rt("Node",Node),Rt("Sprite",Sprite),Rt("Widget",Widget),Rt("Text",Text),Rt("Input",Input),Rt("AnimationBase",AnimationBase),Rt("Animation",Animation),Rt("FrameAnimation",FrameAnimation),Rt("EffectAnimation",EffectAnimation),Rt("SoundNode",SoundNode),Rt("VideoNode",VideoNode),Rt("Scene",Scene),Rt("Stage",Stage),Rt("Component",Component),Rt("Script",Script),Rt("BitmapFont",BitmapFont),Rt("BlurFilter",BlurFilter),Rt("ColorFilter",ColorFilter),Rt("GlowFilter",GlowFilter),Rt("Point",Point),Rt("Rectangle",Rectangle),Rt("Texture",Texture),Rt("Texture2D",Texture2D),Rt("Prefab",Prefab),Rt("Animator2D",Animator2D),Rt("AnimatorControllerLayer2D",AnimatorControllerLayer2D),Rt("AnimatorState2D",AnimatorState2D),Rt("AnimationClip2D",AnimationClip2D),Rt("AnimatorController2D",AnimatorController2D),Rt("Animation2DParm",Animation2DParm),Rt("Animation2DCondition",Animation2DCondition),Rt("Vector2",Vector2),Rt("Vector3",Vector3),Rt("Vector4",Vector4),Rt("Quaternion",Quaternion),Rt("Color",Color),Rt("Matrix",Matrix),Rt("Matrix3x3",Matrix3x3),Rt("Matrix4x4",Matrix4x4);class LocalStorage{static __init__(){return LocalStorage._baseClass||(LocalStorage._baseClass=Storage,Storage.init()),LocalStorage.items=LocalStorage._baseClass.items,LocalStorage.support=LocalStorage._baseClass.support,LocalStorage.support}static setItem(e,t){LocalStorage._baseClass.setItem(e,t)}static getItem(e){return LocalStorage._baseClass.getItem(e)}static setJSON(e,t){LocalStorage._baseClass.setJSON(e,t)}static getJSON(e){return LocalStorage._baseClass.getJSON(e)}static removeItem(e){LocalStorage._baseClass.removeItem(e)}static clear(){LocalStorage._baseClass.clear()}}LocalStorage.support=!1;class Storage{static init(){try{Storage.support=!0,Storage.items=window.localStorage,Storage.setItem("laya","1"),Storage.removeItem("laya")}catch(e){Storage.support=!1}Storage.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(e,t){try{Storage.support&&Storage.items.setItem(e,t)}catch(e){console.warn("set localStorage failed",e)}}static getItem(e){return Storage.support?Storage.items.getItem(e):null}static setJSON(e,t){try{Storage.support&&Storage.items.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}static getJSON(e){try{return JSON.parse(Storage.support?Storage.items.getItem(e):null)}catch(t){return Storage.items.getItem(e)}}static removeItem(e){Storage.support&&Storage.items.removeItem(e)}static clear(){Storage.support&&Storage.items.clear()}}Storage.support=!1;class IStatRender{show(e=0,t=0,r){}showToggle(e=0,t=0,r){}enable(){}hide(){}set_onclick(e){}isCanvasRender(){return!0}renderNotCanvas(e,t,r){}}class StatUI extends IStatRender{constructor(){super(...arguments),this._show=!1,this._showToggle=!1,this._height=100,this._view=[],this._toggleView=[],this._checkBoxArray=[]}show(e=0,t=0,r){this._view.length=r.length;for(let e=0,t=this._view.length;e<t;e++)this._view[e]=r[e];this._show||(this.createUI(e,t),this.enable()),this._show=!0}showToggle(e=0,t=0,r){ILaya.Loader.cacheRes("defaultCheckBox",Texture2D.defalutUITexture,"TEXTURE2D"),this._toggleView.length=r.length;for(let e=0,t=this._toggleView.length;e<t;e++)this._toggleView[e]=r[e];this._showToggle||(this.createToggleUI(e,t),this.enable()),this._showToggle=!0}createToggleUI(t,r){var i=this._toggleSprite,a=Browser.pixelRatio;i||(i=new Sprite,this._toggleleftText=new Text,this._toggleleftText.pos(5,5),this._toggleleftText.color="#ffffff",i.addChild(this._toggleleftText),this._toggletxt=new Sprite,this._toggletxt.pos(170*a,5),i.addChild(this._toggletxt),this._toggleSprite=i,this._checkBoxArray.length=0),i.pos(t,r);for(var s="",n=0;n<this._toggleView.length;n++){var o=this._toggleView[n];s+=o.title+"\n";let t=new e.CheckBox("defaultCheckBox");t.selected=Stat[o.value],this._checkBoxArray.push(t),t.scale(StatUI._toggleSize,StatUI._toggleSize),this._toggletxt.addChild(t),t.pos(0,n*(StatUI._toggleSize+5))}this._toggleleftText.text=s;var l=138*a,h=a*(this._toggleView.length*(StatUI._toggleSize+5))+4;this._toggleleftText.fontSize=(StatUI._toggleSize+5)*a,i.size(l,h),i.graphics.clear(),i.graphics.alpha(.5),i.graphics.drawRect(0,0,l+110,h+10,"#999999"),i.graphics.alpha(2),Laya.stage.addChild(i),this.loop()}createUI(e,t){var r=this._sp,i=Browser.pixelRatio;r||(r=new Sprite,this._leftText=new Text,this._leftText.pos(5,5),this._leftText.color="#ffffff",r.addChild(this._leftText),this._txt=new Text,this._txt.pos(171*i,5),this._txt.color="#ffffff",r.addChild(this._txt),this._sp=r),r.pos(e,t);for(var a="",s=0;s<this._view.length;s++){a+=this._view[s].title+"\n"}this._leftText.text=a;var n=138*i,o=i*(this._view.length*StatUI._fontSize)+4;this._txt.fontSize=StatUI._fontSize*i,this._leftText.fontSize=StatUI._fontSize*i,r.size(n,o),r.graphics.clear(),r.graphics.alpha(.5),r.graphics.drawRect(0,0,n+110,o+10,"#999999"),r.graphics.alpha(2),this.loop()}enable(){ILaya.systemTimer.frameLoop(1,this,this.loop)}hide(){this._show=!1,this._showToggle=!1,ILaya.systemTimer.clear(this,this.loop),this._canvas&&Browser.removeElement(this._canvas.source)}set_onclick(e){this._sp&&this._sp.on("click",this._sp,e),this._canvas&&(this._canvas.source.onclick=e,this._canvas.source.style.pointerEvents="")}loop(){Stat._count++;var e=Browser.now();if(!(e-Stat._timer<1e3)){var t=Stat._count;if(Stat.FPS=Math.round(1e3*t/(e-Stat._timer)),this._show){Stat.updateEngineData();var r=Stat.FPS>0?Math.floor(1e3/Stat.FPS).toString():" ";Stat._fpsStr=Stat.FPS+(Stat.renderSlow?" slow":"")+" "+r,this.renderInfo(t),Stat.clear()}if(this._showToggle)for(var i=0;i<this._toggleView.length;i++){let e=this._toggleView[i];Stat[e.value]=this._checkBoxArray[i].selected}Stat._count=0,Stat._timer=e}}renderInfo(e){for(var t="",r=0;r<this._view.length;r++){let a=this._view[r],s="average"==a.mode;var i=Stat[a.value];"M"==a.units&&(i=Math.floor(i/1048576*100)/100),"K"==a.units&&(i=Math.floor(i/1024*100)/100),s&&(i/=e,i=Math.floor(i)),"M"==a.units&&(i+="M"),"K"==a.units&&(i+="K"),t+=i+"\n"}this._txt.text=t}renderNotCanvas(e,t,r){this._show&&this._sp&&this._sp.render(e,0,0)}}StatUI._fontSize=14,StatUI._toggleSize=16;class SkinSV extends Value2D{constructor(t){super(ShaderDefines2D.SKINMESH,0),this.offsetX=300,this.offsetY=0;var r=8*Const.BYTES_PE;const i=LayaGL.renderEngine.getParams(e.RenderParams.FLOAT);this.position=[2,i,!1,r,0],this.texcoord=[2,i,!1,r,2*Const.BYTES_PE],this.color=[4,i,!1,r,4*Const.BYTES_PE]}}class PrimitiveSV extends Value2D{constructor(e){super(ShaderDefines2D.PRIMITIVE,0),this._attribLocation=["position",0,"attribColor",1]}}class TextureSV extends Value2D{constructor(e=0){super(ShaderDefines2D.TEXTURE2D,e),this.strength=0,this.blurInfo=null,this.colorMat=null,this.colorAlpha=null,this._attribLocation=["posuv",0,"attribColor",1,"attribFlags",2]}clear(){this.texture=null,this.shader=null,this.defines._value=this.subID}}class Mouse{static set cursor(e){Mouse._style.cursor=e}static get cursor(){return Mouse._style.cursor}static __init__(){Mouse._style=Browser.document.body.style}static hide(){"none"!=Mouse.cursor&&(Mouse._preCursor=Mouse.cursor,Mouse.cursor="none")}static show(){"none"==Mouse.cursor&&(Mouse._preCursor?Mouse.cursor=Mouse._preCursor:Mouse.cursor="auto")}}class MeshParticle2D extends Mesh2D{static __init__(){const t=LayaGL.renderEngine.getParams(e.RenderParams.FLOAT);MeshParticle2D._fixattriInfo=[t,4,0,t,3,16,t,3,28,t,4,40,t,4,56,t,3,72,t,2,84,t,4,92,t,1,108,t,1,112]}constructor(e){super(MeshParticle2D.const_stride,4*e*MeshParticle2D.const_stride,4),this.canReuse=!0,this.setAttributes(MeshParticle2D._fixattriInfo),this.createQuadIB(e),this._quadNum=e,MeshParticle2D.vertexDeclaration||(MeshParticle2D.vertexDeclaration=new VertexDeclaration(116,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Vector3,1),new VertexElement(28,VertexElementFormat.Vector3,2),new VertexElement(40,VertexElementFormat.Vector4,3),new VertexElement(56,VertexElementFormat.Vector4,4),new VertexElement(72,VertexElementFormat.Vector3,5),new VertexElement(84,VertexElementFormat.Vector2,6),new VertexElement(92,VertexElementFormat.Vector4,7),new VertexElement(108,VertexElementFormat.Single,8),new VertexElement(112,VertexElementFormat.Single,9)])),this._vb.vertexDeclaration=MeshParticle2D.vertexDeclaration}setMaxParticleNum(e){this._vb.buffer2D._resizeBuffer(4*e*MeshParticle2D.const_stride,!1),this.createQuadIB(e)}static getAMesh(e){if(MeshParticle2D._POOL.length){var t=MeshParticle2D._POOL.pop();return t.setMaxParticleNum(e),t}return new MeshParticle2D(e)}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshParticle2D._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._vb.deleteBuffer()}}MeshParticle2D.const_stride=116,MeshParticle2D._POOL=[],MeshParticle2D.vertexDeclaration=null;class DefineDatas{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,i=this._length-1;i>=0;i--){var a=r[i]&t[i];0==a&&i==this._length-1?this._length--:r[i]=a}}add(e){var t=e._index,r=t+1,i=this._mask,a=this._length;if(a<r){for(i.length<r&&(i.length=r);a<t;a++)i[a]=0;i[t]=e._value,this._length=r}else i[t]|=e._value}remove(e){var t=e._index,r=this._mask,i=this._length-1;if(!(t>i)){var a=r[t]&~e._value;t==i&&0===a?this._length--:r[t]=a}}addDefineDatas(e){var t=e._mask,r=e._length,i=this._mask,a=this._length;if(a<r){i.length=r;for(var s=0;s<a;s++)i[s]|=t[s];for(;s<r;s++)i[s]=t[s];this._length=r}else for(s=0;s<r;s++)i[s]|=t[s]}removeDefineDatas(e){for(var t=e._mask,r=this._mask,i=this._length-1,a=Math.min(e._length,i);a>=0;a--){var s=r[a]&~t[a];a==i&&0===s?(i--,this._length--):r[a]=s}}has(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}clear(){this._length=0}cloneTo(e){var t=e,r=t._mask,i=this._mask,a=this._length;r.length=a;for(var s=0;s<a;s++)r[s]=i[s];t._length=a}clone(){var e=new DefineDatas;return this.cloneTo(e),e}destroy(){delete this._mask}}class ShaderDefine{constructor(e,t){this._index=e,this._value=t}}ShaderDefine._texGammaDefine={};class ShaderVariant{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(e,t,r,i){this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,r,i)}setValue(e,t,r,i){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var a=e.getSubShaderAt(t);if(!a)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${t}.`;var s=a._passes[r];if(!s)throw`ShaderVariantInfo:Shader don't have passIndex of ${r}.`;for(var n=s._validDefine,o=0,l=i.length;o<l;o++){var h=i[o];if(!n.has(Shader3D.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${e._name} subShaderIndex of ${t} passIndex of ${r}.`}this._shader=e,this._subShaderIndex=t,this._passIndex=r,this._defineNames=i}equal(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,r=e._defineNames;if(t.length!==r.length)return!1;for(var i=0,a=this._defineNames.length;i<a;i++)if(t[i]!==r[i])return!1;return!0}clone(){return new ShaderVariant(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class ShaderVariantCollection{constructor(){this._allCompiled=!1,this._variants=[]}get allCompiled(){return this._allCompiled}get variantCount(){return this._variants.length}add(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}remove(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}contatins(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!0;return!1}getByIndex(e){return this._variants[e]}clear(){this._variants.length=0}compile(){if(!this._allCompiled){for(var e=this._variants,t=0,r=e.length;t<r;t++){var i=e[t];Shader3D.compileShaderByDefineNames(i._shader._name,i._subShaderIndex,i._passIndex,i._defineNames)}this._allCompiled=!0}}}var bt,Dt;e.ShaderDataType=void 0,(bt=e.ShaderDataType||(e.ShaderDataType={}))[bt.Int=0]="Int",bt[bt.Bool=1]="Bool",bt[bt.Float=2]="Float",bt[bt.Vector2=3]="Vector2",bt[bt.Vector3=4]="Vector3",bt[bt.Vector4=5]="Vector4",bt[bt.Color=6]="Color",bt[bt.Matrix4x4=7]="Matrix4x4",bt[bt.Texture2D=8]="Texture2D",bt[bt.TextureCube=9]="TextureCube",bt[bt.Buffer=10]="Buffer";class ShaderData{get uniformBufferDatas(){return this._uniformBufferDatas}get uniformBuffersMap(){return this._uniformBuffersMap}constructor(e=null){this._ownerResource=null,this._data=null,this._defineDatas=new DefineDatas,this._ownerResource=e,this._initData(),this._uniformBufferDatas=new Map,this._uniformBuffersMap=new Map}_addCheckUBO(e,t,r){this._uniformBufferDatas.set(e,{ubo:t,uboBuffer:r}),r._uniformParamsState.forEach(((e,r)=>{this.uniformBuffersMap.set(r,t)})),t.setDataByUniformBufferData(r)}_initData(){this._data={},this._gammaColorMap=new Map}getData(){return this._data}applyUBOData(){this._uniformBufferDatas.forEach(((e,t)=>{e.ubo.setDataByUniformBufferData(e.uboBuffer)}))}addDefine(e){this._defineDatas.add(e)}removeDefine(e){this._defineDatas.remove(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getInt(e))}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getNumber(e))}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector2(e))}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector3(e))}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector(e))}getColor(e){return this._gammaColorMap.get(e)}setColor(e,t){if(!t)return;if(this._data[e]){let r=this._gammaColorMap.get(e);t.cloneTo(r);let i=this._data[e];i.x=Color.gammaToLinearSpace(t.r),i.y=Color.gammaToLinearSpace(t.g),i.z=Color.gammaToLinearSpace(t.b),i.w=t.a}else{let r=new Vector4;r.x=Color.gammaToLinearSpace(t.r),r.y=Color.gammaToLinearSpace(t.g),r.z=Color.gammaToLinearSpace(t.b),r.w=t.a,this._data[e]=r,this._gammaColorMap.set(e,t.clone())}let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getLinearColor(e))}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix4x4(e))}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t}setTexture(e,t){var r=this._data[e];if(t){let r=ShaderDefine._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}setValueData(e,t){if(t instanceof Color)return void this.setColor(e,t);t&&t.clone?this._data[e]=t.clone():this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getValueData(e))}setUniformBuffer(e,t){this._data[e]=t}getUniformBuffer(e){return this._data[e]}setShaderData(t,r,i){switch(r){case e.ShaderDataType.Int:this.setInt(t,i);break;case e.ShaderDataType.Bool:this.setBool(t,i);break;case e.ShaderDataType.Float:this.setNumber(t,i);break;case e.ShaderDataType.Vector2:this.setVector2(t,i);break;case e.ShaderDataType.Vector3:this.setVector3(t,i);break;case e.ShaderDataType.Vector4:this.setVector(t,i);break;case e.ShaderDataType.Color:this.setColor(t,i);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,i);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:this.setTexture(t,i);break;case e.ShaderDataType.Buffer:this.setBuffer(t,i);break;default:throw"unkone shader data type."}}getShaderData(t,r){switch(r){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);default:throw"unkone shader data type."}}getValueData(e){return this._data[e]}cloneTo(e){var t=e,r=t._data;for(var i in this._data){var a=this._data[i];if(null!=a)if("number"==typeof a)r[i]=a;else if("number"==typeof a)r[i]=a;else if("boolean"==typeof a)r[i]=a;else if(a instanceof Vector2){var s=r[i]||(r[i]=new Vector2);a.cloneTo(s),r[i]=s}else if(a instanceof Vector3){var n=r[i]||(r[i]=new Vector3);a.cloneTo(n),r[i]=n}else if(a instanceof Vector4){let t=this.getColor(parseInt(i));if(t){let r=t.clone();e.setColor(parseInt(i),r)}else{var o=r[i]||(r[i]=new Vector4);a.cloneTo(o),r[i]=o}}else if(a instanceof Matrix4x4){var l=r[i]||(r[i]=new Matrix4x4);a.cloneTo(l),r[i]=l}else(a instanceof BaseTexture||a instanceof Resource)&&(r[i]=a,a._addReference())}this._defineDatas.cloneTo(t._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())}))}clone(){var e=new ShaderData;return this.cloneTo(e),e}reset(){for(var e in this._data){var t=this._data[e];t instanceof Resource&&t._removeReference()}this._data={},this._gammaColorMap.clear(),this._uniformBufferDatas.clear(),this._uniformBuffersMap.clear(),this._defineDatas.clear()}destroy(){for(var e in this._defineDatas.destroy(),this._defineDatas=null,this._data){var t=this._data[e];t instanceof Resource&&t._removeReference()}this._data=null,this._gammaColorMap.clear(),this._gammaColorMap=null,delete this._uniformBufferDatas,delete this._uniformBuffersMap,this._uniformBufferDatas=null,this._uniformBuffersMap=null}}e.UniformBufferParamsType=void 0,(Dt=e.UniformBufferParamsType||(e.UniformBufferParamsType={}))[Dt.Number=0]="Number",Dt[Dt.Vector2=1]="Vector2",Dt[Dt.Vector3=2]="Vector3",Dt[Dt.Vector4=3]="Vector4",Dt[Dt.Matrix4x4=4]="Matrix4x4",Dt[Dt.Vector4Array=5]="Vector4Array",Dt[Dt.MatrixArray=6]="MatrixArray";class UnifromBufferData{constructor(e){this._uniformParamsState=new Map(e),this._createBuffer(),this._updateFlag=new Vector2,this._resetUpdateFlag()}_createBuffer(){var e=0;this._layoutMap={};this._uniformParamsState.forEach(((t,r)=>{e+=this._addUniformParams(r,t,e)})),this._bytelength=4*Math.ceil(e/4)*4,this._buffer=new Float32Array(e)}_getArraySize(e){let t=e.indexOf("["),r=e.indexOf("]");if(-1!=t&&-1!=r&&t<r)return parseFloat(e.substring(t+1,r));throw e+" is illegal "}_addUniformParams(t,r,i){let a,s=0,n=0,o=i%4;switch(r){case e.UniformBufferParamsType.Number:s=1,n=1;break;case e.UniformBufferParamsType.Vector2:switch(s=2,o){case 0:case 2:n=2;break;case 1:case 3:i+=1,n=3}break;case e.UniformBufferParamsType.Vector3:switch(s=3,n=3,o){case 1:case 2:case 3:i+=4-o,n=4-o+3}break;case e.UniformBufferParamsType.Vector4:switch(s=4,o){case 0:n=4;break;case 1:i+=3,n=7;break;case 2:i+=2,n=6;break;case 3:i+=1,n=5}break;case e.UniformBufferParamsType.Matrix4x4:s=16,a=o?4-o:o,i+=a,n=s+a;break;case e.UniformBufferParamsType.Vector4Array:s=4*this._getArraySize(Shader3D.propertyIDToName(t)),a=o?4-o:o,i+=a,n=s+a;break;case e.UniformBufferParamsType.MatrixArray:s=16*this._getArraySize(Shader3D.propertyIDToName(t)),a=o?4-o:o,i+=a,n=s+a;break;default:throw"Unifrom Buffer Params Type is illegal "}const l=new Vector2(i,s);return this._layoutMap[t]=l,n}_getParamsInfo(e){return this._layoutMap[e]}_setUpdateFlag(e,t){e<this._updateFlag.x&&(this._updateFlag.x=e),t>this._updateFlag.y&&(this._updateFlag.y=t)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(e){return!!this._getParamsInfo(e)}_setData(t,r){switch(this._uniformParamsState.get(t)){case e.UniformBufferParamsType.Number:this.setNumberbyIndex(t,r);break;case e.UniformBufferParamsType.Vector2:this.setVector2byIndex(t,r);break;case e.UniformBufferParamsType.Vector3:this.setVector3byIndex(t,r);break;case e.UniformBufferParamsType.Vector4:this.setVector4byIndex(t,r);break;case e.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(t,r);break;case e.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(t,r);break;case e.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(t,r)}}getbyteLength(){return this._bytelength}setVector4Array(e,t){const r=Shader3D.propertyNameToID(e);this.setVector4ArraybyIndex(r,t)}setVector4ArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x,a=r.y/4;for(let e=0;e<a;e++){let r=t[e];this._buffer[i++]=r.x,this._buffer[i++]=r.y,this._buffer[i++]=r.z,this._buffer[i++]=r.w}this._setUpdateFlag(r.x,i)}setMatrixArray(e,t){const r=Shader3D.propertyNameToID(e);this.setMatrixArraybyIndex(r,t)}setMatrixArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x,a=r.y/4;for(let e=0;e<a;e++){let r=t[e];this._buffer.set(r.elements,i),i+=16}this._setUpdateFlag(r.x,i)}setNumber(e,t){const r=Shader3D.propertyNameToID(e);this.setNumberbyIndex(r,t)}setNumberbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t,this._setUpdateFlag(r.x,i)}setVector2(e,t){const r=Shader3D.propertyNameToID(e);this.setVector2byIndex(r,t)}setVector2byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._setUpdateFlag(r.x,i)}setVector3(e,t){const r=Shader3D.propertyNameToID(e);this.setVector3byIndex(r,t)}setVector3byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._buffer[i++]=t.z,this._setUpdateFlag(r.x,i)}setVector4(e,t){const r=Shader3D.propertyNameToID(e);this.setVector4byIndex(r,t)}setVector4byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=t.x,this._buffer[i++]=t.y,this._buffer[i++]=t.z,this._buffer[i++]=t.w,this._setUpdateFlag(r.x,i)}setColor(e,t){const r=Shader3D.propertyNameToID(e);this.setColorbyIndex(r,t)}setColorbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer[i++]=Color.gammaToLinearSpace(t.r),this._buffer[i++]=Color.gammaToLinearSpace(t.g),this._buffer[i++]=Color.gammaToLinearSpace(t.b),this._buffer[i++]=Color.gammaToLinearSpace(t.a),this._setUpdateFlag(r.x,i)}setMatrix(e,t){const r=Shader3D.propertyNameToID(e);this.setMatrixbyIndex(r,t)}setMatrixbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let i=r.x;this._buffer.set(t.elements,i),i+=16,this._setUpdateFlag(r.x,i)}clone(){return new UnifromBufferData(this._uniformParamsState)}}class ShaderCompileDefineBase{constructor(e,t,r){this._validDefine=new DefineDatas,this._cacheShaderHierarchy=1,this._cacheSharders={},this._owner=e,this.name=t,this._VS=r.vsNode,this._PS=r.psNode,this._defs=r.defs;for(let e of r.defs)this._validDefine.add(Shader3D.getDefineByName(e))}_resizeCacheShaderMap(e,t,r){var i=this._cacheShaderHierarchy-1;if(t==i)for(var a in e)for(var s=e[a],n=0,o=r-i;n<o;n++)n==o-1?e[0]=s:e=e[0==n?a:0]={};else for(var a in++t,e)this._resizeCacheShaderMap(e[a],t,r)}withCompile(t){var r,i=ShaderCompileDefineBase._debugDefineString,a=ShaderCompileDefineBase._debugDefineMask;t._intersectionDefineDatas(this._validDefine),Shader3D.debugMode&&(r=t._length);var s=this._cacheSharders,n=t._length;n>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(s,0,n),this._cacheShaderHierarchy=n);for(var o=t._mask,l=t._length-1,h=this._cacheShaderHierarchy-1,u=0;u<h;u++){var d=l<u?0:o[u],_=s[d];_||(s[d]=_={}),s=_}var c=l<h?0:o[h],m=s[c];if(m)return m;var p=ShaderCompileDefineBase._defineString;Shader3D._getNamesByDefineData(t,p);var f,g,T={},x="";LayaGL.renderEngine.getCapable(e.RenderCapable.GRAPHICS_API_GLES3)?(f="#version 300 es\n\n                #define attribute in\n                #define varying out\n                #define textureCube texture\n                #define texture2D texture\n",g="#version 300 es\n\n                #define varying in\n                out highp vec4 pc_fragColor;\n                #define gl_FragColor pc_fragColor\n                #define gl_FragDepthEXT gl_FragDepth\n                #define texture2D texture\n                #define textureCube texture\n                #define texture2DProj textureProj\n                #define texture2DLodEXT textureLod\n                #define texture2DProjLodEXT textureProjLod\n                #define textureCubeLodEXT textureLod\n                #define texture2DGradEXT textureGrad\n                #define texture2DProjGradEXT textureProjGrad\n                #define textureCubeGradEXT textureGrad\n"):(f="",g="#ifdef GL_EXT_shader_texture_lod\n                    #extension GL_EXT_shader_texture_lod : enable\n                #endif\n                #if !defined(GL_EXT_shader_texture_lod)\n                    #define texture1DLodEXT texture1D\n                    #define texture2DLodEXT texture2D\n                    #define texture2DProjLodEXT texture2DProj\n                    #define texture3DLodEXT texture3D\n                    #define textureCubeLodEXT textureCube\n                #endif\n");u=0;for(var S=p.length;u<S;u++){var y=p[u];x+="#define "+y+"\n",T[y]=!0}var E=this._VS.toscript(T,[]),C="";0==E[0].indexOf("#version")&&(C=E[0]+"\n",E.shift());var v=this._PS.toscript(T,[]),R="";if(0==v[0].indexOf("#version")&&(R=v[0]+"\n",v.shift()),m=LayaGL.renderOBJCreate.createShaderInstance(C+f+x+E.join("\n"),R+g+x+v.join("\n"),this._owner._attributeMap,this),s[c]=m,Shader3D.debugMode){var b="",D="";for(u=0,S=r;u<S;u++)D+=u==S-1?a[u]:a[u]+",";for(u=0,S=i.length;u<S;u++)b+=u==S-1?i[u]:i[u]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this.name+"  DefineMask:["+D+"] DefineNames:["+b+"]","color:green")}return m}}ShaderCompileDefineBase._defineString=[],ShaderCompileDefineBase._debugDefineString=[],ShaderCompileDefineBase._debugDefineMask=[];class GLSLCodeGenerator{static glslAttributeString(e){let t="";for(const r in e){t=`${t}attribute ${getAttributeType(e[r][1])} ${r};\n`}return t}static glslUniformString(e,t){if(t){let t="",r="";for(const i in e)if("object"==typeof e[i]){let r=e[i];t+=`uniform ${i} {\n`;for(const e in r){t+=`${getAttributeType(r[e])} ${e};\n`}t+="};\n"}else{r+=`uniform ${getAttributeType(e[i])} ${i};\n`}return t+r}{let t="";for(const r in e)if("object"==typeof e[r]){let i=e[r];for(const e in i){t+=`uniform ${getAttributeType(i[e])} ${e};\n`}}else{t+=`uniform ${getAttributeType(e[r])} ${r};\n`}return t}}}function getAttributeType(t){switch(t){case e.ShaderDataType.Int:return"int";case e.ShaderDataType.Bool:return"bool";case e.ShaderDataType.Float:return"float";case e.ShaderDataType.Vector2:return"vec2";case e.ShaderDataType.Vector3:return"vec3";case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return"vec4";case e.ShaderDataType.Matrix4x4:return"mat4";case e.ShaderDataType.Texture2D:return"sampler2D";case e.ShaderDataType.TextureCube:return"samplerCube";default:return""}}class ShaderPass extends ShaderCompileDefineBase{get renderState(){return this._renderState}constructor(e,t){super(e,null,t),this._tags={},this.statefirst=!1,this._renderState=LayaGL.renderOBJCreate.createRenderState(),this._renderState.setNull()}_addDebugShaderVariantCollection(e,t,r){var i=Shader3D._debugShaderVariantInfo,a=this._owner,s=a._owner,n=e._mask;Shader3D._getNamesByDefineData(e,t),r.length=n.length;for(var o=0,l=n.length;o<l;o++)r[o]=n[o];i?i.setValue(s,s._subShaders.indexOf(a),a._passes.indexOf(this),t):Shader3D._debugShaderVariantInfo=i=new ShaderVariant(s,s._subShaders.indexOf(a),a._passes.indexOf(this),t),Shader3D.debugShaderVariantCollection.add(i)}withCompile(t){var r,i=ShaderPass._debugDefineStrings,a=ShaderPass._debugDefineMasks;t._intersectionDefineDatas(this._validDefine),Shader3D.debugMode&&(r=t._length,this._addDebugShaderVariantCollection(t,i,a));var s=this._cacheSharders,n=t._length;n>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(s,0,n),this._cacheShaderHierarchy=n);for(var o=t._mask,l=t._length-1,h=this._cacheShaderHierarchy-1,u=0;u<h;u++){var d=l<u?0:o[u],_=s[d];_||(s[d]=_={}),s=_}var c=l<h?0:o[h],m=s[c];if(m)return m;var p=ShaderPass._defineStrings;Shader3D._getNamesByDefineData(t,p);var f,g,T=Config3D.lightClusterCount,x={},S="";let y=this._owner._attributeMap,E=this._owner._uniformMap,C=Config3D._uniformBlock,v=GLSLCodeGenerator.glslAttributeString(y),R=GLSLCodeGenerator.glslUniformString(E,C);LayaGL.renderEngine.getCapable(e.RenderCapable.GRAPHICS_API_GLES3)?(f=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${v}\n${R}\n`,g=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${R}`):(f=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${v}\n${R}`,g=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define texture3DLodEXT texture3D\n    #define textureCubeLodEXT textureCube\n#endif\n${R}`),S+="#define MAX_LIGHT_COUNT "+Config3D.maxLightCount+"\n",S+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+Config3D._maxAreaLightCountPerClusterAverage+"\n",S+="#define CLUSTER_X_COUNT "+T.x+"\n",S+="#define CLUSTER_Y_COUNT "+T.y+"\n",S+="#define CLUSTER_Z_COUNT "+T.z+"\n",S+="#define MORPH_MAX_COUNT "+Config3D.maxMorphTargetCount+"\n",S+="#define SHADER_CAPAILITY_LEVEL "+LayaGL.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";u=0;for(var b=p.length;u<b;u++){var D=p[u];S+="#define "+D+"\n",x[D]=!0}var A=this._VS.toscript(x,[]),M="";0==A[0].indexOf("#version")&&(M=A[0]+"\n",A.shift());var L=this._PS.toscript(x,[]),w="";if(0==L[0].indexOf("#version")&&(w=L[0]+"\n",L.shift()),m=LayaGL.renderOBJCreate.createShaderInstance(M+f+S+A.join("\n"),w+g+S+L.join("\n"),this._owner._attributeMap,this),s[c]=m,Shader3D.debugMode){var I="",B="";for(u=0,b=r;u<b;u++)B+=u==b-1?a[u]:a[u]+",";for(u=0,b=i.length;u<b;u++)I+=u==b-1?i[u]:i[u]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+B+"] DefineNames:["+I+"]","color:green")}return m}}ShaderPass._defineStrings=[],ShaderPass._debugDefineStrings=[],ShaderPass._debugDefineMasks=[];class VertexMesh{static __init__(){VertexMesh.instanceWorldMatrixDeclaration=new VertexDeclaration(64,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW0),new VertexElement(16,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW1),new VertexElement(32,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW2),new VertexElement(48,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW3)]),VertexMesh.instanceSimpleAnimatorDeclaration=new VertexDeclaration(16,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_SIMPLEANIMATOR)])}static getVertexDeclaration(e,t=!0){var r=VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")];if(!r){for(var i=e.split(","),a=0,s=[],n=0,o=i.length;n<o;n++){var l;switch(i[n]){case"POSITION":l=new VertexElement(a,VertexElementFormat.Vector3,VertexMesh.MESH_POSITION0),a+=12;break;case"NORMAL":l=new VertexElement(a,VertexElementFormat.Vector3,VertexMesh.MESH_NORMAL0),a+=12;break;case"COLOR":l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_COLOR0),a+=16;break;case"UV":l=new VertexElement(a,VertexElementFormat.Vector2,VertexMesh.MESH_TEXTURECOORDINATE0),a+=8;break;case"UV1":l=new VertexElement(a,VertexElementFormat.Vector2,VertexMesh.MESH_TEXTURECOORDINATE1),a+=8;break;case"BLENDWEIGHT":l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_BLENDWEIGHT0),a+=16;break;case"BLENDINDICES":t?(l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_BLENDINDICES0),a+=16):(l=new VertexElement(a,VertexElementFormat.Byte4,VertexMesh.MESH_BLENDINDICES0),a+=4);break;case"TANGENT":l=new VertexElement(a,VertexElementFormat.Vector4,VertexMesh.MESH_TANGENT0),a+=16;break;case"NORMAL_BYTE":l=new VertexElement(a,VertexElementFormat.NorByte4,VertexMesh.MESH_NORMAL0),a+=4;break;default:throw"VertexMesh: unknown vertex flag."}s.push(l)}r=new VertexDeclaration(a,s),VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")]=r}return r}}VertexMesh.MESH_POSITION0=0,VertexMesh.MESH_COLOR0=1,VertexMesh.MESH_TEXTURECOORDINATE0=2,VertexMesh.MESH_NORMAL0=3,VertexMesh.MESH_TANGENT0=4,VertexMesh.MESH_BLENDINDICES0=5,VertexMesh.MESH_BLENDWEIGHT0=6,VertexMesh.MESH_TEXTURECOORDINATE1=7,VertexMesh.MESH_WORLDMATRIX_ROW0=8,VertexMesh.MESH_WORLDMATRIX_ROW1=9,VertexMesh.MESH_WORLDMATRIX_ROW2=10,VertexMesh.MESH_WORLDMATRIX_ROW3=11,VertexMesh.MESH_SIMPLEANIMATOR=12,VertexMesh.MESH_CUSTOME0=12,VertexMesh.MESH_CUSTOME1=13,VertexMesh.MESH_CUSTOME2=14,VertexMesh.MESH_CUSTOME3=15,VertexMesh._vertexDeclarationMap={};class SubShader{static regIncludeBindUnifrom(e,t,r){let i={},a=i[e]={};a.uniformMap=t,a.defaultValue=r,Object.assign(SubShader.IncludeUniformMap,i)}static __init__(){let e={s_Cull:Shader3D.RENDER_STATE_CULL,s_Blend:Shader3D.RENDER_STATE_BLEND,s_BlendSrc:Shader3D.RENDER_STATE_BLEND_SRC,s_BlendDst:Shader3D.RENDER_STATE_BLEND_DST,s_BlendSrcRGB:Shader3D.RENDER_STATE_BLEND_SRC_RGB,s_BlendDstRGB:Shader3D.RENDER_STATE_BLEND_DST_RGB,s_BlendSrcAlpha:Shader3D.RENDER_STATE_BLEND_SRC_ALPHA,s_BlendDstAlpha:Shader3D.RENDER_STATE_BLEND_DST_ALPHA,s_BlendEquation:Shader3D.RENDER_STATE_BLEND_EQUATION,s_BlendEquationRGB:Shader3D.RENDER_STATE_BLEND_EQUATION_RGB,s_BlendEquationAlpha:Shader3D.RENDER_STATE_BLEND_EQUATION_ALPHA,s_DepthTest:Shader3D.RENDER_STATE_DEPTH_TEST,s_DepthWrite:Shader3D.RENDER_STATE_DEPTH_WRITE,s_StencilRef:Shader3D.RENDER_STATE_STENCIL_REF,s_StencilTest:Shader3D.RENDER_STATE_STENCIL_TEST,s_StencilWrite:Shader3D.RENDER_STATE_STENCIL_WRITE,s_StencilOp:Shader3D.RENDER_STATE_STENCIL_OP};this.StateParamsMap={};for(let t in e)this.StateParamsMap[e[t]]=Shader3D.propertyNameToID(t);SubShader.IncludeUniformMap={}}constructor(t=SubShader.DefaultAttributeMap,r={},i=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this._attributeMap=t,this._uniformMap=r,this._uniformDefaultValue=i,this._uniformTypeMap=new Map;for(const t in r)if("object"==typeof r[t]){let e=r[t],i=new Map;for(const t in e){let r=ShaderDataTypeToUniformBufferType(e[t]);i.set(t,r),this._uniformTypeMap.set(t,e[t])}let a=new Map;i.forEach(((e,t)=>{a.set(Shader3D.propertyNameToID(t),e)}));let s=new UnifromBufferData(a);this._uniformBufferDataMap.set(t,s)}else{let i=r[t];if(this._uniformTypeMap.set(t,i),i==e.ShaderDataType.Texture2D||i==e.ShaderDataType.TextureCube){let e=Shader3D.getDefineByName(`Gamma_${t}`),r=Shader3D.propertyNameToID(t);ShaderDefine._texGammaDefine[r]=e}}}setFlag(e,t){t?this._flags[e]=t:delete this._flags[e]}getFlag(e){return this._flags[e]}addShaderPass(e,t,r="Forward"){return this._addShaderPass(ShaderCompile.compile(e,t),r)}_addShaderPass(e,t="Forward"){var r=new ShaderPass(this,e);return r._pipelineMode=t,this._passes.push(r),this._addIncludeUniform(e.includeNames),r}_addIncludeUniform(e){for(let r of e)if(SubShader.IncludeUniformMap[r]){let e=SubShader.IncludeUniformMap[r],i=e.uniformMap,a=e.defaultValue;for(var t in i)this._uniformTypeMap.has(t)||(this._uniformTypeMap.set(t,i[t]),this._uniformMap[t]=i[t]);for(var t in a)this._uniformDefaultValue[t]||(this._uniformDefaultValue[t]=a[t])}}}function ShaderDataTypeToUniformBufferType(t){switch(t){case e.ShaderDataType.Float:return e.UniformBufferParamsType.Number;case e.ShaderDataType.Vector2:return e.UniformBufferParamsType.Vector2;case e.ShaderDataType.Vector3:return e.UniformBufferParamsType.Vector3;case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return e.UniformBufferParamsType.Vector4;case e.ShaderDataType.Matrix4x4:return e.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}SubShader.DefaultAttributeMap={a_Position:[VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4],a_Normal:[VertexMesh.MESH_NORMAL0,e.ShaderDataType.Vector3],a_Tangent0:[VertexMesh.MESH_TANGENT0,e.ShaderDataType.Vector4],a_Texcoord0:[VertexMesh.MESH_TEXTURECOORDINATE0,e.ShaderDataType.Vector2],a_Texcoord1:[VertexMesh.MESH_TEXTURECOORDINATE1,e.ShaderDataType.Vector2],a_Color:[VertexMesh.MESH_COLOR0,e.ShaderDataType.Vector4],a_BoneWeights:[VertexMesh.MESH_BLENDWEIGHT0,e.ShaderDataType.Vector4],a_BoneIndices:[VertexMesh.MESH_BLENDINDICES0,e.ShaderDataType.Vector4],a_WorldMat:[VertexMesh.MESH_WORLDMATRIX_ROW0,e.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[VertexMesh.MESH_SIMPLEANIMATOR,e.ShaderDataType.Vector2]};class Shader3D{static init(){Shader3D.debugShaderVariantCollection=new ShaderVariantCollection}static _getNamesByDefineData(e,t){var r=Shader3D._maskMap,i=e._mask;t.length=0;for(var a=0,s=e._length;a<s;a++)for(var n=r[a],o=i[a],l=0;l<32;l++){var h=1<<l;if(o>0&&h>o)break;o&h&&t.push(n[h])}}static getDefineByName(e){var t=Shader3D._defineMap[e];if(!t){var r=Shader3D._maskMap,i=Shader3D._defineCounter,a=Math.floor(i/32),s=1<<i%32;t=new ShaderDefine(a,s),Shader3D._defineMap[e]=t,a==r.length&&(r.length++,r[a]={}),r[a][s]=e,Shader3D._defineCounter++}return t}static propertyNameToID(e){return LayaGL.renderEngine.propertyNameToID(e)}static propertyIDToName(e){return LayaGL.renderEngine.propertyIDToName(e)}static addInclude(e,t){ShaderCompile.addInclude(e,t)}static compileShaderByDefineNames(e,t,r,i){var a=Shader3D.find(e);if(a){var s=a.getSubShaderAt(t);if(s){var n=s._passes[r];if(n){var o=Shader3D._compileDefineDatas;o.clear();for(var l=0,h=i.length;l<h;l++)o.add(Shader3D.getDefineByName(i[l]));o.addDefineDatas(Shader3D._configDefineValues),n.withCompile(o)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}static add(e,t=!1,r=!1){return Shader3D._preCompileShader[e]=new Shader3D(e,t,r)}static find(e){return Shader3D._preCompileShader[e]}static parse(e,t){e.name&&e.uniformMap||console.error("TODO");let r=Shader3D.add(e.name,e.enableInstancing,e.supportReflectionProbe),i=new SubShader(e.attributeMap?e.attributeMap:SubShader.DefaultAttributeMap,e.uniformMap,e.defaultValue);r.addSubShader(i);let a=e.shaderPass;for(var s in a){let e=a[s];i._addShaderPass(ShaderCompile.compile(e.VS,e.FS,t),e.pipeline)}return r}get name(){return this._name}constructor(e,t,r){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._subShaders=[],this._name=e,this._enableInstancing=t,this._supportReflectionProbe=r}addSubShader(e){this._subShaders.push(e),e._owner=this}getSubShaderAt(e){return this._subShaders[e]}static compileShader(e,t,r,...i){var a=Shader3D.find(e);if(a){var s=a.getSubShaderAt(t);if(s){var n=s._passes[r];if(n){var o=Shader3D._compileDefineDatas,l=o._mask;l.length=0;for(var h=0,u=i.length;h<u;h++)l.push(i[h]);o._length=i.length,n.withCompile(o)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}}Shader3D._configDefineValues=new DefineDatas,Shader3D._compileDefineDatas=new DefineDatas,Shader3D.RENDER_STATE_CULL=0,Shader3D.RENDER_STATE_BLEND=1,Shader3D.RENDER_STATE_BLEND_SRC=2,Shader3D.RENDER_STATE_BLEND_DST=3,Shader3D.RENDER_STATE_BLEND_SRC_RGB=4,Shader3D.RENDER_STATE_BLEND_DST_RGB=5,Shader3D.RENDER_STATE_BLEND_SRC_ALPHA=6,Shader3D.RENDER_STATE_BLEND_DST_ALPHA=7,Shader3D.RENDER_STATE_BLEND_CONST_COLOR=8,Shader3D.RENDER_STATE_BLEND_EQUATION=9,Shader3D.RENDER_STATE_BLEND_EQUATION_RGB=10,Shader3D.RENDER_STATE_BLEND_EQUATION_ALPHA=11,Shader3D.RENDER_STATE_DEPTH_TEST=12,Shader3D.RENDER_STATE_DEPTH_WRITE=13,Shader3D.RENDER_STATE_STENCIL_TEST=14,Shader3D.RENDER_STATE_STENCIL_WRITE=15,Shader3D.RENDER_STATE_STENCIL_REF=16,Shader3D.RENDER_STATE_STENCIL_OP=17,Shader3D.PERIOD_CUSTOM=0,Shader3D.PERIOD_MATERIAL=1,Shader3D.PERIOD_SPRITE=2,Shader3D.PERIOD_CAMERA=3,Shader3D.PERIOD_SCENE=4,Shader3D._propertyNameMap={},Shader3D._propertyNameCounter=0,Shader3D._defineCounter=0,Shader3D._defineMap={},Shader3D._preCompileShader={},Shader3D._maskMap=[],Shader3D.debugMode=!1;class Laya{static init(...t){if(At)return Promise.resolve();let r;At=!0,r="number"==typeof t[0]?{designWidth:t[0],designHeight:t[1]}:t[0],ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=arrayBufferSlice),Float32Array.prototype.slice||(Float32Array.prototype.slice=float32ArraySlice),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=uint16ArraySlice),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=uint8ArraySlice),Browser.__init__(),URL.__init__();let i=window.Laya3D;if(i){if(!WebGL.enable())return Promise.reject("Must support webGL!");RunDriver.changeWebGLSize=i._changeWebGLSize,Render.is3DMode=!0}var a=Browser.mainCanvas=new HTMLCanvas(!0),s=a.source.style;return s.position="absolute",s.top=s.left="0px",s.background="#000000",Browser.onKGMiniGame||Browser.onAlipayMiniGame||Browser.container.appendChild(a.source),Browser.canvas=new HTMLCanvas(!0),Browser.context=Browser.canvas.getContext("2d"),Browser.supportWebAudio=SoundManager.__init__(),Browser.supportLocalStorage=LocalStorage.__init__(),Laya.systemTimer=new Timer(!1),e.systemTimer=Timer.gSysTimer=Laya.systemTimer,Laya.physicsTimer=new Timer(!1),Laya.timer=new Timer(!1),ILaya.systemTimer=Laya.systemTimer,e.timer=ILaya.timer=Laya.timer,e.physicsTimer=ILaya.physicsTimer=Laya.physicsTimer,Laya.loader=new Loader,ILaya.Laya=Laya,e.loader=ILaya.loader=Laya.loader,WeakObject.__init__(),Mouse.__init__(),LayaEnv.beforeInit&&(LayaEnv.isPlaying?LayaEnv.beforeInit(r):LayaEnv.beforeInit=null),LayaEnv.isConch&&Laya.enableNative(),CacheManger.beginCheck(),e.stage=Laya.stage=new Stage,ILaya.stage=Laya.stage,LayaEnv.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(e.stage.setGlobalRepaint.bind(e.stage)),Shader3D.init(),MeshQuadTexture.__int__(),MeshVG.__init__(),MeshTexture.__init__(),Laya.render=Laya.createRender(),e.render=Laya.render,e.stage.size(r.designWidth,r.designHeight),r.scaleMode&&(e.stage.scaleMode=r.scaleMode),r.screenMode&&(e.stage.screenMode=r.screenMode),r.alignV&&(e.stage.alignV=r.alignV),r.alignH&&(e.stage.alignH=r.alignH),Config.isAlpha?e.stage.bgColor=null:r.backgroundColor&&(e.stage.bgColor=r.backgroundColor),window.stage=e.stage,RenderStateContext.__init__(),MeshParticle2D.__init__(),RenderSprite.__init__(),InputManager.__init__(e.stage,Render.canvas),window.conch&&"conchUseWXAdapter"in Browser.window&&(Input.isAppUseNewInput=!0),Input.__init__(),SoundManager.autoStopMusic=!0,Stat._StatRender=new StatUI,Value2D._initone(ShaderDefines2D.TEXTURE2D,TextureSV),Value2D._initone(ShaderDefines2D.TEXTURE2D|ShaderDefines2D.FILTERGLOW,TextureSV),Value2D._initone(ShaderDefines2D.PRIMITIVE,PrimitiveSV),Value2D._initone(ShaderDefines2D.SKINMESH,SkinSV),i?i.__init__().then((()=>{Mt.forEach((e=>e())),Mt.length=0,LayaEnv.afterInit&&(LayaEnv.isPlaying?LayaEnv.afterInit():LayaEnv.afterInit=null)})):(Mt.forEach((e=>e())),Mt.length=0,LayaEnv.afterInit&&(LayaEnv.isPlaying?LayaEnv.afterInit():LayaEnv.afterInit=null),Promise.resolve())}static createRender(){return new Render(0,0,Browser.mainCanvas)}static addWasmModule(e,t,r){Laya.WasmModules[e]={exports:t,memory:r}}static alertGlobalError(e){var t=0;Browser.window.onerror=e?function(e,r,i,a,s){t++<5&&s&&this.alert("出错啦，请把此信息截图给研发商\n"+e+"\n"+s.stack)}:null}static _runScript(e){return Browser.window[Laya._evcode](e)}static enableDebugPanel(e="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var t=Browser.createElement("script");t.onload=function(){window.Laya.DebugPanel.enable()},t.src=e,Browser.document.body.appendChild(t)}}static enableNative(){Laya.isNativeRender_enable||(Laya.isNativeRender_enable=!0,RenderState2D.width=Browser.window.innerWidth,RenderState2D.height=Browser.window.innerHeight,Browser.measureText=function(e,t){return window.conchTextCanvas.font=t,window.conchTextCanvas.measureText(e)},Stage.clear=function(t){Context.set2DRenderConfig();var r=ColorUtils.create(t).arrColor;LayaGL.renderEngine.clearRenderTexture(e.RenderClearFlag.Color|e.RenderClearFlag.Depth,new Color(r[0],r[1],r[2],r[3]),1),RenderState2D.clear()},Sprite.drawToCanvas=function(e,t,r,i,a,s){a-=e.x,s-=e.y,a|=0,s|=0,r|=0,i|=0;var n=new HTMLCanvas(!1),o=n.getContext("2d");return n.size(r,i),o.asBitmap=!0,o._targets.start(),RenderSprite.renders[t]._fun(e,o,a,s),o.flush(),o._targets.end(),o._targets.restore(),n},Object.defineProperty(RenderTexture2D.prototype,"uv",{get:function(){return this._uv},set:function(e){this._uv=e}}),HTMLCanvas.prototype.getTexture=function(){return this._texture||(this._texture=this.context._targets,this._texture.uv=RenderTexture2D.flipyuv,this._texture.bitmap=this._texture),this._texture})}static onInitModule(e){At?e():Mt.push(e)}}function arrayBufferSlice(e,t){var r=new Uint8Array(this,e,t-e),i=new Uint8Array(r.length);return i.set(r),i.buffer}function uint8ArraySlice(){for(var e=this.length,t=new Uint8Array(this.length),r=0;r<e;r++)t[r]=this[r];return t}function float32ArraySlice(){for(var e=this.length,t=new Float32Array(this.length),r=0;r<e;r++)t[r]=this[r];return t}function uint16ArraySlice(...e){var t,r,i;if(0===e.length)for(t=this.length,r=new Uint16Array(t),i=0;i<t;i++)r[i]=this[i];else if(2===e.length){var a=e[0],s=e[1];if(s>a)for(t=s-a,r=new Uint16Array(t),i=a;i<s;i++)r[i-a]=this[i];else r=new Uint16Array(0)}return r}Laya.stage=null,Laya.systemTimer=null,Laya.physicsTimer=null,Laya.timer=null,Laya.loader=null,Laya.isWXOpenDataContext=!1,Laya.isWXPosMsg=!1,Laya.WasmModules={},Laya._evcode="eval",Laya.isNativeRender_enable=!1,ILaya.Loader=Loader,ILaya.Context=Context,ILaya.Browser=Browser;var At=!1,Mt=[],Lt=Laya.init;e.stage=void 0,e.systemTimer=void 0,e.physicsTimer=void 0,e.timer=void 0,e.loader=void 0,e.render=void 0;var wt=Laya.alertGlobalError,It=Laya.enableDebugPanel;class EffectBase extends Component{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=Handler.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class KeyLocation{}KeyLocation.STANDARD=0,KeyLocation.LEFT=1,KeyLocation.RIGHT=2,KeyLocation.NUM_PAD=3;class Keyboard{}Keyboard.NUMBER_0=48,Keyboard.NUMBER_1=49,Keyboard.NUMBER_2=50,Keyboard.NUMBER_3=51,Keyboard.NUMBER_4=52,Keyboard.NUMBER_5=53,Keyboard.NUMBER_6=54,Keyboard.NUMBER_7=55,Keyboard.NUMBER_8=56,Keyboard.NUMBER_9=57,Keyboard.A=65,Keyboard.B=66,Keyboard.C=67,Keyboard.D=68,Keyboard.E=69,Keyboard.F=70,Keyboard.G=71,Keyboard.H=72,Keyboard.I=73,Keyboard.J=74,Keyboard.K=75,Keyboard.L=76,Keyboard.M=77,Keyboard.N=78,Keyboard.O=79,Keyboard.P=80,Keyboard.Q=81,Keyboard.R=82,Keyboard.S=83,Keyboard.T=84,Keyboard.U=85,Keyboard.V=86,Keyboard.W=87,Keyboard.X=88,Keyboard.Y=89,Keyboard.Z=90,Keyboard.F1=112,Keyboard.F2=113,Keyboard.F3=114,Keyboard.F4=115,Keyboard.F5=116,Keyboard.F6=117,Keyboard.F7=118,Keyboard.F8=119,Keyboard.F9=120,Keyboard.F10=121,Keyboard.F11=122,Keyboard.F12=123,Keyboard.F13=124,Keyboard.F14=125,Keyboard.F15=126,Keyboard.NUMPAD=21,Keyboard.NUMPAD_0=96,Keyboard.NUMPAD_1=97,Keyboard.NUMPAD_2=98,Keyboard.NUMPAD_3=99,Keyboard.NUMPAD_4=100,Keyboard.NUMPAD_5=101,Keyboard.NUMPAD_6=102,Keyboard.NUMPAD_7=103,Keyboard.NUMPAD_8=104,Keyboard.NUMPAD_9=105,Keyboard.NUMPAD_ADD=107,Keyboard.NUMPAD_DECIMAL=110,Keyboard.NUMPAD_DIVIDE=111,Keyboard.NUMPAD_ENTER=108,Keyboard.NUMPAD_MULTIPLY=106,Keyboard.NUMPAD_SUBTRACT=109,Keyboard.SEMICOLON=186,Keyboard.EQUAL=187,Keyboard.COMMA=188,Keyboard.MINUS=189,Keyboard.PERIOD=190,Keyboard.SLASH=191,Keyboard.BACKQUOTE=192,Keyboard.LEFTBRACKET=219,Keyboard.BACKSLASH=220,Keyboard.RIGHTBRACKET=221,Keyboard.QUOTE=222,Keyboard.ALTERNATE=18,Keyboard.BACKSPACE=8,Keyboard.CAPS_LOCK=20,Keyboard.COMMAND=15,Keyboard.CONTROL=17,Keyboard.DELETE=46,Keyboard.ENTER=13,Keyboard.ESCAPE=27,Keyboard.PAGE_UP=33,Keyboard.PAGE_DOWN=34,Keyboard.END=35,Keyboard.HOME=36,Keyboard.LEFT=37,Keyboard.UP=38,Keyboard.RIGHT=39,Keyboard.DOWN=40,Keyboard.SHIFT=16,Keyboard.SPACE=32,Keyboard.TAB=9,Keyboard.INSERT=45;class CommandEncoder{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(e){this._idata.push(e)}}class QuickTestTool{static getMCDName(e){return QuickTestTool._typeToNameDic[e]}static showRenderTypeInfo(e,t=!1){if(t||!QuickTestTool.showedDic[e]){if(QuickTestTool.showedDic[e]=!0,!QuickTestTool._rendertypeToStrDic[e]){var r,i=[];for(r=1;r<=e;)r&e&&i.push(QuickTestTool.getMCDName(r&e)),r<<=1;QuickTestTool._rendertypeToStrDic[e]=i.join(",")}console.log("cmd:",QuickTestTool._rendertypeToStrDic[e])}}static __init__(){QuickTestTool._typeToNameDic[SpriteConst.ALPHA]="ALPHA",QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM]="TRANSFORM",QuickTestTool._typeToNameDic[SpriteConst.TEXTURE]="TEXTURE",QuickTestTool._typeToNameDic[SpriteConst.GRAPHICS]="GRAPHICS",QuickTestTool._typeToNameDic[SpriteConst.ONECHILD]="ONECHILD",QuickTestTool._typeToNameDic[SpriteConst.CHILDS]="CHILDS",QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM|SpriteConst.ALPHA]="TRANSFORM|ALPHA",QuickTestTool._typeToNameDic[SpriteConst.CANVAS]="CANVAS",QuickTestTool._typeToNameDic[SpriteConst.BLEND]="BLEND",QuickTestTool._typeToNameDic[SpriteConst.FILTERS]="FILTERS",QuickTestTool._typeToNameDic[SpriteConst.MASK]="MASK",QuickTestTool._typeToNameDic[SpriteConst.CLIP]="CLIP",QuickTestTool._typeToNameDic[SpriteConst.LAYAGL3D]="LAYAGL3D"}constructor(){}render(e,t,r){QuickTestTool._addType(this._renderType),QuickTestTool.showRenderTypeInfo(this._renderType),RenderSprite.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}_stageRender(e,t,r){QuickTestTool._countStart(),QuickTestTool._PreStageRender.call(ILaya.stage,e,t,r),QuickTestTool._countEnd()}static _countStart(){var e;for(e in QuickTestTool._countDic)QuickTestTool._countDic[e]=0}static _countEnd(){QuickTestTool._i++,QuickTestTool._i>60&&(QuickTestTool.showCountInfo(),QuickTestTool._i=0)}static _addType(e){QuickTestTool._countDic[e]?QuickTestTool._countDic[e]+=1:QuickTestTool._countDic[e]=1}static showCountInfo(){var e;for(e in console.log("==================="),QuickTestTool._countDic)console.log("count:"+QuickTestTool._countDic[e]),QuickTestTool.showRenderTypeInfo(e,!0)}static enableQuickTest(){QuickTestTool.__init__(),Sprite.prototype.render=QuickTestTool.prototype.render,QuickTestTool._PreStageRender=Stage.prototype.render,Stage.prototype.render=QuickTestTool.prototype._stageRender}}QuickTestTool.showedDic={},QuickTestTool._rendertypeToStrDic={},QuickTestTool._typeToNameDic={},QuickTestTool._countDic={},QuickTestTool._i=0;class Socket extends EventDispatcher{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(e){this._endian=e,null!=this._input&&(this._input.endian=e),null!=this._output&&(this._output.endian=e)}constructor(e=null,t=0,r=null,i=null,a=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=r||Byte,this.protocols=i,this.endian=Socket.BIG_ENDIAN,e&&t>0&&t<65535&&this.connect(e,t,a)}connect(e,t,r=!1){var i=r?"wss":"ws://"+e+":"+t;this.connectByUrl(i)}connectByUrl(e){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new Browser.window.WebSocket(e,this.protocols):this._socket=new Browser.window.WebSocket(e),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=e=>{this._onOpen(e)},this._socket.onmessage=e=>{this._onMessage(e)},this._socket.onclose=e=>{this._onClose(e)},this._socket.onerror=e=>{this._onError(e)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(e){}}_onOpen(e){this._connected=!0,this.event(Event.OPEN,e)}_onMessage(e){if(e&&e.data){var t=e.data;if(this.disableInput&&t)this.event(Event.MESSAGE,t);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var r=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,t&&("string"==typeof t?this._input.writeUTFBytes(t):this._input.writeArrayBuffer(t),this._addInputPosition=this._input.pos,this._input.pos=r),this.event(Event.MESSAGE,t)}}}_onClose(e){this._connected=!1,this.event(Event.CLOSE,e)}_onError(e){this.event(Event.ERROR,e)}send(e){this._socket.send(e)}flush(){if(this._output&&this._output.length>0){var e;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(t){e=t}this._output.endian=this.endian,this._output.clear(),e&&this.event(Event.ERROR,e)}}}Socket.LITTLE_ENDIAN="littleEndian",Socket.BIG_ENDIAN="bigEndian";class Base64Tool{static init(){if(!Base64Tool.lookup){Base64Tool.lookup=new Uint8Array(256);for(var e=0;e<Base64Tool.chars.length;e++)Base64Tool.lookup[Base64Tool.chars.charCodeAt(e)]=e}}static isBase64String(e){return Base64Tool.reg.test(e)}static encode(e){var t,r=new Uint8Array(e),i=r.length,a="";for(t=0;t<i;t+=3)a+=Base64Tool.chars[r[t]>>2],a+=Base64Tool.chars[(3&r[t])<<4|r[t+1]>>4],a+=Base64Tool.chars[(15&r[t+1])<<2|r[t+2]>>6],a+=Base64Tool.chars[63&r[t+2]];return i%3==2?a=a.substring(0,a.length-1)+"=":i%3==1&&(a=a.substring(0,a.length-2)+"=="),a}static decode(e){Base64Tool.init();var t,r,i,a,s,n=.75*e.length,o=e.length,l=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var h=new ArrayBuffer(n),u=new Uint8Array(h);for(t=0;t<o;t+=4)r=Base64Tool.lookup[e.charCodeAt(t)],i=Base64Tool.lookup[e.charCodeAt(t+1)],a=Base64Tool.lookup[e.charCodeAt(t+2)],s=Base64Tool.lookup[e.charCodeAt(t+3)],u[l++]=r<<2|i>>4,u[l++]=(15&i)<<4|a>>2,u[l++]=(3&a)<<6|63&s;return h}}Base64Tool.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Base64Tool.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,Base64Tool.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,Base64Tool.lookup=null;class Log{static enable(){Log._logdiv||(Log._logdiv=Browser.createElement("div"),Log._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",Browser.document.body.appendChild(Log._logdiv),Log._btn=Browser.createElement("button"),Log._btn.innerText="Hide",Log._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",Log._btn.onclick=Log.toggle,Browser.document.body.appendChild(Log._btn))}static toggle(){var e=Log._logdiv.style;""===e.display?(Log._btn.innerText="Show",e.display="none"):(Log._btn.innerText="Hide",e.display="")}static print(e){Log._logdiv&&(Log._count>=Log.maxCount&&Log.clear(),Log._count++,Log._logdiv.innerText+=e+"\n",Log.autoScrollToBottom&&Log._logdiv.scrollHeight-Log._logdiv.scrollTop-Log._logdiv.clientHeight<50&&(Log._logdiv.scrollTop=Log._logdiv.scrollHeight))}static clear(){Log._logdiv.innerText="",Log._count=0}}Log._count=0,Log.maxCount=50,Log.autoScrollToBottom=!0;class PerfData{constructor(e,t,r,i){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=e,this.color=t,this.name=r,this.scale=i}addData(e){this.datas[this.datapos]=e,this.datapos++,this.datapos%=300}}class PerfHUD extends Sprite{constructor(){super(),this.datas=[],this.xdata=new Array(PerfHUD.DATANUM),this.ydata=new Array(PerfHUD.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,PerfHUD.inst=this,this._renderType|=SpriteConst.CUSTOM,this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),PerfHUD._now=performance?performance.now.bind(performance):Date.now}now(){return PerfHUD._now()}start(){this.sttm=PerfHUD._now()}end(e){var t=PerfHUD._now()-this.sttm;this.updateValue(e,t)}config(e,t){this.hud_width=e,this.hud_height=t}addDataDef(e,t,r,i){this.datas[e]=new PerfData(e,t,r,i)}updateValue(e,t){this.datas[e].addData(t)}v2y(e){return this._y,this.hud_height,this.gMinV,this.gMaxV,this._y+this.hud_height*(1-(e-this.gMinV)/this.gMaxV)}drawHLine(e,t,r,i){var a=this._x;this._x,this.hud_width;var s=this.v2y(t);e.fillText(i,a,s-6,null,"green",null),a+=this.textSpace,e.fillStyle=r,e.fillRect(a,s,this._x+this.hud_width,1,null)}customRender(e,t,r){var i=performance.now();PerfHUD._lastTm<=0&&(PerfHUD._lastTm=i),this.updateValue(0,i-PerfHUD._lastTm),PerfHUD._lastTm=i,e.save(),e.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),e.globalAlpha=.9,this.drawHLine(e,0,"green","    0"),this.drawHLine(e,10,"green","  10"),this.drawHLine(e,16.667,"red"," "),this.drawHLine(e,20,"green","50|20"),this.drawHLine(e,33.334,"yellow",""),this.drawHLine(e,16.667*3,"yellow",""),this.drawHLine(e,66.668,"yellow",""),this.drawHLine(e,50,"green","20|50"),this.drawHLine(e,100,"green","10|100");for(var a=0,s=this.datas.length;a<s;a++){var n=this.datas[a];if(n){var o=n.datas.length,l=(this.hud_width-this.textSpace)/o,h=n.datapos,u=this._x+this.textSpace;e.fillStyle=n.color;for(var d=o;h<d;h++){var _=this.v2y(n.datas[h]*n.scale);e.fillRect(u,_,l,this.hud_height+this._y-_,null),u+=l}for(h=0;h<n.datapos;h++)_=this.v2y(n.datas[h]*n.scale),e.fillRect(u,_,l,this.hud_height+this._y-_,null),u+=l}}e.restore()}}PerfHUD._lastTm=0,PerfHUD._now=null,PerfHUD.DATANUM=300,PerfHUD.drawTexTm=0;class PoolCache{constructor(){this.maxCount=1e3}getCacheList(){return Pool.getPoolBySign(this.sign)}tryDispose(e){var t;(t=Pool.getPoolBySign(this.sign)).length>this.maxCount&&t.splice(this.maxCount,t.length-this.maxCount)}static addPoolCacheManager(e,t=100){var r;(r=new PoolCache).sign=e,r.maxCount=t,CacheManger.regCacheByFunction(r.tryDispose.bind(r),r.getCacheList.bind(r))}}class SingletonList{constructor(){this.elements=[],this.length=0}_add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}add(e){let t=this.elements.indexOf(e);"number"!=typeof e&&-1!=t&&t<this.length||(this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++)}indexof(e){let t=this.elements.indexOf(e);return-1!=t&&t<this.length?t:-1}remove(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length&&(this.elements[t]=this.elements[this.length-1],this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}destroy(){this.elements=null}}class TimeLine extends EventDispatcher{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(e,t,r,i=null,a=0){return(new TimeLine).to(e,t,r,i,a)}static from(e,t,r,i=null,a=0){return(new TimeLine).from(e,t,r,i,a)}to(e,t,r,i=null,a=0){return this._create(e,t,r,i,a,!0)}from(e,t,r,i=null,a=0){return this._create(e,t,r,i,a,!1)}_create(e,t,r,i,a,s){var n=Pool.getItemByClass("tweenData",tweenData);return n.isTo=s,n.type=0,n.target=e,n.duration=r,n.data=t,n.startTime=this._startTime+a,n.endTime=n.startTime+n.duration,n.ease=i,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(e,t){var r=Pool.getItemByClass("tweenData",tweenData);return r.type=1,r.data=e,r.endTime=r.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=r,this._tweenDataList.push(r),this}removeLabel(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var r=this._tweenDataList.indexOf(t);r>-1&&this._tweenDataList.splice(r,1)}delete this._labelDic[e]}}gotoTime(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var t,r,i,a;for(var s in this._firstTweenDic)if(r=this._firstTweenDic[s])for(var n in r)n in r.diyTarget&&(r.diyTarget[n]=r[n]);for(s in this._tweenDic)(t=this._tweenDic[s]).clear(),delete this._tweenDic[s];if(this._index=0,this._gidIndex=0,this._currTime=e,this._lastTime=Browser.now(),null==this._endTweenDataList||this._endTimeSort){function Compare(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=i=this._tweenDataList.concat(),i.sort(Compare)}else i=this._endTweenDataList;for(var o=0,l=i.length;o<l;o++)if(0==(a=i[o]).type){if(!(e>=a.endTime))break;this._index=Math.max(this._index,o+1);var h=a.data;if(a.isTo)for(var u in h)a.target[u]=h[u]}for(o=0,l=this._tweenDataList.length;o<l;o++)0==(a=this._tweenDataList[o]).type&&e>=a.startTime&&e<a.endTime&&(this._index=Math.max(this._index,o+1),this._gidIndex++,(t=Pool.getItemByClass("tween",Tween))._create(a.target,a.data,a.duration,a.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,a.isTo,!0,!1),t.setStartTime(this._currTime-(e-a.startTime)),t._updateEase(this._currTime),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t)}}gotoLabel(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}pause(){ILaya.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(e=0,t=!1){if(this._tweenDataList){if(this._startTimeSort){function Compare(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(Compare);for(var r=0,i=this._tweenDataList.length;r<i;r++){var a=this._tweenDataList[r];if(null!=a&&0==a.type){var s=a.target,n=s.$_GID||(s.$_GID=Utils.getGID()),o=null;for(var l in null==this._firstTweenDic[n]?((o={}).diyTarget=s,this._firstTweenDic[n]=o):o=this._firstTweenDic[n],a.data)null==o[l]&&(o[l]=s[l])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=Browser.now(),ILaya.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var e in this._tweenDic)(t=this._tweenDic[e]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var t,r=Browser.now(),i=r-this._lastTime,a=this._currTime+=i*this.scale;for(e in this._lastTime=r,this._tweenDic)(t=this._tweenDic[e])._updateEase(a);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var s=this._tweenDataList[this._index];a>=s.startTime&&(this._index++,0==s.type?(this._gidIndex++,(t=Pool.getItemByClass("tween",Tween))._create(s.target,s.data,s.duration,s.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,s.isTo,!0,!1),t.setStartTime(a),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t,t._updateEase(a)):this.event(Event.LABEL,s.data))}}_animComplete(e){this._tweenDic[e]&&delete this._tweenDic[e]}_complete(){this.event(Event.COMPLETE)}get index(){return this._frameIndex}set index(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var e,t,r;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(e in this._tweenDic)this._tweenDic[e].clear(),delete this._tweenDic[e];for(e in this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(r=this._tweenDataList.length,t=0;t<r;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,ILaya.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class tweenData{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,Pool.recover("tweenData",this)}}class DrawParticleCmd{static create(e){var t=Pool.getItemByClass("DrawParticleCmd",DrawParticleCmd);return t._templ=e,t}recover(){this._templ=null,Pool.recover("DrawParticleCmd",this)}run(e,t,r){e.drawParticle(t,r,this._templ)}get cmdID(){return DrawParticleCmd.ID}}DrawParticleCmd.ID="DrawParticleCmd";class BlendState{static create(e,t,r){}constructor(e){this.blendType=0}}BlendState._blend_All_pool={},BlendState._blend_seperate_pool={};class BlendComponent{static getHash(e,t,r){return e+(t<<3)+(r<<7)}static getBlendComponent(e,t,r){let i=BlendComponent.getHash(e,t,r);return BlendComponent._pool[i]||(BlendComponent._pool[i]=new BlendComponent(e,t,r,i)),BlendComponent._pool[i]}constructor(e,t,r,i){this._hashIndex=0,this._hashIndex=i,this._blendOperationGLData=e,this._sourceBlendFactor=t,this._destinationFactor=r}}BlendComponent._pool={};class UniformBufferBase{constructor(e,t,r){this._mapArray=[],this._blockName=e,this._singgle=r,this._glPointerID=t}add(e){-1==this._mapArray.indexOf(e)&&this._mapArray.push(e)}splitBuffer(e){let t=this._mapArray.indexOf(e);-1!=t&&this._mapArray.splice(t,1)}}class UniformBufferObject extends Buffer{static create(e,t,r,i=!1){UniformBufferObject._Map.get(e)||UniformBufferObject._Map.set(e,new UniformBufferBase(e,LayaGL.renderEngine.getUBOPointer(e),i));let a=UniformBufferObject._Map.get(e);if(a._singgle&&a._mapArray.length>0)return null;{let s=LayaGL.renderOBJCreate.createUniformBufferObject(a._glPointerID,e,t,r,i);return a._singgle&&a.add(s),s}}static getBuffer(e,t){let r=UniformBufferObject._Map.get(e);return r?r._mapArray[t]:null}constructor(t,r,i,a,s){super(e.BufferTargetType.UNIFORM_BUFFER,i),this._isSingle=!1,this._glPointer=t,this.byteLength=a,this._name=r,this._isSingle=s,this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(e,t){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,e,t)}_reset(e){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this._byteLength=this.byteLength=e,this._glBuffer=LayaGL.renderEngine.createBuffer(this._bufferType,this._bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(e,t=0,r=Number.MAX_SAFE_INTEGER){if(!(r<0))if(this.bind(),!(0==t&&r==this.byteLength)){var i=new Uint8Array(e.buffer,t,r);this._glBuffer.setData(i,t)}else this._glBuffer.setDataEx(e,t,e.length)}setDataByUniformBufferData(e){this._updateDataInfo==e?(this.setData(e._buffer,4*e._updateFlag.x,4*(e._updateFlag.y-e._updateFlag.x)),e._resetUpdateFlag()):(this.setData(e._buffer,0,this.byteLength),e._resetUpdateFlag(),this._updateDataInfo=e)}setDataByByUniformBufferDataOffset(e,t){let r=e.getbyteLength(),i=e._realByte;e._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(e._buffer,t*r,i/4)}destroy(){super.destroy()}}UniformBufferObject.UBONAME_SCENE="SceneUniformBlock",UniformBufferObject.UBONAME_CAMERA="CameraUniformBlock",UniformBufferObject.UBONAME_SPRITE3D="SpriteUniformBlock",UniformBufferObject.UBONAME_SHADOW="ShadowUniformBlock",UniformBufferObject.commonMap=["CameraUniformBlock","SceneUniformBlock","SpriteUniformBlock","ShadowUniformBlock"],UniformBufferObject._Map=new Map;class RenderState{constructor(){this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.srcBlend=RenderState.BLENDPARAM_ONE,this.dstBlend=RenderState.BLENDPARAM_ZERO,this.srcBlendRGB=RenderState.BLENDPARAM_ONE,this.dstBlendRGB=RenderState.BLENDPARAM_ZERO,this.srcBlendAlpha=RenderState.BLENDPARAM_ONE,this.dstBlendAlpha=RenderState.BLENDPARAM_ZERO,this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=RenderState.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Vector3(RenderState.STENCILOP_KEEP,RenderState.STENCILOP_KEEP,RenderState.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp=null}}RenderState.CULL_NONE=e.CullMode.Off,RenderState.CULL_FRONT=e.CullMode.Front,RenderState.CULL_BACK=e.CullMode.Back,RenderState.BLEND_DISABLE=e.BlendType.BLEND_DISABLE,RenderState.BLEND_ENABLE_ALL=e.BlendType.BLEND_ENABLE_ALL,RenderState.BLEND_ENABLE_SEPERATE=e.BlendType.BLEND_ENABLE_SEPERATE,RenderState.BLENDPARAM_ZERO=e.BlendFactor.Zero,RenderState.BLENDPARAM_ONE=e.BlendFactor.One,RenderState.BLENDPARAM_SRC_COLOR=e.BlendFactor.SourceColor,RenderState.BLENDPARAM_ONE_MINUS_SRC_COLOR=e.BlendFactor.OneMinusSourceColor,RenderState.BLENDPARAM_DST_COLOR=e.BlendFactor.DestinationColor,RenderState.BLENDPARAM_ONE_MINUS_DST_COLOR=e.BlendFactor.OneMinusDestinationColor,RenderState.BLENDPARAM_SRC_ALPHA=e.BlendFactor.SourceAlpha,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA=e.BlendFactor.OneMinusSourceAlpha,RenderState.BLENDPARAM_DST_ALPHA=e.BlendFactor.DestinationAlpha,RenderState.BLENDPARAM_ONE_MINUS_DST_ALPHA=e.BlendFactor.OneMinusDestinationAlpha,RenderState.BLENDPARAM_SRC_ALPHA_SATURATE=e.BlendFactor.SourceAlphaSaturate,RenderState.BLENDPARAM_BLENDCOLOR=e.BlendFactor.BlendColor,RenderState.BLENDPARAM_BLEND_ONEMINUS_COLOR=e.BlendFactor.OneMinusBlendColor,RenderState.BLENDEQUATION_ADD=e.BlendEquationSeparate.ADD,RenderState.BLENDEQUATION_SUBTRACT=e.BlendEquationSeparate.SUBTRACT,RenderState.BLENDEQUATION_REVERSE_SUBTRACT=e.BlendEquationSeparate.REVERSE_SUBTRACT,RenderState.BLENDEQUATION_MIN=e.BlendEquationSeparate.MIN,RenderState.BLENDEQUATION_MAX=e.BlendEquationSeparate.MAX,RenderState.DEPTHTEST_OFF=0,RenderState.DEPTHTEST_NEVER=e.CompareFunction.Never,RenderState.DEPTHTEST_LESS=e.CompareFunction.Less,RenderState.DEPTHTEST_EQUAL=e.CompareFunction.Equal,RenderState.DEPTHTEST_LEQUAL=e.CompareFunction.LessEqual,RenderState.DEPTHTEST_GREATER=e.CompareFunction.Greater,RenderState.DEPTHTEST_NOTEQUAL=e.CompareFunction.NotEqual,RenderState.DEPTHTEST_GEQUAL=e.CompareFunction.GreaterEqual,RenderState.DEPTHTEST_ALWAYS=e.CompareFunction.Always,RenderState.STENCILTEST_OFF=0,RenderState.STENCILTEST_NEVER=e.CompareFunction.Never,RenderState.STENCILTEST_LESS=e.CompareFunction.Less,RenderState.STENCILTEST_EQUAL=e.CompareFunction.Equal,RenderState.STENCILTEST_LEQUAL=e.CompareFunction.LessEqual,RenderState.STENCILTEST_GREATER=e.CompareFunction.Greater,RenderState.STENCILTEST_NOTEQUAL=e.CompareFunction.NotEqual,RenderState.STENCILTEST_GEQUAL=e.CompareFunction.GreaterEqual,RenderState.STENCILTEST_ALWAYS=e.CompareFunction.Always,RenderState.STENCILOP_KEEP=e.StencilOperation.Keep,RenderState.STENCILOP_ZERO=e.StencilOperation.Zero,RenderState.STENCILOP_REPLACE=e.StencilOperation.Replace,RenderState.STENCILOP_INCR=e.StencilOperation.IncrementSaturate,RenderState.STENCILOP_INCR_WRAP=e.StencilOperation.IncrementWrap,RenderState.STENCILOP_DECR=e.StencilOperation.DecrementSaturate,RenderState.STENCILOP_DECR_WRAP=e.StencilOperation.DecrementWrap,RenderState.STENCILOP_INVERT=e.StencilOperation.Invert,RenderState.Default=new RenderState;var Bt,Pt,Ft,Ut;e.RenderDrawMode=void 0,(Bt=e.RenderDrawMode||(e.RenderDrawMode={}))[Bt.TRIANGLES=0]="TRIANGLES",Bt[Bt.POINTS=1]="POINTS",Bt[Bt.LINES=2]="LINES",e.RenderIndexMode=void 0,(Pt=e.RenderIndexMode||(e.RenderIndexMode={}))[Pt.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Pt[Pt.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Pt[Pt.UNSIGNED_INT=2]="UNSIGNED_INT",e.TextureDecodeFormat=void 0,(Ft=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[Ft.Normal=0]="Normal",Ft[Ft.RGBM=1]="RGBM";class CommonMemoryAllocater{static creatBlock(e){return new ArrayBuffer(e)}static freeMemoryBlock(e){}}e.MemoryDataType=void 0,(Ut=e.MemoryDataType||(e.MemoryDataType={}))[Ut.ShaderData=0]="ShaderData",Ut[Ut.TextureData=1]="TextureData",Ut[Ut.VertexData=2]="VertexData",Ut[Ut.IndexData=3]="IndexData",Ut[Ut.BaseRenderData=4]="BaseRenderData";class NativeMemory{constructor(e,t){if(t){if(e>NativeMemory._sharedBuffer.byteLength)throw new Error("NativeMemory:shared buffer not enough");this._buffer=NativeMemory._sharedBuffer}else this._buffer=CommonMemoryAllocater.creatBlock(e);this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._f64data=new Float64Array(this._buffer),this._byteArray=new Uint8Array(this._buffer),this._byteLength=e}get float32Array(){return this._fdata}get float64Array(){return this._f64data}get uint8Array(){return this._byteArray}get int32Array(){return this._idata}destroy(){this._destroyed||(this.clear(),CommonMemoryAllocater.freeMemoryBlock(this._buffer),this._destroyed=!0)}clear(){this._idata=null,this._fdata=null,this._byteArray=null}}NativeMemory.NativeSourceID=0,NativeMemory._sharedBuffer=new ArrayBuffer(256);class UploadMemory extends NativeMemory{constructor(e){super(e,!1),this._currentOffsetInByte=0}addBlockCell(e,t){e.uploadDataTOShareMemory(this,this._currentOffsetInByte)&&(this._currentOffsetInByte+=t)}check(e){return this._currentOffsetInByte+e<this._byteLength}clear(){this._currentOffsetInByte=0}}class UploadMemoryManager{constructor(){this._dataNodeList=new SingletonList,this._commandNums=0,this._currentBlock=new UploadMemory(UploadMemoryManager.UploadMemorySize),this._conchUploadMemoryManager=new window.conchUploadMemoryManager}static getInstance(){return UploadMemoryManager._instance||(UploadMemoryManager._instance=new UploadMemoryManager),UploadMemoryManager._instance}_addNodeCommand(e,t){this._currentBlock.addBlockCell(e,t),this._commandNums++}static syncRenderMemory(){UploadMemoryManager.getInstance()._serialiseData(),UploadMemoryManager.getInstance().clear()}_serialiseData(){const e=this._dataNodeList.elements;for(let t=0;t<this._dataNodeList.length;t++){let r=e[t],i=r.getUploadMemoryLength();if(i>UploadMemoryManager.UploadMemorySize)throw"dataSize is too large, greater than UploadMemorySize,";this._currentBlock.check(i)?(this.uploadData(),this._addNodeCommand(r,i)):this._addNodeCommand(r,i)}this.uploadData()}uploadData(){this._commandNums>0&&(this._conchUploadMemoryManager.uploadData(this._currentBlock._buffer,this._commandNums),this._commandNums=0,this._currentBlock.clear())}clear(){this._dataNodeList.length=0}}UploadMemoryManager.UploadMemorySize=1048576,UploadMemoryManager._instance=null;class ArabicReshaper{characterMapContains(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return!0;return!1}getCharRep(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return ArabicReshaper.charsMap[t];return!1}getCombCharRep(e,t){for(var r=0;r<ArabicReshaper.combCharsMap.length;++r)if(ArabicReshaper.combCharsMap[r][0][0]===e&&ArabicReshaper.combCharsMap[r][0][1]===t)return ArabicReshaper.combCharsMap[r];return!1}isTransparent(e){for(var t=0;t<ArabicReshaper.transChars.length;++t)if(ArabicReshaper.transChars[t]===e)return!0;return!1}getOriginalCharsFromCode(e){var t;for(t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.charsMap[t][0]);for(t=0;t<ArabicReshaper.combCharsMap.length;++t)if(ArabicReshaper.combCharsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.combCharsMap[t][0][0])+String.fromCharCode(ArabicReshaper.combCharsMap[t][0][1]);return String.fromCharCode(e)}convertArabic(e){for(var t,r,i="",a=0;a<e.length;++a){var s=e.charCodeAt(a);if(this.characterMapContains(s)){for(var n=null,o=null,l=a-1,h=a+1;l>=0&&this.isTransparent(e.charCodeAt(l));--l);for((!(t=!!(n=l>=0?e.charCodeAt(l):null)&&this.getCharRep(n))||null==t[2]&&null==t[3])&&(n=null);h<e.length&&this.isTransparent(e.charCodeAt(h));++h);if((!(t=!!(o=h<e.length?e.charCodeAt(h):null)&&this.getCharRep(o))||null==t[3]&&null==t[4])&&(o=null),1604===s&&null!=o&&(1570===o||1571===o||1573===o||1575===o)){r=this.getCombCharRep(s,o),i+=null!=n?String.fromCharCode(r[4]):String.fromCharCode(r[1]),++a;continue}if(t=this.getCharRep(s),null!=n&&null!=o&&null!=t[3]){i+=String.fromCharCode(t[3]);continue}if(null!=n&&null!=t[4]){i+=String.fromCharCode(t[4]);continue}if(null!=o&&null!=t[2]){i+=String.fromCharCode(t[2]);continue}i+=String.fromCharCode(t[1])}else i+=String.fromCharCode(s)}return i}convertArabicBack(e){var t,r,i="";for(r=0;r<e.length;++r)t=e.charCodeAt(r),i+=this.getOriginalCharsFromCode(t);return i}}ArabicReshaper.charsMap=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],ArabicReshaper.combCharsMap=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],ArabicReshaper.transChars=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];class MatirxArray{static ArrayMul(e,t,r){if(e)if(t)for(var i,a,s,n,o=0;o<4;o++)i=e[o],a=e[o+4],s=e[o+8],n=e[o+12],r[o]=i*t[0]+a*t[1]+s*t[2]+n*t[3],r[o+4]=i*t[4]+a*t[5]+s*t[6]+n*t[7],r[o+8]=i*t[8]+a*t[9]+s*t[10]+n*t[11],r[o+12]=i*t[12]+a*t[13]+s*t[14]+n*t[15];else MatirxArray.copyArray(e,r);else MatirxArray.copyArray(t,r)}static copyArray(e,t){if(e&&t)for(var r=0;r<e.length;r++)t[r]=e[r]}}return e.AlphaCmd=AlphaCmd,e.Animation=Animation,e.Animation2DCondition=Animation2DCondition,e.Animation2DEvent=Animation2DEvent,e.Animation2DParm=Animation2DParm,e.AnimationBase=AnimationBase,e.AnimationClip2D=AnimationClip2D,e.AnimationClip2DParse01=AnimationClip2DParse01,e.Animator2D=Animator2D,e.AnimatorController2D=AnimatorController2D,e.AnimatorControllerLayer2D=AnimatorControllerLayer2D,e.AnimatorControllerParse=AnimatorControllerParse,e.AnimatorPlayState2D=AnimatorPlayState2D,e.AnimatorState2D=AnimatorState2D,e.AnimatorState2DScript=class{onStateEnter(){}onStateUpdate(){}onStateExit(){}},e.AnimatorStateBoolCondition=AnimatorStateBoolCondition,e.AnimatorStateCondition=AnimatorStateCondition,e.AnimatorStateNumberCondition=AnimatorStateNumberCondition,e.AnimatorStateTriggerCondition=AnimatorStateTriggerCondition,e.AnimatorTransition2D=AnimatorTransition2D,e.ArabicReshaper=ArabicReshaper,e.AssetDb=AssetDb,e.AtlasGrid=AtlasGrid,e.AtlasInfoManager=AtlasInfoManager,e.AtlasResource=AtlasResource,e.AudioSound=AudioSound,e.AudioSoundChannel=AudioSoundChannel,e.Base64Tool=Base64Tool,e.BasePoly=BasePoly,e.BaseShader=BaseShader,e.BaseTexture=BaseTexture,e.BatchProgress=BatchProgress,e.Bezier=Bezier,e.BitmapFont=BitmapFont,e.BlendComponent=BlendComponent,e.BlendMode=BlendMode,e.BlendState=BlendState,e.BlurFilter=BlurFilter,e.BlurFilterGLRender=BlurFilterGLRender,e.BoundsStyle=BoundsStyle,e.Browser=Browser,e.Buffer=Buffer,e.Buffer2D=Buffer2D,e.BufferState=BufferState,e.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(e){this._tar=e,e.on(Event.MOUSE_DOWN,this,this.toChangedState),e.on(Event.MOUSE_UP,this,this.toInitState),e.on(Event.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Tween.clear(this._curTween),this._curTween=Tween.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Ease[this.effectEase],Handler.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Tween.clear(this._curTween),this._curState=2,this._curTween=Tween.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Ease[this.backEase],Handler.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},e.Byte=Byte,e.CacheManger=CacheManger,e.CacheStyle=CacheStyle,e.CallLater=CallLater,e.CharRenderInfo=CharRenderInfo,e.CharRender_Canvas=CharRender_Canvas,e.CharRender_Native=CharRender_Native,e.CharSubmitCache=CharSubmitCache,e.ClassUtils=ClassUtils,e.ClipRectCmd=ClipRectCmd,e.Color=Color,e.ColorFilter=ColorFilter,e.ColorUtils=ColorUtils,e.CommandEncoder=CommandEncoder,e.CommandUniformMap=class{constructor(e){this._idata={},this._stateName=e}hasPtrID(e){return!(null==this._idata[e])}getMap(){return this._idata}addShaderUniform(e,t){this._idata[e]=t}},e.CommonMemoryAllocater=CommonMemoryAllocater,e.Component=Component,e.ComponentDriver=ComponentDriver,e.Config=Config,e.Config3D=Config3D,e.Const=Const,e.Context=Context,e.DDSTextureInfo=DDSTextureInfo,e.DefineDatas=DefineDatas,e.Delegate=Delegate,e.DepthState=class{},e.Downloader=Downloader,e.Dragging=Dragging,e.Draw9GridTextureCmd=Draw9GridTextureCmd,e.DrawCircleCmd=DrawCircleCmd,e.DrawCurvesCmd=DrawCurvesCmd,e.DrawImageCmd=DrawImageCmd,e.DrawLineCmd=DrawLineCmd,e.DrawLinesCmd=DrawLinesCmd,e.DrawParticleCmd=DrawParticleCmd,e.DrawPathCmd=DrawPathCmd,e.DrawPieCmd=DrawPieCmd,e.DrawPolyCmd=DrawPolyCmd,e.DrawRectCmd=DrawRectCmd,e.DrawStyle=DrawStyle,e.DrawTextureCmd=DrawTextureCmd,e.DrawTexturesCmd=DrawTexturesCmd,e.DrawTrianglesCmd=DrawTrianglesCmd,e.Earcut=Earcut,e.EarcutNode=EarcutNode,e.Ease=Ease,e.EffectAnimation=EffectAnimation,e.EffectBase=EffectBase,e.Event=Event,e.EventDispatcher=EventDispatcher,e.FadeIn=class extends EffectBase{_doTween(){return this.target.alpha=0,Tween.to(this.target,{alpha:1},this.duration,Ease[this.ease],this._comlete,this.delay)}},e.FadeOut=class extends EffectBase{_doTween(){return this.target.alpha=1,Tween.to(this.target,{alpha:0},this.duration,Ease[this.ease],this._comlete,this.delay)}},e.FillTextCmd=FillTextCmd,e.FillTextureCmd=FillTextureCmd,e.Filter=Filter,e.FontInfo=FontInfo,e.FrameAnimation=FrameAnimation,e.GL2TextureContext=GL2TextureContext,e.GLBuffer=GLBuffer,e.GLObject=GLObject,e.GLParams=GLParams,e.GLRender2DContext=GLRender2DContext,e.GLRenderDrawContext=GLRenderDrawContext,e.GLRenderState=GLRenderState,e.GLSLCodeGenerator=GLSLCodeGenerator,e.GLShaderInstance=GLShaderInstance,e.GLTextureContext=GLTextureContext,e.GLVertexState=GLVertexState,e.GlCapable=GlCapable,e.GlowFilter=GlowFilter,e.GlowFilterGLRender=GlowFilterGLRender,e.GrahamScan=GrahamScan,e.GraphicAnimation=GraphicAnimation,e.Graphics=Graphics,e.GraphicsBounds=GraphicsBounds,e.HDRTextureInfo=HDRTextureInfo,e.HTMLCanvas=HTMLCanvas,e.HalfFloatUtils=HalfFloatUtils,e.Handler=Handler,e.HideFlags=HideFlags,e.HierarchyLoader=HierarchyLoader,e.HierarchyParser=HierarchyParser,e.HierarchyResource=ze,e.HitArea=HitArea,e.HtmlElement=HtmlElement,e.HtmlImage=HtmlImage,e.HtmlLink=HtmlLink,e.HtmlParseOptions=HtmlParseOptions,e.HtmlParser=HtmlParser,e.HttpRequest=HttpRequest,e.ICharRender=ICharRender,e.ILaya=ILaya,e.IStatRender=IStatRender,e.ImgUtils=ImgUtils,e.IncludeFile=IncludeFile,e.IndexBuffer=IndexBuffer,e.IndexBuffer2D=IndexBuffer2D,e.Input=Input,e.InputManager=InputManager,e.KTXTextureInfo=KTXTextureInfo,e.KeyLocation=KeyLocation,e.Keyboard=Keyboard,e.Keyframe2D=Keyframe2D,e.KeyframeNode2D=KeyframeNode2D,e.KeyframeNodeList2D=KeyframeNodeList2D,e.Laya=Laya,e.LayaEnv=LayaEnv,e.LayaGL=LayaGL,e.LayaGLQuickRunner=LayaGLQuickRunner,e.LegacyUIParser=LegacyUIParser,e.Loader=Loader,e.LocalStorage=LocalStorage,e.Log=Log,e.MathUtil=MathUtil,e.MathUtils3D=MathUtils3D,e.MatirxArray=MatirxArray,e.Matrix=Matrix,e.Matrix3x3=Matrix3x3,e.Matrix4x4=Matrix4x4,e.Mesh2D=Mesh2D,e.MeshParticle2D=MeshParticle2D,e.MeshQuadTexture=MeshQuadTexture,e.MeshTexture=MeshTexture,e.MeshVG=MeshVG,e.Mouse=Mouse,e.NativeContext=NativeContext,e.NativeFilter=NativeFilter,e.NativeGL2TextureContext=NativeGL2TextureContext,e.NativeGLObject=NativeGLObject,e.NativeGLRender2DContext=class extends NativeGLObject{constructor(e){super(e)}activeTexture(e){}bindTexture(e,t){}bindUseProgram(e){return!0}},e.NativeGLRenderDrawContext=NativeGLRenderDrawContext,e.NativeGLTextureContext=NativeGLTextureContext,e.NativeGLVertexState=NativeGLVertexState,e.NativeMemory=NativeMemory,e.NativeRenderStateCommand=NativeRenderStateCommand,e.NativeRenderTexture2D=NativeRenderTexture2D,e.NativeWebGLCacheAsNormalCanvas=NativeWebGLCacheAsNormalCanvas,e.NativeWebGLEngine=NativeWebGLEngine,e.Node=Node,e.NodeFlags=NodeFlags,e.NullLoader=NullLoader,e.Path=Path,e.PerfData=PerfData,e.PerfHUD=PerfHUD,e.Point=Point,e.Pool=Pool,e.PoolCache=PoolCache,e.Prefab=Prefab,e.PrefabImpl=PrefabImpl,e.PrimitiveSV=PrimitiveSV,e.Quaternion=Quaternion,e.QuickTestTool=QuickTestTool,e.Rectangle=Rectangle,e.Render=Render,e.RenderInfo=RenderInfo,e.RenderSprite=RenderSprite,e.RenderState=RenderState,e.RenderState2D=RenderState2D,e.RenderStateCommand=RenderStateCommand,e.RenderStateContext=RenderStateContext,e.RenderTexture=RenderTexture,e.RenderTexture2D=RenderTexture2D,e.RenderTextureCube=class extends RenderTexture{constructor(e,t,r,i,a){super(e,e,t,r,i,a),this.faceIndex=0}_createRenderTarget(){this._dimension=e.TextureDimension.Cube,this._renderTarget=LayaGL.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}_start(){RenderTexture._configInstance.invertY=this._isCameraTarget,RenderTexture._currentActive!=this&&(RenderTexture._currentActive&&RenderTexture._currentActive._end(),RenderTexture._currentActive=this,LayaGL.textureContext.bindRenderTarget(this._renderTarget,this.faceIndex))}},e.Resource=Resource,e.RestoreCmd=RestoreCmd,e.RotateCmd=RotateCmd,e.RunDriver=RunDriver,e.SaveBase=SaveBase,e.SaveClipRect=SaveClipRect,e.SaveCmd=SaveCmd,e.SaveMark=SaveMark,e.SaveTransform=SaveTransform,e.SaveTranslate=SaveTranslate,e.ScaleCmd=ScaleCmd,e.Scene=Scene,e.Script=Script,e.SerializeUtil=SerializeUtil,e.Shader=Shader,e.Shader2D=Shader2D,e.Shader2X=Shader2X,e.Shader3D=Shader3D,e.ShaderCompile=ShaderCompile,e.ShaderCompileDefineBase=ShaderCompileDefineBase,e.ShaderData=ShaderData,e.ShaderDataDefaultValue=function(t){switch(t){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return Vector2.ZERO;case e.ShaderDataType.Vector3:return Vector3.ZERO;case e.ShaderDataType.Vector4:return Vector4.ZERO;case e.ShaderDataType.Color:return Color.BLACK;case e.ShaderDataType.Matrix4x4:return Matrix4x4.DEFAULT}return null},e.ShaderDefine=ShaderDefine,e.ShaderDefines2D=ShaderDefines2D,e.ShaderDefinesBase=ShaderDefinesBase,e.ShaderInstance=class{constructor(e,t,r,i){this._customUniformParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1,this._cullStateCMD=LayaGL.renderOBJCreate.createRenderStateComand(),this._renderShaderInstance=LayaGL.renderEngine.createShaderInstance(e,t,r),this._renderShaderInstance._complete&&(this._shaderPass=i,this._create())}get complete(){return this._renderShaderInstance._complete}_create(){this._sceneUniformParamsMap=new CommandEncoder,this._cameraUniformParamsMap=new CommandEncoder,this._spriteUniformParamsMap=new CommandEncoder,this._materialUniformParamsMap=new CommandEncoder;const e=LayaGL.renderOBJCreate.createGlobalUniformMap("Scene3D"),t=LayaGL.renderOBJCreate.createGlobalUniformMap("Sprite3D"),r=LayaGL.renderOBJCreate.createGlobalUniformMap("BaseCamera"),i=LayaGL.renderOBJCreate.createGlobalUniformMap("Custom");let a,s,n=this._renderShaderInstance.getUniformMap();for(a=0,s=n.length;a<s;a++){let s=n[a];e.hasPtrID(s.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(s):r.hasPtrID(s.dataOffset)?this._cameraUniformParamsMap.addShaderUniform(s):t.hasPtrID(s.dataOffset)?this._spriteUniformParamsMap.addShaderUniform(s):i.hasPtrID(s.dataOffset)?(this._customUniformParamsMap||(this._customUniformParamsMap=[]),this._customUniformParamsMap[s.dataOffset]=s):this._materialUniformParamsMap.addShaderUniform(s)}}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._customUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null}_getRenderState(e,t){return e[SubShader.StateParamsMap[t]]}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,t,r){LayaGL.renderEngine.uploadUniforms(this._renderShaderInstance,e,t,r)}uploadRenderStateBlendDepth(e){var t=this._shaderPass.renderState,r=e.getData(),i=this._getRenderState(r,Shader3D.RENDER_STATE_DEPTH_WRITE),a=this._getRenderState(r,Shader3D.RENDER_STATE_DEPTH_TEST),s=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND),n=this._getRenderState(r,Shader3D.RENDER_STATE_STENCIL_REF),o=this._getRenderState(r,Shader3D.RENDER_STATE_STENCIL_TEST),l=this._getRenderState(r,Shader3D.RENDER_STATE_STENCIL_WRITE),h=this._getRenderState(r,Shader3D.RENDER_STATE_STENCIL_OP);switch(this._shaderPass.statefirst?(null!=t.depthWrite&&(i=t.depthWrite),null!=t.depthTest&&(a=t.depthTest),null!=t.blend&&(s=t.blend),null!=t.stencilRef&&(n=t.stencilRef),null!=t.stencilTest&&(o=t.stencilTest),null!=t.stencilWrite&&(l=t.stencilWrite),null!=t.stencilOp&&(h=t.stencilOp)):(i=null!=i?i:t.depthWrite,a=null!=a?a:t.depthTest,s=null!=s?s:t.blend,n=null!=n?n:t.stencilRef,o=null!=o?o:t.stencilTest,l=null!=l?l:t.stencilWrite,h=null!=h?h:t.stencilOp),i=null!=i?i:RenderState.Default.depthWrite,a=null!=a?a:RenderState.Default.depthTest,s=null!=s?s:RenderState.Default.blend,n=null!=n?n:RenderState.Default.stencilRef,o=null!=o?o:RenderState.Default.stencilTest,l=null!=l?l:RenderState.Default.stencilWrite,h=null!=h?h:RenderState.Default.stencilOp,RenderStateContext.setDepthMask(i),a===RenderState.DEPTHTEST_OFF?RenderStateContext.setDepthTest(!1):(RenderStateContext.setDepthTest(!0),RenderStateContext.setDepthFunc(a)),s){case RenderState.BLEND_DISABLE:RenderStateContext.setBlend(!1);break;case RenderState.BLEND_ENABLE_ALL:var u=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_EQUATION),d=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_SRC),_=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_DST);this._shaderPass.statefirst?(null!=t.blendEquation&&(u=t.blendEquation),null!=t.srcBlend&&(d=t.srcBlend),null!=t.dstBlend&&(_=t.dstBlend)):(u=null!=u?u:t.blendEquation,d=null!=d?d:t.srcBlend,_=null!=_?_:t.dstBlend),u=null!=u?u:RenderState.Default.blendEquation,d=null!=d?d:RenderState.Default.srcBlend,_=null!=_?_:RenderState.Default.dstBlend,RenderStateContext.setBlend(!0),RenderStateContext.setBlendEquation(u),RenderStateContext.setBlendFunc(d,_);break;case RenderState.BLEND_ENABLE_SEPERATE:var c=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_EQUATION_RGB),m=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_EQUATION_ALPHA),p=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_SRC_RGB),f=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_DST_RGB),g=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_SRC_ALPHA),T=this._getRenderState(r,Shader3D.RENDER_STATE_BLEND_DST_ALPHA);this._shaderPass.statefirst?(null!=t.blendEquationRGB&&(c=t.blendEquationRGB),null!=t.blendEquationAlpha&&(m=t.blendEquationAlpha),null!=t.srcBlendRGB&&(p=t.srcBlendRGB),null!=t.dstBlendRGB&&(f=t.dstBlendRGB),null!=t.srcBlendAlpha&&(g=t.srcBlendAlpha),null!=t.dstBlendAlpha&&(T=t.dstBlendAlpha)):(c=null!=c?c:t.blendEquationRGB,m=null!=m?m:t.blendEquationAlpha,p=null!=p?p:t.srcBlendRGB,f=null!=f?f:t.dstBlendRGB,g=null!=g?g:t.srcBlendAlpha,T=null!=T?T:t.dstBlendAlpha),c=null!=c?c:RenderState.Default.blendEquationRGB,m=null!=m?m:RenderState.Default.blendEquationAlpha,p=null!=p?p:RenderState.Default.srcBlendRGB,f=null!=f?f:RenderState.Default.dstBlendRGB,g=null!=g?g:RenderState.Default.srcBlendAlpha,T=null!=T?T:RenderState.Default.dstBlendAlpha,RenderStateContext.setBlend(!0),RenderStateContext.setBlendEquationSeparate(c,m),RenderStateContext.setBlendFuncSeperate(p,f,g,T)}RenderStateContext.setStencilMask(l),o==RenderState.STENCILTEST_OFF?RenderStateContext.setStencilTest(!1):(RenderStateContext.setStencilTest(!0),RenderStateContext.setStencilFunc(o,n)),RenderStateContext.setstencilOp(h.x,h.y,h.z)}uploadRenderStateFrontFace(t,r,i){var a;this._cullStateCMD.clear();var s,n=this._shaderPass.renderState,o=t.getData(),l=this._getRenderState(o,Shader3D.RENDER_STATE_CULL);switch(this._shaderPass.statefirst&&(l=null!==(a=n.cull)&&void 0!==a?a:l),l=null!=l?l:RenderState.Default.cull){case RenderState.CULL_NONE:this._cullStateCMD.addCMD(e.RenderStateType.CullFace,!1),s=r!=i?e.CullMode.Front:e.CullMode.Back,this._cullStateCMD.addCMD(e.RenderStateType.FrontFace,s);break;case RenderState.CULL_FRONT:this._cullStateCMD.addCMD(e.RenderStateType.CullFace,!0),s=r==i?e.CullMode.Front:e.CullMode.Back,this._cullStateCMD.addCMD(e.RenderStateType.FrontFace,s);break;case RenderState.CULL_BACK:this._cullStateCMD.addCMD(e.RenderStateType.CullFace,!0),s=r!=i?e.CullMode.Front:e.CullMode.Back,this._cullStateCMD.addCMD(e.RenderStateType.FrontFace,s)}this._cullStateCMD.applyCMD()}uploadCustomUniform(e,t){LayaGL.renderEngine.uploadCustomUniforms(this._renderShaderInstance,this._customUniformParamsMap,e,t)}},e.ShaderNode=ShaderNode,e.ShaderPass=ShaderPass,e.ShaderValue=class{constructor(){}},e.ShaderVariable=ShaderVariable,e.ShaderVariant=ShaderVariant,e.ShaderVariantCollection=ShaderVariantCollection,e.SingletonList=SingletonList,e.SkinMeshBuffer=SkinMeshBuffer,e.SkinSV=SkinSV,e.Socket=Socket,e.Sound=class extends EventDispatcher{load(e){}play(e=0,t=0){return null}get duration(){return 0}dispose(){}},e.SoundChannel=SoundChannel,e.SoundManager=SoundManager,e.SoundNode=SoundNode,e.Sprite=Sprite,e.SpriteConst=SpriteConst,e.SpriteStyle=SpriteStyle,e.SpriteUtils=SpriteUtils,e.Stage=Stage,e.Stat=Stat,e.StatUI=StatUI,e.StencilState=class{},e.StringKey=StringKey,e.SubShader=SubShader,e.SubUniformBufferData=class extends UnifromBufferData{constructor(e,t){super(e),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=t,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},e.Submit=Submit,e.SubmitBase=SubmitBase,e.SubmitCMD=SubmitCMD,e.SubmitCanvas=SubmitCanvas,e.SubmitKey=SubmitKey,e.SubmitTarget=SubmitTarget,e.SubmitTexture=SubmitTexture,e.System=class{static changeDefinition(e,t){window.Laya[e]=t;var r=e+"=classObj";window.eval(r)}},e.Text=Text,e.TextAtlas=TextAtlas,e.TextRender=TextRender,e.TextResource=TextResource,e.TextStyle=TextStyle,e.TextTexture=TextTexture,e.Texture=Texture,e.Texture2D=Texture2D,e.Texture2DArray=class extends BaseTexture{constructor(t,r,i,a,s=!0,n,o=!1){super(t,r,a),this._dimension=e.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=i,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,r,a,s,o)}setImageData(e,t,r){let i=this._texture;LayaGL.textureContext.setTexture3DImageData(i,e,this.depth,t,r)}setPixlesData(e,t,r){let i=this._texture;LayaGL.textureContext.setTexture3DPixlesData(i,e,this.depth,t,r)}setSubPixelsData(e,t,r,i,a,s,n,o,l,h,u){let d=this._texture;LayaGL.textureContext.setTexture3DSubPixelsData(d,n,o,l,e,t,r,i,a,s,h,u)}},e.TextureCube=TextureCube,e.TextureSV=TextureSV,e.TimeLine=TimeLine,e.Timer=Timer,e.TransformCmd=TransformCmd,e.TranslateCmd=TranslateCmd,e.Tween=Tween,e.TypedArrayClasses=mt,e.UBBParser=UBBParser,e.URL=URL,e.UniformBufferBase=UniformBufferBase,e.UniformBufferObject=UniformBufferObject,e.UnifromBufferData=UnifromBufferData,e.UploadMemory=UploadMemory,e.UploadMemoryManager=UploadMemoryManager,e.Utils=Utils,e.Value2D=Value2D,e.Vector2=Vector2,e.Vector3=Vector3,e.Vector4=Vector4,e.VectorGraphManager=VectorGraphManager,e.VertexArrayObject=class{constructor(){}},e.VertexBuffer=VertexBuffer,e.VertexBuffer2D=VertexBuffer2D,e.VertexDeclaration=VertexDeclaration,e.VertexElement=VertexElement,e.VertexElementFormat=VertexElementFormat,e.VertexMesh=VertexMesh,e.VideoNode=VideoNode,e.VideoTexture=VideoTexture,e.WeakObject=WeakObject,e.WebAudioSound=WebAudioSound,e.WebAudioSoundChannel=WebAudioSoundChannel,e.WebGL=WebGL,e.WebGLCacheAsNormalCanvas=WebGLCacheAsNormalCanvas,e.WebGLEngine=WebGLEngine,e.WebGLInternalRT=WebGLInternalRT,e.WebGLInternalTex=WebGLInternalTex,e.WebGLRTMgr=WebGLRTMgr,e.WebGlConfig=class{},e.Widget=Widget,e.WordText=WordText,e.WorkerLoader=WorkerLoader,e.XML=XML,e.XMLIterator=XMLIterator,e.XMLUtils=XMLUtils,e.alertGlobalError=wt,e.classInfo=function(e){return dummy},e.enableDebugPanel=It,e.init=Lt,e.isWXOpenDataContext=undefined,e.isWXPosMsg=undefined,e.property=function(e){return dummy},e.regClass=function(e){return function(t){ClassUtils.regClass(e,t)}},e.runInEditor=function(e){},e}({});
//# sourceMappingURL=laya.core.js.map